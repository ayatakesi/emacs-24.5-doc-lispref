<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Appendix E. GNU Emacs Internals</title><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"/></head><body><div class="appendix"><div class="titlepage"><div><div><h1 class="title"><a id="GNU-Emacs-Internals"/>Appendix E. GNU Emacs Internals</h1></div></div></div><p>このチャプターでは、実行可能なEmacs実行可能形式を事前ロードされたLispライブラリーとともにダンプする方法と、ストレージが割り当てられる方法、およびCプログラマーが興味をもつかもしれないGNU
Emacsの内部的な側面のいくつかを説明します。
</p><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="Building-Emacs"/>Building Emacs</h1></div></div></div><a id="idm84385488" class="indexterm"/><a id="idm84384720" class="indexterm"/><p>このセクションでは、Emacs実行可能形式のビルドに関するステップの説明をします。makefileがこれらすべてを自動的に行うので、Emacsをビイルドおよびインストールするために、この題材を知る必要はありません。この情報は、Emacs開発者にとって適切です。
</p><p><code class="filename">src</code>ディレクトリー内のCソースファイルをコンパイルすることにより、<code class="filename">temacs</code>と呼ばれる実行可能形式ファイルが生成されます。これは<em class="firstterm">bare
impure Emacs()裸で不純なEmacs</em>とも呼ばれます。これにはEmacs
LispインタープリターとI/Oルーチンが含まれますが、編集コマンドは含まれません。
</p><a id="idm84381904" class="indexterm"/><p>コマンド<span class="command"><strong>temacs -l
loadup</strong></span>は<code class="filename">temacs</code>を実行して、それが<code class="filename">loadup.el</code>をロードするよう計らいます。<code class="literal">loadup</code>ライブラリーは、通常のEmacs編集環境をセットアップする、追加のLispライブラリーをロードします。このステップの後には、そのEmacs実行可能形式は<em class="firstterm">bare(裸)</em>ではなくなります。
</p><a id="idm84377936" class="indexterm"/><p>標準的なLispファイルのロードには若干の時間を要するので、ユーザーが直接<code class="filename">temacs</code>実行可能形式を実行することは、通常はありません。そのかわり、Emacsビルドの最終ステップとして、コマンド‘<code class="literal">temacs
-batch -l loadup
dump</code>’が実行されます。特別な引数‘<code class="literal">dump</code>’により、<span class="command"><strong>temacs</strong></span>は<code class="filename">emacs</code>と呼ばれる実行可能形式のプログラムにダンプされます。これには、標準的なLispファイルがすべて事前ロードされています。(引数‘<code class="literal">-batch</code>’は<code class="filename">temacs</code>がその端末上でデータの初期化を試みることを防げるので、端末情報のテーブルはダンプされたEmacsでは空になる。)
</p><a id="idm84373200" class="indexterm"/><a id="idm84372432" class="indexterm"/><p>ダンプされた<code class="filename">emacs</code>実行可能形式(<em class="firstterm">純粋</em>なEmacsとも呼ばれる)が、インストールされるEmacsになります。変数<code class="literal">preloaded-file-list</code>には、ダンプ済みEmacsに事前ロードされるLispファイルのリストが格納されています。新たなオペレーティングシステムにEmacsをポートする際、そのOSがダンプを実装していなければ、Emacsは起動時に毎回<code class="filename">loadup.el</code>をロードしなければなりません。
</p><a id="idm84369360" class="indexterm"/><p><code class="filename">site-load.el</code>という名前のライブラリーを記述することにより、事前ロードするファイルを追加指定できます。追加するファイルを保持するための純粋なスペース<em class="replaceable"><code>n</code></em>バイトを追加するように、以下の定義
</p><pre class="screen">#define SITELOAD_PURESIZE_EXTRA <em class="replaceable"><code>n</code></em>
</pre><p>でEmacsをリビルドする必要があるでしょう。<code class="filename">src/puresize.h</code>を参考にしてください(十分大きくなるまで、20000▽ずつ増加させる)。しかし、追加ファイルの事前ロードの優位は、マシンの高速化により減少します。現代的なマシンでは、通常はお勧めしません。
</p><p><code class="filename">loadup.el</code>が<code class="filename">site-load.el</code>を読み込んだ後に<code class="literal">Snarf-documentation</code>を呼び出すことにより、それらが格納された場所のファイル<code class="filename">etc/DOC</code>内にある、プリミティブと事前ロードされる関数(と変数)のドキュメント文字列を探します(<a class="link" href="ch24s02.html#Definition-of-Snarf_002ddocumentation">Accessing Documentation</a>を参照)。
</p><a id="idm84362448" class="indexterm"/><a id="idm84361424" class="indexterm"/><p><code class="filename">site-init.el</code>という名前のライブラリー名に配置することにより、ダンプ直前に実行する他のLisp式を指定できます。このファイルは、ドキュメント文字列を見つけた後に実行されます。
</p><p>関数または変数の定義を事前ロードしたい場合には、それを行うために、3つの方法があります。それらにより定義ロードして、その後のEmacs実行時にドキュメント文字列をアクセス可能にします:
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="filename">etc/DOC</code>の生成時にそれらのファイルをスキャンするよう計らい、それらを<code class="filename">site-load.el</code>でロードする。
</p></li><li class="listitem"><p>ファイルを<code class="filename">site-init.el</code>でロードして、Emacsインストール時にLispファイルのインストール先ディレクトリーに、そのファイルをコピーする。
</p></li><li class="listitem"><p>それらの各ファイルで、ローカル変数として<code class="literal">byte-compile-dynamic-docstrings</code>に<code class="literal">nil</code>値を指定して、それらを<code class="filename">site-load.el</code>か<code class="filename">site-init.el</code>でロードする(この手法には、Emacsが毎回そのドキュメント文字列用のスペースを確保するという欠点がある)。
</p></li></ul></div><a id="idm84354384" class="indexterm"/><a id="idm84353104" class="indexterm"/><p>通常の未変更のEmacsでユーザーが期待する何らかの機能を変更するような何かを、<code class="filename">site-load.el</code>または<code class="filename">site-init.el</code>内に配置することはお勧めしません。あなたのサイトで通常の機能をオーバーライドしなければならないと感じた場合には、<code class="filename">default.el</code>でそれを行えば、ユーザーが望む場合にあなたの変更をオーバーライドできます。<a class="link" href="ch39.html#Startup-Summary" title="Summary: Sequence of Actions at Startup">Startup
Summary</a>を参照してください。<code class="filename">site-load.el</code>か<code class="filename">site-init.el</code>のいずれかが<code class="literal">load-path</code>を変更する場合、その変更はダンプ後に失われます。<a class="link" href="ch16s03.html" title="Library Search">Library
Search</a>を参照してください。<code class="literal">load-path</code>を永続的に変更するには、<span class="command"><strong>configure</strong></span>の<code class="option">--enable-locallisppath</code>オプションを指定してください。
</p><p>事前ロード可能なパッケージでは、その後のEmacsスタートアップまで、特定の評価を遅延させのが必要(または便利)なことがあります。そのようなケースの大半は、カスタマイズ可能な変数の値に関するものです。たとえば<code class="literal">tutorial-directory</code>は、事前ロードされる<code class="filename">startup.el</code>内で定義される変数です。これのデフォルト値は、<code class="literal">data-directory</code>にもとづいてセットされます。この変数はEmacsダンプ時ではなく、スタート時に<code class="literal">data-directory</code>の値を必要とします。なぜならEmacs実行可能形式はダンプされたものなので、恐らく異なる場所にインストールされます。
</p><pre class="synopsis"><a id="idm84343120" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">custom-initialize-delay</code> <em class="replaceable"><code>symbol</code></em> <em class="replaceable"><code>value</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、次回のEmacs開始まで<em class="replaceable"><code>symbol</code></em>の初期化を遅延する。通常は、カスタマイズ可能変数の<code class="literal">:initialize</code>プロパティとしてこの関数を指定することにより使用する(引数<em class="replaceable"><code>value</code></em>はフォームCustom由来の互換性のためだけに提供されており使用しない)。
</p></blockquote></div><p><code class="literal">custom-initialize-delay</code>が提供するより一般的な機能を要するような稀なケースでは、<code class="literal">before-init-hook</code>を使用できます(<a class="link" href="ch39.html#Startup-Summary" title="Summary: Sequence of Actions at Startup">Startup
Summary</a>を参照)。
</p><pre class="synopsis"><a id="idm84336464" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">dump-emacs</code> <em class="replaceable"><code>to-file</code></em> <em class="replaceable"><code>from-file</code></em></pre><div class="blockquote"><blockquote class="blockquote"><a id="idm84321232" class="indexterm"/><p>この関数は、Emacsのカレント状態を、実行可能ファイル<em class="replaceable"><code>to-file</code></em>にダンプする。これは<em class="replaceable"><code>from-file</code></em>(通常はファイル<code class="filename">temacs</code>)からシンボルを取得する。
</p><p>すでにダンプ済みのEmacs内でこの関数を使用する場合には、‘<code class="literal">-batch</code>’でEmacsを実行しなければならない。
</p></blockquote></div></div></div></body></html>