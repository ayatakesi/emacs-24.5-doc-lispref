<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Reading Text Strings with the Minibuffer</title><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"/></head><body><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="Text-from-Minibuffer"/>Reading Text Strings with the Minibuffer</h1></div></div></div><a id="idm58233296" class="indexterm"/><p>ミニバッファー入力にたいする基本的なプリミティブは<code class="literal">read-from-minibuffer</code>で、これは文字列とLispオブジェクトの両方からテキスト表現されたフォームを読み取ることができます。関数<code class="literal">read-regexp</code>は、特別な種類の文字列である正規表現式(<a class="link" href="ch34s03.html" title="Regular Expressions">Regular
Expressions</a>を参照)の読み取りに使用されます。コマンドや変数、ファイル名などの読み取りに特化した関数もあります(<a class="link" href="ch20s06.html" title="Completion">Completion</a>を参照)。
</p><p>ほとんどの場合では、Lisp関数の途中でミニバッファー入力関数を呼び出すべきではありません。かわりに<code class="literal">interactive</code>指定されたコマンドの引数読み取りの一部として、すべてのミニバッファー入力を行います。<a class="link" href="ch21s02.html" title="Defining Commands">Defining
Commands</a>を参照してください。
</p><pre class="synopsis"><a id="idm58228304" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">read-from-minibuffer</code> <em class="replaceable"><code>prompt</code></em> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>initial</code></em> <em class="replaceable"><code>keymap</code></em> <em class="replaceable"><code>read</code></em> <em class="replaceable"><code>history</code></em> <em class="replaceable"><code>default</code></em> <em class="replaceable"><code>inherit-input-method</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、ミニバッファーから入力を取得するもっとも一般的な手段である。デフォルトでは、任意のテキストを受け入れて、それを文字列としてリターンする。しかし、<em class="replaceable"><code>read</code></em>が非<code class="literal">nil</code>の場合は、テキストをLispオブジェクトに変換するために<code class="literal">read</code>を使用する(<a class="link" href="ch19s03.html" title="Input Functions">Input
Functions</a>を参照)。
</p><p>この関数が最初に行うのは、ミニバッファーをアクティブにして、プロンプトに<em class="replaceable"><code>prompt</code></em>(文字列でなければならない)を用いてミニバッファーを表示することである。その後に、ユーザーはミニバッファーでテキストを編集できる。
</p><p>ミニバッファーをexitするためにユーザーがコマンドをタイプするとき、<code class="literal">read-from-minibuffer</code>はミニバッファー内のテキストからリターン値を構築する。通常はそのテキストを含む文字列がリターンされる。しかし、<em class="replaceable"><code>read</code></em>が非<code class="literal">nil</code>の場合、<code class="literal">read-from-minibuffer</code>はテキストを読み込んで結果を未評価のLispオブジェクトでリターンする。(読み取りについての詳細は、See <a class="link" href="ch19s03.html" title="Input Functions">Input
Functions</a>を参照のこと。)
</p><p>引数<em class="replaceable"><code>default</code></em>は、ヒストリーコマンドを通じて利用できるデフォルト値を指定する。値には文字列、文字列リスト、または<code class="literal">nil</code>を指定する。文字列または文字列リストは、ユーザーが<strong class="userinput"><code>M-n</code></strong>で利用可能な“未来のヒストリー(future
history)”になります。
</p><p><em class="replaceable"><code>read</code></em>が非<code class="literal">nil</code>の場合は、ユーザーの入力が空のときの<code class="literal">read</code>の入力としても、<em class="replaceable"><code>default</code></em>が使用される。<em class="replaceable"><code>default</code></em>が文字列リストの!は、最初の文字列が入力として使用される。<em class="replaceable"><code>default</code></em>が<code class="literal">nil</code>の場合、空の入力は<code class="literal">end-of-file</code>エラーとなる。しかし通常(<em class="replaceable"><code>read</code></em>が<code class="literal">nil</code>)の場合には、ユーザーの入力が空のとき<code class="literal">read-from-minibuffer</code>は<em class="replaceable"><code>default</code></em>を無視して、空文字列<code class="literal">""</code>をリターンする。この点において、この関数はこのチャプターの他のどのミニバッファー入力関数とも異なる。
</p><p><em class="replaceable"><code>keymap</code></em>が非<code class="literal">nil</code>の場合、そのキーマップはミニバッファー内で使用されるローカルキーマップとなる。<em class="replaceable"><code>keymap</code></em>が省略、または<code class="literal">nil</code>の場合は、<code class="literal">minibuffer-local-map</code>の値がキーマップとして使用される。キーマップの指定は、補完のようなさまざまなアプリケーションにたいしてミニバッファーをカスタマイズする、もっとも重要な方法である。
</p><p>引数<em class="replaceable"><code>history</code></em>は、入力の保存やミニバッファー内で使用されるヒストリーコマンドが使用するヒストリーリスト変数を指定する。デフォルトは<code class="literal">minibuffer-history</code>である。同様に、オプションでヒストリーリスト内の開始位置を指定できる。<a class="link" href="ch20s04.html" title="Minibuffer History">Minibuffer
History</a>を参照のこと。
</p><p>変数<code class="literal">minibuffer-allow-text-properties</code>が非<code class="literal">nil</code>の場合には、リターンされる文字列にはミニバッファーでのすべてのテキストプロパティが含まれる。それ以外では、値がリターンされるときすべてのテキストプロパティが取り除かれる。
</p><p>引数<em class="replaceable"><code>inherit-input-method</code></em>が非<code class="literal">nil</code>の場合には、ミニバッファーにエンターする前にカレントだったバッファーが何であれ、カレントのインプットメソッド(<a class="link" href="ch33s11.html" title="Input Methods">Input
Methods</a>を参照)、および<code class="literal">enable-multibyte-characters</code>のセッティング(<a class="link" href="ch33.html#Text-Representations" title="Text Representations">Text
Representations</a>を参照)が継承される。
</p><p>ほとんどの場合、<em class="replaceable"><code>initial</code></em>の使用は推奨されない。非<code class="literal">nil</code>値の使用は、<em class="replaceable"><code>history</code></em>にたいするコンスセル指定と組み合わせる場合のみ推奨する。<a class="link" href="ch20s05.html" title="Initial Input">Initial
Input</a>を参照のこと。
</p></blockquote></div><pre class="synopsis"><a id="idm58194000" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">read-string</code> <em class="replaceable"><code>prompt</code></em> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>initial</code></em> <em class="replaceable"><code>history</code></em> <em class="replaceable"><code>default</code></em> <em class="replaceable"><code>inherit-input-method</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数はミニバッファーから文字列を読み取り、それをリターンする。引数<em class="replaceable"><code>prompt</code></em>、<em class="replaceable"><code>initial</code></em>、<em class="replaceable"><code>history</code></em>、<em class="replaceable"><code>inherit-input-method</code></em>は<code class="literal">read-from-minibuffer</code>で使用する場合と同様。使用されるキーマップは<code class="literal">minibuffer-local-map</code>である。
</p><p>オプション引数<em class="replaceable"><code>default</code></em>は<code class="literal">read-from-minibuffer</code>の場合と同様に使用されるが、ユーザーの入力が空の場合にリターンするデフォルト値も指定する。<code class="literal">read-from-minibuffer</code>の場合と同様、値は文字列、文字列リスト、または<code class="literal">nil</code>(空文字列と等価)である。<em class="replaceable"><code>default</code></em>が文字列のときは、その文字列がデフォルト値になる。文字列リストのときは、最初の文字列がデフォルト値になる。(これらの文字列はすべて“未来のミニバッファーヒストリー(future
minibuffer history)”としてユーザーが利用可能)。
</p><p>この関数は<code class="literal">read-from-minibuffer</code>を呼び出すことにより機能する。
</p><pre class="screen">(read-string <em class="replaceable"><code>prompt</code></em> <em class="replaceable"><code>initial</code></em> <em class="replaceable"><code>history</code></em> <em class="replaceable"><code>default</code></em> <em class="replaceable"><code>inherit</code></em>)
≡
(let ((value
       (read-from-minibuffer <em class="replaceable"><code>prompt</code></em> <em class="replaceable"><code>initial</code></em> nil nil
                             <em class="replaceable"><code>history</code></em> <em class="replaceable"><code>default</code></em> <em class="replaceable"><code>inherit</code></em>)))
  (if (and (equal value "") <em class="replaceable"><code>default</code></em>)
      (if (consp <em class="replaceable"><code>default</code></em>) (car <em class="replaceable"><code>default</code></em>) <em class="replaceable"><code>default</code></em>)
    value))
</pre></blockquote></div><pre class="synopsis"><a id="idm58176848" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">read-regexp</code> <em class="replaceable"><code>prompt</code></em> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>defaults</code></em> <em class="replaceable"><code>history</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数はミニバッファーから文字列として正規表現を読み取り、それをリターンする。ミニバッファーのプロンプト文字列<em class="replaceable"><code>prompt</code></em>が‘<code class="literal">:</code>’(とその後にオプションの空白文字)で終端されていない場合、この関数はデフォルトのリターン値(空文字列でない場合。以下参照)の前に‘<code class="literal">:
</code>’を付加する。
</p><p>オプション引数<em class="replaceable"><code>defaults</code></em>は、入力が空の場合にリターンするデフォルト値を制御する。値は文字列、<code class="literal">nil</code>(空文字列と等価)、文字列リスト、シンボルのうちのどれか。
</p><p><em class="replaceable"><code>defaults</code></em>がシンボルの場合、<code class="literal">read-regexp</code>は変数<code class="literal">read-regexp-defaults-function</code>(以下参照)の値を調べて非<code class="literal">nil</code>のときは、<em class="replaceable"><code>defaults</code></em>よりそちらを優先的に使用する。この場合、値は以下のいずれか:
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>− <code class="literal">regexp-history-last</code>。これは適切なミニバッファーヒストリーリスト(以下参照)の最初の要素を使用することを意味する。
</p></li><li class="listitem"><p>− 引数なしの関数。リターン値(<code class="literal">nil</code>、文字列、文字列リストのいずれか)が<em class="replaceable"><code>defaults</code></em>の値となる。
</p></li></ul></div><p>これで、<code class="literal">read-regexp</code>が<em class="replaceable"><code>defaults</code></em>を処理した結果はリストに確定する(値が<code class="literal">nil</code>または文字列の場合は1要素のリストに変換する)。このリストにたいし、<code class="literal">read-regexp</code>は、以下のような入力として有用な候補をいくつか追加する:
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>− ポイント位置の単語またはシンボル。
</p></li><li class="listitem"><p>− インクリメンタル検索で最後に使用されたregexp。
</p></li><li class="listitem"><p>− インクリメンタル検索で最後に使用された文字列。
</p></li><li class="listitem"><p>− 問い合わせつき置換コマンドで最後に使用された文字列またはパターン。
</p></li></ul></div><p>これで関数は、ユーザー入力を取得するために<code class="literal">read-from-minibuffer</code>に渡す正規表現のリストを得た。リストの最初の要素は入力が空の場合のデフォルト値である。リストのすべての要素は“未来のミニバッファーヒストリーリスト(future
minibuffer history list)” (see section “future list” in <em class="citetitle">The GNU Emacs Manual</em>を参照)としてユーザーが利用可能になる。
</p><p>オプション引数<em class="replaceable"><code>history</code></em>が非<code class="literal">nil</code>の場合、それは使用するミニバッファーヒストリーリストを指定するシンボルである(<a class="link" href="ch20s04.html" title="Minibuffer History">Minibuffer
History</a>を参照)。これが省略、または<code class="literal">nil</code>の場合、ヒストリーリストのデフォルトは<code class="literal">regexp-history</code>となる。
</p></blockquote></div><pre class="synopsis"><a id="idm58139856" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">read-regexp-defaults-function</code></pre><div class="blockquote"><blockquote class="blockquote"><p>関数<code class="literal">read-regexp</code>は、デフォルトの正規表現リストを決定するために、この変数の値を使用するかもしれない。非<code class="literal">nil</code>の場合、この変数は以下のいずれかである:
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>− シンボル<code class="literal">regexp-history-last</code>。
</p></li><li class="listitem"><p>− <code class="literal">nil</code>、文字列、文字列リストのいずれかをリターンする引数なしの関数。
</p></li></ul></div><p>これらの変数の使い方についての詳細は、上述の<code class="literal">read-regexp</code>を参照のこと。
</p></blockquote></div><pre class="synopsis"><a id="idm58133072" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">minibuffer-allow-text-properties</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この変数が<code class="literal">nil</code>の場合、<code class="literal">read-from-minibuffer</code>および<code class="literal">read-string</code>はミニバッファー入力をリターンする前に、すべてのテキストプロパティを取り除く。しかし<code class="literal">read-no-blanks-input</code>(以下参照)、同様に補完つきでミニバッファー入力を行う<code class="literal">read-minibuffer</code>およびそれに関連する関数(<a class="link" href="ch20s03.html" title="Reading Lisp Objects with the Minibuffer">Reading Lisp Objects With the
Minibuffer</a>を参照)は、この変数の値に関わらず、無条件でテキストプロパティを破棄する。
</p></blockquote></div><pre class="synopsis"><a id="idm58123088" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">minibuffer-local-map</code></pre><div class="blockquote"><blockquote class="blockquote"><a id="Definition-of-minibuffer_002dlocal_002dmap"/><p>これはミニバッファーからの読み取りにたいするデフォルトローカルキーマップである。デフォルトでは以下のバインディングをもつ:
</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><strong class="userinput"><code>C-j</code></strong>
</span></dt><dd><p><code class="literal">exit-minibuffer</code>
</p></dd><dt><span class="term"><span class="keycap"><strong>RET</strong></span>
</span></dt><dd><p><code class="literal">exit-minibuffer</code>
</p></dd><dt><span class="term"><strong class="userinput"><code>C-g</code></strong>
</span></dt><dd><p><code class="literal">abort-recursive-edit</code>
</p></dd><dt><span class="term"><strong class="userinput"><code>M-n</code></strong>
, </span><span class="term"><span class="keycap"><strong>DOWN</strong></span>
</span></dt><dd><p><code class="literal">next-history-element</code>
</p></dd><dt><span class="term"><strong class="userinput"><code>M-p</code></strong>
, </span><span class="term"><span class="keycap"><strong>UP</strong></span>
</span></dt><dd><p><code class="literal">previous-history-element</code>
</p></dd><dt><span class="term"><strong class="userinput"><code>M-s</code></strong>
</span></dt><dd><p><code class="literal">next-matching-history-element</code>
</p></dd><dt><span class="term"><strong class="userinput"><code>M-r</code></strong>
</span></dt><dd><p><code class="literal">previous-matching-history-element</code>
</p></dd></dl></div></blockquote></div><pre class="synopsis"><a id="idm58093904" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">read-no-blanks-input</code> <em class="replaceable"><code>prompt</code></em> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>initial</code></em> <em class="replaceable"><code>inherit-input-method</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数はミニバッファーから文字列を読み取るが、入力の一部として空白文字を認めず、かわりに空白文字は入力を終端させる。引数<em class="replaceable"><code>prompt</code></em>、<em class="replaceable"><code>initial</code></em>、<em class="replaceable"><code>inherit-input-method</code></em>は<code class="literal">read-from-minibuffer</code>で使用するときと同様。
</p><p>これは関数<code class="literal">read-from-minibuffer</code>の簡略化されたインターフェイスであり、キーマップ<code class="literal">minibuffer-local-ns-map</code>の値を<em class="replaceable"><code>keymap</code></em>引数として、<code class="literal">read-from-minibuffer</code>関数に渡す。キーマップ<code class="literal">minibuffer-local-ns-map</code>は<strong class="userinput"><code>C-q</code></strong>をリバインドしないので、クォートすることにより文字列内にスペースを挿入することが<span class="emphasis"><em>可能である</em></span>。
</p><p><code class="literal">minibuffer-allow-text-properties</code>の値に関わらず、この関数はテキストプロパティを破棄する。
</p><pre class="screen">(read-no-blanks-input <em class="replaceable"><code>prompt</code></em> <em class="replaceable"><code>initial</code></em>)
≡
(let (minibuffer-allow-text-properties)
  (read-from-minibuffer <em class="replaceable"><code>prompt</code></em> <em class="replaceable"><code>initial</code></em> minibuffer-local-ns-map))
</pre></blockquote></div><pre class="synopsis"><a id="idm58080720" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">minibuffer-local-ns-map</code></pre><div class="blockquote"><blockquote class="blockquote"><p>このビルトイン変数は関数<code class="literal">read-no-blanks-input</code>内でミニバッファーローカルキーマップとして使用されるキーマップである。デフォルトでは、<code class="literal">minibuffer-local-map</code>のバインディングに加えて、以下のバインディングが有効になる:
</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="keycap"><strong>SPC</strong></span>
</span></dt><dd><a id="idm58076240" class="indexterm"/><p><code class="literal">exit-minibuffer</code>
</p></dd><dt><span class="term"><span class="keycap"><strong>TAB</strong></span>
</span></dt><dd><a id="idm58073424" class="indexterm"/><p><code class="literal">exit-minibuffer</code>
</p></dd><dt><span class="term"><strong class="userinput"><code>?</code></strong>
</span></dt><dd><a id="idm58070608" class="indexterm"/><p><code class="literal">self-insert-and-exit</code>
</p></dd></dl></div></blockquote></div></div></body></html>