<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Information from the Command Loop</title><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"/></head><body><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="Command-Loop-Info"/>Information from the Command Loop</h1></div></div></div><a id="idm60676944" class="indexterm"/><p>エディターコマンドループは、自分自身と実行するコマンドのために、いくつかのLisp変数にステータス記録を保持します。<code class="literal">this-command</code>および<code class="literal">last-command</code>以外は、一般的にこれらの変数をLispプログラム内で変更するのは、良いアイデアではありません。
</p><pre class="synopsis"><a id="idm60674512" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">last-command</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この変数は、コマンドループにより実行された以前のコマンド(前にカレントだったコマンド)の名前を記録する。値は通常、関数定義をもつシンボルだが、その保証はない。
</p><p>コマンドがコマンドループからリターンするとき、<code class="literal">this-command</code>から値がコピーされる。ただしそのコマンドが、後続のコマンドにたいしてプレフィクス引数を指定されたときを除く。
</p><p>この変数は常にカレント端末にたいしてローカルであり、バッファーローカルにできない。<a class="link" href="ch29s02.html" title="Multiple Terminals">Multiple Terminals</a>を参照のこと。
</p></blockquote></div><pre class="synopsis"><a id="idm60669904" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">real-last-command</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この変数はEmacsにより<code class="literal">last-command</code>と同様にセットアップされるが、Lispプログラムから決して変更されない。
</p></blockquote></div><pre class="synopsis"><a id="idm60666704" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">last-repeatable-command</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この変数は、入力イベントと一部としではなく、もっとも最近実行されたコマンドを格納する。これはコマンド<code class="literal">repeat</code>が再実行を試みるコマンドである。section “Repeating” in <em class="citetitle">The GNU Emacs Manual</em>を参照のこと。
</p></blockquote></div><pre class="synopsis"><a id="idm60662992" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">this-command</code></pre><div class="blockquote"><blockquote class="blockquote"><a id="idm60660944" class="indexterm"/><p>この変数は、コマンドループにより現在実行中のコマンドの名前を記録する。<code class="literal">last-command</code>と同様、通常は関数定義をもつシンボルである。
</p><p>コマンドループはコマンドを実行する直前にこの変数をセットして、(そのコマンドが後続のコマンドのプレフィクス引数を指定しない場合)そのコマンドが終了したときに、その値を<code class="literal">last-command</code>内にコピーする。
</p><a id="idm60658384" class="indexterm"/><p>いくつかのコマンドは、次に実行されるコマンドが何であれ、それにたいするフラグとして、実行中の間この変数をセットする。特にテキストをkillする関数は<code class="literal">this-command</code>を<code class="literal">kill-region</code>にセットするので、直後に実行された任意のkillコマンドは、killしたテキストを前にkillされたテキストに追加すべきことが解かるだろう。
</p></blockquote></div><p>特定のコマンドにおいて、エラーが発生した場合に前のコマンドとして認識されたくない場合は、これを防ぐようにそのコマンドをコーディングしなければならない。これを行う1つの方法は、以下のようにコマンドの最初で<code class="literal">this-command</code>に<code class="literal">t</code>をセットして、最後に<code class="literal">this-command</code>に正しい値をセットする方法である:
</p><pre class="screen">(defun foo (args…)
  (interactive …)
  (let ((old-this-command this-command))
    (setq this-command t)
    … 処理を行う …
    (setq this-command old-this-command)))
</pre><p>エラーの場合、<code class="literal">let</code>は古い値をリストアするので、わたしたちは<code class="literal">let</code>で<code class="literal">this-command</code>をバインドしない。この場合における<code class="literal">let</code>の機能は、わたしたちが避けたいと思っていることを正確に行ってしまうだろう。
</p><pre class="synopsis"><a id="idm60650960" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">this-original-command</code></pre><div class="blockquote"><blockquote class="blockquote"><p>コマンドのリマップ(<a class="link" href="ch22s13.html" title="Remapping Commands">Remapping
Commands</a>を参照)が発生したときを除き、これは<code class="literal">this-command</code>と同じ値をもつ。リマップが発生した場合、<code class="literal">this-command</code>は実際に実行されたコマンド、<code class="literal">this-original-command</code>は実行を指定されたが他のコマンドにリマップされたコマンドを与える。
</p></blockquote></div><pre class="synopsis"><a id="idm60633936" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">this-command-keys</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、現在のコマンドを呼び出したキーシーケンスと、加えてそのコマンドにたいするプレフィクス引数を生成した前のコマンドを含む文字列またはベクターをリターンする。<code class="literal">read-event</code>を使用するコマンドにより、タイムアウトせずに読み取られた任意のイベントは最後に加えられる。
</p><p>しかし、そのコマンドが<code class="literal">read-key-sequence</code>を呼び出していた場合は、最後に読み取られたキーシーケンスをリターンする。<a class="link" href="ch21s08.html#Key-Sequence-Input" title="Key Sequence Input">Key
Sequence Input</a>を参照のこと。シーケンス内のすべてのイベントが文字列として適当な文字の場合は、文字列が値になる。<a class="link" href="ch21s07.html" title="Input Events">Input
Events</a>を参照のこと。
</p><pre class="screen">(this-command-keys)
;; これを評価するために<strong class="userinput"><code>C-u C-x C-e</code></strong>を使用すると、
     ⇒ "^U^X^E"
</pre></blockquote></div><pre class="synopsis"><a id="idm60627664" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">this-command-keys-vector</code></pre><div class="blockquote"><blockquote class="blockquote"><a id="Definition-of-this_002dcommand_002dkeys_002dvector"/><p><code class="literal">this-command-keys</code>と同様だが、常にベクターでイベントをリターンするので、入力イベントを文字列内に格納する複雑さを処理する必要がない(<a class="link" href="ch21s07.html#Strings-of-Events" title="Putting Keyboard Events in Strings">Strings
of Events</a>を参照)。
</p></blockquote></div><pre class="synopsis"><a id="idm60623696" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">clear-this-command-keys</code> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>keep-record</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、<code class="literal">this-command-keys</code>がリターンするイベントテーブルを空にする。<em class="replaceable"><code>keep-record</code></em>が<code class="literal">nil</code>の場合は、その後に関数<code class="literal">recent-keys</code>(<a class="link" href="ch39s12.html#Recording-Input" title="Recording Input">Recording
Input</a>)がリターンするレコードも空にする。これは特定のケースにおいて、パスワードを読み取った後、次のコマンドの一部として不用意にパスワードがエコーされるのを防ぐために有用である。
</p></blockquote></div><pre class="synopsis"><a id="idm60617680" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">last-nonmenu-event</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この変数はキーシーケンス(マウスメニューからのイベントは勘定しない)の一部として読み取られた最後の入力イベントを保持する。
</p><p>この変数の1つの使い方は、<code class="literal">x-popup-menu</code>にたいしてどこにメニューをポップアップすべきか告げる場合である。これは内部的に<code class="literal">y-or-n-p</code>(<a class="link" href="ch20s07.html" title="Yes-or-No Queries">Yes-or-No
Queries</a>を参照)にも使用されている。
</p></blockquote></div><pre class="synopsis"><a id="idm60612944" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">last-command-event</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この変数には、コマンドの一部としてコマンドループに読み取られた、最後の入力イベントがセットされる。この変数は主に、<code class="literal">self-insert-command</code>内でどの文字が挿入されたか判断するために使用されている。
</p><pre class="screen">last-command-event
;; これを評価するために<strong class="userinput"><code>C-u C-x C-e</code></strong>を使用すると、
     ⇒ 5
</pre><p><strong class="userinput"><code>C-e</code></strong>の<acronym class="acronym">ASCII</acronym>コードの5が値になる。
</p></blockquote></div><pre class="synopsis"><a id="idm60603472" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">last-event-frame</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この変数は、最後の入力イベントが送られたフレームを記録する。これは通常、そのイベントが生成されたときに選択されていたフレームだが、そのフレームの入力が他のフレームにリダイレクトされていた場合は、そのリダイレクトされていたフレームが値となる。<a class="link" href="ch29s09.html" title="Input Focus">Input
Focus</a>を参照のこと。
</p><p>最後のイベントがキーボードマクロ由来の場合、値は<code class="literal">macro</code>になる。
</p></blockquote></div></div></body></html>