<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 22. Major and Minor Modes</title><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="Modes"/>Chapter 22. Major and Minor Modes</h1></div></div></div><a id="idm61948752" class="indexterm"/><p><em class="firstterm">モード(mode)</em>とは、Emacsをカスタマイズする定義のセットであり、編集時にオン/オフを切り替えることができます。モードには2つの種類があります。<em class="firstterm">メジャーモード(major
modes)</em>とは、互いに排他なモードであり、特定の種類のテキストの編集にたいして使用されます。<em class="firstterm">マイナーモード(minor
modes)</em>とは、ユーザーが個別に有効にすることができる機能を提供します。
</p><p>このチャプターでは、メジャーモード、およびマイナーモードを記述する方法、モードラインにそれらを示す方法、そしてそれらのモードがユーザーが提供するフックを実行する方法について説明します。キーマップ(keymaps)や構文テーブル(syntax
tables)のような関連するトピックについては<a class="link" href="ch22.html" title="Chapter 21. Keymaps">Keymaps</a>および<a class="link" href="ch35.html" title="Chapter 34. Syntax Tables">Syntax Tables</a>を参照してください。
</p><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="Hooks"/>Hooks</h1></div></div></div><a id="idm61944144" class="indexterm"/><p><em class="firstterm">フック(hook)</em>とは、既存のプログラムから特定のタイミングで呼び出される関数(複数可)を格納することができる変数のことです。Emacsはカスタマイズ用にフックを提供します。ほとんどの場合は、initファイル内(<a class="link" href="ch39.html#Init-File" title="The Init File">Init
File</a>を参照)でフックをセットアップしますが、Lispプログラムもフックをセットできます。標準的なフック変数のリストは、<a class="link" href="aph.html" title="Appendix H. Standard Hooks">Standard
Hooks</a>を参照してください。
</p><a id="idm61941712" class="indexterm"/><p>Emacsのほとんどのフックは、<em class="firstterm">ノーマルフック(normal
hooks)</em>です。これらの変数は、引数なしで呼び出される、関数のリストを含んでいます。慣習により、フック名が‘<code class="literal">-hook</code>’で終わるフックは、そのフックがノーマルフックであることを意味します。わたしたちは、一貫した方法でフックを使用できるよう、すべてのフックが可能な限りノーマルフックとなるよう努力しています。
</p><p>すべてのメジャーモードコマンドは、初期化の最終ステップの1つとして、<em class="firstterm">モードフック(mode
hook)</em>と呼ばれるノーマルフックを実行するとみなされます。これにより、そのモードによりすでに作成されたバッファーローカル変数割り当てをオーバーライドすることにより、ユーザーがそのモードの動作をカスタマイズするのが簡単になります。ほとんどのマイナーモード関数も、最後にモードフックを実行します。しかし、フックは他のコンテキストでも使用されます。たとえばフック<code class="literal">suspend-hook</code>は、Emacsが自身をサスペンド(<a class="link" href="ch39s02.html#Suspending-Emacs" title="Suspending Emacs">Suspending
Emacs</a>を参照)する直前に実行されます。
</p><p>フックにフック関数を追加するには、<code class="literal">add-hook</code>(<a class="link" href="ch23.html#Setting-Hooks" title="Setting Hooks">Setting
Hooks</a>を参照)を呼び出す方法が推奨です。フック関数は、<code class="literal">funcall</code>(<a class="link" href="ch13.html#What-Is-a-Function" title="What Is a Function?">What Is a
Function</a>を参照)が受け入れる任意の種類の関数を指定できます。ほとんどのフック変数の初期値はvoidです。<code class="literal">add-hook</code>は、これを扱う方法を知っています。<code class="literal">add-hook</code>により、グローバルフック、またはバッファーローカルフックのどちらを追加することも可能です。
</p><a id="idm61934416" class="indexterm"/><p>フック変数の名前が‘<code class="literal">-hook</code>’で終わらない場合は、それが恐らく<em class="firstterm">アブノーマルフック(abnormal
hook)</em>であることを示しています。こええは、フック関数が引数とともに呼ぶ出されること、または何らかの方法により、そのリターン値が使用されることを意味します。その関数の呼び出し方は、フックのドキュメントに記載されています。アブノーマルフックとして関数を追加するために<code class="literal">add-hook</code>を使用できますが、その関数はフック呼び出しの慣習にしたがって記述しななければなりません。慣習により、アブノーマルフックの名前は‘<code class="literal">-functions</code>’で終わります。
</p><a id="idm61931344" class="indexterm"/><p>変数の名前が‘<code class="literal">-function</code>’で終わる場合、その値は関数のリストではなく単一の関数です。<code class="literal">add-hook</code>を、<span class="emphasis"><em>単一関数フック</em></span>のように修正して使用することはできないので、かわりに<code class="literal">add-function</code>を使用します(<a class="link" href="ch13s10.html" title="Advising Emacs Lisp Functions">Advising
Functions</a>を参照)。
</p><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="Running-Hooks"/>Running Hooks</h2></div></div></div><p>このセクションでは、ノーマルフックを実行するために使用される、<code class="literal">run-hooks</code>について説明します。また、さまざまな種類のアブノーマルフックを実行する関数についても説明します。
</p><pre class="synopsis"><a id="idm61925712" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">run-hooks</code> <em class="replaceable"><code>&amp;rest</code></em> <em class="replaceable"><code>hookvars</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、引数として1つ以上のノーマルフック変数名をとり、各フックを順に実行する。引数はそれぞれ、ノーマルフック変数であるようなシンボルであること。これらの引数は、指定された順に処理される。
</p><p>フック変数の値が非<code class="literal">nil</code>の場合、その値は関数のリストであること。<code class="literal">run-hooks</code>は、すべての関数を引数なしで1つずつ呼び出す。
</p><p>フック変数の値には、単一の関数(ラムダ式、またはシンボルの関数定義)も指定でき、その場合<code class="literal">run-hooks</code>はそれを喚び出す。しかし、この使い方は時代遅れである。
</p><p>フック変数がバッファーローカルな場合、グローバル変数のかわりにそのバッファーローカル変数が使用される。しかし、そのバッファーローカル変数が要素<code class="literal">t</code>を含む場合は、そのグローバルフック変数も同様に実行されるだろう。
</p></blockquote></div><pre class="synopsis"><a id="idm61914832" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">run-hook-with-args</code> <em class="replaceable"><code>hook</code></em> <em class="replaceable"><code>&amp;rest</code></em> <em class="replaceable"><code>args</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、<em class="replaceable"><code>hook</code></em>内のすべての関数に、1つの引数<em class="replaceable"><code>args</code></em>を渡して喚び出すことにより、アブノーマルフックを実行する。
</p></blockquote></div><pre class="synopsis"><a id="idm61910096" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">run-hook-with-args-until-failure</code> <em class="replaceable"><code>hook</code></em> <em class="replaceable"><code>&amp;rest</code></em> <em class="replaceable"><code>args</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、各フック関数を順に呼び出すことによりアブノーマルフック関数を実行し、それらのうち1つが<code class="literal">nil</code>をリターンして“失敗”したときは停止する。それぞれのフック関数は、引数に<em class="replaceable"><code>args</code></em>を渡される。この関数は、フック関数の1つが失敗して停止した場合は<code class="literal">nil</code>、それ以外は非<code class="literal">nil</code>値をリターンする。
</p></blockquote></div><pre class="synopsis"><a id="idm61904208" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">run-hook-with-args-until-success</code> <em class="replaceable"><code>hook</code></em> <em class="replaceable"><code>&amp;rest</code></em> <em class="replaceable"><code>args</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、各フック関数を順に呼び出すことによりアブノーマルフック関数を実行し、それらのうち1つが非<code class="literal">nil</code>値をリターンして“成功”したときは停止する。それぞれのフック関数は、引数に<em class="replaceable"><code>args</code></em>を渡される。この関数は、フック関数の1つが失敗して停止した場合はその値を、それ以外は<code class="literal">nil</code>をリターンする。
</p></blockquote></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="Setting-Hooks"/>Setting Hooks</h2></div></div></div><p>以下は、Lisp Interactionモードのときに、モードフックを使用してAuto Fillモードをオンに切り替える例です:
</p><pre class="screen">(add-hook 'lisp-interaction-mode-hook 'auto-fill-mode)
</pre><pre class="synopsis"><a id="idm61896784" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">add-hook</code> <em class="replaceable"><code>hook</code></em> <em class="replaceable"><code>function</code></em> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>append</code></em> <em class="replaceable"><code>local</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、フック変数に関数<em class="replaceable"><code>function</code></em>を追加する手軽な方法である。ノーマルフックと同じように、アブノーマルフックにたいしてもこの関数を使用できる。<em class="replaceable"><code>function</code></em>には、正しい数の引数を受け付ける任意のLisp関数を指定できる。たとえば、
</p><pre class="screen">(add-hook 'text-mode-hook 'my-text-hook-function)
</pre><p>は、<code class="literal">text-mode-hook</code>と呼ばれるフックに<code class="literal">my-text-hook-function</code>を追加する。
</p><p><em class="replaceable"><code>hook</code></em>内に<em class="replaceable"><code>function</code></em>がすでに存在する場合(比較には<code class="literal">equal</code>を使用)、<code class="literal">add-hook</code>は2回目の追加を行わない。
</p><p><em class="replaceable"><code>function</code></em>のプロパティ<code class="literal">permanent-local-hook</code>が非<code class="literal">nil</code>の場合、<code class="literal">kill-all-local-variables</code>(またはメジャーモードを変更しても)、そのフック変数のローカル値から関数を削除しない。
</p><p>ノーマルフックにたいして、フック関数は実行される順序に無関係であるようにデザインされるべきである。順序への依存は、トラブルを招く。とはいえ、その順序は予測可能である。通常、<em class="replaceable"><code>function</code></em>はフックリストの先頭に追加されるので、(他の<code class="literal">add-hook</code>呼び出しがなければ)それは最初に実行される。オプション引数<em class="replaceable"><code>append</code></em>が非<code class="literal">nil</code>の場合、新たなフック関数はフックリストの最後に追加され、実行されるのも最後になる。
</p><p><code class="literal">add-hook</code>は、<em class="replaceable"><code>hook</code></em>がvoidのとき、または値が単一の関数の場合、値を関数リストにセットまたは変更して、それらを扱うことができる。
</p><p><em class="replaceable"><code>local</code></em>が非<code class="literal">nil</code>の場合、それはグローバルフックリストではなくバッファーローカルフックリストに<em class="replaceable"><code>function</code></em>を追加する。これはフックをバッファーローカルにして、そのバッファーローカルな値に<code class="literal">t</code>を追加する。バッファーローカルな値への<code class="literal">t</code>の追加は、ローカル値と同じようにデフォルト値でもフック関数を実行するためのフラグである。
</p></blockquote></div><pre class="synopsis"><a id="idm61866576" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">remove-hook</code> <em class="replaceable"><code>hook</code></em> <em class="replaceable"><code>function</code></em> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>local</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、フック変数<em class="replaceable"><code>hook</code></em>から<em class="replaceable"><code>function</code></em>を削除する。これは、<code class="literal">equal</code>を使用して<em class="replaceable"><code>function</code></em>と<em class="replaceable"><code>hook</code></em>要素を比較するので、その比較はシンボルとラムダ式の両方で機能する。
</p><p><em class="replaceable"><code>local</code></em>が非<code class="literal">nil</code>の場合、それはグローバルフックリストではなく、バッファーローカルフックリストから<em class="replaceable"><code>function</code></em>を削除する。
</p></blockquote></div></div></div></div></body></html>