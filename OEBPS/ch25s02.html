<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Saving Buffers</title><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"/></head><body><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="Saving-Buffers"/>Saving Buffers</h1></div></div></div><a id="idm63622736" class="indexterm"/><p>Emacs内でファイルを編集とき、実際にはそのファイルをvisitしているバッファーにたいして編集を行っています。つまり、ファイルのコンテンツをバッファーにコピーして、編集しているのはそのコピーなのです。そのバッファーにを変更しても、バッファーを<em class="firstterm">保存(save)</em>するまでファイルは変更されません。保存とは、バッファーのコンテンツをファイルにコピーすることを意味します。
</p><pre class="synopsis"><a id="idm63620944" class="indexterm"/><span class="category"><span class="bold"><strong>Command</strong></span>:</span> <code class="function">save-buffer</code> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>backup-option</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、バッファーが最後にvisitされたとき、または保存されたときから変更されている場合は、カレントバッファーのコンテンツを、バッファーによりvisitされているファイルに保存し、変更されていなければ何も行わない。
</p><p><code class="literal">save-buffer</code>は、バックアップファイルの作成に責任を負う。通常、<em class="replaceable"><code>backup-option</code></em>は<code class="literal">nil</code>であり、<code class="literal">save-buffer</code>はファイルをvisit以降、それが最初の保存の場合のみバックアップファイルを作成する。<em class="replaceable"><code>backup-option</code></em>にたいする他の値は、別の条件によるバックアップファイル作成を要求する:
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>引数4は1つの<strong class="userinput"><code>C-u</code></strong>を、引数64は3つの<strong class="userinput"><code>C-u</code></strong>を示すので、<code class="literal">save-buffer</code>はバッファーの次回保存時にこのバージョンのファイルがバックアップされるようマークする。
</p></li><li class="listitem"><p>引数16は2つの<strong class="userinput"><code>C-u</code></strong>を、引数64は3つの<strong class="userinput"><code>C-u</code></strong>を示すので、<code class="literal">save-buffer</code>関数はそれを保存する前に、前バージョンのファイルを無条件にバックアップする。
</p></li><li class="listitem"><p>引数0は、無条件にバックアップファイルを何も<span class="emphasis"><em>作成しない</em></span>。
</p></li></ul></div></blockquote></div><pre class="synopsis"><a id="idm63609424" class="indexterm"/><span class="category"><span class="bold"><strong>Command</strong></span>:</span> <code class="function">save-some-buffers</code> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>save-silently-p</code></em> <em class="replaceable"><code>pred</code></em></pre><div class="blockquote"><blockquote class="blockquote"><a id="Definition-of-save_002dsome_002dbuffers"/><p>このコマンドは、ファイルをvisitしている変更されたバッファーのいくつかを保存する。これは通常、各バッファーごとにユーザーに確認を求める。しかし、<em class="replaceable"><code>save-silently-p</code></em>が非<code class="literal">nil</code>の場合は、ユーザーに質問せずにファイルをvisitしているすべてのバッファーを保存する。
</p><p>オプション引数<em class="replaceable"><code>pred</code></em>は、どのバッファーで確認を求めるか(または<em class="replaceable"><code>save-silently-p</code></em>が非<code class="literal">nil</code>の場合は、どのバッファーで確認せずに保存するか)を制御する。これが<code class="literal">nil</code>の場合、それはファイルをvisitしているバッファーにたいしてのみ確認を求めることを意味する。<code class="literal">t</code>の場合、それは、<code class="literal">buffer-offer-save</code>のバッファーローカル値が<code class="literal">nil</code>であるような、非ファイルバッファー以外の特定のバッファーの保存も提案することを意味する(<a class="link" href="ch27s10.html" title="Killing Buffers">Killing
Buffers</a>を参照)。ユーザーが、非ファイルバッファーの保存にたいして‘<code class="literal">yes</code>’と応えると、保存に使用するファイル名の指定を求める。<code class="literal">save-buffers-kill-emacs</code>関数は、<em class="replaceable"><code>pred</code></em>にたいして値<code class="literal">t</code>を渡す。
</p><p><em class="replaceable"><code>pred</code></em>が<code class="literal">t</code>と<code class="literal">nil</code>のどちらでもない場合、それは引数なしの関数であること。その関数は、そのバッファーの保存するを提案するか否かを決定するために、バッファーごとに呼び出されるだろう。これが特定のバッファーで非<code class="literal">nil</code>値をリターンした場合は、バッファーの保存を提案することを意味する。
</p></blockquote></div><pre class="synopsis"><a id="idm63579472" class="indexterm"/><span class="category"><span class="bold"><strong>Command</strong></span>:</span> <code class="function">write-file</code> <em class="replaceable"><code>filename</code></em> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>confirm</code></em></pre><div class="blockquote"><blockquote class="blockquote"><a id="Definition-of-write_002dfile"/><p>この関数は、カレントバッファーをファイル<em class="replaceable"><code>filename</code></em>に書き込み、バッファーがそのファイルをvisitしていることにして、未変更とマークする。次に<em class="replaceable"><code>filename</code></em>にもとづいてバッファー名をリネームする。バッファー名を一意にするため、必要なら‘<code class="literal">&lt;2&gt;</code>’のような文字列を付加する。処理のほとんどは、<code class="literal">set-visited-file-name</code>(<a class="link" href="ch27s04.html" title="Buffer File Name">Buffer
File Name</a>を参照)、および<code class="literal">save-buffer</code>を呼び出すことにより行われる。
</p><p><em class="replaceable"><code>confirm</code></em>が非<code class="literal">nil</code>の場合、それは既存のファイルを上書きする前に確認を求めることを意味する。ユーザーがプレフィックス引数を与えない場合、interactiveに確認が求められる。
</p><p><em class="replaceable"><code>filename</code></em>が既存のディレクトリーであったり、既存のディレクトリーへのシンボリックリンクの場合、<code class="literal">write-file</code>はディレクトリー<em class="replaceable"><code>filename</code></em>内でvisitされているファイルの名前を使用する。そのバッファーがファイルをvisitしていない場合は、かわりにバッファーの名前を使用する。
</p></blockquote></div><p>バッファーの保存により、複数のフックが実行される。これはフォーマット変換も処理する(<a class="link" href="ch25s12.html" title="File Format Conversion">Format Conversion</a>を参照)。
</p><pre class="synopsis"><a id="idm63568592" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">write-file-functions</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この変数の値は、バッファーをvisitされているファイルに書き出す前に呼び出される、関数のリストである。それらのうちのいずれかが非<code class="literal">nil</code>をリターンした場合、そのファイルは書き込み済みだと判断され、残りの関数は呼び出されないし、ファイルを書き込むための通常のコードも実行されない。
</p><p><code class="literal">write-file-functions</code>内の関数が非<code class="literal">nil</code>をリターンした場合、(それが適切であれば)その関数はファイルをバックアップする責任を負う。これを行うには、以下のコードを実行する:
</p><pre class="screen">(or buffer-backed-up (backup-buffer))
</pre><p><code class="literal">backup-buffer</code>によりリターンされるファイルモードの値を保存して、(もし非<code class="literal">nil</code>なら)書き込むファイルのモードビットをセットしたいと思うかもしれない。これは正に<code class="literal">save-buffer</code>が通常行うことである。<a class="link" href="ch26.html#Making-Backups" title="Making Backup Files">Making Backup Files</a>を参照のこと。
</p><p><code class="literal">write-file-functions</code>内のフック関数は、データのエンコード(が望ましければ)にも責任を負う。これらは適切なコーディングシステムと改行規則(<a class="link" href="ch33s10.html#Lisp-and-Coding-Systems" title="Coding Systems in Lisp">Lisp
and Coding Systems</a>を参照)を選択してエンコード(<a class="link" href="ch33s10.html#Explicit-Encoding" title="Explicit Encoding and Decoding">Explicit
Encoding</a>を参照)を処理し、使用されていたコーディングシステム(<a class="link" href="ch33s10.html#Encoding-and-I_002fO" title="Encoding and I/O">Encoding and
I/O</a>を参照)を<code class="literal">last-coding-system-used</code>にセットしなければならない。
</p><p>バッファー内でこのフックをローカルにセットした場合、バッファーはそのファイル、またはバッファーのコンテンツを取得したファイルに類するものに関連付けられる。このようにして、変数は恒久的にローカルであるとマークされるので、メジャーモードの変更がバッファーローカルな値を変更することはない。その一方で、<code class="literal">set-visited-file-name</code>を呼び出すことにより、変数はリセットされるだろう。これを望まない場合は、かわりに<code class="literal">write-contents-functions</code>を使用したいと思うだろう。
</p><p>たとえこれがノーマルフックでないとしても、このリストを操作するために<code class="literal">add-hook</code>および<code class="literal">remove-hook</code>を使用することはできる。<a class="link" href="ch23.html#Hooks" title="Hooks">Hooks</a>を参照のこと。
</p></blockquote></div><pre class="synopsis"><a id="idm63554640" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">write-contents-functions</code></pre><div class="blockquote"><blockquote class="blockquote"><p>これは正に<code class="literal">write-file-functions</code>と同様に機能するが、こちらはvisitしている特定のファイルやファイルの場所ではなく、バッファーのコンテンツに関連するフックを意図している。そのようなフックは、この変数にたいするバッファーローカルなバインディングとして、通常はメジャーモードにより作成される。この変数は、セットされた際は、常に自動的にバッファーローカルになる。新たなメジャーモードへの切り替えは、常にこの変数をリセットするが、<code class="literal">set-visited-file-name</code>の呼び出しではリセットされない。
</p><p>このフック内の関数のいずれかが非<code class="literal">nil</code>をリターンした場合、そのファイルはすでに書き込み済みとみなされ、残りの関数は呼び出されず、<code class="literal">write-file-functions</code>内の関数も呼び出されない。
</p></blockquote></div><pre class="synopsis"><a id="idm63537232" class="indexterm"/><span class="category"><span class="bold"><strong>User Option</strong></span>:</span> <code class="varname">before-save-hook</code></pre><div class="blockquote"><blockquote class="blockquote"><p>このノーマルフックは、visitしているファイルにバッファーが保存される前に実行される。保存が通常の方法で行われるか、あるいは上述のフックのいずれかで行われたかは問題にしない。たとえば、<code class="filename">copyright.el</code>プログラムは、ファイルの保存において、それの著作権表示が今年であることを確認するために、このフックを使用する。
</p></blockquote></div><pre class="synopsis"><a id="idm63533776" class="indexterm"/><span class="category"><span class="bold"><strong>User Option</strong></span>:</span> <code class="varname">after-save-hook</code></pre><div class="blockquote"><blockquote class="blockquote"><p>このノーマルフックは、visitしているファイルにバッファーを保存した後に実行される。このフックの使用例の1つは、Fast
Lockモードにある。このモードは、キャッシュファイルにハイライト情報を保存するために、このフックを使用している。
</p></blockquote></div><pre class="synopsis"><a id="idm63531088" class="indexterm"/><span class="category"><span class="bold"><strong>User Option</strong></span>:</span> <code class="varname">file-precious-flag</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この変数が非<code class="literal">nil</code>の場合、<code class="literal">save-buffer</code>は保存ファイルがもつ名前のかわりに、一時的な名前で新たなファイルに書き込み、エラーがないと明確になった後にファイルを意図する名前にリネームすることにより、保存中のI/Oエラーから防御する。この手順は、無効なファイルが原因となるディスク容量逼迫のような問題を防ぐ。
</p><p>副作用として、バックアップ作成にコピーが必要になる。<a class="link" href="ch26.html#Rename-or-Copy" title="Backup by Renaming or by Copying?">Rename or
Copy</a>を参照のこと。しかし同時に、この高価なファイル保存により、保存したファイルと他のファイル名との間のすべてのハードリンクは切断される。
</p><p>いくつかのモードは、特定のバッファーにおいて、この変数に非<code class="literal">nil</code>のバッファーローカル値を与える。
</p></blockquote></div><pre class="synopsis"><a id="idm63525584" class="indexterm"/><span class="category"><span class="bold"><strong>User Option</strong></span>:</span> <code class="varname">require-final-newline</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この変数は、ファイルが改行で<span class="emphasis"><em>終わらない</em></span>ように書き込まれるかどうかを決定する。変数の値が<code class="literal">t</code>の場合、<code class="literal">save-buffer</code>はバッファーの終端に改行がなければ暗黙理に改行を追加する。値が<code class="literal">visit</code>の場合、Emacsはファイルをvisitした直後に不足している改行を追加する。値が<code class="literal">visit-save</code>の場合、Emacsはvisitと保存の両方のタイミングで、不足している改行を追加する。その他の非<code class="literal">nil</code>値にたいしては、そのようなケースが生じるたびに、改行を追加するかどうか、<code class="literal">save-buffer</code>がユーザーに尋ねる。
</p><p>変数の値が<code class="literal">nil</code>の場合、<code class="literal">save-buffer</code>は改行を追加しない。デフォルト値は<code class="literal">nil</code>だが、特定のバッファーでこれを<code class="literal">t</code>にセットするメジャーモードも少数存在する。
</p></blockquote></div><p><a class="link" href="ch27s04.html" title="Buffer File Name">Buffer File Name</a>の関数<code class="literal">set-visited-file-name</code>も参照されたい。
</p></div></body></html>