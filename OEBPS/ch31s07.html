<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>The Mark</title><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"/></head><body><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="The-Mark"/>The Mark</h1></div></div></div><a id="idm73081552" class="indexterm"/><p>バッファーはそれぞれ、<em class="firstterm">マーク(mark)</em>という、バッファー専用の特別なマーカーをもちますバッファーが新たに作成される際、すでにこのマーカーは存在していますが、どこも指していません。これは、そのバッファーにはまだマークが“存在しない”ことを意味します。それ以降のコマンドがマークをセットできます。
</p><p>マークは、<code class="literal">kill-region</code>や<code class="literal">indent-rigidly</code>のような多くのコマンドにたいして、テキスト範囲をバインドするための位置を指定します。通常これらのコマンドは、ポイントとマークの間の、<em class="firstterm">リージョン(region)</em>と呼ばれるテキストに作用します。リージョンを操作するコマンドを記述する場合は、マークを直接調べず、かわりに‘<code class="literal">r</code>’指定とともに<code class="literal">interactive</code>を使用してください。このようにすれば、インタラクティブな呼び出しではコマンドの引数としてポイントとマークの値が提供され、かつ他のLispプログラムは引数を明示的に指定できます。<a class="link" href="ch21s02.html#Interactive-Codes" title="Code Characters for interactive">Interactive
Codes</a>を参照してください。
</p><p>いくつかのコマンドは、その副作用(side-effect)としてマークをセットします。コマンドは、ユーザーがそれを使用する可能性がある場合のみマークをセットするべきであり、決してコマンドの内部的な目的にたいして使用してはなりません。たとえば<code class="literal">replace-regexp</code>コマンドは、何らかの置換を行う前にマークにポイントの値をセットしますが、その理由はこれによりユーザーが置換を終えた後、簡単にその位置に戻ることが可能になるからです。
</p><p>一度バッファー内にマークが“存在”すれば、その存在は通常は決して消えることはありません。しかし、Transient
Markモードが有効な場合、マークが<em class="firstterm">非アクティブ(inactive)</em>になることはあります。バッファーローカル変数<code class="literal">mark-active</code>が非<code class="literal">nil</code>なら、それはマークがアクティブであることを意味します。コマンドはマークを直接非アクティブにするために関数<code class="literal">deactivate-mark</code>を呼び出すことができ、変数<code class="literal">deactivate-mark</code>を非<code class="literal">nil</code>値にセットすることにより、エディターコマンドループ(editor
command loop)にリターン時にマークの非アクティブ化を要求できます。
</p><p>Transient
Markモードが有効な場合、通常ならポイント近傍に適用される特定の編集コマンドは、マークがアクティブなときはかわりにリージョンに適用されます。これがTransient
Markモードを使用する主な動機です(他にも、マークアクティブ時にはリージョンのハイライトが有効になるという理由もある。<a class="link" href="ch38.html" title="Chapter 37. Emacs Display">Display</a>を参照されたい)。
</p><a id="idm73050832" class="indexterm"/><p>マークに加えて、バッファーはそれぞれ<em class="firstterm">マークリング(mark
ring)</em>をもっています。これは、以前のマーク値を含むマーカーのリストです。編集コマンドがマークを変更する際、それらのコマンドは通常はマークの旧値をマークリングに保存するべきです。変数<code class="literal">mark-ring-max</code>は、マークリング内のエントリー最大数を指定します。リストがこの長さに達すると、最後の要素を削除して、新たな要素が追加されます。
</p><p>これとは別にグローバルマークリング(global mark
ring)がありますが、それは少数の特定のユーザーレベルコマンドでのみ使用され、Lispプログラムとは関連しないので、ここでは説明しません。
</p><pre class="synopsis"><a id="idm73027664" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">mark</code> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>force</code></em></pre><div class="blockquote"><blockquote class="blockquote"><a id="idm73024720" class="indexterm"/><p>この関数は、カレントバッファーのマーク位置を整数でリターンする。そのバッファー内でそれまでマークがセットされていなければ<code class="literal">nil</code>をリターンする。
</p><p>Transient
Markモードが有効、かつ<code class="literal">mark-even-if-inactive</code>が<code class="literal">nil</code>の場合、マークが非アクティブなら<code class="literal">mark</code>はエラーをシグナルする。しかし、<em class="replaceable"><code>force</code></em>が非<code class="literal">nil</code>なら、<code class="literal">mark</code>はマークの非アクティブ性を無視して、何にせよマーク位置(か<code class="literal">nil</code>)をリターンする。
</p></blockquote></div><pre class="synopsis"><a id="idm73018960" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">mark-marker</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、カレントバッファーのマークを表すマーカーをリターンする。これはコピーではなく、内部的に使用されるマーカーである。したがって、このマーカー位置にたいする変更は、そのバッファーのマークに直接影響する。それが望む効果でなければ、これを行ってはならない。
</p><pre class="screen">(setq m (mark-marker))
     ⇒ #&lt;marker at 3420 in markers.texi&gt;
</pre><pre class="screen">(set-marker m 100)
     ⇒ #&lt;marker at 100 in markers.texi&gt;
</pre><pre class="screen">(mark-marker)
     ⇒ #&lt;marker at 100 in markers.texi&gt;
</pre><p>他のマーカー同様、このマーカーを任意のバッファー位置にセットできる。このマーカーに、これがマークする以外のバッファーを指すようにすると、完全に整合性があるものの、いささか奇妙な結果を得ることになるだろう。これを行わないことを、わたしたちは推奨する!
</p></blockquote></div><pre class="synopsis"><a id="idm73014480" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">set-mark</code> <em class="replaceable"><code>position</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、マークを<em class="replaceable"><code>position</code></em>にセットして、そのマークをアクティブにする。マークの旧値はマークリングに<span class="emphasis"><em>pushされない</em></span>。
</p><p><span class="bold"><strong>注意:</strong></span>
マークが移動したことをユーザーに確認させ、かつ前のマーク位置が失われることを望む場合のみ、この関数を使用すること。通常は、マークセット時に古いマークは<code class="literal">mark-ring</code>にpushされるべきである。この理由により、ほとんどのアプリケーションは<code class="literal">set-mark</code>ではなく、<code class="literal">push-mark</code>および<code class="literal">pop-mark</code>を使用するべきである。
</p><p>Emacs
Lispの初心者プログラマーは、誤った用途にマークの使用を試みがちである。ユーザーの利便のために位置を保存するのがマークである。編集コマンドは、マーク変更がコマンドのユーザーレベル機能の一部でない限り、マークを変更するべきではない(そして、そのような場合にはその効果をドキュメントするべきである)。Lispプログラムの内部的な使用のために位置を記憶するためには、マークをLisp変数に格納すること。たとえば:
</p><pre class="screen">(let ((beg (point)))
  (forward-line 1)
  (delete-region beg (point)))
</pre></blockquote></div><pre class="synopsis"><a id="idm72994512" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">push-mark</code> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>position</code></em> <em class="replaceable"><code>nomsg</code></em> <em class="replaceable"><code>activate</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、カレントバッファーのマークを<em class="replaceable"><code>position</code></em>にセットして、前のマークを<code class="literal">mark-ring</code>にpushする。<em class="replaceable"><code>position</code></em>が<code class="literal">nil</code>の場合は、ポイントの値を使用する。
</p><p>関数<code class="literal">push-mark</code>は通常、マークをアクティブに<span class="emphasis"><em>しない</em></span>。アクティブにする場合は、引数<em class="replaceable"><code>activate</code></em>に<code class="literal">t</code>を指定する。
</p><p><em class="replaceable"><code>nomsg</code></em>が<code class="literal">nil</code>なら、メッセージ‘<code class="literal">Mark set</code>’が表示される。
</p></blockquote></div><pre class="synopsis"><a id="idm72984016" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">pop-mark</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、<code class="literal">mark-ring</code>のトップ要素をpopして、そのマークをバッファーの実際のマークにする。これはバッファー内のポイントを移動せず、<code class="literal">mark-ring</code>が空なら何も行わない。これはマークを非アクティブ化する。
</p></blockquote></div><pre class="synopsis"><a id="idm72979408" class="indexterm"/><span class="category"><span class="bold"><strong>User Option</strong></span>:</span> <code class="varname">transient-mark-mode</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この変数が非<code class="literal">nil</code>なら、Transient Markモードを有効にする。Transient
Markモードでは、すべてのバッファー変更プリミティブが<code class="literal">deactivate-mark</code>をセットする。結果として、バッファーを変更するほとんどのコマンドも、マークを非アクティブにする。
</p><p>Transient
Markモードが有効かつマークがアクティブの場合、通常はポイント近傍に適用されるコマンドの多くは、かわりにリージョンに適用される。そのようなコマンドは、リージョンを処理すべきかどうかをテストするために、関数<code class="literal">use-region-p</code>を使用するべきである。<a class="link" href="ch31s08.html" title="The Region">The
Region</a>を参照のこと。
</p><p>Lispプログラムは、一時的にTransient
Markモードを有効にするために、<code class="literal">transient-mark-mode</code>を<code class="literal">nil</code>でも<code class="literal">t</code>でもない値にセットできる。値が<code class="literal">lambda</code>なら、バッファー変更のような通常ならマークを非アクティブ化するような操作の後、Transient
Markモードを自動的にオフに切り替える。値が<code class="literal">(only
. <em class="replaceable"><code>oldval</code></em>)</code>なら、後続のコマンドがポイントを移動かつシフト変換(<a class="link" href="ch21s08.html#Key-Sequence-Input" title="Key Sequence Input">shift-translation</a>を参照)されていない場合、あるいは通常はマークを非アクティブにするその他の操作の場合は、<code class="literal">transient-mark-mode</code>に値<em class="replaceable"><code>oldval</code></em>をセットする。
</p></blockquote></div><pre class="synopsis"><a id="idm72969424" class="indexterm"/><span class="category"><span class="bold"><strong>User Option</strong></span>:</span> <code class="varname">mark-even-if-inactive</code></pre><div class="blockquote"><blockquote class="blockquote"><p>これが非<code class="literal">nil</code>なら、LispプログラムおよびEmacsユーザーは、たとえ非アクティブでもマークを使用できる。このオプションは、Transient
Markモードの動作に影響を及ぼす。このオプションが非<code class="literal">nil</code>なら、マークの非アクティブ化によりリージョンのハイライトはオフに切り替えられるが、マークを使用するコマンドは、あたかもマークがアクティブであるかのように振る舞う。
</p></blockquote></div><pre class="synopsis"><a id="idm72965712" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">deactivate-mark</code></pre><div class="blockquote"><blockquote class="blockquote"><p>エディターコマンドがこの変数を非<code class="literal">nil</code>にセットすると、エディターコマンドループはコマンドのリターン後に、(Transient
Markモードが有効なら)マークを非アクティブにする。バッファーを変更するすべてのプリミティブは、コマンド終了時にマークを非アクティブにするために、<code class="literal">deactivate-mark</code>をセットする。
</p><p>コマンド終了時にマークを非アクティブにすることなくバッファーを変更するLispコードを記述するためには、変更を行うコードの周辺で<code class="literal">deactivate-mark</code>を<code class="literal">nil</code>にバインドすること。たとえば:
</p><pre class="screen">(let (deactivate-mark)
  (insert " "))
</pre></blockquote></div><pre class="synopsis"><a id="idm72960080" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">deactivate-mark</code> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>force</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>Transient
Markモードが有効、または<em class="replaceable"><code>force</code></em>が非<code class="literal">nil</code>の場合、この関数はマークを非アクティブにしてノーマルフック<code class="literal">deactivate-mark-hook</code>を実行し、それ以外は何も行わない。
</p></blockquote></div><pre class="synopsis"><a id="idm72955088" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">mark-active</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この変数が非<code class="literal">nil</code>なら、マークはアクティブである。この変数は、それぞれのバッファーにたいして、常にローカルである。通常はポイント近傍を操作するコマンドが、かわりにリージョンを操作すべきかどうかを判断するために、この変数の値を<span class="emphasis"><em>使用してはならない</em></span>。その目的にたいしては、関数<code class="literal">use-region-p</code>を使用すること(<a class="link" href="ch31s08.html" title="The Region">The
Region</a>を参照)。
</p></blockquote></div><pre class="synopsis"><a id="idm72950480" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">activate-mark-hook</code></pre><pre class="synopsis"><a id="idm72948304" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">deactivate-mark-hook</code></pre><div class="blockquote"><blockquote class="blockquote"><p>これらのノーマルフックは、マークがアクティブまたは非アクティブになった際に、順次実行される。マークがアクティブで、かつリージョンが変更された可能性があるなら、コマンドループの最後にフック<code class="literal">activate-mark-hook</code>も実行される。
</p></blockquote></div><pre class="synopsis"><a id="idm72945104" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">handle-shift-selection</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、ポイント移動コマンドの“シフト選択(shift-selection)”の動作を実装する。section “Shift Selection” in <em class="citetitle">The GNU Emacs
Manual</em>を参照のこと。これは、<code class="literal">interactive</code>指定に文字‘<code class="literal">^</code>’を含むコマンド呼び出し時は常に、そのコマンド自身を実行する前に、Emacsコマンドループにより自動的に呼び出される(<a class="link" href="ch21s02.html#Interactive-Codes" title="Code Characters for interactive">^</a>を参照)。
</p><p><code class="literal">shift-select-mode</code>が非<code class="literal">nil</code>、かつカレントコマンドがシフト変換(<a class="link" href="ch21s08.html#Key-Sequence-Input" title="Key Sequence Input">shift-translation</a>を参照)を通じて呼び出された場合、この関数はマークをセットして一時的にリージョンをアクティブにする(すでにこの方法によりリージョンが一時的にアクティブにされている場合を除く)。それ以外では、リージョンが一時的にアクティブにされていれば、マークを非アクティブにして、変数<code class="literal">transient-mark-mode</code>に前の値をリストアする。
</p></blockquote></div><pre class="synopsis"><a id="idm72938064" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">mark-ring</code></pre><div class="blockquote"><blockquote class="blockquote"><p>このバッファーローカル変数の値は、もっとも最近のものが先頭となった、カレントバッファーの以前に保存されたマークのリストである。
</p><pre class="screen">mark-ring
⇒ (#&lt;marker at 11050 in markers.texi&gt;
    #&lt;marker at 10832 in markers.texi&gt;
    …)
</pre></blockquote></div><pre class="synopsis"><a id="idm72934736" class="indexterm"/><span class="category"><span class="bold"><strong>User Option</strong></span>:</span> <code class="varname">mark-ring-max</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この変数の値は、<code class="literal">mark-ring</code>の最大サイズである。これより多くのマークが<code class="literal">mark-ring</code>にpushされると、新たなマーク追加時に<code class="literal">push-mark</code>は古いマークを破棄する。
</p></blockquote></div></div></body></html>