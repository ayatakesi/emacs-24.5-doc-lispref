<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Undo</title><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"/></head><body><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="Undo"/>Undo</h1></div></div></div><a id="idm72224976" class="indexterm"/><p>ほとんどのバッファーは、バッファーのテキストにたいして行われた変更をundoできるように、すべての変更を記録する<em class="firstterm">undoリスト(undo
list)</em>をもちます(undoリストをもたないバッファーとは通常、Emacsがundoを有用とみなさない特殊用途のバッファーである。特に、名前がスペースで始まるバッファーはすべて、undo記録がデフォルトでオフになっている。<a class="link" href="ch27s03.html" title="Buffer Names">Buffer
Names</a>を参照されたい)。バッファー内でテキストを変更するすべてのプリミティブは、undoリストの先頭に自動的に要素を追加し、それは変数<code class="literal">buffer-undo-list</code>に格納されます。
</p><pre class="synopsis"><a id="idm72222160" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">buffer-undo-list</code></pre><div class="blockquote"><blockquote class="blockquote"><p>このバッファーローカル変数の値は、カレントバッファーのundoリストである。値が<code class="literal">t</code>なら、undo情報の記録を無効にする。
</p></blockquote></div><p>以下は、undoリストが保有可能な要素の種類です:
</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal"><em class="replaceable"><code>position</code></em></code>
</span></dt><dd><p>この種の要素は、前のポイント値を記録する。この要素をundoすることにより、ポイントは<em class="replaceable"><code>position</code></em>に移動する。通常のカーソル移動はどのような類のundo記録も作成しないが、削除操作はそのコマンド以前にポイントがあった場所を記録するために、このエントリーを使用する。
</p></dd><dt><span class="term"><code class="literal">(<em class="replaceable"><code>beg</code></em> . <em class="replaceable"><code>end</code></em>)</code>
</span></dt><dd><p>この種の要素は、挿入されたテキストを削除する方法を示す。挿入において、そのテキストはバッファー内の範囲<em class="replaceable"><code>beg</code></em>から<em class="replaceable"><code>end</code></em>を占める。
</p></dd><dt><span class="term"><code class="literal">(<em class="replaceable"><code>text</code></em> . <em class="replaceable"><code>position</code></em>)</code>
</span></dt><dd><p>この種の要素は、削除されたテキストを再度挿入する方法を示す。文字列<em class="replaceable"><code>text</code></em>は、削除されたテキストそのものである。削除されたテキストを再挿入する位置は<code class="literal">(abs
<em class="replaceable"><code>position</code></em>)</code>である。<em class="replaceable"><code>position</code></em>が正ならポイントがあったのは削除されたテキストの先頭、それ以外では末尾である。0個以上の(<em class="replaceable"><code>marker</code></em>
. <em class="replaceable"><code>adjustment</code></em>)要素が、この要素の直後に続く。
</p></dd><dt><span class="term"><code class="literal">(t . <em class="replaceable"><code>time-flag</code></em>)</code>
</span></dt><dd><p>この種の要素は、未変更のバッファーが変更されたことを示す。<code class="literal">(<em class="replaceable"><code>sec-high</code></em> <em class="replaceable"><code>sec-low</code></em>
<em class="replaceable"><code>microsec</code></em>
<em class="replaceable"><code>picosec</code></em>)</code>という形式の<em class="replaceable"><code>time-flag</code></em>は、visitされたファイルにたいして、それが以前にvisitまたは保存されたときの更新時刻(modification
time)を、<code class="literal">current-time</code>と同じ形式を用いて表す。<a class="link" href="ch39s05.html" title="Time of Day">Time of
Day</a>を参照のこと。<em class="replaceable"><code>time-flag</code></em>が0ならそのバッファーに対応するファイルがないことを、−1ならvisitされたファイルは以前は存在しなかったことを意味する。<code class="literal">primitive-undo</code>は、バッファーを再度未変更とマークするかどうかを判断するために、これらの値を使用(ファイルの状態が<em class="replaceable"><code>time-flag</code></em>のそれとマッチする場合のみ未変更とマーク)する。
</p></dd><dt><span class="term"><code class="literal">(nil <em class="replaceable"><code>property</code></em> <em class="replaceable"><code>value</code></em> <em class="replaceable"><code>beg</code></em> . <em class="replaceable"><code>end</code></em>)</code>
</span></dt><dd><p>この種の要素は、テキストプロパティの変更を記録する。変更をundoする方法は、以下のようになる:
</p><pre class="screen">(put-text-property <em class="replaceable"><code>beg</code></em> <em class="replaceable"><code>end</code></em> <em class="replaceable"><code>property</code></em> <em class="replaceable"><code>value</code></em>)
</pre></dd><dt><span class="term"><code class="literal">(<em class="replaceable"><code>marker</code></em> . <em class="replaceable"><code>adjustment</code></em>)</code>
</span></dt><dd><p>この種の要素は、マーカー<em class="replaceable"><code>marker</code></em>がそれを取り囲むテキストの削除により再配置されて、<em class="replaceable"><code>adjustment</code></em>文字位置を移動したということを記録する。undoリスト内の前にある要素(<em class="replaceable"><code>text</code></em>
. <em class="replaceable"><code>position</code></em>)とマーカーの位置が一致する場合、は、この要素をundoすることにより、<em class="replaceable"><code>marker</code></em> −
<em class="replaceable"><code>adjustment</code></em>文字移動する。
</p></dd><dt><span class="term"><code class="literal">(apply <em class="replaceable"><code>funname</code></em> . <em class="replaceable"><code>args</code></em>)</code>
</span></dt><dd><p>これは拡張可能なundoアイテムであり、引数<em class="replaceable"><code>args</code></em>とともに<em class="replaceable"><code>funname</code></em>を呼び出すことによりundoが行われる。
</p></dd><dt><span class="term"><code class="literal">(apply <em class="replaceable"><code>delta</code></em> <em class="replaceable"><code>beg</code></em> <em class="replaceable"><code>end</code></em> <em class="replaceable"><code>funname</code></em> . <em class="replaceable"><code>args</code></em>)</code>
</span></dt><dd><p>これは拡張可能なundoアイテムであり、<em class="replaceable"><code>beg</code></em>から<em class="replaceable"><code>end</code></em>までに限定された範囲にたいして、そのバッファーのサイズを<em class="replaceable"><code>delta</code></em>文字増加させる変更を記録する。これは、引数<em class="replaceable"><code>args</code></em>とともに<em class="replaceable"><code>funname</code></em>を呼び出すことによりundoが行われる。
</p><p>この種の要素は、それがリージョンと関係するか否かを判断することにより、リージョンに限定されたundoを有効にする。
</p></dd><dt><span class="term"><code class="literal">nil</code>
</span></dt><dd><p>この要素は境界(boundary)である。2つの境界の間にある要素を<em class="firstterm">変更グループ(change
group)</em>と呼び、それぞれの変更グループは通常1つのキーボードコマンドに対応するとともに、undoコマンドは通常、グループを1つの単位として全体をundoを行う。
</p></dd></dl></div><pre class="synopsis"><a id="idm72171216" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">undo-boundary</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、undoリスト内に境界を配置する。このような境界ごとにundoコマンドは停止し、連続するundoコマンドは、より以前の境界へとundoを行っていく。この関数は<code class="literal">nil</code>をリターンする。
</p><p>エディターコマンドループは、各キーシーケンス実行の直前に、1つのundoごとに通常は1つのコマンドがundoされるよう、自動的に<code class="literal">undo-boundary</code>を呼び出す。例外として、入力文字の自己挿入を引き起こすコマンド<code class="literal">self-insert-command</code>(<a class="link" href="ch32s05.html" title="User-Level Insertion Commands">Commands
for
Insertion</a>を参照)は、コマンドループにより挿入された境界を削除するかもしれない。そのような自己挿入文字の1つ目の境界は許容されるが、後続する19個の自己挿入する入力文字は境界をもたず、20個目の自己挿入文字は境界をもつ。そして、自己挿入文字が続くかぎり、これが繰り返される。したがって、連続する文字挿入シーケンスは、グループとしてundoすることが可能である。
</p><p>他のバッファーに行われたundo可能な以前の変更が何であれ、すべてのバッファー変更は境界を追加する。これは各バッファー内で変更を行なった箇所で、すべてのコマンドが境界を作成することを保証する。
</p><p>この関数を明示的に呼び出すことは、あるコマンドの効果を複数単位に分割するために有用である。たとえば<code class="literal">query-replace</code>は、ユーザーが個別に置換をundoできるように、それぞれの置換後に<code class="literal">undo-boundary</code>を呼び出している。
</p></blockquote></div><pre class="synopsis"><a id="idm72164176" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">undo-in-progress</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この変数は通常<code class="literal">nil</code>だが、undoコマンドはこれを<code class="literal">t</code>にバインドする。これにより、さまざまな種類の変更フックがundoにより呼び出された際、それを告げることが可能になる。
</p></blockquote></div><pre class="synopsis"><a id="idm72160464" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">primitive-undo</code> <em class="replaceable"><code>count</code></em> <em class="replaceable"><code>list</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>これは、undoリストの要素のundoにたいする基本的な関数である。これは<em class="replaceable"><code>list</code></em>の最初の<em class="replaceable"><code>count</code></em>要素をundoして、<em class="replaceable"><code>list</code></em>の残りをリターンする。
</p><p><code class="literal">primitive-undo</code>はバッファー変更時、そのバッファーのundoリストに要素を追加する。undoコマンドは混乱を避けるために、undo操作シーケンス冒頭にundoリストの値を保存する。その後、undo操作は保存された値の使用および更新を行う。undoにより追加された新たな要素はこの保存値の一部でないので、継続するundoと干渉しない。
</p><p>この関数は、<code class="literal">undo-in-progress</code>をバインドしない。
</p></blockquote></div></div></body></html>