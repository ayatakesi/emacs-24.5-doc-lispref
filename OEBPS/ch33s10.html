<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Coding Systems</title><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"/></head><body><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="Coding-Systems"/>Coding Systems</h1></div></div></div><a id="idm74063568" class="indexterm"/><p>Emacsがファイルにたいして読み書きを行う際、およびEmacsがサブプロセスとテキストの送受信を行う際、通常は特定の<em class="firstterm">コーディングシステム(coding
system)</em>の指定にしたがって文字コード変換および行末変換を行います。
</p><p>コーディングシステムの定義は難解な問題であり、ここには記述しません。
</p><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="Coding-System-Basics"/>Basic Concepts of Coding Systems</h2></div></div></div><a id="idm74060752" class="indexterm"/><p><em class="firstterm">文字コード変換(character code
conversion)</em>により、Emacs内部で使用される文字の内部表現と他のエンコーディングの間で、変換が行われます。Emacsは多くの異なるエンコーディングをサポートしており、それらは双方向に変換が可能です。たとえばLatin
1、Latin 2、Latin 3、Latin 4、Latin 5、およびいくつかのISO
2022の変種等のようなエンコーディングにたいして、テキストを双方向に変換できます。あるケースにおいては、同じ文字にたいしてEmacsは複数のエンコーディング候補をサポートします。たとえばキリル(ロシア語)のアルファベットにたいしてはISO、Alternativnyj、KOI8のように3つにコーディングシステムが存在します。
</p><p>コーディングシステムはそれぞれ特定の文字コード変換セットを指定しますが、<code class="literal">undecided</code>というコーディングシステムは特別です。これはそれぞれのファイルにたいして、そのファイルのデータにもとづいて発見的に選択が行われるように、選択を未指定のままにします。
</p><p>一般的に、コーディングシステムは可逆的な同一性を保証しません。あるコーディングシステムを使用してバイトシーケンスをデコードしてから、同じコーディングシステムで結果テキストをエンコードしても、異なるバイトシーケンスが生成される可能性があります。しかし、デコードされたオリジナルのバイトシーケンスとなることを保証するコーディングシステムもいくつかあります。以下にいくつかの例を挙げます:
</p><div class="blockquote"><blockquote class="blockquote"><p>iso-8859-1、utf-8、big5、shift_jis、euc-jp
</p></blockquote></div><p>バッファーテキストのエンコードと結果のデコードでも、オリジナルテキストの再生成に失敗する可能性があります。たとえば、その文字をサポートしないコーディングシステムで文字をエンコードした場合の結果は予測できず、したがって同じコーディングシステムを使用してそれをデコードしても、異なるテキストが生成されるでしょう。現在のところ、Emacsは未サポート文字のエンコーディングによる結果をエラーとして報告できません。
</p><a id="idm74057168" class="indexterm"/><a id="idm74035920" class="indexterm"/><a id="idm74035152" class="indexterm"/><p><em class="firstterm">行末変換(end of line conversion:
改行変換)</em>は、ファイル内の行末を表すために、さまざまなシステム上で使用される3つの異なる慣例を扱います。GNUやUnixシステムで使用されるUnixの慣例では、LF文字(linefeed文字、改行とも呼ばれる)が使用されます。MS-WindowsやMS-DOSシステムで使用されるDOSの慣例では、行末にCR文字(carriage-return文字、復帰文字とも呼ばれる)とLF文字が使用されますMacの慣例ではCR文字だけが使用されます(これはOS
X以前のMacintoshシステムで使用されていた慣例である)。
</p><a id="idm74033744" class="indexterm"/><a id="idm74032976" class="indexterm"/><p><code class="literal">latin-1</code>のような<em class="firstterm">ベースコーディングシステム(base coding systems:
基本コーディングシステム)</em>では、データにもとづいて選択されるよう、行末変換は未指定となっています。<code class="literal">latin-1-unix</code>、<code class="literal">latin-1-dos</code>、<code class="literal">latin-1-mac</code>のような<em class="firstterm">バリアントコーディングシステム(variant
coding systems:
変種コーディングシステム)</em>では、行末変換を明示的に指定します。ほとんどのベースコーディングシステムは‘<code class="literal">-unix</code>’、‘<code class="literal">-dos</code>’、‘<code class="literal">-mac</code>’を追加した形式の、3つの対応する変種をもちます。
</p><a id="idm74027600" class="indexterm"/><p><code class="literal">raw-text</code>は、文字コード変換を抑制して、このコーディングシステムでvisitされたバッファーがユニバイトバッファーとなる点において、特殊なコーディングシステムです。歴史的な理由により、このコーディングシステムによりユニバイトおよびマルチバイト両方のテキストを保存できます。マルチバイトテキストのエンコードに<code class="literal">raw-text</code>を使用した際は、1文字コード変換を行います。8ビット文字は、1バイトの外部表現に変換されます。<code class="literal">raw-text</code>は通常のようにデータにより判断できるように行末変換を指定せず、通常のように行末変換を指定する3つの変種をもちます。
</p><a id="idm74025040" class="indexterm"/><a id="idm74024272" class="indexterm"/><p><code class="literal">no-conversion</code>(とエイリアスの<code class="literal">binary</code>)は、<code class="literal">raw-text-unix</code>と等価です。これは文字コードおよび行末にたいする変換をいずれもしてくださいしません。
</p><a id="idm74021584" class="indexterm"/><a id="idm74020816" class="indexterm"/><p><code class="literal">utf-8-emacs</code>は、データがEmacsの内部エンコーディング(<a class="link" href="ch33.html#Text-Representations" title="Text Representations">Text
Representations</a>を参照)で表されることを指定するコーディングシステムです。コード変換が何も発生しない点で、これは<code class="literal">raw-text</code>と似ていますが、結果がマルチバイトデータである点が異なります。The
name  <code class="literal">emacs-internal</code>という名前は、<code class="literal">utf-8-emacs</code>にたいするエイリアスです。
</p><pre class="synopsis"><a id="idm74016976" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">coding-system-get</code> <em class="replaceable"><code>coding-system</code></em> <em class="replaceable"><code>property</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、コーディングシステム<em class="replaceable"><code>coding-system</code></em>の、指定されたプロパティをリターンする。コーディングシステムのプロパティのほとんどは内部的な目的のために存在するが、<code class="literal">:mime-charset</code>については有用と思うかもしれない。このプロパティの値は、そのコーディングシステムが読み書きできる文字コードにたいしてMIME内で使用される名前である。以下に例を示す:
</p><pre class="screen">(coding-system-get 'iso-latin-1 :mime-charset)
     ⇒ iso-8859-1
(coding-system-get 'iso-2022-cn :mime-charset)
     ⇒ iso-2022-cn
(coding-system-get 'cyrillic-koi8 :mime-charset)
     ⇒ koi8-r
</pre><p><code class="literal">:mime-charset</code>プロパティの値は、そのコーディングシステムにたいするエイリアスとしても定義されている。
</p></blockquote></div><a id="idm74011472" class="indexterm"/><pre class="synopsis"><a id="idm74010448" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">coding-system-aliases</code> <em class="replaceable"><code>coding-system</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、<em class="replaceable"><code>coding-system</code></em>のエイリアスのリストをリターンする。
</p></blockquote></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="Encoding-and-I_002fO"/>Encoding and I/O</h2></div></div></div><p>コーディングシステムの主な目的は、ファイルの読み込みと書き込みへの使用です。関数<code class="literal">insert-file-contents</code>はファイルデータのデコードにコーディングシステムを使用し、<code class="literal">write-region</code>はバッファーコンテンツのエンコードにコーディングシステムを使用します。
</p><p>使用するコーディングシステムは明示的(<a class="link" href="ch33s10.html#Specifying-Coding-Systems" title="Specifying a Coding System for One Operation">Specifying Coding
Systems</a>を参照)、またはデフォルトメカニズム(<a class="link" href="ch33s10.html#Default-Coding-Systems" title="Default Coding Systems">Default Coding
Systems</a>を参照)を使用により暗黙的に指定できます。しかしきれらの手法は、何を行うかを完全には指定しないかもしれません。たとえば、これらはデータから文字コード変換を行わない<code class="literal">undefined</code>のようなコーディングシステムを選択するかもしれません。このような場合、I/O処理はコーディングシステム選択により、その処理を完了します。後でどのコーディングシステムが選択されたか調べたいことが、頻繁にあるでしょう。
</p><pre class="synopsis"><a id="idm74002384" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">buffer-file-coding-system</code></pre><div class="blockquote"><blockquote class="blockquote"><p>このバッファーローカル変数は、バッファーの保存、および<code class="literal">write-region</code>によるバッファー部分のファイルへの書き出しに使用されるコーディングシステムを記録する。書き込まれるテキストが、この変数で指定されたコーディングシステムを使用して安全にエンコードできない場合、これらの操作は関数<code class="literal">select-safe-coding-system</code>を呼び出すことにより、代替となるエンコーディングを選択する(<a class="link" href="ch33s10.html#User_002dChosen-Coding-Systems" title="User-Chosen Coding Systems">User-Chosen
Coding
Systems</a>を参照)。異なるエンコーディングの選択が、ユーザーによるコーディングシステムの指定を要するなら、<code class="literal">buffer-file-coding-system</code>は新たに選択されたコーディングシステムに更新される。
</p><p><code class="literal">buffer-file-coding-system</code>は、サブプロセスへのテキスト送信に<span class="emphasis"><em>影響しない</em></span>。
</p></blockquote></div><pre class="synopsis"><a id="idm73996496" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">save-buffer-coding-system</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この変数は、(<code class="literal">buffer-file-coding-system</code>をオーバーライドして)バッファーを保存するためのコーディングシステムを指定する。これは<code class="literal">write-region</code>には使用されないことに注意。
</p><p>あるコマンドがバッファーを保存するために<code class="literal">buffer-file-coding-system</code>(または<code class="literal">save-buffer-coding-system</code>)の使用を開始して、そのコーディングシステムがバッファー内の実際のテキストを処理できなければ、(<code class="literal">select-safe-coding-system</code>を呼び出すことにより)そのコマンドは他のコーディングシステムの選択をユーザーに求める。これが発生した後は、コマンドはユーザー指定のコーディングシステムを表すために、<code class="literal">buffer-file-coding-system</code>の更新も行う。
</p></blockquote></div><pre class="synopsis"><a id="idm73990224" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">last-coding-system-used</code></pre><div class="blockquote"><blockquote class="blockquote"><p>ファイルおよびサブプロセスにたいするI/O操作は、使用したコーディングシステムの名前を、この変数にセットする。明示的にエンコードとデコードを行う関数(<a class="link" href="ch33s10.html#Explicit-Encoding" title="Explicit Encoding and Decoding">Explicit
Encoding</a>を参照)も、この変数をセットする。
</p><p><span class="bold"><strong>警告:</strong></span>
サブプロセス出力の受信によりこの変数がセットされるため、この変数はEmacsがwaitしているとくは常に変更され得る。したがって、興味対象となる値を格納する関数呼び出し後は、間を空けずにその値をコピーするべきである。
</p></blockquote></div><p>変数<code class="literal">selection-coding-system</code>はウィンドウシステムにたいして、選択(selection)をエンコードする方法を指定します。<a class="link" href="ch29s18.html" title="Window System Selections">Window
System Selections</a>を参照してください。
</p><pre class="synopsis"><a id="idm73972432" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">file-name-coding-system</code></pre><div class="blockquote"><blockquote class="blockquote"><p>変数<code class="literal">file-name-coding-system</code>は、ファイル名のエンコーディングに使用するコーディングシステムを指定する。Emacsは、すべてのファイル操作にたいして、ファイル名のエンコードにそのコーディングシステムを使用する。<code class="literal">file-name-coding-system</code>が<code class="literal">nil</code>なら、Emacsは選択された言語環境(language
environment)により決定された、デフォルトのコーディングシステムを使用する。デフォルト言語環境では、ファイル名に含まれるすべての非<acronym class="acronym">ASCII</acronym>文字は、特別にエンコードされない。これらはEmacsの内部表現を使用して、ファイルシステム内で表される。
</p></blockquote></div><p><span class="bold"><strong>警告:</strong></span>
Emacsのセッション中に<code class="literal">file-name-coding-system</code>(または言語環境)を変更した場合、以前のコーディングシステムを使用してエンコードされた名前をもつファイルをvisitしていると、新たなコーディングシステムでは異なるように扱われるので、問題が発生し得る。これらのvisitされたファイル名でこれらのバッファーの保存を試みると、保存により間違ったファイル名が使用されるか、エラーとなるかもしれない。そのような問題が発生したら、そのバッファーにたいして新たなファイル名を指定するために、<strong class="userinput"><code>C-x
C-w</code></strong>を使用すること。
</p><a id="idm73941712" class="indexterm"/><p>Windows 2000以降では、EmacsはOSに渡すファイル名にデフォルトでUnicode
APIを使用するため、<code class="literal">file-name-coding-system</code>の値は大部分が無視される。Lispレベルでファイル名のエンコードまたはデコードを必要とするLispアプリケーションは、<code class="literal">system-type</code>が<code class="literal">windows-nt</code>のときは、<code class="literal">utf-8</code>をコーディングシステムに使用するべきである。UTF-8でエンコードされたファイル名から、OSと対話するために適したエンコーディングへの変換は、Emacsにより内部的に処理される。
</p></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="Lisp-and-Coding-Systems"/>Coding Systems in Lisp</h2></div></div></div><p>以下はコーディングシステムと連携するLisp機能です:
</p><a id="idm73937104" class="indexterm"/><pre class="synopsis"><a id="idm73936080" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">coding-system-list</code> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>base-only</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、すべてのコーディングシステムの名前(シンボル)をリターンする。<em class="replaceable"><code>base-only</code></em>が非<code class="literal">nil</code>なら、値にはベースコーディングシステムだけが含まれる。それ以外ならエイリアス、およびバリアントコーディングシステムも同様に含まれる。
</p></blockquote></div><pre class="synopsis"><a id="idm73931600" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">coding-system-p</code> <em class="replaceable"><code>object</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、<em class="replaceable"><code>object</code></em>がコーディングシステムの名前、または<code class="literal">nil</code>なら、<code class="literal">t</code>をリターンする。
</p></blockquote></div><a id="idm73927248" class="indexterm"/><a id="idm73926480" class="indexterm"/><pre class="synopsis"><a id="idm73925456" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">check-coding-system</code> <em class="replaceable"><code>coding-system</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、<em class="replaceable"><code>coding-system</code></em>の有効性をチェックする。有効なら<em class="replaceable"><code>coding-system</code></em>をリターンする。<em class="replaceable"><code>coding-system</code></em>が<code class="literal">nil</code>なら、この関数は<code class="literal">nil</code>をリターンする。それ以外の値にたいしては、<code class="literal">error-symbol</code>が<code class="literal">coding-system-error</code>であるようなエラーをシグナルする(<a class="link" href="ch11s05.html#Signaling-Errors" title="How to Signal an Error">signal</a>を参照)。
</p></blockquote></div><a id="idm73918800" class="indexterm"/><pre class="synopsis"><a id="idm73917776" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">coding-system-eol-type</code> <em class="replaceable"><code>coding-system</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、行末(<em class="firstterm">eol</em>とも言う)を<em class="replaceable"><code>coding-system</code></em>で使用されるタイプに変換する。<em class="replaceable"><code>coding-system</code></em>が特定のeol変換を指定する場合、リターン値は0、1、2で、それらは順に<code class="literal">unix</code>、<code class="literal">dos</code>、<code class="literal">mac</code>を意味する。<em class="replaceable"><code>coding-system</code></em>が明示的にeol変換を指定しなければ、リターン値は以下のようにそれぞれが可能なeol変換タイプをもつようなコーディングシステムのベクターである:
</p><pre class="programlisting">(coding-system-eol-type 'latin-1)
     ⇒ [latin-1-unix latin-1-dos latin-1-mac]
</pre><p>この関数がベクターをリターンしたら、Emacsはテキストのエンコードやデコードプロセスの一部として、使用するeol変換を決定するだろう。デコードでは、テキストの行末フォーマットは自動検知され、eol変換はそれに適合するようセットされる(DOSスタイルのCRLFフォーマットは暗黙でeol変換に<code class="literal">dos</code>をセットする)。エンコードにたいしては、適切なデフォルトコーディングシステム(<code class="literal">buffer-file-coding-system</code>にたいする<code class="literal">buffer-file-coding-system</code>のデフォルト値)、または配下にあるプラットフォームにたいして適切なデフォルトeol変換が採用される。
</p></blockquote></div><a id="idm73909200" class="indexterm"/><pre class="synopsis"><a id="idm73908176" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">coding-system-change-eol-conversion</code> <em class="replaceable"><code>coding-system</code></em> <em class="replaceable"><code>eol-type</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、<em class="replaceable"><code>coding-system</code></em>と類似するが、<code class="literal">eol-type</code>で指定されたeol変換の異なるコーディングシステムをリターンする。<em class="replaceable"><code>eol-type</code></em>は<code class="literal">unix</code>、<code class="literal">dos</code>、<code class="literal">mac</code>、または<code class="literal">nil</code>であること。これが<code class="literal">nil</code>なら、リターンされるコーディングシステムは、データのeol変換により決定される。
</p><p><em class="replaceable"><code>eol-type</code></em>は<code class="literal">unix</code>、<code class="literal">dos</code>、<code class="literal">mac</code>を意味する0、1、2でもよい。
</p></blockquote></div><a id="idm73898704" class="indexterm"/><pre class="synopsis"><a id="idm73897680" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">coding-system-change-text-conversion</code> <em class="replaceable"><code>eol-coding</code></em> <em class="replaceable"><code>text-coding</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、<em class="replaceable"><code>eol-coding</code></em>の行末変換と、<em class="replaceable"><code>text-coding</code></em>のテキスト変換を使用するコーディングシステムをリターンする。<em class="replaceable"><code>text-coding</code></em>が<code class="literal">nil</code>なら、これは<code class="literal">undecided</code>、または<em class="replaceable"><code>eol-coding</code></em>に対応するバリアントの1つをリターンする。
</p></blockquote></div><a id="idm73891792" class="indexterm"/><a id="idm73891024" class="indexterm"/><pre class="synopsis"><a id="idm73890000" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">find-coding-systems-region</code> <em class="replaceable"><code>from</code></em> <em class="replaceable"><code>to</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、<em class="replaceable"><code>from</code></em>と<em class="replaceable"><code>to</code></em>の間のテキストのエンコードに使用可能な、コーディングシステムのリストをリターンする。このリスト内のすべてのリストは、そのテキスト範囲内にあるすべてのマルチバイト文字を、安全にエンコードできる。
</p><p>そのテキストがマルチバイト文字を含まれなければ、この関数はリスト<code class="literal">(undecided)</code>をリターンする。
</p></blockquote></div><a id="idm73885008" class="indexterm"/><a id="idm73884240" class="indexterm"/><pre class="synopsis"><a id="idm73883216" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">find-coding-systems-string</code> <em class="replaceable"><code>string</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、<em class="replaceable"><code>string</code></em>のテキストのエンコードに使用可能な、コーディングシステムのリストをリターンする。このリスト内のすべてのリストは、<em class="replaceable"><code>string</code></em>にあるすべてのマルチバイト文字を、安全にエンコードできる。そのテキストがマルチバイト文字を含まれなければ、この関数はリスト<code class="literal">(undecided)</code>をリターンする。
</p></blockquote></div><a id="idm73878992" class="indexterm"/><a id="idm73878224" class="indexterm"/><pre class="synopsis"><a id="idm73877200" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">find-coding-systems-for-charsets</code> <em class="replaceable"><code>charsets</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、リスト<em class="replaceable"><code>charsets</code></em>内のすべての文字セットのエンコードに使用可能な、コーディングシステムのリストをリターンする。
</p></blockquote></div><pre class="synopsis"><a id="idm73861328" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">check-coding-systems-region</code> <em class="replaceable"><code>start</code></em> <em class="replaceable"><code>end</code></em> <em class="replaceable"><code>coding-system-list</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、リスト<code class="literal">coding-system-list</code>内のコーディングシステムが、<em class="replaceable"><code>start</code></em>と<em class="replaceable"><code>end</code></em>の間のリージョン内にあるすべての文字をエンコード可能かどうかをチェックする。このリスト内のすべてのコーディングシステムが指定されたテキストをエンコード可能なら、この関数は<code class="literal">nil</code>をリターンする。ある文字をエンコードできないコーディングシステムがある場合は、各要素が<code class="literal">(<em class="replaceable"><code>coding-system1</code></em>
<em class="replaceable"><code>pos1</code></em> <em class="replaceable"><code>pos2</code></em>
…)</code>という形式のalistが値となる。これは<em class="replaceable"><code>coding-system1</code></em>が、バッファーの位置<em class="replaceable"><code>pos1</code></em>、<em class="replaceable"><code>pos2</code></em>、...にある文字をエンコードできないことを意味する。
</p><p><em class="replaceable"><code>start</code></em>は文字列かもしれず、その場合<em class="replaceable"><code>end</code></em>は無視され、リターン値はバッファー位置のかわりに文字列のインデックスを参照することになる。
</p></blockquote></div><pre class="synopsis"><a id="idm73851728" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">detect-coding-region</code> <em class="replaceable"><code>start</code></em> <em class="replaceable"><code>end</code></em> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>highest</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、<em class="replaceable"><code>start</code></em>から<em class="replaceable"><code>end</code></em>のテキストのデコードに適したコーディングシステムを選択する。このテキストはバイトシーケンス、すなわちユニバイトテキスト、<acronym class="acronym">ASCII</acronym>のみのマルチバイトテキスト、8ビット文字のシーケンスであること(<a class="link" href="ch33s10.html#Explicit-Encoding" title="Explicit Encoding and Decoding">Explicit
Encoding</a>を参照)。
</p><p>この関数は通常はスキャンしたテキストのデコーディングを処理可能な、コーディングシステムのリストをリターンする。これらのコーディングシステムは優先度降順でリストされる。しかし<em class="replaceable"><code>highest</code></em>が非<code class="literal">nil</code>なら、リターン値はもっとも高い優先度のコーディングシステムただ1つとなる。
</p><p>リージョンにISO-2022の<code class="literal">ESC</code>のようなISO-2022制御文字を除いて<acronym class="acronym">ASCII</acronym>文字だけが含まれる場合、値は<code class="literal">undecided</code>、<code class="literal">(undecided)</code>、またはテキストから推論可能ならeol変換を指定するバリアントとなる。
</p><p>リージョンにnullバイトが含まれる場合は、あるコーディングシステムによりエンコードされたテキストがリージョン内に含まれる場合でも、値は<code class="literal">no-conversion</code>となる。
</p></blockquote></div><pre class="synopsis"><a id="idm73837136" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">detect-coding-string</code> <em class="replaceable"><code>string</code></em> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>highest</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は<code class="literal">detect-coding-region</code>と似ているが、バッファー内のバイトのかわりに<em class="replaceable"><code>string</code></em>のコンテンツを処理する点が異なる。
</p></blockquote></div><a id="idm73832528" class="indexterm"/><pre class="synopsis"><a id="idm73831504" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">inhibit-null-byte-detection</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この変数が非<code class="literal">nil</code>値をもつなら、リージョンや文字列のエンコーディング検出時に、nullバイトを無視する。これによりIndexノードをもつInfoファイルのように、nullバイトを含むテキストのエンコーディングを正しく検出できる。
</p></blockquote></div><pre class="synopsis"><a id="idm73828304" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">inhibit-iso-escape-detection</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この変数が非<code class="literal">nil</code>値をもつなら、リージョンや文字列のエンコーディング検出時に、ISO-2022エスケープシーケンスを無視する。その結果、これまでいくつかのISO-2022エンコーディングにおいてエンコード済みと検出されていたテキストがなくなり、バッファー内ですべてのエスケープシーケンスが可視になる。<span class="bold"><strong>警告:</strong></span>
この変数の使用には特に注意を払うこと。なぜならEmacsディストリビューション内で多くのファイルがISO-2022エンコーディングを使用するからである。
</p></blockquote></div><a id="idm73824848" class="indexterm"/><pre class="synopsis"><a id="idm73823824" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">coding-system-charset-list</code> <em class="replaceable"><code>coding-system</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、<em class="replaceable"><code>coding-system</code></em>がサポートする文字セット(<a class="link" href="ch33s07.html" title="Character Sets">Character
Sets</a>を参照)のリストをリターンする。リストすべき文字セットを非常に多くサポートするいくつかのコーディングシステムでは、特別な値がリストされる:
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><em class="replaceable"><code>coding-system</code></em>がすべてのEmacs文字をサポートするなら、値は<code class="literal">(emacs)</code>。
</p></li><li class="listitem"><p><em class="replaceable"><code>coding-system</code></em>がすべてのUnicode文字をサポートするなら、値は<code class="literal">(unicode)</code>。
</p></li><li class="listitem"><p><em class="replaceable"><code>coding-system</code></em>がすべてのISO-2022文字をサポートするなら、値は<code class="literal">iso-2022</code>。
</p></li><li class="listitem"><p><em class="replaceable"><code>coding-system</code></em>がEmacsバージョン21(Unicodeサポートの内部的な実装以前)で使用される内部的コーディングシステム内のすべての文字をサポートするなら、値は<code class="literal">emacs-mule</code>。
</p></li></ul></div></blockquote></div><p>サブプロセスへの入出力に使用されるコーディングシステムのチェックやセットの方法については、<a class="link" href="ch37s06.html#Coding-systems-for-a-subprocess">Process
Information</a>、特に関数<code class="literal">process-coding-system</code>および<code class="literal">set-process-coding-system</code>の説明を参照してください。
</p></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="User_002dChosen-Coding-Systems"/>User-Chosen Coding Systems</h2></div></div></div><a id="idm73812304" class="indexterm"/><pre class="synopsis"><a id="idm73811280" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">select-safe-coding-system</code> <em class="replaceable"><code>from</code></em> <em class="replaceable"><code>to</code></em> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>default-coding-system</code></em> <em class="replaceable"><code>accept-default-p</code></em> <em class="replaceable"><code>file</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、指定されたテキストをエンコードするために、必要ならユーザーに選択を求めて、コーディングシステムを選択する。指定されるテキストは、通常はカレントバッファーの<em class="replaceable"><code>from</code></em>と<em class="replaceable"><code>to</code></em>の間のテキストである。<em class="replaceable"><code>from</code></em>が文字列なら、その文字列はエンコードするテキストを指定し、<em class="replaceable"><code>to</code></em>は無視される。
</p><p>指定されたテキストにrawバイト(<a class="link" href="ch33.html#Text-Representations" title="Text Representations">Text
Representations</a>を参照)が含まれる場合、<code class="literal">select-safe-coding-system</code>はそのエンコーディングに<code class="literal">raw-text</code>を提案する。
</p><p><em class="replaceable"><code>default-coding-system</code></em>が非<code class="literal">nil</code>なら、それは試行すべき最初のコーディングシステムである。それがテキストを処理できるなら、<code class="literal">select-safe-coding-system</code>はそのコーディングシステムをリターンする。これはコーディングシステムのリストの可能性もある。その場合、この関数はそれらを1つずつ試みる。それらをすべて試した後に、(<code class="literal">undecided</code>以外なら)カレントバッファーの<code class="literal">buffer-file-coding-system</code>の値、次に<code class="literal">buffer-file-coding-system</code>のデフォルト値、最後にユーザーがもっとも好むコーディングシステム(コマンド<code class="literal">prefer-coding-system</code>でセットできる最優先されるコーディングシステム)を試みる(section “Recognizing Coding Systems” in <em class="citetitle">The GNU Emacs Manual</em>を参照)。
</p><p>これらのうちいずれかのコーディングシステムが指定されたテキストすべてを安全にエンコード可能なら、<code class="literal">select-safe-coding-system</code>はそれを選択およびリターンする。それ以外なら、コーディングシステムのリストからすべてのテキストをエンコードできるコーディングシステムの選択をユーザーに求めて、ユーザーの選択をリターンする。
</p><p><em class="replaceable"><code>default-coding-system</code></em>は、最初の要素がtで、他の要素がコーディングシステムであるようなリストかもしれない。その場合、もしリスト内にテキストを処理できるコーディングシステムがなければ、<code class="literal">select-safe-coding-system</code>は上述した3つの代替えいずれを試みることなく、即座にユーザーに問い合わせる。
</p><p>オプション引数<em class="replaceable"><code>accept-default-p</code></em>が非<code class="literal">nil</code>なら、それはユーザーとの対話なしで選択されたコーディングシステムが許容できるかどうかを判断する関数であること。<code class="literal">select-safe-coding-system</code>は、選択されたコーディングシステムのベースコーディングシステムを唯一の引数として、この関数を呼び出す。<em class="replaceable"><code>accept-default-p</code></em>が<code class="literal">nil</code>うちリターンしたら、<code class="literal">select-safe-coding-system</code>は黙って選択されたコーディングシステムを拒絶して、可能な候補リストからコーディングシステムの選択をユーザーに求める。
</p><a id="idm73789392" class="indexterm"/><p>変数<code class="literal">select-safe-coding-system-accept-defaultf-p</code>が非<code class="literal">nil</code>なら、それは1つの引数をとる関数であること。これは<em class="replaceable"><code>accept-default-p</code></em>引数に与えられた値をオーバーライドすることにより、<em class="replaceable"><code>accept-default-p</code></em>のかわりに使用される。
</p><p>最後のステップとして、選択されたコーディングシステムをリターンする前に、<code class="literal">select-safe-coding-system</code>は、もしリージョンのコンテンツがファイルから読み込まれたものだったとしたなら選択されたであろうコーディングシステムと、そのコーディングシステムが一致するかどうかをチェックする(異なるなら、その後の再visitと編集でファイル内のデータ汚染が起こり得る)。通常、<code class="literal">select-safe-coding-system</code>はこの目的のためのファイルとして<code class="literal">buffer-file-name</code>を使用するが、<em class="replaceable"><code>file</code></em>が非<code class="literal">nil</code>なら、かわりにそのファイルをかわりに使用する(これは<code class="literal">write-region</code>、および類似の関数に関連し得る)。明らかな不一致が検出された場合、<code class="literal">select-safe-coding-system</code>はそのコーディングシステムを選択する前に、ユーザーに問い合わせる。
</p></blockquote></div><p>以下の2つの関数は、補完つきでユーザーにコーディングシステムの選択を求めるために使用できます。<a class="link" href="ch20s06.html" title="Completion">Completion</a>を参照してください。
</p><pre class="synopsis"><a id="idm73777360" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">read-coding-system</code> <em class="replaceable"><code>prompt</code></em> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>default</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、文字列<em class="replaceable"><code>prompt</code></em>をプロンプトにミニバッファーを使用してコーディングシステムを読み取り、そのコーディングシステムの名前をシンボルとしてリターンする。<em class="replaceable"><code>default</code></em>は、ユーザーの入力が空の場合にリターンするべきコーディングシステムを指定する。これはシンボルまたは文字列であること。
</p></blockquote></div><pre class="synopsis"><a id="idm73772624" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">read-non-nil-coding-system</code> <em class="replaceable"><code>prompt</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、文字列<em class="replaceable"><code>prompt</code></em>をプロンプトにミニバッファーを使用してコーディングシステムを読み取り、そのコーディングシステムの名前をシンボルとしてリターンする。ユーザーが空の入力を試みると、再度ユーザーに問い合わせを行う。<a class="link" href="ch33s10.html" title="Coding Systems">Coding
Systems</a>を参照のこと。
</p></blockquote></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="Default-Coding-Systems"/>Default Coding Systems</h2></div></div></div><a id="idm73767760" class="indexterm"/><a id="idm73766992" class="indexterm"/><p>このセクションでは、特定のファイルや特定のサブプロセス実行時のデフォルトコーディングシステムを指定する変数、およびそれらへアクセスするためのI/O処理が使用する関数について説明します。
</p><p>これらの変数は、希望するデフォルトにそれらすべてを一度セットして、その後は再びそれを変更しないというアイデアにもとづいています。Lispプログラム内の特定の処理で特定のコーディングシステムを指定するために、これらの変数を変更しないでください。かわりに<code class="literal">coding-system-for-read</code>および<code class="literal">coding-system-for-write</code>を使用して、それらをオーバーライドしてください(<a class="link" href="ch33s10.html#Specifying-Coding-Systems" title="Specifying a Coding System for One Operation">Specifying
Coding Systems</a>を参照)。
</p><a id="idm73763920" class="indexterm"/><pre class="synopsis"><a id="idm73762896" class="indexterm"/><span class="category"><span class="bold"><strong>User Option</strong></span>:</span> <code class="varname">auto-coding-regexp-alist</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この変数は、テキストパターンと対応するコーディングシステムのalistである。要素はそれぞれ<code class="literal">(<em class="replaceable"><code>regexp</code></em>
.
<em class="replaceable"><code>coding-system</code></em>)</code>という形式をもつ。冒頭の数キロバイトが<em class="replaceable"><code>regexp</code></em>にマッチするファイルは、そのコンテンツをバッファーに読み込む際は、<em class="replaceable"><code>coding-system</code></em>によりデコードされる。このalist内のセッティングは、ファイル内の<code class="literal">coding:</code>タグ、および<code class="literal">file-coding-system-alist</code>(以下参照)の内容より優先される。Emacsが自動的にBabylフォーマットのメールファイルを認識して、コード変換なしでそれらを読み取るよう、デフォルト値がセットされている。
</p></blockquote></div><a id="idm73745104" class="indexterm"/><pre class="synopsis"><a id="idm73744080" class="indexterm"/><span class="category"><span class="bold"><strong>User Option</strong></span>:</span> <code class="varname">file-coding-system-alist</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この変数は、特定のファイルの読み書きに使用するコーディングシステムを指定するalistである。要素はそれぞれ<code class="literal">(<em class="replaceable"><code>pattern</code></em>
.
<em class="replaceable"><code>coding</code></em>)</code>という形式をもち、<em class="replaceable"><code>pattern</code></em>は特定のファイル名にマッチする正規表現である。この要素は<em class="replaceable"><code>pattern</code></em>にマッチするファイル名に適用される。
</p><p>要素のCDRとなる<em class="replaceable"><code>coding</code></em>はコーディングシステム、2つのコーディングシステムを含むコンスセル、または関数名(関数定義をもつシンボル)であること。<em class="replaceable"><code>coding</code></em>がコーディングシステムなら、そのコーディングシステムはファイルの読み込みと書き込みの両方で使用される。<em class="replaceable"><code>coding</code></em>が2つのコーディングシステムを含むコンスセルなら、CARはデコード用のコーディングシステム、CDRはエンコード用のコーディングシステムを指定する。
</p><p><em class="replaceable"><code>coding</code></em>が関数名なら、それは<code class="literal">find-operation-coding-system</code>に渡されたすべての引数からなるリストを唯一の引数とする関数であること。これはコーディングシステム、または2つのコーディングシステムを含むコンスセルをリターンしなければならない。この値は上記と同じ意味をもつ。
</p><p><em class="replaceable"><code>coding</code></em>(または上記関数のリターン値)が<code class="literal">undecided</code>なら、通常のコード検出が行われる。
</p></blockquote></div><pre class="synopsis"><a id="idm73735504" class="indexterm"/><span class="category"><span class="bold"><strong>User Option</strong></span>:</span> <code class="varname">auto-coding-alist</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この変数は、特定のファイルの読み書きに使用するコーディングシステムを指定するalistである。この変数の形式は<code class="literal">file-coding-system-alist</code>の形式と似ているが、後者と異なるのは、この変数がファイル内の<code class="literal">coding:</code>タグより優先されることである。
</p></blockquote></div><a id="idm73732048" class="indexterm"/><pre class="synopsis"><a id="idm73731024" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">process-coding-system-alist</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この変数は、何のプログラムがサブプロセス内で実行中かによって、そのサブプロセスにたいしてどのコーディングシステムを使用するかを指定するalistである。これは<code class="literal">file-coding-system-alist</code>と同じように機能するが、<em class="replaceable"><code>pattern</code></em>がそのサブプロセスを開始するために使用されたプログラム名にたいしてマッチされる点が異なる。コーディングシステム、またはalist内で指定されたコーディングシステムは、そのサブプロセスへのI/Oに使用されるコーディングシステムの初期化に使用されるが、<code class="literal">set-process-coding-system</code>を使用して後から他のコーディングシステムを指定できる。
</p></blockquote></div><p><span class="bold"><strong>警告:</strong></span>
データからコーディングシステムを判断する<code class="literal">undecided</code>のようなコーディングシステムは、非同期のサブプロセスでは完全な信頼性をもって機能はしない。これはEmacsが非同期サブプロセスの出力を、到着によりバッチ処理するためである。そのコーディングシステムが文字コード変換、または行末変換を未指定にしておくと、Emacsは一度に1バッチから正しい変換の検出を試みなければならず、これは常に機能するとは限らない。
</p><p>したがって非同期サブプロセスでは、可能なら文字コード変換と行末変換の両方を判断するコーディングシステム、つまり<code class="literal">undecided</code>や<code class="literal">latin-1</code>ではなく<code class="literal">latin-1-unix</code>のようなコーディングシステムを使用すること。
</p><a id="idm73719760" class="indexterm"/><a id="idm73718992" class="indexterm"/><pre class="synopsis"><a id="idm73717968" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">network-coding-system-alist</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この変数は、ネットワークストリームに使用するコーディングシステムを指定するalistである。これは<code class="literal">file-coding-system-alist</code>と同じように機能するが、要素内の<em class="replaceable"><code>pattern</code></em>がポート番号、または正規表現かもしれない点が異なる。正規表現なら、そのネットワークストリームのオープンに使用されたネットワークサービス名にたいしてマッチされる。
</p></blockquote></div><pre class="synopsis"><a id="idm73714384" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">default-process-coding-system</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この変数は、他に何を行うか指定されていない際に、サブプロセス(とネットワークストリーム)への入出力に使用するコーディングシステムを指定する。
</p><p>値は、<code class="literal">(<em class="replaceable"><code>input-coding</code></em>
.
<em class="replaceable"><code>output-coding</code></em>)</code>という形式のコンスセルであること。ここで<em class="replaceable"><code>input-coding</code></em>はサブプロセスからの入力、<em class="replaceable"><code>output-coding</code></em>はサブプロセスへの出力に適用される。
</p></blockquote></div><a id="idm73709520" class="indexterm"/><pre class="synopsis"><a id="idm73708496" class="indexterm"/><span class="category"><span class="bold"><strong>User Option</strong></span>:</span> <code class="varname">auto-coding-functions</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この変数は、ファイルのデコードされていないコンテンツにもとづいて、ファイルにたいするコーディングシステムの判断を試みる関数のリストを保持する。
</p><p>このリスト内の各関数は、カレントバッファー内のテキストを調べるように、ただしいいかなる方法にせよそれを変更しないよう記述されるべきである。そのバッファーは、ファイルの一部であるデコードされていないテキストを含むだろう。各関数はポイントを始点に何文字を調べる可を告げる、唯一の引数<em class="replaceable"><code>size</code></em>をとること。関数が、そのファイルにたいするコーディングシステムの決定に成功したら、そのコーディングシステムをリターンすること。それ以外は<code class="literal">nil</code>をリターンするべきである。
</p><p>ファイルに‘<code class="literal">coding:</code>’タグがある場合は、それが優先されるので、これらの関数が呼び出されることはないだろう。
</p></blockquote></div><pre class="synopsis"><a id="idm73703632" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">find-auto-coding</code> <em class="replaceable"><code>filename</code></em> <em class="replaceable"><code>size</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、<em class="replaceable"><code>filename</code></em>に適するコーディングシステムの判定を試みる。これは、上記で説明した変数により指定されたルールのいずれかにマッチするまで、それらの変数を順に使用して、ファイルをvisitするバッファーを調べる。そして<code class="literal">(<em class="replaceable"><code>coding</code></em>
.
<em class="replaceable"><code>source</code></em>)</code>という形式のコンスセルをリターンする。ここで<em class="replaceable"><code>coding</code></em>は使用するコーディングシステム、<em class="replaceable"><code>source</code></em>はは<code class="literal">auto-coding-alist</code>、<code class="literal">auto-coding-regexp-alist</code>、<code class="literal">:coding</code>、<code class="literal">auto-coding-functions</code>のいずれかであるようなシンボルで、マッチングルールとして供されるルールを示す。値<code class="literal">:coding</code>は、ファイル内の<code class="literal">coding:</code>タグによりコーディングシステムが指定されたことを意味する(section “coding tag” in <em class="citetitle">The GNU Emacs
Manual</em>を参照)。マッチングルールを調べる順序は<code class="literal">auto-coding-alist</code>、<code class="literal">auto-coding-regexp-alist</code>、<code class="literal">coding:</code>、<code class="literal">auto-coding-functions</code>の順である。マッチングルールが見つからなければ、この関数は<code class="literal">nil</code>をリターンする。
</p><p>2つ目の引数<em class="replaceable"><code>size</code></em>は、ポイントの後のテキストの文字単位のサイズである。この関数は、ポイントの後の<em class="replaceable"><code>size</code></em>文字のテキストだけを調べる。<code class="literal">coding:</code>タグが置かれる箇所としてはファイルの先頭2行が考えられる箇所の1つなので、通常はバッファーの先頭位置で、この関数を呼び出すべきである。その場合、<em class="replaceable"><code>size</code></em>はそのバッファーのサイズであること。
</p></blockquote></div><pre class="synopsis"><a id="idm73689296" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">set-auto-coding</code> <em class="replaceable"><code>filename</code></em> <em class="replaceable"><code>size</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、ファイル<em class="replaceable"><code>filename</code></em>に適するコーディングシステムをリターンする。これはコーディングシステムを探すために、<code class="literal">find-auto-coding</code>を使用する。コーディングシステムを決定できなかったら、この関数は<code class="literal">nil</code>をリターンする。引数<em class="replaceable"><code>size</code></em>の意味は、<code class="literal">find-auto-coding</code>と同様。
</p></blockquote></div><pre class="synopsis"><a id="idm73683280" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">find-operation-coding-system</code> <em class="replaceable"><code>operation</code></em> <em class="replaceable"><code>&amp;rest</code></em> <em class="replaceable"><code>arguments</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、<em class="replaceable"><code>operation</code></em>を<em class="replaceable"><code>arguments</code></em>で行う際に、(デフォルトで)使用するコーディングシステムをリターンする。値は以下の形式である:
</p><pre class="screen">(<em class="replaceable"><code>decoding-system</code></em> . <em class="replaceable"><code>encoding-system</code></em>)
</pre><p>1つ目の要素<em class="replaceable"><code>decoding-system</code></em>はデコード(<em class="replaceable"><code>operation</code></em>がデコードを行う場合)、<em class="replaceable"><code>encoding-system</code></em>はエンコード(<em class="replaceable"><code>operation</code></em>がエンコードを行う場合)に使用するコーディングシステムである。
</p><p>引数<em class="replaceable"><code>operation</code></em>はシンボルで<code class="literal">write-region</code>、<code class="literal">start-process</code>、<code class="literal">call-process</code>、<code class="literal">call-process-region</code>、<code class="literal">insert-file-contents</code>、<code class="literal">open-network-stream</code>のいずれかであること。これらは文字コード変換と行末変換を行うことができる、EmacsのI/Oプリミティブの名前である。
</p><p>残りの引数は、対応するI/Oプリミティブに与えられる引数と同じであること。そのプリミティブに応じて、これらの引数のうち1つが<em class="firstterm">ターゲット</em>として選択される。たとえば<em class="replaceable"><code>operation</code></em>がファイルI/Oなら、ファイル名を指定する引数がターゲットである。サブプロセス用のプリミティブでは、プロセス名がターゲットになる。<code class="literal">open-network-stream</code>では、サービス名またはポート番号がターゲットである。
</p><p><em class="replaceable"><code>operation</code></em>に応じて、この関数は<code class="literal">file-coding-system-alist</code>、<code class="literal">process-coding-system-alist</code>、<code class="literal">network-coding-system-alist</code>の中からターゲットを探す。このalist内でターゲットが見つかったら、<code class="literal">find-operation-coding-system</code>はalist内のassociation(連想:
キーと連想値からなるコンスセル)をリターンし、それ以外は<code class="literal">nil</code>をリターンする。
</p><p><em class="replaceable"><code>operation</code></em>が<code class="literal">insert-file-contents</code>なら、ターゲットに対応する引数は、<code class="literal">(<em class="replaceable"><code>filename</code></em>
.
<em class="replaceable"><code>buffer</code></em>)</code>という形式のコンスセルだろう。この場合、<em class="replaceable"><code>filename</code></em>は<code class="literal">file-coding-system-alist</code>内で照合されるファイル名であり、<em class="replaceable"><code>buffer</code></em>はそのファイルの(デコードされていない)コンテンツを含むバッファーである。<code class="literal">file-coding-system-alist</code>がこのファイルにたいして呼び出す関数を指定していて、かつ(通常行われるように)ファイルのコンテンツを調べる必要があるなら、ファイルを読み込むかわりに<em class="replaceable"><code>buffer</code></em>のコンテンツを調べるべきである。
</p></blockquote></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="Specifying-Coding-Systems"/>Specifying a Coding System for One Operation</h2></div></div></div><a id="idm73657040" class="indexterm"/><a id="idm73656272" class="indexterm"/><a id="idm73655504" class="indexterm"/><p>変数<code class="literal">coding-system-for-read</code>および/または<code class="literal">coding-system-for-write</code>をバインドすることにより、特定の操作にたいしてコーディングシステムを指定できます。
</p><pre class="synopsis"><a id="idm73652944" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">coding-system-for-read</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この変数が非<code class="literal">nil</code>なら、それはファイルの読み込み、または同期サブプロセスプロセスからの入力にたいして使用する、コーディングシステムを指定する。
</p><p>これは非同期サブプロセスやネットワークストリームにも適用されるが、その方法は異なる。サブプロセス開始時、またはネットワークストリームオープン時の<code class="literal">coding-system-for-read</code>の値は、サブプロセスまたはネットワークストリームにたいして入力のデコードメソッドを指定する。そのサブプロセスまたはネットワークストリームにたいして、それがオーバーライドされるまで、それが使用され続ける。
</p><p>特定のI/O操作にたいして<code class="literal">let</code>でバインドするのが、この変数の正しい使い方である。この変数のグローバル値は常に<code class="literal">nil</code>であり、他の値にグローバルにセットするべきではない。以下は、この変数の正しい使用例である:
</p><pre class="screen">;; 文字コード変換なしでファイルを読み込む
(let ((coding-system-for-read 'no-conversion))
  (insert-file-contents filename))
</pre><p>この変数の値が非<code class="literal">nil</code>のときは<code class="literal">file-coding-system-alist</code>、<code class="literal">process-coding-system-alist</code>、<code class="literal">network-coding-system-alist</code>を含む、入力にたいして使用するコーディングシステムを指定するすべてのメソッドより、この変数が優先される。
</p></blockquote></div><pre class="synopsis"><a id="idm73632080" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">coding-system-for-write</code></pre><div class="blockquote"><blockquote class="blockquote"><p>これは<code class="literal">coding-system-for-read</code>と同じように機能するが、入力ではなく出力に適用される点が異なる。これはファイルへの書き込み、同様にサブプロセスおよびネットワークストリームへの出力の送信にも適用される。
</p><p>単一の操作が<code class="literal">call-process-region</code>や<code class="literal">start-process</code>のように、入力と出力の両方を行う際は、<code class="literal">coding-system-for-read</code>と<code class="literal">coding-system-for-write</code>の両方がそれに影響する。
</p></blockquote></div><pre class="synopsis"><a id="idm73626448" class="indexterm"/><span class="category"><span class="bold"><strong>User Option</strong></span>:</span> <code class="varname">inhibit-eol-conversion</code></pre><div class="blockquote"><blockquote class="blockquote"><p>この変数が非<code class="literal">nil</code>なら、どのコーディングシステムが指定されたかに関わらず、行末変換は何も行われない。これはEmacsすべてのI/Oおよびサブプロセスにたいするプリミティブ、および明示的なエンコード関数(<a class="link" href="ch33s10.html#Explicit-Encoding" title="Explicit Encoding and Decoding">Explicit
Encoding</a>を参照)とデコード関数に適用される。
</p></blockquote></div><a id="idm73622992" class="indexterm"/><a id="idm73622224" class="indexterm"/><p>ある操作にたいして、固定された1つのコーディングシステムではなく、複数のコーディングシステムを選択する必要があることが、ときおりあります。Emacsでは、使用するコーディングシステムにたいして優先順位を指定できます。これは、<code class="literal">find-coding-systems-region</code>(<a class="link" href="ch33s10.html#Lisp-and-Coding-Systems" title="Coding Systems in Lisp">Lisp
and Coding Systems</a>を参照)のような関数によりリターンされるコーディングシステムのリストのソート順に影響します。
</p><pre class="synopsis"><a id="idm73619792" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">coding-system-priority-list</code> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>highestp</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、コーディングシステムのカレント優先順に、コーディングシステムのリストをリターンする。オプション引数<em class="replaceable"><code>highestp</code></em>が非<code class="literal">nil</code>なら、それはもっとも高い優先度のコーディングシステムだけをリターンすることを意味する。
</p></blockquote></div><pre class="synopsis"><a id="idm73615312" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">set-coding-system-priority</code> <em class="replaceable"><code>&amp;rest</code></em> <em class="replaceable"><code>coding-systems</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、コーディングシステムの優先リストの先頭に<em class="replaceable"><code>coding-systems</code></em>を置き、それらを他のコーディングシステムすべてより高い優先度とする。
</p></blockquote></div><pre class="synopsis"><a id="idm73611344" class="indexterm"/><span class="category"><span class="bold"><strong>Macro</strong></span>:</span> <code class="function">with-coding-priority</code> <em class="replaceable"><code>coding-systems</code></em> <em class="replaceable"><code>&amp;rest</code></em> <em class="replaceable"><code>body</code></em><em class="replaceable"><code>…</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>このマクロは、<em class="replaceable"><code>coding-systems</code></em>をコーディングシステム優先リスト先頭に置いて、<code class="literal">progn</code>(<a class="link" href="ch11.html#Sequencing" title="Sequencing">progn</a>を参照)が行うように、<em class="replaceable"><code>body</code></em>を実行する。<em class="replaceable"><code>coding-systems</code></em>は、<em class="replaceable"><code>body</code></em>実行中に選択するコーディングシステムのリストであること。
</p></blockquote></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="Explicit-Encoding"/>Explicit Encoding and Decoding</h2></div></div></div><a id="idm73603792" class="indexterm"/><a id="idm73603024" class="indexterm"/><p>Emacs内外へテキストを転送するすべての操作は、そのテキストをエンコードまたはデコードする能力をもっています。このセクション内の関数を使用して、テキストを明示的にエンコードあるいはデコードすることもできます。
</p><p>エンコード結果およびデコーディングへの入力は、通常のテキストではありません。これらは理論的には一連のバイト値から構成され、すなわち一連の<acronym class="acronym">ASCII</acronym>文字と8ビット文字から構成されます。ユニバイトのバッファーおよび文字列では、これらの文字は0から#xFF(255)の範囲のコードをもちます。マルチバイトのバッファーおよび文字列では、8ビット文字は#xFFより大きい文字コードをもちますが(<a class="link" href="ch33.html#Text-Representations" title="Text Representations">Text
Representations</a>を参照)、そのようなテキストのエンコードやデコード時、Emacsは透過的にそれらを単一バイト値に変換します。
</p><p>コンテンツを明示的にデコードできるように、バイトシーケンスとしてバッファーにファイルを読み込むには、<code class="literal">insert-file-contents-literally</code>(<a class="link" href="ch25s03.html" title="Reading from Files">Reading
from
Files</a>を参照)を使用するのが通常の方法です。あるいは<code class="literal">find-file-noselect</code>でファイルをvisitする際、引数<em class="replaceable"><code>rawfile</code></em>に非<code class="literal">nil</code>を指定することもできます。これらのメソッドの結果は、ユニバイトバッファーになります。
</p><p>テキストを明示的にエンコードした結果であるバイトシーケンスは、たとえばそれを<code class="literal">write-region</code>(see <a class="link" href="ch25s04.html" title="Writing to Files">Writing to
Files</a>)で書き込み、<code class="literal">coding-system-for-write</code>を<code class="literal">no-conversion</code>にバインドすることによりエンコードを抑制する等、それをファイルまたはプロセスへコピーするのが、通常の使い方です。
</p><p>以下は、エンコードまたはデコードを明示的に行う関数です。エンコード関数とはバイトシーケンスを生成し、デコード関数とはバイトシーケンスを操作する関数のことを意味します。これらの関数はすべて、テキストプロパティを破棄します。これらは、自身が使用したコーディングシステムを、正確に<code class="literal">last-coding-system-used</code>することも行います。
</p><pre class="synopsis"><a id="idm77734992" class="indexterm"/><span class="category"><span class="bold"><strong>Command</strong></span>:</span> <code class="function">encode-coding-region</code> <em class="replaceable"><code>start</code></em> <em class="replaceable"><code>end</code></em> <em class="replaceable"><code>coding-system</code></em> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>destination</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>このコマンドは、<em class="replaceable"><code>start</code></em>から<em class="replaceable"><code>end</code></em>のテキストを、コーディングシステム<em class="replaceable"><code>coding-system</code></em>でエンコードする。通常、バッファー内の元テキストはエンコードされたテキストで置き換えられるが、オプション引数<em class="replaceable"><code>destination</code></em>でそれを変更できる。<em class="replaceable"><code>destination</code></em>がバッファーなら、エンコードされたテキストはそのバッファーのポイントの後に挿入される(ポイントは移動しない)。<code class="literal">t</code>なら、このコマンドはエンコードされたテキストを挿入せずに、ユニバイトとしてリターンする。
</p><p>エンコードされたテキストが何らかのバッファーに挿入された場合、このコマンドはエンコードされたテキストの長さをリターンする。
</p><p>エンコードされた結果は理論的にはバイトシーケンスだが、バッファーが以前マルチバイトだったならマルチバイトのまま留まり、すべての8ビットのバイトはマルチバイト表現に変換される(<a class="link" href="ch33.html#Text-Representations" title="Text Representations">Text
Representations</a>を参照)。
</p><a id="idm77726800" class="indexterm"/><p>期待しない結果となる恐れがあるので、テキストのエンコードする際は、<em class="replaceable"><code>coding-system</code></em>に<code class="literal">undecided</code>を<span class="emphasis"><em>使用してはならない</em></span>。<em class="replaceable"><code>coding-system</code></em>にたいして自明な適値が存在しなければ、適切なエンコードを提案させるために、かわりに<code class="literal">select-safe-coding-system</code>を使用すること(<a class="link" href="ch33s10.html#User_002dChosen-Coding-Systems" title="User-Chosen Coding Systems">select-safe-coding-system</a>を参照)。
</p></blockquote></div><pre class="synopsis"><a id="idm77722192" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">encode-coding-string</code> <em class="replaceable"><code>string</code></em> <em class="replaceable"><code>coding-system</code></em> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>nocopy</code></em> <em class="replaceable"><code>buffer</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、コーディングシステム<em class="replaceable"><code>coding-system</code></em>で、<em class="replaceable"><code>string</code></em>内のテキストをエンコードする。これはエンコードされたテキストを含む新たな文字列をリターンするが、<em class="replaceable"><code>nocopy</code></em>が非<code class="literal">nil</code>の場合、些細なエンコード処理なら、この関数は<em class="replaceable"><code>string</code></em>自身をリターンする。エンコード結果はユニバイト文字列である。
</p></blockquote></div><pre class="synopsis"><a id="idm77715408" class="indexterm"/><span class="category"><span class="bold"><strong>Command</strong></span>:</span> <code class="function">decode-coding-region</code> <em class="replaceable"><code>start</code></em> <em class="replaceable"><code>end</code></em> <em class="replaceable"><code>coding-system</code></em> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>destination</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>このコマンドは、コーディングシステム<em class="replaceable"><code>coding-system</code></em>で、<em class="replaceable"><code>start</code></em>から<em class="replaceable"><code>end</code></em>のテキストをデコードする。明示的なデコードを使いやすくするために、デコード前のテキストはバイトシーケンス値であるべきだが、マルチバイトとユニバイトのバッファーいずれでも許すようになっている(マルチバイトバッファーの場合rawバイト値は8ビット文字で表現されていること)。通常、デコードされたテキストでバッファー内の元のテキストは置き換えられるが、オプション引数<em class="replaceable"><code>destination</code></em>はそれを変更する。<em class="replaceable"><code>destination</code></em>がバッファーなら、デコードされたテキストは、そのバッファーのポイントの後に挿入される(ポイントは移動しない)。これが<code class="literal">t</code>なら、このコマンドはデコードされたテキストを挿入せずに、それをマルチバイト文字列としてリターンする。
</p><p>デコードされたテキストが何らかのバッファーに挿入された場合、このコマンドはデコードされたテキストの長さをリターンする。
</p><p>このコマンドは、デコードされたテキストに、テキストプロパティ<code class="literal">charset</code>をputする。このプロパティの値は、元ののテキストのデコードに使用された文字セットを示す。
</p></blockquote></div><pre class="synopsis"><a id="idm77706960" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">decode-coding-string</code> <em class="replaceable"><code>string</code></em> <em class="replaceable"><code>coding-system</code></em> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>nocopy</code></em> <em class="replaceable"><code>buffer</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、<em class="replaceable"><code>coding-system</code></em>で<em class="replaceable"><code>string</code></em>内のテキストをデコードする。これはデコードされたテキストを含む新たな文字列をリターンするが、<em class="replaceable"><code>nocopy</code></em>が非<code class="literal">nil</code>の場合、些細なデコード処理なら<em class="replaceable"><code>string</code></em>自体をリターンするかもしれない。明示的なデコードを使いやすくするために、<em class="replaceable"><code>string</code></em>のコンテンツはバイトシーケンス値をもつユニバイト文字列であるべきだが、マルチバイト文字列も許すようになっている(マルチバイト形式で8ビットバイトを含むと仮定する)。
</p><p>オプション引数<em class="replaceable"><code>buffer</code></em>がバッファーを指定する場合、デコードされたテキストは、そのバッファー内のポイントの後に挿入される(ポイントは移動しない)。この場合、リターン値はデコードされたテキストの長さとなる。
</p><a id="idm77699280" class="indexterm"/><p>この関数は、デコードされたテキストに、テキストプロパティ<code class="literal">charset</code>をputする。このプロパティの値は、元のテキストのデコードに使用された、文字セットを示す。
</p><pre class="screen">(decode-coding-string "Gr\374ss Gott" 'latin-1)
     ⇒ #("Grüss Gott" 0 9 (charset iso-8859-1))
</pre></blockquote></div><pre class="synopsis"><a id="idm77696336" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">decode-coding-inserted-region</code> <em class="replaceable"><code>from</code></em> <em class="replaceable"><code>to</code></em> <em class="replaceable"><code>filename</code></em> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>visit</code></em> <em class="replaceable"><code>beg</code></em> <em class="replaceable"><code>end</code></em> <em class="replaceable"><code>replace</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、<em class="replaceable"><code>from</code></em>から<em class="replaceable"><code>to</code></em>のテキストを、あたかもファイル<em class="replaceable"><code>filename</code></em>から、与えられた残りの引数で<code class="literal">insert-file-contents</code>を使用して読み込んだかのようにデコードする。
</p><p>デコードせずにファイルからテキストを読み込んだ後、やはりデコードすることを決心したときに使用するのが、この関数の通常の使い方である。テキストを削除して再度読み込むかわりに、この関数を呼び出せばデコードして読み込むことができる。
</p></blockquote></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="Terminal-I_002fO-Encoding"/>Terminal I/O Encoding</h2></div></div></div><p>Emacsは、キーボード入力のデコード、および端末出力のエンコードにコーディングシステムを使用できます。これはLatin-1のような、特定のエンコーディングを使用したテキストの送信や表示を行う端末にとって有用です。端末I/Oをエンコードまたはデコードする際、Emacsは<code class="literal">last-coding-system-used</code>をセットしません。
</p><pre class="synopsis"><a id="idm77686480" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">keyboard-coding-system</code> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>terminal</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、<em class="replaceable"><code>terminal</code></em>からのキーボード入力をデコードするために使用する、コーディングシステムをリターンする。<code class="literal">no-conversion</code>という値は、何のデコーディングも行われていないことを意味する。<em class="replaceable"><code>terminal</code></em>が省略または<code class="literal">nil</code>なら、それは選択されたフレームの端末を意味する。<a class="link" href="ch29s02.html" title="Multiple Terminals">Multiple
Terminals</a>を参照のこと。
</p></blockquote></div><pre class="synopsis"><a id="idm77647824" class="indexterm"/><span class="category"><span class="bold"><strong>Command</strong></span>:</span> <code class="function">set-keyboard-coding-system</code> <em class="replaceable"><code>coding-system</code></em> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>terminal</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>このコマンドは、<em class="replaceable"><code>terminal</code></em>からのキーボード入力のデコードに使用するコーディングシステムとして、<em class="replaceable"><code>coding-system</code></em>を指定する。<em class="replaceable"><code>coding-system</code></em>が<code class="literal">nil</code>なら、キーボード入力をデコードしないことを意味する。<em class="replaceable"><code>terminal</code></em>がフレームなら、それはそのフレームの端末を意味する。<code class="literal">nil</code>なら、それはカレントで選択されたフレームの端末を意味する。<a class="link" href="ch29s02.html" title="Multiple Terminals">Multiple
Terminals</a>を参照のこと。
</p></blockquote></div><pre class="synopsis"><a id="idm77640784" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">terminal-coding-system</code> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>terminal</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、<em class="replaceable"><code>terminal</code></em>からの端末出力のエンコードに使用中のコーディングシステムをリターンする。<code class="literal">no-conversion</code>という値は、何のデコーディングも行われていないことを意味する。<em class="replaceable"><code>terminal</code></em>がフレームなら、それはそのフレームの端末を意味する。<code class="literal">nil</code>なら、それはカレントで選択されたフレームの端末を意味する。
</p></blockquote></div><pre class="synopsis"><a id="idm77635408" class="indexterm"/><span class="category"><span class="bold"><strong>Command</strong></span>:</span> <code class="function">set-terminal-coding-system</code> <em class="replaceable"><code>coding-system</code></em> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>terminal</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、<em class="replaceable"><code>terminal</code></em>からの端末出力のエンコードに使用するためののコーディングシステムとして、<em class="replaceable"><code>coding-system</code></em>を指定する。<em class="replaceable"><code>coding-system</code></em>が<code class="literal">nil</code>なら、端末出力をエンコードしないことを意味する。<em class="replaceable"><code>terminal</code></em>がフレームなら、それはそのフレームの端末を意味する。<code class="literal">nil</code>なら、それはカレントで選択されたフレームの端末を意味する。
</p></blockquote></div></div></div></body></html>