<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Low-Level Network Access</title><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"/></head><body><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="Low_002dLevel-Network"/>Low-Level Network Access</h1></div></div></div><p><code class="literal">make-network-process</code>を使用することにより、<code class="literal">open-network-stream</code>より低レベルでの処理により、ネットワーク接続を作成することもできます。
</p><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="Network-Processes"/><code class="literal">make-network-process</code></h2></div></div></div><p>ネットワーク接続およびネットワークサーバーを作成する基本的な関数は、<code class="literal">make-network-process</code>です。これは与えられた引数に応じて、これらの仕事のいずれかを行うことができます。
</p><pre class="synopsis"><a id="idm78495440" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">make-network-process</code> <em class="replaceable"><code>&amp;rest</code></em> <em class="replaceable"><code>args</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、ネットワーク接続またはサーバーを作成して、それを表すプロセスオブジェクトをリターンする。引数<em class="replaceable"><code>args</code></em>は、キーワード/引数のペアからなるリストである。キーワードの省略は<code class="literal">:coding</code>、<code class="literal">:filter-multibyte</code>、<code class="literal">:reuseaddr</code>を除き、常に値として<code class="literal">nil</code>を指定したのと同じことになる。重要なキーワードを以下に示す(ネットワークオプションに対応するキーワードを、以降のセクションにリストする)。
</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">:name <em class="replaceable"><code>name</code></em>
</span></dt><dd><p>プロセス名として、文字列<em class="replaceable"><code>name</code></em>を使用する。一意にするために、必要に応じて変更され得る。
</p></dd><dt><span class="term">:type <em class="replaceable"><code>type</code></em>
</span></dt><dd><p>コミュニケーションのタイプを指定する。値<code class="literal">nil</code>はストリーム接続(デフォルト)、<code class="literal">datagram</code>はデータグラム接続、<code class="literal">seqpacket</code>は“シーケンスパケットストリーム(sequenced
packet stream)”による接続を指定する。接続およびサーバーの両方で、これらのタイプを指定できる。
</p></dd><dt><span class="term">:server <em class="replaceable"><code>server-flag</code></em>
</span></dt><dd><p><em class="replaceable"><code>server-flag</code></em>が非<code class="literal">nil</code>ならサーバー、それ以外なら接続を作成する。ストリームタイプのサーバーでは、<em class="replaceable"><code>server-flag</code></em>はそのサーバーへの保留中の接続キューの長さを指定する、整数を指定できる。キューのデフォルト長は5。
</p></dd><dt><span class="term">:host <em class="replaceable"><code>host</code></em>
</span></dt><dd><p>接続するホストを指定する。<em class="replaceable"><code>host</code></em>は、ホスト名またはインターネットアドレスを表す文字列、またはローカルホストを表すシンボル<code class="literal">local</code>であること。サーバーのときに<em class="replaceable"><code>host</code></em>を指定する場合は、有効なローカルホストのアドレスを指定しなければならず、そのアドレスに接続するクライアントだけが受け入れられるだろう。
</p></dd><dt><span class="term">:service <em class="replaceable"><code>service</code></em>
</span></dt><dd><p><em class="replaceable"><code>service</code></em>は接続先のポート番号、またはサーバーにたいしてはlistenするポート番号である。これはポート番号に変換されるようなサービス名、または直接ポート番号を指定する整数であること。サーバーにたいしては<code class="literal">t</code>も指定でき、これは未使用のポート番号をシステムに選択させることを意味する。
</p></dd><dt><span class="term">:family <em class="replaceable"><code>family</code></em>
</span></dt><dd><p><em class="replaceable"><code>family</code></em>は、接続のアドレス(またはプロトコル)のファミリーを指定する。<code class="literal">nil</code>は、与えられた<em class="replaceable"><code>host</code></em>と<em class="replaceable"><code>service</code></em>にたいして、自動的に適切なアドレスファミリーを決定する。<code class="literal">local</code>はUnixのsocketを指定し、この場合<em class="replaceable"><code>host</code></em>は無視される。<code class="literal">ipv4</code>と<code class="literal">ipv6</code>はそれぞれ、IPv4とIPv6の使用を指定する。
</p></dd><dt><span class="term">:local <em class="replaceable"><code>local-address</code></em>
</span></dt><dd><p>サーバープロセスでは、<em class="replaceable"><code>local-address</code></em>はlistenするアドレスである。これは<em class="replaceable"><code>family</code></em>、<em class="replaceable"><code>host</code></em>、<em class="replaceable"><code>service</code></em>をオーバーライドするので、これらを指定しないこともできる。
</p></dd><dt><span class="term">:remote <em class="replaceable"><code>remote-address</code></em>
</span></dt><dd><p>接続プロセスでは、<em class="replaceable"><code>remote-address</code></em>は接続先のアドレスである。これは<em class="replaceable"><code>family</code></em>、<em class="replaceable"><code>host</code></em>、<em class="replaceable"><code>service</code></em>をオーバーライドするので、これらを指定しないこともできる。
</p><p>データグラムサーバーでは、<em class="replaceable"><code>remote-address</code></em>はリモートデータグラムアドレスの初期セッティングを指定する。
</p><p><em class="replaceable"><code>local-address</code></em>と<em class="replaceable"><code>remote-address</code></em>のフォーマットは、そのアドレスファミリーに依存する:
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>- IPv4アドレスは、4つの8ビット整数と1つの16ビット整数からなる5要素のベクター<code class="literal">[<em class="replaceable"><code>a</code></em> <em class="replaceable"><code>b</code></em> <em class="replaceable"><code>c</code></em>
<em class="replaceable"><code>d</code></em>
<em class="replaceable"><code>p</code></em>]</code>で表され、それぞれ数値的なIPv4アドレス<em class="replaceable"><code>a</code></em>.<em class="replaceable"><code>b</code></em>.<em class="replaceable"><code>c</code></em>.<em class="replaceable"><code>d</code></em>、およびポート番号<em class="replaceable"><code>p</code></em>に対応する。
</p></li><li class="listitem"><p>- IPv6アドレスは、9要素の16ビット整数ベクター<code class="literal">[<em class="replaceable"><code>a</code></em> <em class="replaceable"><code>b</code></em> <em class="replaceable"><code>c</code></em> <em class="replaceable"><code>d</code></em> <em class="replaceable"><code>e</code></em>
<em class="replaceable"><code>f</code></em> <em class="replaceable"><code>g</code></em> <em class="replaceable"><code>h</code></em>
<em class="replaceable"><code>p</code></em>]</code>で表され、それぞれ数値的なIPv６アドレス<em class="replaceable"><code>a</code></em>:<em class="replaceable"><code>b</code></em>:<em class="replaceable"><code>c</code></em>:<em class="replaceable"><code>d</code></em>:<em class="replaceable"><code>e</code></em>:<em class="replaceable"><code>f</code></em>:<em class="replaceable"><code>g</code></em>:<em class="replaceable"><code>h</code></em>、およびポート番号<em class="replaceable"><code>p</code></em>に対応する。
</p></li><li class="listitem"><p>- ローカルアドレスは、ローカルアドレススペース内でアドレスを指定する文字列として表される。
</p></li><li class="listitem"><p>- “未サポートファミリー(unsupported family)”のアドレスは、コンスセル<code class="literal">(<em class="replaceable"><code>f</code></em>
.
<em class="replaceable"><code>av</code></em>)</code>で表される。ここで<em class="replaceable"><code>f</code></em>はファミリー名、<em class="replaceable"><code>av</code></em>はアドレスデータバイトごとに1つの要素を使用する、ソケットアドレスを指定するベクターである。可搬性のあるコードでこのフォーマットを信頼してはならない。これは実装定義の定数、データサイズ、データ構造のアライメントに依存する可能性があるからだ。
</p></li></ul></div></dd><dt><span class="term">:nowait <em class="replaceable"><code>bool</code></em>
</span></dt><dd><p>ストリーム接続にたいして<em class="replaceable"><code>bool</code></em>が非<code class="literal">nil</code>なら、その接続の完了を待機せずにリターンする。接続が成功または失敗時には、Emacsは<code class="literal">"open"</code>(成功時)、または<code class="literal">"failed"</code>(失敗時)にマッチするような第2引数により、センチネル関数を呼び出すだろう。デフォルトではwaitせずにblockするので、<code class="literal">make-network-process</code>はその接続が成功または失敗するまで、リターンしない。
</p></dd><dt><span class="term">:stop <em class="replaceable"><code>stopped</code></em>
</span></dt><dd><p><em class="replaceable"><code>stopped</code></em>が非<code class="literal">nil</code>なら、“stopped”の状態でネットワーク接続、またはサーバーを開始する。
</p></dd><dt><span class="term">:buffer <em class="replaceable"><code>buffer</code></em>
</span></dt><dd><p>プロセスバッファーとして<em class="replaceable"><code>buffer</code></em>を使用する。
</p></dd><dt><span class="term">:coding <em class="replaceable"><code>coding</code></em>
</span></dt><dd><p>このプロセスにたいするコーディングシステムとして、<em class="replaceable"><code>coding</code></em>を使用する。接続からのデータのデコード、および接続への送信データのエンコードに異なるコーディングシステムを指定するには、<em class="replaceable"><code>coding</code></em>にたいして<code class="literal">(<em class="replaceable"><code>decoding</code></em>
.  <em class="replaceable"><code>encoding</code></em>)</code>と指定する。
</p><p>このキーワードをまったく指定しないかった場合のデフォルトは、そのデータからコーディングシステムを判断する。
</p></dd><dt><span class="term">:noquery <em class="replaceable"><code>query-flag</code></em>
</span></dt><dd><p>プロセスqueryフラグを<em class="replaceable"><code>query-flag</code></em>に初期化する。<a class="link" href="ch37s11.html" title="Querying Before Exit">Query Before Exit</a>を参照のこと。
</p></dd><dt><span class="term">:filter <em class="replaceable"><code>filter</code></em>
</span></dt><dd><p>プロセスフィルターを<em class="replaceable"><code>filter</code></em>に初期化する。
</p></dd><dt><span class="term">:filter-multibyte <em class="replaceable"><code>multibyte</code></em>
</span></dt><dd><p><em class="replaceable"><code>multibyte</code></em>が非<code class="literal">nil</code>ならマルチバイト文字列、それ以外ならユニバイト文字列がプロセスフィルターに与えられるデフォルトは、<code class="literal">enable-multibyte-characters</code>のデフォルト値である。
</p></dd><dt><span class="term">:sentinel <em class="replaceable"><code>sentinel</code></em>
</span></dt><dd><p>プロセスセンチネルを<em class="replaceable"><code>sentinel</code></em>に初期化する。
</p></dd><dt><span class="term">:log <em class="replaceable"><code>log</code></em>
</span></dt><dd><p>サーバープロセスのlog関数を、<em class="replaceable"><code>log</code></em>に初期化する。サーバーがクライアントからネットワーク接続をacceptするたびに、そのlog関数が呼び出される。log関数に渡される引数は<em class="replaceable"><code>server</code></em>、<em class="replaceable"><code>connection</code></em>、<em class="replaceable"><code>message</code></em>である。ここで<em class="replaceable"><code>server</code></em>はサーバープロセス、<em class="replaceable"><code>connection</code></em>はその接続にたいする新たなプロセス、<em class="replaceable"><code>message</code></em>は何が発生したかを説明する文字列である。
</p></dd><dt><span class="term">:plist <em class="replaceable"><code>plist</code></em>
</span></dt><dd><p>プロセスplistを<em class="replaceable"><code>plist</code></em>に初期化する。
</p></dd></dl></div><p>実際の接続情報で修正されたオリジナルの引数リストは、<code class="literal">process-contact</code>を通じて利用できる。
</p></blockquote></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="Network-Options"/>Network Options</h2></div></div></div><p>以下のネットワークオプションは、ネットワークプロセス作成時に指定できます。<code class="literal">:reuseaddr</code>を除き、<code class="literal">set-network-process-option</code>を使用して、これらのオプションを後からセットまたは変更することもできます。
</p><p>サーバープロセスにたいしては、<code class="literal">make-network-process</code>で指定されたオプションはクライアントに継承されないので、子接続が作成されるたびに、必要なオプションをセットする必要があるでしょう。
</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">:bindtodevice <em class="replaceable"><code>device-name</code></em>
</span></dt><dd><p><em class="replaceable"><code>device-name</code></em>が空でないネットワークインターフェースを指定する文字列なら、そのインターフェースで受信したパケットだけを処理する。<em class="replaceable"><code>device-name</code></em>が<code class="literal">nil</code>(デフォルト)なら、任意のインターフェースが受信したパケットを処理する。
</p><p>このオプションの使用にたいして、特別な特権を要求するシステムがいくつかあるかもしれない。
</p></dd><dt><span class="term">:broadcast <em class="replaceable"><code>broadcast-flag</code></em>
</span></dt><dd><p>データグラムプロセスにたいして<em class="replaceable"><code>broadcast-flag</code></em>が非<code class="literal">nil</code>なら、そのプロセスはブロードキャストアドレスに送信されたデータグラムパケットを受信し、ブロードキャストアドレスにパケットを送信できるだろう。これはストリーム接続では無視される。
</p></dd><dt><span class="term">:dontroute <em class="replaceable"><code>dontroute-flag</code></em>
</span></dt><dd><p><em class="replaceable"><code>dontroute-flag</code></em>が非<code class="literal">nil</code>なら、プロセスはローカルホストと同一ネットワーク上のホストだけに送信することができる。
</p></dd><dt><span class="term">:keepalive <em class="replaceable"><code>keepalive-flag</code></em>
</span></dt><dd><p>ストリーム接続にたいして<em class="replaceable"><code>keepalive-flag</code></em>が非<code class="literal">nil</code>なら、低レベルのkeep-aliveメッセージの交換が有効になる。
</p></dd><dt><span class="term">:linger <em class="replaceable"><code>linger-arg</code></em>
</span></dt><dd><p><em class="replaceable"><code>linger-arg</code></em>が非<code class="literal">nil</code>なら、接続を削除(<code class="literal">delete-process</code>を参照)する前にキューされたすべてのパケットの送信が成功するまで待機する。<em class="replaceable"><code>linger-arg</code></em>が整数なら、接続クローズ前のキュー済みパケット送信のために待機する、最大の秒数を指定する。デフォルトは<code class="literal">nil</code>で、これはプロセス削除時に未送信のキュー済みパケットを破棄することを意味する。
</p></dd><dt><span class="term">:oobinline <em class="replaceable"><code>oobinline-flag</code></em>
</span></dt><dd><p>ストリーム接続にたいして<em class="replaceable"><code>oobinline-flag</code></em>が非<code class="literal">nil</code>なら、通常のデータストリーム内の帯域外(out-of-band)データを受信し、それ以外なら帯域外データは破棄する。
</p></dd><dt><span class="term">:priority <em class="replaceable"><code>priority</code></em>
</span></dt><dd><p>この接続で送信するパケットの優先順位を、整数<em class="replaceable"><code>priority</code></em>にセットする。たとえばこの接続で送信するIPパケットのTOS(type of
service)フィールドにセットする等、この数字の解釈はプロトコル固有である。また、そのネットワークインターフェース上で特定の出力キューを選択する等、これにはシステム依存の効果もある。
</p></dd><dt><span class="term">:reuseaddr <em class="replaceable"><code>reuseaddr-flag</code></em>
</span></dt><dd><p>ストリームプロセスサーバーにたいして<em class="replaceable"><code>reuseaddr-flag</code></em>が非<code class="literal">nil</code>(デフォルト)なら、そのホスト上の別プロセスがそのポートですでにlistenしていなければ、このサーバーは特定のポート番号(<code class="literal">:service</code>を参照)を再使用できる。<em class="replaceable"><code>reuseaddr-flag</code></em>が<code class="literal">nil</code>なら、(そのホスト上の任意のプロセスが)そのポートを最後に使用した後、そのポート上で新たなサーバーを作成するのが不可能となるような、一定の期間が存在するかもしれない。
</p></dd></dl></div><pre class="synopsis"><a id="idm78382928" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">set-network-process-option</code> <em class="replaceable"><code>process</code></em> <em class="replaceable"><code>option</code></em> <em class="replaceable"><code>value</code></em> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>no-error</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数はネットワークプロセス<em class="replaceable"><code>process</code></em>にたいして、ネットワークオプションのセットまたは変更を行う。指定できるオプションは<code class="literal">make-network-process</code>と同様。<em class="replaceable"><code>no-error</code></em>が非<code class="literal">nil</code>なら、<em class="replaceable"><code>option</code></em>がサポートされないオプションの場合に、この関数はエラーをシグナルせずに、<code class="literal">nil</code>をリターンする。この関数が成功裏に完了したら、<code class="literal">t</code>をリターンする。
</p><p>あるオプションのカレントのセッティングは、<code class="literal">process-contact</code>関数を通じて利用できる。
</p></blockquote></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="Network-Feature-Testing"/>Testing Availability of Network Features</h2></div></div></div><p>与えられネットワーク機能が▼利用可能かテストするためには、以下のように<code class="literal">featurep</code>を使用します:
</p><pre class="screen">(featurep 'make-network-process '(<em class="replaceable"><code>keyword</code></em> <em class="replaceable"><code>value</code></em>))
</pre><p>このフォームの結果は、<code class="literal">make-network-process</code>内で<em class="replaceable"><code>keyword</code></em>に値<em class="replaceable"><code>value</code></em>を指定することが機能するなら、<code class="literal">t</code>になります。以下は、この方法でテストできる<em class="replaceable"><code>keyword</code></em>/<em class="replaceable"><code>value</code></em>ペアーのいくつかです。
</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">(:nowait t)</code>
</span></dt><dd><p>非ブロッキング接続がサポートされていれば非<code class="literal">nil</code>。
</p></dd><dt><span class="term"><code class="literal">(:type datagram)</code>
</span></dt><dd><p>データグラムがサポートされていれば非<code class="literal">nil</code>。
</p></dd><dt><span class="term"><code class="literal">(:family local)</code>
</span></dt><dd><p>ローカルsocket(別名“UNIX domain”)がサポートされていれば非<code class="literal">nil</code>。
</p></dd><dt><span class="term"><code class="literal">(:family ipv6)</code>
</span></dt><dd><p>IPv6がサポートされていれば非<code class="literal">nil</code>。
</p></dd><dt><span class="term"><code class="literal">(:service t)</code>
</span></dt><dd><p>サーバーにたいしてシステムがポートを選択できれば非<code class="literal">nil</code>。
</p></dd></dl></div><p>与えられたネットワークオプションが利用可能かテストするためには、以下のように<code class="literal">featurep</code>を使用します:
</p><pre class="screen">(featurep 'make-network-process '<em class="replaceable"><code>keyword</code></em>)
</pre><p>指定できる<em class="replaceable"><code>keyword</code></em>の値は<code class="literal">:bindtodevice</code>等です。完全なリストは<a class="link" href="ch37s17.html#Network-Options" title="Network Options">Network
Options</a>を参照してください。このフォームは、<code class="literal">make-network-process</code>(または<code class="literal">set-network-process-option</code>)が特定のネットワークオプションをサポートしていれば、非<code class="literal">nil</code>をリターンする。
</p></div></div></body></html>