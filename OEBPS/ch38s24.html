<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Bidirectional Display</title><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"/></head><body><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="Bidirectional-Display"/>Bidirectional Display</h1></div></div></div><a id="idm82590928" class="indexterm"/><a id="idm82590160" class="indexterm"/><p>Emacsはアラビア語、ペルシア語、ヘブライ語のような、水平方向テキストの自然な表示順がR2L(right-to-left:
右から左)に実行されるようなスクリプトで記述されたテキストを表示できます。さらにL2R(right-to-left:
左から右)のテキストに埋め込まれたR2Lスクリプト(例:
プログラムソースファイル内のアラビア語やヘブライ語のコメント)は適宜右から左にR2Lに表示される一方、ラテンスクリプト部やR2Lテキストに埋め込まれた数字はL2Rで表示されます。わたしたちは、そのようなL2RとR2Lが混交されたテキストを<em class="firstterm">双方向テキスト(bidirectional
text)</em>と呼びます。このセクションでは、双方向テキストの編集と表示にたいする機能とオプションんついて説明します。
</p><a id="idm82588624" class="indexterm"/><a id="idm82587856" class="indexterm"/><a id="idm82587088" class="indexterm"/><a id="idm82586320" class="indexterm"/><a id="idm82585552" class="indexterm"/><a id="idm82572496" class="indexterm"/><a id="idm82571728" class="indexterm"/><p>テキストは<em class="firstterm">ロジカル</em>な順序(または<em class="firstterm">読込順</em>)、すなわち人間が各文字を読み込むであろう順序で、テキストをEmacsバッファーおよび文字列に格納します。R2Lおよび双方向テキストでは、スクリーン上で文字が表示される順序(<em class="firstterm">ビジュアル順</em>と呼ばれる)はロジカル順と同一ではありません。それら各文字のスクリーン位置は、文字列またはバッファー位置により単調に増加しません。この<em class="firstterm">双方向の並べ替え(bidirectional
reordering)</em>を処理を行うに際、EmacsはUnicode双方向アルゴリズム(<acronym class="acronym">UBA</acronym>： Unicode
Bidirectional
Algorithm)にしたがいます(<a class="ulink" href="http://www.unicode.org/reports/tr9/">http://www.unicode.org/reports/tr9/</a>)。現在のところEmacsは、<acronym class="acronym">UBA</acronym>の“Non-isolate
Bidirectionality(双方向非分離)”なクラスの実装を提供します。これはまだ、Unicode Standard
v6.3.0で提唱された方向分離フォーマットをサポートしていません。
</p><pre class="synopsis"><a id="idm82567504" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">bidi-display-reordering</code></pre><div class="blockquote"><blockquote class="blockquote"><p>このバッファーローカル変数の値が非<code class="literal">nil</code>(デフォルト)なら、Emacsは表示で双方向の並べ替えを行う。この並べ替えはバッファーテキスト、同様に文字列表示やバッファー内のテキストプロパティやオーバーレイプロパティ由来のオーバーレイ文字列に効果を及ぼす(<a class="link" href="ch38s09.html#Overlay-Properties" title="Overlay Properties">Overlay
Properties</a>および<a class="link" href="ch38s16.html" title="The display Property">Display
Property</a>を参照)。値が<code class="literal">nil</code>なら、Emacsはバッファー内での双方向の並べ替えを行わない。
</p><p><code class="literal">bidi-display-reordering</code>のデフォルト値は、モードライン内に表示されるテキスト(<a class="link" href="ch23s04.html" title="Mode Line Format">Mode Line
Format</a>を参照)、およびヘッダー行(<a class="link" href="ch23s04.html#Header-Lines" title="Window Header Lines">Header
Lines</a>を参照)を含む、バッファーにより直接提供されない文字列の並べ替えを制御する。
</p></blockquote></div><a id="idm82561104" class="indexterm"/><p>たとえバッファーの<code class="literal">bidi-display-reordering</code>が非<code class="literal">nil</code>でも、Emacsがユニバイトバッファーのテキストの並べ替えを行うことはありません。これはユニバイトバッファーに含まれるのが文字ではなくrawバイトであり、並べ替えに要する方向的なプロパティを欠くからです。したがって、あるバッファーのテキストが並べ替えられるかどうかテストするには、<code class="literal">bidi-display-reordering</code>のテスト単独では不十分です。正しいテストは以下のようになります:
</p><pre class="screen"> (if (and enable-multibyte-characters
          bidi-display-reordering)
     ;; 表示時にバッファーは並べ替えられるだろう
   )
</pre><p>とはいえ、親バッファーが並べ替えられた際には、ユニバイト表示およびオーバーレイ文字列は<span class="emphasis"><em>並べ替えられます</em></span>。これはEmacsにより、プレーンASCII文字列がユニバイト文字列に格納されるからです。ユニバイト表示またはオーバーレイ文字列が非ASCII文字列を含むなら、それらの文字はL2Rの方向をもつとみなされます。
</p><a id="idm82557136" class="indexterm"/><p>テキストプロパティ<code class="literal">display</code>、値が文字列であるような<code class="literal">display</code>プロパティによるオーバーレイ、バッファーテキストを置換するその他任意のプロパティにカバーされたテキストは、表示時の並べ替え時に単一の単位として扱われます。つまり、これらのプロパティにカバーされたテキストのchunk全体が、一緒に並べ替えられます。さらに、そのようなテキストchunk内の文字の双方向的なプロパティは無視され、Emacsはあたかもそれらが<em class="firstterm">オブジェクト置換文字(Object
Replacement
Character)</em>として知られる単一文字で置換されたかのように、それらを並べ替えます。これは、テキスト範囲上にdisplayプロパティを配すことにより、表示時に周辺テキストを並べ替える方法が変更され得ることを意味しています。このような予期せぬ効果を防ぐには、常に周辺テキストと等しい方向のテキストにたいしてそのようなプロパティを配してください。
</p><a id="idm82554576" class="indexterm"/><p>双方向テキストのパラグラフはそれぞれ、R2LまたはL2Rいずれかの<em class="firstterm">基本方向(base
direction)</em>をもちます。L2Rパラグラフは、そのウィンドウの左マージンを先頭に表示され、そのテキストが右マージンに達したら切り詰め、または継続されます。R2Lパラグラフは、そのウィンドウの右マージンを先頭に表示され、そのテキストが左マージンに達したら切り詰め、または継続されます。
</p><p>デフォルトでは、Emacsはテキスト先頭を調べることにより、各パラグラフの基本方向を判断します。基本方向の精細な決定手法は<acronym class="acronym">UBA</acronym>により指定されており、簡潔に言うとその明示にな方向生をもつそのパラグラフ内の最初の文字が、そのパラグラフの基本方向を決定します。とはいえ、あるバッファーが自身のパラグラフにたいして、特定の基本方向の強制を要する場合もあります。たとえば、プログラムソースコードを含むバッファーは、すべてのパラグラフがL2Rで表示されるよう強制されるべきでしょう。これを行うために、以下の変数を使用できます:
</p><pre class="synopsis"><a id="idm82547920" class="indexterm"/><span class="category"><span class="bold"><strong>Variable</strong></span>:</span> <code class="varname">bidi-paragraph-direction</code></pre><div class="blockquote"><blockquote class="blockquote"><p>このバッファーローカル変数の値が、<code class="literal">right-to-left</code>または<code class="literal">left-to-right</code>いずれかのシンボルなら、そのバッファー内のすべてのパラグラフがその指定された方向をもつとみなされる。その他すべての値は<code class="literal">nil</code>(デフォルト)と等価であり、各パラグラフの基本方向はその内容により判断されることを意味する。
</p><a id="idm82543952" class="indexterm"/><p>プログラムソースコードにたいするモードは、これを<code class="literal">left-to-right</code>にセットすること。Progモードはデフォルトでこれを行うので、Progモードから派生したモードは、これを明示的にセットする必要はない(<a class="link" href="ch23s02.html#Basic-Major-Modes" title="Basic Major Modes">Basic
Major Modes</a>を参照)。
</p></blockquote></div><pre class="synopsis"><a id="idm82540752" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">current-bidi-paragraph-direction</code> <em class="replaceable"><code>&amp;optional</code></em> <em class="replaceable"><code>buffer</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、<em class="replaceable"><code>buffer</code></em>という名前のバッファーのポイント位置のパラグラフ方向をリターンする。リターンされる値は、<code class="literal">left-to-right</code>か<code class="literal">right-to-left</code>いずれかのシンボルである。<em class="replaceable"><code>buffer</code></em>が省略または<code class="literal">nil</code>の場合のデフォルトは、カレントバッファーである。変数<code class="literal">bidi-paragraph-direction</code>のバッファーローカル値が非<code class="literal">nil</code>なら、リターンされる値はその値と等しくなるだろう。それ以外なら、リターンされる値はEmacsにより動的に決定されたそのパラグラフの方向を反映する。<code class="literal">bidi-display-reordering</code>の値が<code class="literal">nil</code>のバッファー、同様にユニバイトバッファーにたいしては、この関数は常に<code class="literal">left-to-right</code>をリターンする。
</p></blockquote></div><a id="idm82528464" class="indexterm"/><p>バッファーのカレントのスクリーン位置にたいして、ビジュアル順に、L2RまたはR2Lいずれかの方向へ、厳密なポイント移動を要す場合があります。Emacsはこれを行うためのプリミティブを提供します。
</p><pre class="synopsis"><a id="idm82527056" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">move-point-visually</code> <em class="replaceable"><code>direction</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、そのバッファーにたいしてカレントで選択されたウィンドウのポイントを、スクリーン上ですぐ右または左のポイントへ移動する。<em class="replaceable"><code>direction</code></em>が正ならスクリーン位置は右へ、それ以外ならスクリーン位置は左へ移動するだろう。周囲の双方向コンテキストに依存して、これは潜在的に多くのバッファーのポイントを移動してしまい得ることに注意。スクリーン行終端で呼び出された場合、この関数は<em class="replaceable"><code>direction</code></em>に応じて適宜、次行または前行の、右端または左端のスクリーン位置にポイントを移動する。
</p><p>この関数はその値として、新たなバッファー位置をリターンする。
</p></blockquote></div><a id="idm82522832" class="indexterm"/><a id="idm82522064" class="indexterm"/><a id="idm82521296" class="indexterm"/><p>バッファー内で双方向の内容をもつ2つの文字列が並置されているときや、プログラムで1つのテキスト文字列に結合した場合、双方向の並べ替えは以外かつ不快な効果を与える可能性があります。典型的な問題ケースはBuffer
MenuモードやRmail
Summaryモードのように、バッファーがスペースや区切り文字分割されたテキストの“フィールド”のシーケンスで構成されているときです。それはセパレーターとして使用されている区切り文字が、<em class="firstterm">弱い方向性</em>をもち、周囲のテキストの方向を採用するためです。結果として、双方向の内容のフィールドが後続する数値フィールドは、先行するフィールドヘ<span class="emphasis"><em>左方向</em></span>に表示され、期待したレイアウトを破壊してしまいます。この問題を回避するための方法がいくつかあります：
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>− 双方向の内容をもち得る各フィールド終端に、スペシャル文字LEFT-TO-RIGHT
MARK(略して<acronym class="acronym">LRM</acronym>)の<code class="literal">U+200E</code>を付加する。後述の関数<code class="literal">bidi-string-mark-left-to-right</code>は、この目的に手頃である。(R2LパラグラフではかわりにRIGHT-TO-LEFT
MARK、略して<acronym class="acronym">RLM</acronym>の<code class="literal">U+200F</code>を使用する。) これはUBAにより推奨される解決策の1つである。
</p></li><li class="listitem"><p>− フィールドセパレーターにタブ文字を含める。タブ文字は双方向の並べ替えにおいて<em class="firstterm">セグメントセパレーター(segment
separator)</em>の役割を演じ、両側のテキストを個別に並べ替えさせる。
</p></li><li class="listitem"><a id="idm82515408" class="indexterm"/><p><code class="literal">display</code>プロパティ、または<code class="literal">(space . PROPS)</code>という形式の値をもつオーバーレイ(<a class="link" href="ch38s16.html#Specified-Space" title="Specified Spaces">Specified
Space</a>を参照)でフィールドを区切る。Emacsはこのdisplay仕様を<em class="firstterm">パラグラフセパレーター(paragraph
separator)</em>として扱い、両側のテキストを個別に並べ替える。
</p></li></ul></div><pre class="synopsis"><a id="idm82511824" class="indexterm"/><span class="category"><span class="bold"><strong>Function</strong></span>:</span> <code class="function">bidi-string-mark-left-to-right</code> <em class="replaceable"><code>string</code></em></pre><div class="blockquote"><blockquote class="blockquote"><p>この関数は、結果を安全に他の文字列に結合できるよう、あるいはこの文字列とスクリーン上で次行となる行に関連するレイアウトを乱すことなく、バッファー内の他の文字列に並置できるよう、自身への引数<em class="replaceable"><code>string</code></em>を恐らく変更してリターンする。この関数がリターンする文字列がR2Lパラグラフの一部として表示される文字列なら、それは常に後続するテキストの左に出現するだろう。この関数は自身の引数の文字を検証することにより機能し、もしそれらの文字のいずれかがディスプレイ上の並べ替えを発生し得るなら、この関数はその文字列に<acronym class="acronym">LRM</acronym>文字を付加する。付加された<acronym class="acronym">LRM</acronym>文字はテキストプロパティ<code class="literal">invisible</code>に<code class="literal">t</code>を与えることにより、不可視にできる(<a class="link" href="ch38s06.html" title="Invisible Text">Invisible
Text</a>を参照)。
</p></blockquote></div><p>並べ替えアルゴリズムは、<code class="literal">bidi-class</code>プロパティとして格納された、その文字の双方向プロパティを使用します(<a class="link" href="ch33s06.html" title="Character Properties">Character
Properties</a>を参照)。Lispプログラムは<code class="literal">put-char-code-property</code>関数を呼び出すことにより、これらのプロパティを変更できます。しかしこれを行うには<acronym class="acronym">UBA</acronym>の完全な理解が要求されるので、推奨しません。ある文字の双方向プロパティにたいする任意の変更は、グローバルな効果をもちます。これらはEmacsのフレームのすべてのフレームとウィンドウに影響します。
</p><p>同様に、<code class="literal">mirroring</code>プロパティは、並べ替えられたテキスト内の、適切にミラーされた文字の表示に使用されます。Lispプログラムは、このプロパティを変更することにより、ミラーされた表示に影響を与えることができます。繰り返しますが、そのような変更はEmacsのすべての表示に影響を与えます。










</p></div></body></html>