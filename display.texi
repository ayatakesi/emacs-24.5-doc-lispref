@c ===========================================================================
@c
@c This file was generated with po4a. Translate the source file.
@c
@c ===========================================================================
@c -*-texinfo-*-
@c This is part of the GNU Emacs Lisp Reference Manual.
@c Copyright (C) 1990-1995, 1998-2015 Free Software Foundation, Inc.
@c See the file elisp.texi for copying conditions.
@node Display
@chapter Emacs Display

  このチャプターでは、Emacsによるユーザーへのプレゼンテーションである、表示に関連する機能のいくつかを説明します。

@menu
* Refresh Screen::           スクリーン上にあるすべてのもののクリアーと再描画。
* Forcing Redisplay::        再描画の強制。
* Truncation::               長いテキストの折り畳みと折り返し。
* The Echo Area::            スクリーン最下部へのメッセージ表示。
* Warnings::                 ユーザーへの警告メッセージの表示。
* Invisible Text::           バッファーのテキストの一部を隠す。
* Selective Display::        バッファーのテキストの一部を隠す(旧来の方式)。
* Temporary Displays::       自動的に消える表示。
* Overlays::                 オーバーレイを使用したバッファーの一部のハイライト。
* Size of Displayed Text::   表示されたテキストの大きさ。
* Line Height::              行の高さの制御。
* Faces::                    テキスト文字のグラフィカルスタイル(フォント、カラー等)を定義するフェイス。
* Fringes::                  ウィンドウフリンジの制御。
* Scroll Bars::              垂直スクロールバーの制御。
* Window Dividers::          ウィンドウを視覚的に区別する。
* Display Property::         特別な表示機能の有効化。
* Images::                   Emacsバッファー内でのイメージ表示。
* Buttons::                  Emacsバッファー内へのイメージ表示クリック可能ボタン追加。
* Abstract Display::         オブジェクトコレクション用のEmacsウィジェット。
* Blinking::                 Emacsがマッチする開カッコを表示する方法。
* Character Display::        Emacsがマッチする個々の文字を表示する方法。
* Beeping::                  ユーザーへの可聴シグナル。
* Window Systems::           どのウィンドウシステムが使用されているか。
* Bidirectional Display::    アラビア語やペルシア語のような、双方向スクリプトの表示。
@end menu

@node Refresh Screen
@section Refreshing the Screen
@cindex refresh the screen
@cindex screen refresh

  関数@code{redraw-frame}は、与えられたフレーム(@ref{Frames}を参照)のコンテンツ全体にたいして、クリアーおよび再描画を行います。これはスクリーンが壊れている(corrupted)場合に有用です。

@defun redraw-frame frame
この関数は、フレーム@var{frame}のクリアーと再描画を行う。
@end defun

  更に強力なのが@code{redraw-display}です:

@deffn Command redraw-display
この関数は、すべての可視なフレームのクリアーと再描画を行う。
@end deffn

  Emacsでは、ユーザー入力は再描画より優先されます。入力が可能なときにこれらの関数を呼び出すと、これらはすぐに再描画はしませんが、要求された再描画はやがて、すべての入力処理後に行われます。

  テキスト端末では、Emacsのサスペントと再開により、通常はスクリーンのリフレッシュも行われます。Emacsのようなディスプレイ指向のプログラムと、通常のシーケンシャル表示のプログラムで、コンテンツを区別して記録する端末エミュレーターがいくつかあります。そのような端末を使用する場合は、おそらく再開時の再表示を抑制したいでしょう。

@defopt no-redraw-on-reenter
@cindex suspend (cf. @code{no-redraw-on-reenter})
@cindex resume (cf. @code{no-redraw-on-reenter})
この変数は、Emacsがサスペンドおよび再開された後に、スクリーン全体を再描画するかどうかを制御する。非@code{nil}なら再描画は不要、@code{nil}なら再描画が必要であることを意味する。デフォルトは@code{nil}。
@end defopt

@node Forcing Redisplay
@section Forcing Redisplay
@cindex forcing redisplay

  Emacsは入力の待機時は常に、再表示を試みます。以下の関数により、実際に入力を待機することなく、Lispコードの中から、即座に再表示を試みることを要求できます。

@defun redisplay &optional force
この関数は、即座に再表示を試みる。オプション引数@var{force}が非@code{nil}なら、入力が保留中に横取りされるかわりに、強制的に再表示が行われる。

この関数は実際に再表示が試行されたなら@code{t}、それ以外は@code{nil}をリターンする。@code{t}という値は、再表示の試行が完了したことを意味しない。新たに到着した入力に横取りされた可能性がある。
@end defun

@defvar pre-redisplay-function
再表示の直前に実行される関数。これは、再表示されるウィンドウセットを単一の引数として呼び出される。
@end defvar

  @code{redisplay}が即座に再表示を試みたとしても、Emacsがフレーム(複数可)のどの部分を再表示するか決定する方法を変更するわけではありません。それとは対照的に、以下の関数は特定のウィンドウを(あたかもコンテンツが完全に変更されたかのように)、保留中の再表示処理に追加します。しかし再描画を即座には試みません。

@defun force-window-update &optional object
この関数は、Emacsが次に再表示を行う際にいくつか、あるいはすべてのウィンドウが更新されるよう強制する。@var{object}がウィンドウならそのウィンドウ、バッファーまたはバッファー名ならそのバッファーを表示するすべてのウィンドウ、@code{nil}(または省略)の場合はすべてのウィンドウが更新される。

この関数は、即座に再表示を行わない。再表示はEmacsが入力を待機時、または関数@code{redisplay}呼び出し時に行われる。
@end defun

@node Truncation
@section Truncation
@cindex line wrapping
@cindex line truncation
@cindex continuation lines
@cindex @samp{$} in display
@cindex @samp{\} in display

  テキスト行がウィンドウ右端を超過する際、Emacsはその行を@dfn{継続(continue)}させる(次のスクリーン行へ``wrap''、すなわち折り返す)か、あるいはその行を@dfn{切り詰める(truncate)}て表示(その行をスクリーン行の1行に制限)することができます。長いテキスト行を表示するために使用される追加のスクリーン行は、@dfn{継続(continuation)}行と呼ばれます。継続はフィルとは異なります。継続はバッファーのコンテンツ内ではなくスクリーン上でのみ発生し、単語境界ではなく正確に右マージンで行をブレークします。@ref{Filling}を参照してください。

   グラフィカルなディスプレイでは、切り詰めと継続はウィンドウフリンジ内の小さな矢印イメージで示されます(@ref{Fringes}を参照)。テキスト端末では、切り詰めはそのウィンドウの最右列の@samp{$}、``折り返し''は最右列の@samp{\}で示されます(ディスプレイテーブルにより、これを行うための代替え文字を指定できる。@ref{Display
Tables}を参照されたい)。

@defopt truncate-lines
このバッファーローカル変数が非@code{nil}なら、ウィンドウ右端を超過する行は切り詰められ、それ以外なら継続される。特別な例外として、@dfn{部分幅(partial-width)}ウィンドウ(フレーム全体の幅を占有しないウィンドウ)では、変数@code{truncate-partial-width-windows}が優先される。
@end defopt

@defopt truncate-partial-width-windows
@cindex partial-width windows
この変数は、@dfn{部分幅(partial-width)}ウィンドウ内の、行の切り詰めを制御する。部分幅ウィンドウとは、フレーム全体の幅を占有しないウィンドウである(@ref{Splitting
Windows}を参照)。値が@code{nil}なら、行の切り詰めは変数@code{truncate-lines}(上記参照)により決定される。値が整数@var{n}の場合は、部分幅ウィンドウの列数が@var{n}より小さければ、@code{truncate-lines}の値とは無関係に行は切り詰められ、部分幅ウィンドウの列数が@var{n}以上なら、行の切り詰めは@code{truncate-lines}により決定される。それ以外の非@code{nil}値では、@code{truncate-lines}の値とは無関係にすべての部分幅ウィンドウで行は切り詰められる。
@end defopt

  ウィンドウ内で水平スクロール(@ref{Horizontal Scrolling}を参照)を使用中は、切り詰めが強制されます。

@defvar wrap-prefix
このバッファーローカル変数が非@code{nil}なら、それはEmacsが各継続行の先頭に表示する、@dfn{折り返しプレフィックス(wrap
prefix)}を定義する(行を切り詰めている場合、@code{wrap-prefix}は使用されない)。この値は文字列、イメージ(@ref{Other
Display
Specs}を参照)、またはディスプレイプロパティ@code{:width}や@code{:align-to}で指定されるような、伸長された空白文字を指定できる(@ref{Specified
Space}を参照)。値はテキストプロパティ@code{display}と同じ方法で解釈される。@ref{Display
Property}を参照のこと。

折り返しプレフィックスは、テキストプロパティまたはオーバーレイプロパティ@code{wrap-prefix}を使用することにより、テキストのリージョンにたいして指定することもできる。これは@code{wrap-prefix}変数より優先される。@ref{Special
Properties}を参照のこと。
@end defvar

@defvar line-prefix
このバッファーローカル変数が非@code{nil}なら、それはEmacsがすべての非継続行の先頭に表示する、@dfn{行プレフィックス(line
prefix)}を定義する。この値は文字列、イメージ(@ref{Other Display
Specs}を参照)、またはディスプレイプロパティ@code{:width}や@code{:align-to}で指定されるような、伸長された空白文字を指定できる(@ref{Specified
Space}を参照)。値はテキストプロパティ@code{display}と同じ方法で解釈される。@ref{Display
Property}を参照のこと。

行プレフィックスは、テキストプロパティまたはオーバーレイプロパティ@code{line-prefix}を使用することにより、テキストのリージョンにたいして指定することもできる。これは@code{line-prefix}変数より優先される。@ref{Special
Properties}を参照のこと。
@end defvar

@ignore
  If your buffer contains only very short lines, you might find it
advisable to set @code{cache-long-scans} to @code{nil}.

@defvar cache-long-scans
If this variable is non-@code{nil} (the default), various indentation
and motion functions, and Emacs redisplay, cache the results of
scanning the buffer, and consult the cache to avoid rescanning regions
of the buffer unless they are modified.

Turning off the cache speeds up processing of short lines somewhat.

This variable is automatically buffer-local in every buffer.
@end defvar
@end ignore

@node The Echo Area
@section The Echo Area
@cindex error display
@cindex echo area

@c FIXME: Why not use @xref{Minibuffers} directly?  --xfq
  @dfn{エコーエリア(echo
area)}はエラーメッセージ(@ref{Errors})や、@code{message}プリミティブで作成されたメッセージの表示、およびキーストロークをエコーするために使用されます。(アクティブ時には)ミニバッファーがスクリーン上のエコーエリアと同じ場所に表示されるという事実にも関わらず、エコーエリアはミニバッファーと同じではありません。@ref{Minibuffer,,
The Minibuffer, emacs, The GNU Emacs Manual}を参照してください。

  このセクションに記述された関数とは別に、出力ストリームとして@code{t}を指定することにより、エコーエリアにLispオブジェクトをプリントできます。@ref{Output
Streams}を参照してください。

@menu
* Displaying Messages::      エコーエリア内に明示的にテキストを表示する。
* Progress::                 長時間の処理の進行状況をユーザーに知らせる。
* Logging Messages::         ユーザー用にログされるエコーエリアメッセージ。
* Echo Area Customization::  エコーエリアの制御。
@end menu

@node Displaying Messages
@subsection Displaying Messages in the Echo Area
@cindex display message in echo area

  このセクションでは、エコーエリア内にメッセージを表示する、標準的な関数を説明します。

@defun message format-string &rest arguments
この関数は、エコーエリア内にメッセージを表示する。@code{format}関数(@ref{Formatting
Strings}を参照)の場合と同様、@var{format-string}はフォーマット文字列、@var{arguments}はそのフォーマット仕様にたいするオブジェクトである。フォーマットされた結果文字列は、エコーエリア内に表示される。それに@code{face}テキストプロパティが含まれる場合、指定されたフェイスにより表示される(@ref{Faces}を参照)。この文字列は@file{*Messages*}バッファーにも追加されるが、テキストプロパティは含まれない(@ref{Logging
Messages}を参照)。

バッチモードでは、後に改行が付加されたメッセージが、標準エラーストリームにプリントされる。

@var{format-string}が@code{nil}か空文字列なら、@code{message}はエコーエリアをクリアーする。エコーエリアが自動的に拡張されていたら、これにより通常のサイズに復元される。ミニバッファーがアクティブなら、これによりスクリーン上に即座にミニバッファーのコンテンツが復元される。

@example
@group
(message "Minibuffer depth is %d."
         (minibuffer-depth))
 @print{} Minibuffer depth is 0.
@result{} "Minibuffer depth is 0."
@end group

@group
---------- Echo Area ----------
Minibuffer depth is 0.
---------- Echo Area ----------
@end group
@end example

エコーエリアやポップバッファー内に、自動的にメッセージを表示するには、そのサイズに応じて@code{display-message-or-buffer}(以下参照)を使用する。
@end defun

@defmac with-temp-message message &rest body
この構成は@var{body}実行の間、エコーエリア内にメッセージを一時的に表示する。これは@var{message}を表示して@var{body}を実行し、それからエコーエリアの前のコンテンツをリストアするとともに、bodyの最後のフォームの値をリターンする。
@end defmac

@defun message-or-box format-string &rest arguments
この関数は@code{message}と同様にメッセージを表示するが、エコーエリアではなくダイアログボックスにメッセージを表示するかもしれない。この関数があるコマンド内からマウスを使用して呼び出された場合
--- より正確には@code{last-nonmenu-event}(@ref{Command Loop
Info}を参照)が@code{nil}かリストなら、そのメッセージの表示にダイアログボックスまたはポップアップメニューを使用する。それ以外の場合は、エコーエリアを使用する(これは@code{y-or-n-p}が同様の決定を行う際に使用する条件と同じである。@ref{Yes-or-No
Queries}を参照されたい)。

呼び出しの前後で@code{last-nonmenu-event}を適切な値にバインドすることにより、エコーエリアでのマウスの使用を強制できる。
@end defun

@defun message-box format-string &rest arguments
@anchor{message-box}
この関数は@code{message}と同様にメッセージを表示するが、利用可能なら常にダイアログボックス(かポップアップメニュー)を使用する。端末がサポートしないために、ダイアログボックスまたはポップアップメニューが使用できなければ、@code{message-box}は@code{message}と同様にエコーエリアを使用する。
@end defun

@defun display-message-or-buffer message &optional buffer-name not-this-window frame
この関数はメッセージ@var{message}を表示する。@var{message}は文字列かバッファーを指定できる。これが@code{max-mini-window-height}で定義されるエコーエリアの最大高さより小さければ、@code{message}を使用してエコーエリアに表示される。それ以外なら、メッセージを表示するために@code{display-buffer}はポップアップバッファーを使用する。

エコーエリアに表示したメッセージ、またはポップアップバッファー使用時はその表示に使用したウィンドウをリターンする。

@var{message}が文字列なら、オプション引数@var{buffer-name}はポップアップバッファー使用時にメッセージ表示に使用するバッファー名(デフォルトは@file{*Message*})である。@var{message}が文字列でエコーエリアに表示されてる場合は、いずれにせよコンテンツをバッファーに挿入するかどうかは指定されない。

オプション引数@var{not-this-window}と@var{frame}は、@code{display-buffer}の場合と同様に、バッファーが表示されている場合のみ使用される。
@end defun

@defun current-message
この関数は、エコーエリア内にカレントで表示されているメッセージ、またはそれが存在しなければ@code{nil}をリターンする。
@end defun

@node Progress
@subsection Reporting Operation Progress
@cindex progress reporting

  処理の完了まで暫く時間を要するかもしれない際は、その進行状況についてユーザーに通知するべきです。これによりユーザーが残り時間を予測するとともに、Emacsがhungしているのではなく、処理中であえうことが明確に確認できます。@dfn{プログレスリポーター(progress
reporter: 進行状況リポーター)}を使用するのが、これを行う便利な方法です。

  以下は、何も有用なことを行わない、実行可能な例です:

@smallexample
(let ((progress-reporter
       (make-progress-reporter "Collecting mana for Emacs..."
                               0  500)))
  (dotimes (k 500)
    (sit-for 0.01)
    (progress-reporter-update progress-reporter k))
  (progress-reporter-done progress-reporter))
@end smallexample

@defun make-progress-reporter message &optional min-value max-value current-value min-change min-time
この関数は、以下に挙げる他の関数として使用されるであろう、プログレスリポーターオブジェクトを作成して、リターンする。これはプログレスリポーターを高速にするように、可能なかぎり多くのデータを事前に計算するというアイデアが元である。

この後にこのプログレスリポーターを使用する際は、進行状況のパーセンテージを後に付加して@var{message}が表示されるだろう。@var{message}は、単なる文字列として扱われる。たとえばファイル名に依存させる必要があるなら、この関数の呼び出し前に、@code{format}を使えばよい。

引数@var{min-value}と@var{max-value}は、その処理の開始と終了を意味する数値であること。たとえばバッファーを``スキャン''する処理なら、これらをそれぞれ@code{point-min}と@code{point-max}にセットするべきだろう。@var{max-value}は@var{min-value}より大であること。

かわりに、@var{min-value}と@var{max-value}を@code{nil}にセットすることができる。この場合、プログレスリポーターは進行状況のパーセンテージを報告しない。かわりにプログレスリポーターを更新するたびに刻み(notch)を回転する``スピナー(spinner)''を表示する。

@var{min-value}と@var{max-value}が数値なら、進行状況の初期の数値を与える引数@var{current-value}を与えることができる。省略時のデフォルトは@var{min-value}。

残りの引数は、エコーエリアの更新レートを制御する。プログレスリポーターは次のメッセージを表示する前に、その処理が少なくとも@var{min-change}パーセントより多く完了するまで待機する。デフォルトは1パーセント。@var{min-time}は連続するプリントの間に空ける最小時間をミリ秒単位で指定する(いくつかのオペレーティングシステムでは、プログレスリポーターは秒の少数部をさまざまな制度で処理するかもしれない)。

この関数は@code{progress-reporter-update}を呼び出すた、最初のメッセージは即座にプリントされる。
@end defun

@defun progress-reporter-update reporter &optional value
この関数は、操作の進行状況報告に関する、主要な機能を担う。これは@var{reporter}のメッセージと、その後に@var{value}により決定された進行状況のパーセンテージを表示する。パーセンテージが0、または引数@var{min-change}と@var{min-time}に比べて十分0に近ければ、出力は省略される。

@var{reporter}は、@code{make-progress-reporter}呼び出しがリターンした結果でなければならない。@var{value}は処理のカレント状況を指定し、@code{make-progress-reporter}に渡された@var{min-value}と@var{max-value}の間(両端を含む)でなければならない。たとえばバッファーのスキャンにおいては、@var{value}は@code{point}び呼び出し結果であるべきだろう。

この関数は@code{make-progress-reporter}に渡された@var{min-change}と@var{min-time}にしたがい、毎回の呼び出しで新たなメッセージを出力しない。したがってこれは非常に高速であり、通常はこれを呼び出す回数を減らすことを試みるべきではない。結果として生じるオーバーヘッドは、あなたの努力をほぼ否定するだろう。
@end defun

@defun progress-reporter-force-update reporter &optional value new-message
この関数は@code{progress-reporter-update}と同様だが、これは無条件にメッセージをエコーエリアにプリントする点が異なる。

最初の2つの引数は、@code{progress-reporter-update}の場合と同じ意味をもつ。オプションの@var{new-message}で、@var{reporter}のメッセージを変更できる。この関数は常にエコーエリアを更新するので、そのような変更は即座にユーザーに示されるだろう。
@end defun

@defun progress-reporter-done reporter
この関数は、処理の完了時に呼び出されるべきである。これはエコーエリア内に、単語``done''が付加された@var{reporter}のメッセージを表示する。

あなたは@code{progress-reporter-update}に``100%''とプリントさせようとせず、常にこの関数を呼び出すべきである。まず、この関数は決してそれをプリントしないだろうし、これが発生しないために多くの正当な理由がある。次に``done''はより自明である。
@end defun

@defmac dotimes-with-progress-reporter (var count [result]) message body@dots{}
これは@code{dotimes}と同じ方法で機能するが、上述の関数を使用してループ進行状況(loop
progress)の報告も行う、便利なマクロである。これにより、タイプ量を幾分節約できる。

以下の方法でこのマクロを使用することにより、このセクション冒頭の例を書き換えることができる:

@example
(dotimes-with-progress-reporter
    (k 500)
    "Collecting some mana for Emacs..."
  (sit-for 0.01))
@end example
@end defmac

@node Logging Messages
@subsection Logging Messages in @file{*Messages*}
@cindex logging echo-area messages

  エコーエリア内に表示されるほとんどすべてのメッセージは、ユーザーが後で参照できるように、@file{*Messages*}バッファー内にも記録されます。これには@code{message}により出力されたメッセージも含まれます。デフォルトではこのバッファーは読み取り専用で、メジャーモード@code{messages-buffer-mode}を使用します。ユーザーによる@file{*Messages*}バッファーのkillを妨げるものは何もありませんが、次回のメッセージ表示でバッファーは再作成されます。@file{*Messages*}バッファーに直接アクセスする必要があり、それが確実に存在するようにしたいLispコードはすべて、関数@code{messages-buffer}を使用するべきです。

@defun messages-buffer
この関数は、@file{*Messages*}バッファーをリターンする。バッファーが存在しなければ作成して、そのバッファーを@code{messages-buffer-mode}に切り替える。
@end defun

@defopt message-log-max
この変数は、@file{*Messages*}バッファー内に保持するべき行数を指定する。値@code{t}は保持すべき行数に制限がないことを意味し、値@code{nil}はメッセージのロギングを完全に無効にする。以下は、メッセージを表示して、それがロギングされることを防ぐ例である:

@example
(let (message-log-max)
  (message @dots{}))
@end example
@end defopt

  @file{*Messages*}にたいするユーザーの利便性を向上させるために、ロギング機能は連続する同じメッセージを結合します。さらに、2つのケースのために連続する関連メッセージの結合も行います。2つのケースとは、応答を後にともなう質問(question
followed by answer)と、一連のプログレスメッセージ(series of progress messages)です。

  ``応答を後にともなう質問(question followed by an
answer)''とは、@code{y-or-n-p}により生成されるような、これは1つ目が@samp{@var{question}}、2つ目が@samp{@var{question}...@var{answer}}のような、2つのメッセージです。1つ目のメッセージには、2つ目のメッセージ以上の追加の情報は伝えないので、2つ目のメッセージをロギングして、1つ目のメッセージは破棄します。

  ``一連のプログレスメッセージ(series of progress
messages)''とは、@code{make-progress-reporter}が生成するような、連続するメッセージを意味します。これらは@samp{@var{base}...@var{how-far}}のような形式をもち、@var{how-far}は毎回異なりますが、@var{base}は常に同じです。このシリーズ内の各メッセージのロギングでは、そのメッセージが前のメッセージと連続していれば、前のメッセージを破棄します。

  関数@code{make-progress-reporter}および@code{y-or-n-p}は、メッセージログ結合機能をアクティブにするために、何ら特別なことを行う必要はありません。これは@samp{...}で終わる共通のプレフィックスを共有する、連続する2つのメッセージをログする際は、常にこの処理を行います。

@node Echo Area Customization
@subsection Echo Area Customization
@cindex echo area customization

  以下の変数は、エコーエリアが機能する方法の詳細を制御します。

@defvar cursor-in-echo-area
この変数は、エコーエリア内にメッセージ表示時に、カーソルを表示する場所を制御する。これが非@code{nil}なら、カーソルはメッセージの終端に表示される。それ以外なら、カーソルはエコーエリア内ではなく、ポイント位置に表示される。

この値は、通常は@code{nil}である。Lispプログラムは短時間の間、これを@code{t}にバインドする。
@end defvar

@defvar echo-area-clear-hook
このノーマルフックは@code{(message nil)}、または別の何らかの理由によりエコーエリアが作成されると、常に実行される。
@end defvar

@defopt echo-keystrokes
この変数は、コマンド文字をエコーする前に、どれだけの時間を待機するかを決定する。この値は数字でなければならず、エコー前に待機する秒数を指定する。ユーザーが(@kbd{C-x}のような)プレフィックスキーをタイプしてから、継続してタイプを継続するのをこの秒数遅延した場合、エコーエリア内にそのプレフィックスキーがエコーされる(あるキーシーケンスで一度エコーが開始されると、同一のキーシーケンス内の後続するすべての文字は、即座にエコーされる)。

値が0なら、コマンド入力はエコーされない。
@end defopt

@defvar message-truncate-lines
通常、長いメッセージの表示により、そのメッセージ全体を表示するために、エコーエリアはリサイズされる。しかし変数@code{message-truncate-lines}が非@code{nil}なら、エコーエリアをリサイズせず、エコーエリアに収まるようメッセージは切り詰められる。
@end defvar

  ミニバッファーウィンドウのリサイズの最大高さを指定する変数@code{max-mini-window-height}は、エコーエリアにも適用される(エコーエリアは真にミニバッファーウィンドウの特殊な使い方である。@ref{Minibuffer
Misc}を参照されたい)。

@node Warnings
@section Reporting Warnings
@cindex warnings

  @dfn{警告(warnings)}とは、プログラムがユーザーにたいして問題の可能性を知らせるが、実行は継続するための機能です。

@menu
* Warning Basics::           警告の概念と、それらを報告するための関数。
* Warning Variables::        プログラムが警告をカスタマイズするためにバインドする変数。
* Warning Options::          ユーザーが警告の表示を制御するためにセットする変数。
* Delayed Warnings::         コマンド終了まで警告を延期する。
@end menu

@node Warning Basics
@subsection Warning Basics
@cindex severity level

  すべての警告は、ユーザーに問題を説明するためのテキストのメッセージと、@dfn{重大レベル(severity
level)}をもっています。重大レベルはシンボルです。以下は可能性のある重大レベルとその意味を、重大度の降順でリストしたものです:

@table @code
@item :emergency
直ちに対処しなければ、Emacs処理が間もなく深刻に害される問題。
@item :error
本質的に悪いデータまたは状況のリポート。
@item :warning
本質的に悪くはないが、可能性のある問題を励起する恐れのあるデータまたは状況のリポート。
@item :debug
デバッグ中なら有用かもしれない情報のリポート。
@end table

  あなたのプログラムが無効な入力データに遭遇した際には、@code{error}呼び出しによるLispエラーのシグナルするか、または重大度@code{:error}の警告をリポートすることができます。Lispエラーのシグナルはもっとも簡単に行えることですが、それはプログラムが処理を継続できないことを意味します。間違ったデータでも処理を継続するための方法を実装するために、そのトラブルを受け取めたい場合には、その問題をユーザーに知らせるために、重大度@code{:error}の警告をリポートするのが正しい方法です。たとえばEmacs
Lispバイトコンパイラーはこの方法によりエラーを報告して、他の関数のコンパイルを継続できます(プログラムがLispエラーをシグナルして、それを@code{condition-case}でhandleしたなら、ユーザーがそのエラーを確認することはないだろう。これは警告としてリポートすることにより、ユーザーにメッセージを示すことができる)。

@c FIXME: Why use "(bytecomp)" instead of "'bytecomp" or simply
@c "bytecomp" here?  The parens are part of warning-type-format but
@c not part of the warning type. --xfq
@cindex warning type
  クラス分けのために、それぞれの警告には@dfn{警告タイプ(warning
type)}があります。このタイプはシンボルのリストです。最初のシンボルは、そのプログラムのユーザーオプションとして使用する、カスタムグループであるべきです。たとえばバイトコンパイラーの警告は、警告タイプ@code{(bytecomp)}を使用します。もし望むなら、このリスト内で更にシンボルを使用することにより、警告をサブカテゴリー化することもできます。

@defun display-warning type message &optional level buffer-name
この関数はメッセージとして@var{message}、警告タイプとして@var{type}を使用して、警告をリポートする。@var{level}は重大レベルであること。デフォルトは@code{:warning}。

@var{buffer-name}が非@code{nil}なら、それは警告をロギングするためのバッファー名を指定する。デフォルトは@file{*Warnings*}。
@end defun

@defun lwarn type level message &rest args
この関数は、@file{*Warnings*}バッファー内のメッセージとして@code{(format @var{message}
@var{args}...)}の値を使用して、、警告をリポートする。他の点では、これは@code{display-warning}と同じである。
@end defun

@defun warn message &rest args
この関数はメッセージとして@code{(format @var{message}
@var{args}...)}の値、タイプとして@code{(emacs)}、重大レベルとして@code{:warning}を使用して、警告をリポートする。これは互換性のためだけに存在する。固有な警告タイプを指定するべきであり、この関数の使用は推奨しない。
@end defun

@node Warning Variables
@subsection Warning Variables
@cindex warning variables

  プログラムは、このセクション内で説明する変数をバインドすることにより、警告が表示される方法をカスタマイズできます。

@defvar warning-levels
このリストは、警告の重大レベルの意味と、重大度の順序を定義する。それぞれの要素は1つの重大レベルを定義し、それらは重大度の降順で配置される。

各要素は@code{(@var{level} @var{string}
@var{function})}という形式をもち、@var{level}はその要素が定義する重大レベルである。@var{string}はそのレベルのテキストによる説明である。@var{string}は警告タイプ情報の配置箇所の指定に@samp{%s}を使用するか、さもなくばその情報を含まぬよう@samp{%s}を省略できる。

オプションの@var{function}が非@code{nil}なら、これはユーザーの注目を得るために引数なしで呼び出される関数であること。

通常は、この変数の値を変更するべきではない。
@end defvar

@defvar warning-prefix-function
値が非@code{nil}なら、それは警告用にプレフィックスを生成する関数であること。プログラムは、この変数を適切な関数にバインドできる。@code{display-warning}はwarningsバッファーがカレントの状態でこの関数を呼び出し、関数はそのバッファーにテキストを挿入できる。そのテキストが、警告メッセージの先頭になる。

この関数は重大レベル、および@code{warning-levels}内でのその重大レベルのエントリーという、2つの引数で呼び出される。これは、エントリーとして使用するためのリストをリターンするべきである(この値は@code{warning-levels}の実際のメンバーである必要はない)。この値を構築することにより、関数はその警告の重大レベルを変更したり、与えられた重大レベルにたいして異なる処理を指定することができる。

この変数の値が@code{nil}なら、呼び出される関数は存在しない。
@end defvar

@defvar warning-series
プログラムは、次の警告がシリーズの開始であることを告げるために、この変数を@code{t}にバインドできる。複数の警告がシリーズを形成するということは、それぞれの警告にたいしてポイントが維持されるよう移動して、最後の警告にポイントが表示されるのではなく、そのシリーズの最初の警告にポイントを残すことを意味する。このシリーズは、そのローカルバインドが非バインドされて、@code{warning-series}が再び@code{nil}になったときに終了する。

この値は、関数定義をもつシンボルでもよい。これは、次の警告によりwarningsバッファーがカレントの状態で、引数なしでその関数が呼び出されることを除き、@code{t}と等価である。この関数は、その警告シリーズのヘッダーの役目をもつであろうテキストを挿入できる。

あるシリーズが開始されると、その値はwarningsバッファー内でシリーズ開始となるバッファー位置を指すマーカーとなる。

この変数の通常の値は@code{nil}で、これはそれぞれの警告を個別に処理することを意味する。
@end defvar

@defvar warning-fill-prefix
この変数が非@code{nil}なら、それは各警告テキストのフィルに使用する、フィルプレフィックスを指定する。
@end defvar

@defvar warning-type-format
この変数は、警告メッセージ内の警告タイプを表示するための、フォーマットを指定する。この方法でフォーマットされたタイプは、@code{warning-levels}内のエントリー内の文字列制御下にあるメッセージに含まれることになる。デフォルト値は@code{"
(%s)"}。これを@code{""}にバインドすると、警告タイプはまったく表示されなくなる。
@end defvar

@node Warning Options
@subsection Warning Options
@cindex warning options

  以下の変数は、何が発生したときにLispプログラムが警告をリポートするかを、ユーザーが制御するために使用されます。

@defopt warning-minimum-level
このユーザーオプションは、ユーザーにたいして即座に表示されるべき、最小の重大レベルを指定する。デフォルトは@code{:warning}で、これは@code{:debug}警告を除くすべての警告が即座に表示されることを意味する。
@end defopt

@defopt warning-minimum-log-level
このユーザーオプションは、warningsバッファー内にログされるべき、最小の重大レベルを指定する。デフォルトは@code{:warning}で、これは@code{:debug}警告を除くすべての警告がログされることを意味する。
@end defopt

@defopt warning-suppress-types
このリストは、ユーザーにたいしてどの警告タイプを即座に表示するべきではないかを指定する。このリスト内の各要素は、シンボルのリストであること。それの要素が警告タイプ内の最初の要素にマッチしたら、その警告は即座に表示されない。
@end defopt

@defopt warning-suppress-log-types
このリストは、ユーザーにたいしてどの警告タイプがwarningsバッファーにログされるべきではないかを指定する。このリスト内の各要素は、シンボルのリストであること。それの要素が警告タイプ内の最初の数要素にマッチしたら、その警告はログされない。
@end defopt

@node Delayed Warnings
@subsection Delayed Warnings
@cindex delayed warnings

コマンド実行中には警告の表示を避けて、コマンドの終わりでのみ警告を表示したいことがあるかもしれません。これは、変数@code{delayed-warnings-list}により行うことができます。

@defvar delayed-warnings-list
この変数の値は、カレントのコマンド完了後に表示される警告のリストである。各要素は以下のようなリストでなければならない:

@smallexample
(@var{type} @var{message} [@var{level} [@var{buffer-name}]])
@end smallexample

@noindent
これらは、は@code{display-warning}の引数リストと同じ形式、同じ意味である(@ref{Warning
Basics}を参照)。@code{post-command-hook}(@ref{Command
Overview}を参照)の実行直後、Emacsのコマンドループはこの変数で指定されたすべての警告を表示してから、変数を@code{nil}にリセットする。
@end defvar

  遅延警告メカニズムをよりカスタマイズする必要があるプログラムは、変数@code{delayed-warnings-hook}を変更することができます:

@defvar delayed-warnings-hook
これは遅延警告を処理して表示するために、@code{post-command-hook}の後にEmacsコマンドループが実行する、ノーマルフックである。

デフォルト値は、2つの関数からなるリストである:

@smallexample
(collapse-delayed-warnings display-delayed-warnings)
@end smallexample

@findex collapse-delayed-warnings
@findex display-delayed-warnings
@noindent
関数@code{collapse-delayed-warnings}は、@code{delayed-warnings-list}から重複するエントリーを削除する。関数@code{display-delayed-warnings}は、@code{delayed-warnings-list}内の各要素にたいして順次@code{display-warning}を呼び出してから、@code{delayed-warnings-list}を@code{nil}にセットする。
@end defvar

@node Invisible Text
@section Invisible Text

@cindex invisible text
@code{invisible}プロパティにより、スクリーン上に表示されないように、文字を@dfn{不可視(invisible)}にすることができます。これはテキストプロパティ(@ref{Text
Properties}を参照)、またはオーバーレイプロパティ(@ref{Overlays}を参照)のいずれかで行うことができます。カーソル移動も、これらの文字を部分的に無視します。あるコマンドの後に、不可視テキスト範囲内にポイントがあることをコマンドループが検知した場合、コマンドループはポイントをそのテキストの別サイドへ再配置します。

もっともシンプルなケースでは、非@code{nil}の@code{invisible}プロパティにより、文字は不可視になります。これがデフォルトのケースであり、もし@code{buffer-invisibility-spec}のデフォルト値を変更したくない場合は、これが@code{invisible}プロパティを機能させる方法です。自身で@code{buffer-invisibility-spec}をセットする予定がなければ、@code{invisible}プロパティの値として、通常は@code{t}を使用するべきです。

より一般的には、どの@code{invisible}の値がテキストを不可視にするかを制御するために、変数@code{buffer-invisibility-spec}を使用できます。テキストにたいして異なる@code{invisible}の値を与えることにより、事前に別のサブセットへテキストをクラス分けした後に、@code{buffer-invisibility-spec}の値を変更して、さまざまなサブセットを可視または不可視にすることができます。

特にデータベース内のエントリーのリストを表示するプログラム内では、@code{buffer-invisibility-spec}による可視性の制御は有用です。これにより、データベース内の一部だけを閲覧するフィルターコマンドを、簡便に実装することが可能になります。この変数をセットするのは非常に高速で、バッファー内のすべてのテキストにたいしてプロパティが変更されたかスキャンするより、はるかに高速です。

@defvar buffer-invisibility-spec
この変数は、どの種類の@code{invisible}プロパティが、実際に文字を不可視にするかを指定する。この変数はセットすることにより、バッファーローカルになる。

@table @asis
@item @code{t}
@code{invisible}プロパティが非@code{nil}なら、その文字は不可視になる。これがデフォルトである。

@item リスト
このリスト内の各要素は、不可視性の条件を指定する。ある文字の@code{invisible}プロパティがこれらの条件のいずれかに適合したら、その文字は不可視になる。このリストは2種類の要素をもつことができる:

@table @code
@item @var{atom}
@code{invisible}プロパティの値が@var{atom}、または@var{atom}をメンバーにもつリストなら、その文字は不可視になる。比較は@code{eq}により行われる。

@item (@var{atom} . t)
@code{invisible}プロパティの値が@var{atom}、または@var{atom}をメンバーにもつリストなら、その文字は不可視になる。比較は@code{eq}により行われる。さらに、そのような文字シーケンスは省略記号(ellipsis)として表示される。
@end table
@end table
@end defvar

  特に@code{buffer-invisibility-spec}への要素の追加と削除のために、2つの関数が提供されています。

@defun add-to-invisibility-spec element
この関数は、@code{buffer-invisibility-spec}に要素@var{element}を追加する。@code{buffer-invisibility-spec}が@code{t}なら、これはリスト@code{(t)}に変更され、@code{invisible}プロパティが@code{t}のテキストは不可視のまま留まる。
@end defun

@defun remove-from-invisibility-spec element
この関数は、@code{buffer-invisibility-spec}から要素@var{element}を削除する。リスト内に@var{element}がなければ、何も行わない。
@end defun

  @code{buffer-invisibility-spec}を使用するための規約として、メジャーモードは@code{buffer-invisibility-spec}の要素、および@code{invisible}プロパティの値として、自身のモード名を使用することになっている。

@example
;; @r{省略記号を表示したければ:}
(add-to-invisibility-spec '(my-symbol . t))
;; @r{表示したくなければ:}
(add-to-invisibility-spec 'my-symbol)

(overlay-put (make-overlay beginning end)
             'invisible 'my-symbol)

;; @r{不可視状態が終わったら:}
(remove-from-invisibility-spec '(my-symbol . t))
;; @r{または各々を:}
(remove-from-invisibility-spec 'my-symbol)
@end example

  以下の関数を使用することにより、不可視性をチェックできます:

@defun invisible-p pos-or-prop
@var{pos-or-prop}がマーカーか数字の場合、その位置のテキストが不可視なら、この関数は非@code{nil}をリターンする。

@var{pos-or-prop}が別の類のLispオブジェクトなら、テキストプロパティまたはオーバーレイプロパティとして可能な値を意味すると解釈される。この場合、@code{buffer-invisibility-spec}のカレント値にもとづき、もしその値がテキストを不可視とするようなら、この関数は非@code{nil}をリターンする。
@end defun

@vindex line-move-ignore-invisible
  通常、テキストを操作したりポイントを移動する関数は、そのテキストが不可視かどうかに注意を払わず、可視および不可視のテキストを同様に処理します。@code{next-line}や@code{previous-line}のようなユーザーレベルの行移動関数は、@code{line-move-ignore-invisible}が非@code{nil}(デフォルト)なら、不可視な改行を無視します。これらの関数は不可視な改行がそのバッファーに存在しないかのように振る舞いますが、これはそう振る舞うよう、明示的にプログラムされているからです。

  あるコマンドが、不可視テキストの境界内側のポイントで終了した場合、メイン編集ループはその不可視テキストの両端のうちのいずれかにポイントを再配置します。そのコマンドの移動関数の全体的な方向と同じになるように、Emacsが再配置の方向は決定します。これに疑問がある場合には、挿入された文字が@code{invisible}プロパティを継承しないような位置を優先してください。加えて、そのテキストが省略記号で置換されず、コマンドが不可視テキスト内への移動のみを行う場合、ポイントを1文字余計に移動して、目に見えるようカーソルを移動することにより、そのコマンドの移動を反映するよう試みます。

  したがって,コマンドが(通常のstickinessをもつ)不可視範囲に、後方へとポイントを移動した場合、Emacsはポイントをその範囲の先頭へと、後方に移動します。コマンドが不可視範囲へ前方にポイントを移動した場合には、Emacsは不可視テキストの前にある最初の可視文字へと、前方にポイントを移動して、その後さらに前方へ1文字余計に移動します。

  これら不可視テキスト中間で終了するポイントにたいするこれらの@dfn{調整(adjustments)}は、@code{disable-point-adjustment}を非@code{nil}にセットすることにより無効にできます。@ref{Adjusting
Point}を参照してください。

  インクリメンタル検索はマッチが不可視テキストを含む場合は、一時的および/または永続的に不可視オーバーレイを可視にすることができます。これを有効にするためには、そのオーバーレイが非@code{nil}の@code{isearch-open-invisible}プロパティをもつ必要があります。プロパティの値は、そのオーバーレイを引数として呼び出される関数であるべきです。その関数は、オーバーレイを永続的に可視にする必要があります。これは検索からのexit時にマッチがそのオーバーレイに重なるときに使用されます。

  検索の間、そのようなオーバーレイのinvisible、およびintangibleプロパティを一時的に変更することにより、オーバーレイは一時的に可視にされます。特定のオーバーレイにたいして、異なる方法でこれを行いたいなら、それを@code{isearch-open-invisible-temporary}プロパティ(関数)に与えてください。その関数は2つの引数により呼び出されます。1つ目はそのオーバーレイ、2つ目は@code{nil}ならオーバーレイを可視に、@code{t}なら再び不可視にします。

@node Selective Display
@section Selective Display
@c @cindex selective display   Duplicates selective-display

  @dfn{選択的表示(selective display)}とは、スクリーン上で特定の行を隠蔽する、関連する機能ペアーを指します。

@cindex explicit selective display
  1つ目の変種は明示的な選択的表示で、これはLispプログラム内で使用するようにデザインされています。これはテキスト変更により、どの行を隠すかを制御します。この種の隠蔽は現在では時代遅れです。かわりに@code{invisible}プロパティで同じ効果を得ることができます(@ref{Invisible
Text}を参照)。

  2つ目の変種は、インデントにもとづいて隠す行の選択を自動的に行います。この変種は、ユーザーレベルの機能としてデザインされています。

  選択的表示を明示的に制御する方法では、改行(control-j)を復帰(control-m)に置換します。以前は行末に改行があった行は、これにより隠蔽されます。厳密に言うと、改行だけが行を分離できるので、これはもはや一時的には行ではなく、前の行の一部です。

  選択的表示は編集コマンドに直接影響を与えません。たとえば@kbd{C-f}(@code{forward-char})は、隠蔽された行へ気軽にポイントを移動します。しかし復帰文字による改行文字の置換は、いくつかの編集コマンドに影響を与えます。たとえば@code{next-line}は改行だけを検索するため、隠蔽された行をスキップします。選択的表示を使用するモードは、改行を考慮するコマンドを定義したり、テキストのどの部分を隠すか制御することもできます。

  選択的表示されたバッファーをファイルに書き込む際には、control-mはすべて改行として出力されます。これはファイル内のテキストを読み取る際には、すべて問題なく隠蔽されずに表示されることを意味します。選択的表示は、Emacs内でだけ見られる効果です。

@defvar selective-display
このバッファーローカル変数は、選択的表示を有効にする。これは行、または行の一部を隠すことができることを意味する。

@itemize @bullet
@item
@code{selective-display}の値が@code{t}なら、文字control-mが隠蔽されたテキストの開始をマークする。control-mと、それに後続する行の残りは表示されない。これは明示的な選択的表示である。

@item
@code{selective-display}の値が正の整数なら、それより多くの列によるインデントで始まる行は表示されない。
@end itemize

バッファーの一部が隠蔽されている際は、垂直移動コマンドはあたかもその部分を存在しないかのように処理して、1回の@code{next-line}コマンドで任意の行数の隠蔽された行をスキップできる。しかし(@code{forward-char}のような)文字移動コマンドは隠蔽された部分をスキップせず、(注意すれば)隠蔽された部分にたいしてテキストの挿入と削除が可能である。

以下の例では、@code{selective-display}の値の変更による、バッファー@code{foo}の@emph{外観表示}を示す。このバッファーの@emph{コンテンツ}は変更されない。

@example
@group
(setq selective-display nil)
     @result{} nil

---------- Buffer: foo ----------
1 on this column
 2on this column
  3n this column
  3n this column
 2on this column
1 on this column
---------- Buffer: foo ----------
@end group

@group
(setq selective-display 2)
     @result{} 2

---------- Buffer: foo ----------
1 on this column
 2on this column
 2on this column
1 on this column
---------- Buffer: foo ----------
@end group
@end example
@end defvar

@defopt selective-display-ellipses
このバッファーローカル変数が非@code{nil}なら、Emacsは隠蔽されたテキストを後にともなう行の終端に、@samp{@dots{}}を表示する。この例は、前の例からの継続である。

@example
@group
(setq selective-display-ellipses t)
     @result{} t

---------- Buffer: foo ----------
1 on this column
 2on this column ...
 2on this column
1 on this column
---------- Buffer: foo ----------
@end group
@end example

省略記号(@samp{@dots{}})にたいして他のテキストを代替えするために、ディスプレイテーブルを使用できる。@ref{Display
Tables}を参照のこと。
@end defopt

@node Temporary Displays
@section Temporary Displays
@cindex temporary display
@cindex temporary buffer display

  一時的表示(temporary
display)は、出力をバッファーに配して、それを編集用ではなく閲覧用としてユーザーに示すために、Lispプログラムにより使用されます。多くのヘルプコマンドは、この機能を使用します。

@defmac with-output-to-temp-buffer buffer-name body@dots{}
この関数は、@var{buffer-name}という名前のバッファー(必要なら最初に作成される)にプリントされた任意の出力が挿入されるようアレンジ、さらにバッファーをHelpモードにして、@var{body}内のフォームを実行する(類似する以下のフォーム@code{with-temp-buffer-window}を参照されたい)。最後に、そのバッファーはいずれかのウィンドウに表示されるが、そのウィンドウは選択されない。

@var{body}内のフォームが出力バッファーのメジャーモードを変更しないため、実行の最後においても依然としてHelpモードにあるなら、@code{with-output-to-temp-buffer}は最後にそのバッファーを読み取り専用するとともに、クリック可能なクロスリファレンスとなるよう、関数名と変数名のスキャンも行う。特にドキュメント文字列内のハイパーリンク上アイテムに関する詳細は、@ref{Docstring
hyperlinks, , Tips for Documentation Strings}を参照のこと。

文字列@var{buffer-name}は一時的なバッファーを指定し、これはあらかじめ存在する必要はない。引数はバッファーではなく文字列でなければならない。そのバッファーは最初に消去され(確認なし)、@code{with-output-to-temp-buffer}のexit後は未変更(unmodified)とマークされる。

@code{with-output-to-temp-buffer}は@code{standard-output}を一時的バッファーにバインドして、@var{body}内のフォームを評価する。@var{body}内のLisp出力関数を使用した出力のデフォルト出力先は、そのバッファーになる(しかしスクリーン表示、エコーエリア内のメッセージは、一般的な世界の感覚では``出力''であるものの、影響は受けない)。@ref{Output
Functions}を参照のこと。

この構成の振る舞いをカスタマイズするために利用できるフックがいくつかあり、それらは以下にリストしてある。

リターン値は、@var{body}内の最後のフォームの値である。

@example
@group
---------- Buffer: foo ----------
 This is the contents of foo.
---------- Buffer: foo ----------
@end group

@group
(with-output-to-temp-buffer "foo"
    (print 20)
    (print standard-output))
@result{} #<buffer foo>

---------- Buffer: foo ----------

20

#<buffer foo>

---------- Buffer: foo ----------
@end group
@end example
@end defmac

@defopt temp-buffer-show-function
この変数が非@code{nil}なら、@code{with-output-to-temp-buffer}はヘルプバッファーを表示する処理を行うために、その関数を呼び出す。この関数は、表示すべきバッファーという、1つの引数を受け取る。

@code{with-output-to-temp-buffer}が通常行うように、@code{save-selected-window}内部や選択されたウィンドウ内で、バッファーか選択された状態で、@code{temp-buffer-show-hook}を実行するのは、この関数にとってよいアイデアである。
@end defopt

@defvar temp-buffer-setup-hook
このノーマルフックは、@var{body}を評価する前に、@code{with-output-to-temp-buffer}により実行される。フック実行時は、一時的バッファーがカレントになる。このフックは通常、そのバッファーをHelpモードにするための関数にセットアップされる。
@end defvar

@defvar temp-buffer-show-hook
このノーマルフックは、一時的バッファー表示後に、@code{with-output-to-temp-buffer}により実行される。フック実行時は一時的バッファーがカレントになり、それが表示されているウィンドウが選択される。
@end defvar

@defmac with-temp-buffer-window buffer-or-name action quit-function body@dots{}
このマクロは@code{with-output-to-temp-buffer}と類似している。@code{with-output-to-temp-buffer}構成同様、これはプリントされる任意の出力が@var{buffer-or-name}という名前のバッファーに挿入されるようにアレンジして@var{body}を実行し、そのバッファーをいぜれかのウィンドウに表示する。しかし@code{with-output-to-temp-buffer}とは異なり、このマクロはそのバッファーを自動的にHelpモードに切り替えない。

@code{with-output-to-temp-buffer}と同様、これは@var{buffer-or-name}で指定されるバッファーを、@var{body}実行時カレントにしない。
@findex with-current-buffer-window
@var{body}を実行するために、そのバッファーをカレントにする点以外は等価なマクロ@code{with-current-buffer-window}を使用できる。

引数@var{buffer-or-name}は、一時的バッファーを指定する。これはバッファー(既存でなければならない)、または文字列を指定でき、文字列の場合は必要ならその名前のバッファーが作成される。そのバッファーは@code{with-temp-buffer-window}のexit時、未変更かる読み取り専用とマークされる。

このマクロは@code{temp-buffer-show-function}を呼び出さない。かわりにそのバッファーを表示するために、@var{action}引数を@code{display-buffer}に渡す。

引数@var{quit-function}が指定されていなければ、@var{body}内の最後のフォームの値がリターンされる。指定されている場合、それはそのバッファーを表示するウィンドウと、@var{body}の結果という、2つの引数で呼び出される。その場合、最終的なリターン値は何であれ@var{quit-function}がリターンした値となる。

@vindex temp-buffer-window-setup-hook
@vindex temp-buffer-window-show-hook
このマクロは、@code{with-output-to-temp-buffer}により実行される類似フックのかわりに、ノーマルフック@code{temp-buffer-window-setup-hook}と@code{temp-buffer-window-show-hook}使用する。
@end defmac

@defun momentary-string-display string position &optional char message
この関数は、カレントバッファー内の@var{position}に、@var{string}を瞬間表示(momentarily
display)する。これはundoリストや、そのバッファーの変更状態(modification status)に影響を与えない。

瞬間表示は、次の入力イベントまで留まる。次の入力イベントが@var{char}なら、@code{momentary-string-display}はそれを無視してリターンする。それ以外なら、そのイベントは後続の入力として使用するためにバッファーされる。つまり@var{char}とタイプすると、表示からその文字列を単に削除して、@var{char}ではない(たとえば)@kbd{C-f}とタイプすると表示からその文字列を削除して、後で(おそらく)ポイントを前方へ移動するだろう。引数@var{char}のデフォルトはスペース。

@code{momentary-string-display}のリターン値に意味はない。

文字列@var{string}がコントロール文字を含まなければ、@code{before-string}プロパティでオーバーレイを作成(してその後削除)することで、より一般的に同じことを行うことができる。@ref{Overlay
Properties}を参照のこと。

@var{message}gが非@code{nil}なら、バッファー内に@var{string}が表示されている間は、エコーエリアにそれが表示される。@code{nil}ならデフォルトは、継続するためには@var{char}をタイプするよう告げるメッセージである。

以下の例ではポイントは最初、2行目の先頭に置かれている:

@example
@group
---------- Buffer: foo ----------
This is the contents of foo.
@point{}Second line.
---------- Buffer: foo ----------
@end group

@group
(momentary-string-display
  "**** Important Message! ****"
  (point) ?\r
  "Type RET when done reading")
@result{} t
@end group

@group
---------- Buffer: foo ----------
This is the contents of foo.
**** Important Message! ****Second line.
---------- Buffer: foo ----------

---------- Echo Area ----------
Type RET when done reading
---------- Echo Area ----------
@end group
@end example
@end defun

@node Overlays
@section Overlays
@cindex overlays
@c FIXME: mention intervals in this section?

プレゼンテーション機能として、バッファーのテキストのスクリーン上の見栄えを変更するために、@dfn{オーバーレイ(overlay)}を使用できます。オーバーレイとは、個々のバッファーに属するオブジェクトであり、指定された開始と終了をもっています。確認したりセットすることができるプロパティももっています。それらはオーバーレイをもつテキストの表示に影響を与えます。

@cindex scalability of overlays
オーバーレイの視覚的効果は、対応するテキストプロパティと同様です(@ref{Text
Properties}を参照)。しかし実装が異なるため、オーバーレイは一般的にスケーラブルではありません(処理数に応じて、バッファー内のオーバーレイ数に比例した時間を要する)。バッファー内の多数の部分の視覚的外観に効果を及ぼす必要がある場合は、テキストプロパティの使用を推奨します。

オーバーレイは、その開始と終了を記録するために、マーカーを使用します。したがってバッファーのテキスト編集では、すべてのオーバーレイがそのテキストに留まるように、開始と終了が調整されます。オーバーレイ作成時には、オーバーレイ先頭、同様に終端にテキストが挿入された場合に、それがオーバーレイの内側あるいは外側であるべきかを指定できます。

@menu
* Managing Overlays::        オーバーレイの作成と変更。
* Overlay Properties::       プロパティ読み取りおよびセットの方法。どのプロパティがスクリーン表示に何を行うか。
* Finding Overlays::         オーバーレイにたいする検索。
@end menu

@node Managing Overlays
@subsection Managing Overlays
@cindex managing overlays
@cindex overlays, managing

  このセクションでは、オーバーレイの作成、削除、移動、およびそれらのコンテンツを調べる関数を説明します。オーバーレイはバッファーのコンテンツの一部ではないので、その変更はバッファーのundoリストに記録されません。

@defun overlayp object
この関数は、@var{object}がオーバーレイなら@code{t}をリターンする。
@end defun

@defun make-overlay start end &optional buffer front-advance rear-advance
この関数は@var{buffer}に属し、@var{start}から@var{end}の範囲のオーバーレイを作成してリターンする。@var{start}と@var{end}はいずれもバッファーの位置を指定しなければならず、整数またはマーカーを指定できる。@var{buffer}が省略された場合、そのオーバーレイはカレントバッファーに作成される。

引数@var{front-advance}と@var{rear-advance}はそれぞれ、オーバーレイの開始と終了にたいするマーカーの挿入タイプを指定する。@ref{Marker
Insertion
Types}を参照のこと。どちらも@code{nil}(デフォルト)なら、そのオーバーレイは先頭に挿入された任意のテキストを含むように拡張されるが、終端に挿入されたテキストにたいしては拡張されない。@var{front-advance}が非@code{nil}なら、オーバーレイの先頭に挿入されたテキストは、オーバーレイから除外される。@var{rear-advance}が非@code{nil}なら、オーバーレイの終端に挿入されたテキストは、オーバーレイに含まれる。
@end defun

@defun overlay-start overlay
この関数は、@var{overlay}が開始する位置を整数でリターンする。
@end defun

@defun overlay-end overlay
この関数は、@var{overlay}が終了する位置を整数でリターンする。
@end defun

@defun overlay-buffer overlay
この関数は、@var{overlay}が所属するバッファーをリターンする。@var{overlay}が削除されていれば@code{nil}をリターンする。
@end defun

@defun delete-overlay overlay
この関数は@var{overlay}を削除する。そのオーバーレイはLispオブジェクトとして存在し続け、そのプロパティリストは変更されないが、バッファーへの所属と表示にたいするすべての効果は失う。

削除済みオーバーレイが、永続的に非接続という訳ではない。@code{move-overlay}を呼び出すことにより、バッファー内の位置を与えることができる。
@end defun

@defun move-overlay overlay start end &optional buffer
この関数は@var{overlay}を@var{buffer}に移動して、その境界を@var{start}と@var{end}に配する。@var{start}と@var{end}の引数はいずれもバッファーの位置を指定しなければならず、整数またはマーカーを指定できる。

@var{buffer}が省略された場合、@var{overlay}はすでに関連付けられている同じバッファーに留まる。さらに@var{overlay}が削除されていたら、それをカレントバッファーに所属させる。

リターン値は@var{overlay}。

これはオーバーレイの両端位置を変更する、唯一有効な方法である。手作業でオーバーレイ内のマーカーの変更を試みてはならない。それにより他の重要なデータ構造の更新が失敗して、いくつかのオーバーレイが``失われる''可能性がある。
@end defun

@defun remove-overlays &optional start end name value
この関数は、プロパティ@var{name}が値@var{value}をもつ、@var{start}と@var{end}の間のすべてのオーバーレイを削除する。これによりオーバーレイの両端位置が変更されたり、分割される可能がある。

@var{name}が省略または@code{nil}なら、それは指定されたリージョン内のすべてのオーバーレイを削除することを意味する。@var{start}および/または@var{end}が省略または@code{nil}なら、それぞれバッファーの先頭と終端を意味する。したがって@code{(remove-overlays)}は、カレントバッファー内のすべてのオーバーレイを削除する。
@end defun

@defun copy-overlay overlay
この関数は@var{overlay}のコピーをリターンする。このコピーは@var{overlay}と同じ両端位置とプロパティをもつ。しかしオーバーレイの開始と終了にたいするマーカー挿入タイプは、デフォルト値にセットされる(@ref{Marker
Insertion Types}を参照)。
@end defun

  以下にいくつか例を示します:

@example
;; @r{オーバーレイの作成}
(setq foo (make-overlay 1 10))
     @result{} #<overlay from 1 to 10 in display.texi>
(overlay-start foo)
     @result{} 1
(overlay-end foo)
     @result{} 10
(overlay-buffer foo)
     @result{} #<buffer display.texi>
;; @r{後でチェックできるようプロパティ付与}
(overlay-put foo 'happy t)
     @result{} t
;; @r{プロパティが付与されたか検証}
(overlay-get foo 'happy)
     @result{} t
;; @r{オーバーレイを移動}
(move-overlay foo 5 20)
     @result{} #<overlay from 5 to 20 in display.texi>
(overlay-start foo)
     @result{} 5
(overlay-end foo)
     @result{} 20
;; @r{オーバーレイを削除}
(delete-overlay foo)
     @result{} nil
;; @r{削除されたか検証}
foo
     @result{} #<overlay in no buffer>
;; @r{削除済みオーバーレイは位置をもたない}
(overlay-start foo)
     @result{} nil
(overlay-end foo)
     @result{} nil
(overlay-buffer foo)
     @result{} nil
;; @r{オーバーレイの削除取り消し}
(move-overlay foo 1 20)
     @result{} #<overlay from 1 to 20 in display.texi>
;; @r{結果の検証}
(overlay-start foo)
     @result{} 1
(overlay-end foo)
     @result{} 20
(overlay-buffer foo)
     @result{} #<buffer display.texi>
;; @r{オーバーレイの移動と削除では、オーバーレイのプロパティは変更されない}
(overlay-get foo 'happy)
     @result{} t
@end example

  Emacsはそれぞれのバッファーのオーバーレイを、任意の``中心位置(center
position)''で分割される、2つのリストに格納します。一方のリストはバッファーの中心位置から後方へ拡張され、もう一方は中心位置から前方へと拡張されます。中心位置は、バッファーの任意の位置をとることができます。

@defun overlay-recenter pos
この関数は、カレントバッファーのオーバーレイを、位置@var{pos}の周辺に再センタリングする。これにより位置@var{pos}近傍のオーバーレイの照合は高速になるが、@var{pos}から離れた位置にたいしては低速になる。
@end defun

  バッファーを前方にスキャンしてオーバーレイを作成するループは、最初に@code{(overlay-recenter
(point-max))}を行うことにより高速になる可能性があります。

@node Overlay Properties
@subsection Overlay Properties
@cindex overlay properties

  オーバーレイプロパティは、文字が表示される方法をどちらのソースからも取得できるという点において、テキストプロパティと似ています。しかしほとんどの観点で、両者は異なります。これらの比較は@ref{Text
Properties}を参照してください。

  テキストプロパティは、そのテキストの一部として考えることができます。オーバーレイとそのプロパティは、特にテキストの一部としてはみなされません。したがって、さまざまなバッファーや文字列の間でテキストをコピーすると、テキストプロパティは保持されますが、オーバーレイを保持しようとは試みません。バッファーのテキストプロパティの変更は、そのバッファーを変更済みとマークしますが、オーバーレイの移動やプロパティの変更は違います。テキストプロパティの変更とは異なり、オーバーレイプロパティの変更は、バッファーのundoリストに記録されません。

  複数のオーバーレイが同じ文字にたいしてプロパティ値を指定できるので、Emacsは各オーバーレイにたいして優先度の指定を促します。2つのオーバーレイが同じ値の優先度をもち、一方が他方にネストされている場合には、内側のオーバーレイが外側のオーバーレイより高い優先度をもちます。いずれのオーバーレイも他方をネストしない場合には、どちらのオーバーレイが優先されるかについて予測するべきではありません。

  以下の関数は、オーバーレイのプロパティの読み取りとセットを行います:

@defun overlay-get overlay prop
この関数は、@var{overlay}内に記録されたプロパティ@var{prop}の値をリターンする。そのプロパティにたいして@var{overlay}が何も値を記録していないが、シンボルであるような@code{category}プロパティをもつ場合は、そのシンボルの@var{prop}プロパティが使用される。それ以外なら値は@code{nil}。
@end defun

@defun overlay-put overlay prop value
この関数は、@var{overlay}内に記録されたプロパティ@var{prop}の値に、@var{value}をセットする。リターン値は@var{value}。
@end defun

@defun overlay-properties overlay
これは、@var{overlay}のプロパティリストのコピーをリターンする。
@end defun

  与えられた文字にたいしてテキストプロパティとオーバーレイプロパティの両方をチェックする関数@code{get-char-property}も参照してください。@ref{Examining
Properties}を参照してください。

  多くのオーバーレイプロパティには特別な意味があります。以下はそれらのテーブルです:

@table @code
@item priority
@kindex priority @r{(overlay property)}
このプロパティの値は、そのオーバーレイの優先度を決定する。優先度にたいして値を指定したければ、@code{nil}(か0)、または正の整数を使用すること。それ以外のすべての値にたいして、動作は未定義である。

2つ以上のオーバーレイが同じ文字をカバーし、いずれもが同じプロパティを指定する場合には、優先度が重要になる。他より@code{priority}の値が大きいほうが他をオーバーライドする。@code{face}プロパティにたいしては、より高い優先度のオーバーレイの値は、他の値を完全にはオーバーライドしない。かわりにより低い優先度の@code{face}プロパティのface属性を、高い優先度のface属性がオーバーライドする。

現在のところ、すべてのオーバーレイはテキストプロパティより優先される。

Emacsは内部的なオーバーレイのいくつかにたいして、非数値の優先度を使用することがあるので、(自分が作成したオーバーレイでない場合は)オーバーレイ優先度の算術演算を試みないよう注意すること。オーバーレイを優先度順に配す必要があるなら、@code{overlays-at}の@var{sorted}引数を使用すること。@ref{Finding
Overlays}を参照されたい。

@item window
@kindex window @r{(overlay property)}
@code{window}プロパティが非@code{nil}なら、そのオーバーレイはそのウィンドウだけに適用される。

@item category
@kindex category @r{(overlay property)}
オーバーレイが@code{category}プロパティをもつなら、それをそのオーバーレイの@dfn{カテゴリー(category)}と呼ぶ。これはシンボルであること。そのシンボルのプロパティは、そのオーバーレイのプロパティにたいしてデフォルトの役割を果たす。

@item face
@kindex face @r{(overlay property)}
このプロパティはテキストの外観を制御する(@ref{Faces}を参照)。プロパティの値は以下のいずれか:

@itemize @bullet
@item
フェイス名(シンボルか文字列)。

@item
anonymousフェイス: @code{(@var{keyword} @var{value}
@dots{})}という形式のプロパティリストで、@var{keyword}はフェイス属性名、@var{value}はその属性の値。

@item
フェイスのリスト。リストの要素はそれぞれフェイス名か、anonymousフェイスのいずれかであること。これはリストされた各フェイスの属性を集約するフェイスを指定する。このリスト内で先に出現するフェイスが、より高い優先度をもつ。

@item
@code{(foreground-color . @var{color-name})}または@code{(background-color
. @var{color-name})}という形式のコンスセル。これは@code{(:foreground
@var{color-name})}や@code{(:background
@var{color-name})}と同様、フォアグラウンドとバックグラウンドのカラーを指定する。この形式は後方互換性のためだけにサポートされており、避けるべきである。
@end itemize

@item mouse-face
@kindex mouse-face @r{(overlay property)}
このプロパティは、マウスがオーバーレイ範囲内にあるとき、@code{face}のかわりに使用される。しかしEmacsは、このプロパティのテキストのサイズを変更する、すべてのフェイス属性(@code{:height}、@code{:weight}、@code{:slant})を無視する。これらの属性は、ハイライトされていないテキストでは、常に同一である。

@item display
@kindex display @r{(overlay property)}
このプロパティは、テキストが表示される方法を変更する、さまざまな機能をアクティブにする。たとえばこれは、テキストの外観を縦長(taller)や横長(shorter)にしたり、高く(higher)したり低く(lower)したり、イメージで置き換える。@ref{Display
Property}を参照のこと。

@item help-echo
@kindex help-echo @r{(overlay property)}
あるオーバーレイが@code{help-echo}プロパティをもつなら、そのオーバーレイ内のテキスト上にマウスを移動した際、Emacsはエコーエリアまたはツールチップウィンドウにヘルプ文字列を表示する。詳細は@ref{Text
help-echo}を参照のこと。

@item field
@kindex field @r{(overlay property)}
@c Copied from Special Properties.
同じ@code{field}プロパティをもつ連続する文字は、@emph{フィールド(field)}を形成する。@code{forward-word}や@code{beginning-of-line}を含むいくつかの移動関数は、フィールド境界で移動を停止する。@ref{Fields}を参照のこと。

@item modification-hooks
@kindex modification-hooks @r{(overlay property)}
このプロパティの値は、オーバーレイ内の任意の文字の変更、またはオーバーレイの厳密に内側にテキストが挿入された場合に呼び出される、関数のリストである。

このフックの関数は、各変更の前後両方で呼び出される。これらの関数が受け取った情報を保存し、呼び出し間で記録を比較すれば、バッファー内のテキストでどのような変更が行われたかを、正確に判断できる。

変更前に呼び出された際、各関数はオーバーレイ、@code{nil}、変更されたテキスト範囲の開始と終了という、4つの引数を受け取る。

変更後に呼び出された際、各関数はオーバーレイ、@code{t}、変更されたテキスト範囲の開始と終了、およびその範囲により置き換えられた変更前のテキスト長という、5つの引数を受け取る(変更前の長さは、挿入では0、削除では削除された文字数であり、変更後の先頭と終端が等しくなる)。

これらの関数がバッファーを変更する場合は、これらのフックを呼び出す内部的メカニズムの混乱を避けるために、それを行う前後で@code{inhibit-modification-hooks}を@code{t}にバインドすること。

テキストプロパティも@code{modification-hooks}プロパティをサポートするが、詳細は幾分か異なる(@ref{Special
Properties}を参照)。

@item insert-in-front-hooks
@kindex insert-in-front-hooks @r{(overlay property)}
このプロパティの値は、オーバーレイ先頭へのテキスト挿入前後に呼び出される、関数のリストである。呼び出し方は、@code{modification-hooks}の関数と同様。

@item insert-behind-hooks
@kindex insert-behind-hooks @r{(overlay property)}
このプロパティの値は、オーバーレイ終端へのテキスト挿入前後に呼び出される、関数のリストである。呼び出し方は、@code{modification-hooks}の関数と同様。

@item invisible
@kindex invisible @r{(overlay property)}
@code{invisible}プロパティにより、オーバーレイ内のテキストを不可視似出来る。これはそのテキストが、スクリーン上に表示されないことを意味する。詳細は、@xref{Invisible
Text}を下さいのこと。

@item intangible
@kindex intangible @r{(overlay property)}
オーバーレイの@code{intangible}プロパティは、正に@code{intangible}テキストプロパティと同様に機能する。詳細は@xref{Special
Properties}を参照のこと。

@item isearch-open-invisible
このプロパティは、インクリメンタル検索にたいして、最後のマッチがそのオーバーレイに重なる場合に、不可視なオーバーレイを永続的に可視にする方法を告げる。@ref{Invisible
Text}を参照のこと。

@item isearch-open-invisible-temporary
このプロパティは、インクリメンタル検索にたいして、検索の間に、不可視なオーバーレイを一時的に可視にする方法を告げる。@ref{Invisible
Text}を参照のこと。

@item before-string
@kindex before-string @r{(overlay property)}
このプロパティの値は、オーバーレイ先頭に表示するために追加する文字列である。この文字列は、いかなる意味においてもバッファー内には表れず、スクリーン上にのみ表れる。

@item after-string
@kindex after-string @r{(overlay property)}
このプロパティの値は、オーバーレイ終端に表示するために追加する文字列である。この文字列は、いかなる意味においてもバッファー内には表れず、スクリーン上にのみ表れる。

@item line-prefix
このプロパティは、表示時にそれぞれの非継続行の後に追加する、表示仕様(display
spec)を指定する。@ref{Truncation}を参照のこと。

@item wrap-prefix
このプロパティは、表示時にそれぞれの継続行の前に追加する、表示仕様(display spec)を指定する。@ref{Truncation}を参照のこと。

@item evaporate
@kindex evaporate @r{(overlay property)}
このプロパティが非@code{nil}の場合は、そのオーバーレイが空(長さが0)になったら、自動的に削除される。空のオーバーレイにたいして非@code{nil}の@code{evaporate}プロパティを与えた場合は、即座に削除される。

@item keymap
@cindex keymap of character (and overlays)
@kindex keymap @r{(overlay property)}
このプロパティがから@code{nil}なら、それはそのテキスト範囲にたいしてキーマップを指定する。このキーマップは、ポイントの後の文字がそのオーバーレイ内にあるときに使用され、他のほとんどのキーマップより優先される。@ref{Active
Keymaps}を参照のこと。

@item local-map
@kindex local-map @r{(overlay property)}
@code{local-map}プロパティは@code{keymap}プロパティと同様だが、既存のキーマップに付け加えるのではなく、バッファーのローカルマップを置き換える点が異なる。これは、そのキーマップがマイナーモードキーマップより低い優先度をもつことも意味する。
@end table

@code{keymap}と@code{local-map}プロパティは、@code{before-string}、@code{after-string}、@code{display}プロパティにより表示された文字列には影響しません。これはポイントがその文字列上にない場合の、マウスクリックや、その文字列に関する他のマウスイベントにのみ関係があります。その文字列に特別なマウスイベントをバインドするには、そのイベントを@code{keymap}か@code{local-map}プロパティに割り当てます。@ref{Special
Properties}を参照してください。

@node Finding Overlays
@subsection Searching for Overlays
@cindex searching for overlays
@cindex overlays, searching for

@defun overlays-at pos &optional sorted
この関数は、カレントバッファー内の位置@var{pos}にある文字をカバーする、すべてオーバーレイのリストをリターンする。@var{sorted}が非@code{nil}ならリストは優先度降順、それ以外なら特定の順にはソートされない。オーバーレイが@var{pos}、またはそれより前から始まり、かつ@var{pos}の後で終わる場合、位置@var{pos}はオーバーレイに含まれる。

使い方を説明するために、ポイント位置の文字にたいして、プロパティ@var{prop}を指定するオーバーレイのリストをリターンするLisp関数である:

@smallexample
(defun find-overlays-specifying (prop)
  (let ((overlays (overlays-at (point)))
        found)
    (while overlays
      (let ((overlay (car overlays)))
        (if (overlay-get overlay prop)
            (setq found (cons overlay found))))
      (setq overlays (cdr overlays)))
    found))
@end smallexample
@end defun

@defun overlays-in beg end
この関数は、@var{beg}から@var{end}のリージョンと重複(overlap)する、オーバーレイのリストをリターンする。``重複''とは、少なくとも1つの文字がそのオーバーレイに含まれ、かつ指定されたリージョンにも含まれることを意味する。しかし、空のオーバーレイが@var{beg}、厳密に言うと@var{beg}と@var{end}にある場合、または@var{end}がバッファーの終端を示す場合は、その空のオーバーレイも結果に含まれる。
@end defun

@defun next-overlay-change pos
この関数は@var{pos}の後にあるオーバーレイの、開始または終了となるバッファー位置をリターンする。それが存在しなければ@code{(point-max)}をリターンする。
@end defun

@defun previous-overlay-change pos
この関数は@var{pos}の前にあるオーバーレイの、開始または終了となるバッファー位置をリターンする。それが存在しなければ@code{(point-min)}をリターンする。
@end defun

  以下に例として、プリミティブ関数@code{next-single-char-property-change}(@ref{Property
Search}を参照)の、単純化(かつ非効率的な)したバージョンを示します。これは位置@var{pos}から前方へ、与えられたプロパティ@code{prop}にたいして、オーバーレイプロパティまたはテキストプロパティのいずれかの値が変化した、次の位置を検索します。

@smallexample
(defun next-single-char-property-change (position prop)
  (save-excursion
    (goto-char position)
    (let ((propval (get-char-property (point) prop)))
      (while (and (not (eobp))
                  (eq (get-char-property (point) prop) propval))
        (goto-char (min (next-overlay-change (point))
                        (next-single-property-change (point) prop)))))
    (point)))
@end smallexample

@node Size of Displayed Text
@section Size of Displayed Text
@cindex size of text on display
@cindex character width on display

すべての文字が同じ幅をもつ訳ではないので、以下の関数により文字の幅をチェックできます。関連する関数については、@ref{Primitive
Indent}と@ref{Screen Lines}を参照してください。

@defun char-width char
この関数は、文字@var{char}がカレントバッファーに表示された場合(つまりそのバッファーのディスプレイテーブルがあれば、それを考慮に入れる。@ref{Display
Tables}を参照されたい)の幅を、列数でリターンする。タブ文字の幅は、通常は@code{tab-width}である(@ref{Usual
Display}を参照)。
@end defun

@defun string-width string
この関数は、文字列@var{string}がカレントバッファー、および選択されたウィンドウに表示された場合の幅を、列数でリターンする。
@end defun

@defun truncate-string-to-width string width &optional start-column padding ellipsis
この関数は@var{string}の一部を、列数@var{width}にフィット新たな文字列としてリターンする。

@var{string}が@var{width}に満たない場合、その文字列終端が結果の終端となる。@var{string}内の1つの複数列文字が、列@var{width}を超えて跨がる場合、その文字は結果に含まれない。つまり結果は@var{width}より短くなるかもしれないが、それを超えることはできない。

オプション引数@var{start-column}は、開始列を指定する。これが非@code{nil}なら、その文字列の最初の@var{start-column}列は、値から省かれる。@var{string}内の1つの複数列文字が、列@var{start-column}を超えて跨がる場合、その文字は結果に含まれない。

オプション引数@var{padding}が非@code{nil}なら、結果となる文字列の幅を正確に@var{width}列に拡張するために、パディング文字が追加される。結果文字列が@var{width}より短ければ、結果文字列の終端にパディング文字が使用される。@var{string}内の1つの複数列文字が列@var{start-column}を跨ぐ場合は、先頭にもパディング文字が使用される。

@var{ellipsis}が非@code{nil}なら、それは@var{string}の表示幅が@var{ellipsis}の表示幅以下でなければ、@var{width}を超えてしまう場合に、@var{string}の終端(任意のパディングを含む)を置き換える文字列であること。@var{ellipsis}が非@code{nil}、かつ文字列以外なら、それは@code{"..."}を意味する。

@example
(truncate-string-to-width "\tab\t" 12 4)
     @result{} "ab"
(truncate-string-to-width "\tab\t" 12 4 ?\s)
     @result{} "    ab  "
@end example
@end defun

以下の関数は、あるテキストが与えられたウィンドウに表示されたときのサイズを、ピクセル単位でリターンします。この関数は、テキストを含むためにウィンドウを十分大きくするために、@code{fit-window-to-buffer}(@ref{Resizing
Windows}を参照)と@code{fit-frame-to-buffer}(@ref{Size and
Position}を参照)により使用されます。

@defun window-text-pixel-size &optional window from to x-limit y-limit mode-and-header-line
この関数は、@var{window}のバッファーのテキストサイズを、ピクセル単位でリターンする。@var{window}は生きたウィンドウでなければならず、デフォルトは選択されたウィンドウ。リターン値は、任意のテキスト行の最大ピクセル幅と、すべてのテキスト行の最大ピクセル高さのコンスである。

オプション引数@var{from}が非@code{nil}なら、それは考慮すべき最初のテキスト位置を指定し、デフォルトはそのバッファーのアクセス可能な最小の位置である。@var{from}が@code{t}なら、それは改行文字ではない、アクセス可能な最小位置を使用する。オプション引数@var{to}が非@code{nil}なら、それは考慮すべき最後のテキスト位置を指定し、デフォルトはそのバッファーのアクセス可能な最大の位置である。@var{to}が@code{t}なら、それは改行文字ではない、アクセス可能な最大位置を使用する。

オプション引数@var{x-limit}が非@code{nil}なら、それはリターンされ得る、最大ピクセル幅を指定する。@var{x-limit}が@code{nil}または省略された場合には、@var{window}のbody(@ref{Window
Sizes}を参照)のピクセル幅を使用する。これは、呼び出し側が@var{window}の幅の変更を意図しない場合に有用である。それ以外なら、呼び出し側はここで想定される@var{window}のbodyの、最大幅を指定するべきである。X座標を超えるテキストの@var{x-limit}は無視される。長い行の幅の計算には多くの時間を要する可能性があるので、特にいずれにせよ切り詰められるであろう長い行を含むバッファーの場合には、必要に応じて、この引数の値を小さくすることは、よいアイデアである。

オプション引数@var{y-limit}が非@code{nil}なら、それはリターンされ得る、最大ピクセル高さを指定する。Y座標を超えるテキストの@var{y-limit}は無視される。大きなバッファーのピクセル高さの計算には多くの時間を要する可能性があるので、特に呼び出し側がバッファーのサイズを知らない場合、この変数の指定は合理的である。

オプション引数@var{mode-and-header-line}が@code{nil}または省略された場合は、リターン値に@var{window}のモードラインとヘッダーラインの高さを含めないことを意味する。これがシンボル@code{mode-line}または@code{header-line}のいずれかなら、それらが存在する場合は、リターン値にそのラインの高さだけを含める。これが@code{t}なら、存在する場合は両方の高さをリターン値に含める。
@end defun


@node Line Height
@section Line Height
@cindex line height
@cindex height of a line

  各ディスプレイ行のトータル高さは、その行のコンテンツ高さに、そのディスプレイ上部または下部にオプションで追加される垂直行スペーシングを加えて構成されます。

  行のコンテンツ高さは、もしあれば最後の改行を含む、そのディスプレイ行の文字またはイメージの最大高さです(継続されるディスプレイ行には最後の改行が含まれない)。特にこれより大きい高さを指定しなければ、これがデフォルトの行高さになります(一般的には、これはデフォルトのフレームフォント高さに等しい)。

  より大きい行高さを明示的に指定するためにはディスプレイ行の絶対高さ、または垂直スペースを指定することによる、複数の方法が存在します。しかし何を指定したかに関わらず、実際の行高さがデフォルトの高さより小さくなることはありません。

@kindex line-height @r{(text property)}
  改行は、その改行で終わるディスプレイ行のトータル高さを制御する、テキストプロパティまたはオーバーレイプロパティ@code{line-height}をもつことができます。

  プロパティの値が@code{t}なら、改行文字はその行の表示高さにたいして効果をもたず、可視なコンテンツだけが高さを決定します。これはイメージ間に追加のブランク領域をもたない、小さなイメージ(またはイメージスライス)にたいして有用です。

  プロパティの値が@code{(@var{height}
@var{total})}という形式のリストなら、これはディスプレイ行の@emph{下部}に余分なスペースを追加します。最初にEmacsは、その行の@emph{上部}の余分なスペースを制御するための高さspecとして、@var{height}を使用します。それから行のトータル高さを@var{total}にするために、行の@emph{下部}に必要なスペースを追加します。この場合、行のスペーシングを指定する他の方法は無視されます。

@cindex height spec
  他の種類のプロパティ値は高さspec(height
spec)です。これは行の高さを指定する数値に変換されます。高さspecを記述するためには複数の方法があります。以下はそれらが数値に変換される方法です:

@table @code
@item @var{integer}
高さspecが正の整数なら、高さの値はその整数。
@item @var{float}
高さspecが浮動小数点数@var{float}なら、高さ数値はそのフレームのデフォルト行高さの@var{float}倍。
@item (@var{face} . @var{ratio})
高さspecがこのフォーマットのコンスなら、高さ数値はフェイス@var{face}の高さの@var{ratio}倍。@var{ratio}には任意の型の数値を指定でき、@code{nil}は1のratioを意味する。@var{face}が@code{t}なら、カレントフェイスを参照する。
@item (nil . @var{ratio})
高さspecがこのフォーマットのコンスなら、高さ数値はその行のコンテンツ高さの@var{ratio}倍。
@end table

  したがって、任意の有効な種々の高さspecにより、ピクセル単位で高さが決定されます。行のコンテンツ高さがこれより小さければ、Emacsは指定されたトータル高さになるよう、余分な垂直スペースを行の上部に追加します。

  @code{line-height}プロパティを指定しない場合、その行の高さは行のコンテンツ高さとに行スペーシングを追加して構成されます。Emacsの異なるさまざまな部分のテキストにたいして、行スペーシングを指定する複数の方法が存在します。

  グラフィカルなディスプレイでは、フレームパラメーター@code{line-spacing}(@ref{Layout
Parameters}を参照)を使用することにより、フレーム内のすべての行にたいして行スペーシングを指定できます。しかし@code{line-spacing}のデフォルト値が非@code{nil}なら、それはそのフレームのフレームパラメーター@code{line-spacing}をオーバーライドします。整数は行の下部に配するピクセル数を指定します。浮動小数点数はフレームのデフォルト行高さに相対的にスペーシングを指定します。

@vindex line-spacing
  バッファーローカル変数@code{line-spacing}を通じて、バッファー内のすべての行の行スペーシングを指定できます。整数は行の下部に配するピクセル数を指定します。浮動小数点数はデフォルトフレーム行高さに相対的にスペーシングを指定します。これは、そのフレームにたいして指定された行スペーシングをオーバーライドします。

@kindex line-spacing @r{(text property)}
  最後に改行は、改行で終わるディスプレイ行にたいして、デフォルトフレーム行スペーシングおよびバッファーローカル変数@code{line-spacing}をオーバーライドする、テキストプロパティまたはオーバーレイプロパティ@code{line-spacing}をもつことができます。

  種々の方法により、これらのメカニズムは各行のスペーシングにたいするLisp値を指定します。値は高さspecで、これは上述したLisp値に変換されます。しかしこの場合高さ数値は行高さではなく行スペーシングを指定します。

  テキスト端末では、行スペーシングは変更できません。

@node Faces
@section Faces
@cindex faces

  @dfn{フェイス(face)}とはフォント、フォアグラウンドカラー、バックグラウンドカラー、オプションのアンダーライン等のテキストを表示するための、グラフィカルな属性のコレクションのことです。フェイスはEmacsがバッファー内、同様にモードラインのようなフレームの他の部分で、テキストを表示する方法を制御します。

@cindex anonymous face
  フェイスを表現する1つの方法として、@code{(:foreground "red" :weight
bold)}のような属性のプロパティリストがあります。このようなリストは、@dfn{anonymousフェイス(anonymous
face)}と呼ばれます。たとえば@code{face}テキストプロパティとしてanonymousフェイスを割り当てることができ、Emacsは指定された属性でテキストを表示するでしょう。@ref{Special
Properties}を参照してください。

@cindex face name
  より一般的には、フェイスは@dfn{フェイス名(face
name)}を通じて参照されます。これはフェイス属性のセットに関連付けられたLispシンボル@footnote{後方互換のため、フェイス名の指定に文字列も使用できます。これは同名のLispシンボルと等価です。}。です。名前つきフェイスは@code{defface}マクロを使用して定義できます(@ref{Defining
Faces}を参照)。Emacsにはいくつかの標準名前つきフェイスが同梱されています(@ref{Basic Faces}を参照)。

  Emacsの多くの箇所で名前つきフェイスが要求され、anonymousフェイスは受け入れられません。これらには@ref{Attribute
Functions}に記述される関数、および変数@code{font-lock-keywords}(@ref{Search-based
Fontification}を参照)が含まれます。特に明記しないかぎり、名前つきフェイスの参照だけに用語@dfn{フェイス}を使用することとします。

@defun facep object
この関数は@var{object}が名前つきフェイス(フェイス名の役目をもつLispシンボルまたは文字列)なら、非@code{nil}をリターンする。それ以外なら@code{nil}をリターンする。
@end defun

@menu
* Face Attributes::          フェイスとは?
* Defining Faces::           フェイスを定義する方法。
* Attribute Functions::      フェイス属性の確認およびセットを行う関数。
* Displaying Faces::         ある文字にたいして指定されたフェイスをEmacsが組み合わせる方法。
* Face Remapping::           フェイスを別の定義にリマップする。
* Face Functions::           フェイスの定義、および確認する方法。
* Auto Faces::               自動的にフェイスを割り当てるフック。
* Basic Faces::              デフォルトで定義されるフェイス。
* Font Selection::           あるフェイスに最適なフォントを見つける。
* Font Lookup::              利用可能なフォント名とそれらの情報の照会。
* Fontsets::                 フォントセット、それは文字セットの範囲を処理するフォントコレクションである。
* Low-Level Font::           文字表示フォントのLisp表現。
@end menu

@node Face Attributes
@subsection Face Attributes
@cindex face attributes

  @dfn{フェイス属性(Face
attributes)}は、フェイスの視覚的外観を決定します。以下はすべてのフェイス属性と、それらの可能な値と効果に関するテーブルです。

  以下の値とは別に、各フェイス属性は値@code{unspecified}をもつことができます。この特殊な値は、フェイスがその属性を直接指定しないことを意味します。@code{unspecified}属性は、Emacsにかわりに親フェイス(以下の@code{:inherit}属性の記述を参照)を参照すること、それに失敗した場合は基礎フェイス(@ref{Displaying
Faces}を参照)を参照することを指示します。@code{default}フェイスはすべての属性を指定しなければなりません。

  これらの属性のいくつかは、特定の種類のディスプレイにおいてのみ意味があります。ディスプレイが特定の属性を処理できなければ、その属性は無視されます。

@table @code
@item :family
フォントファミリーまたはフォントセット(文字列)。フォントファミリーに関する詳細は、@xref{Fonts,,, emacs, The GNU
Emacs
Manual}を参照のこと。関数@code{font-family-list}(以下参照)は、利用可能なファミリー名のリストをリターンする。フォントセットに関する情報は、@ref{Fontsets}を参照されたい。

@item :foundry
@code{:family}属性により指定されるフォントファミリーにたいする@dfn{フォントfoundry(font
foundry)}(文字列)。@ref{Fonts,,, emacs, The GNU Emacs Manual}を参照のこと。

@item :width
相対的な文字幅。これはシンボル@code{ultra-condensed}、@code{extra-condensed}、@code{condensed}、@code{semi-condensed}、@code{normal}、@code{semi-expanded}、@code{expanded}、@code{extra-expanded}、@code{ultra-expanded}のいずれかであること。

@item :height
フォントの高さ。もっともシンプルなケースでは1/10ポイントを単位とする整数。

値には@dfn{基礎フェイス(underlying
face)}にたいして相対的に高さを指定する浮動小数点数、または関数も指定できる(@ref{Displaying
Faces}を参照)。浮動小数点数は基礎フェイスの高さをスケーリングする量を指定する。関数値は基礎フェイスの高さを単一の引数として呼び出され、新たなフェイスの高さをリターンする。関数が整数を引数として渡された場合には、整数をリターンしなければならない。

デフォルトフェイスの高さは、整数を使用して指定しなければならない。浮動小数点数および関数は受け入れられない。

@item :weight
フォントのweight。(太字から細字順に)シンボル@code{ultra-bold}、@code{extra-bold}、@code{bold}、@code{semi-bold}、@code{normal}、@code{semi-light}、@code{light}、@code{extra-light}、@code{ultra-light}のいずれか。可変輝度テキストをサポートするテキスト端末では、normalより大なweightはより高輝度、小なweightはより低輝度で表示される。

@cindex italic text
@item :slant
フォントのslant。シンボル@code{italic}、@code{oblique}、@code{normal}、@code{reverse-italic}、@code{reverse-oblique}のいずれか。可変輝度テキストをサポートするテキスト端末では、slantされたテキストはhalf-brightで表示される。

@item :foreground
フォアグラウンドカラー(文字列)。値にはシステム定義済みカラー、または16進カラー仕様を指定できる。@ref{Color
Names}を参照のこと。白黒ディスプレイでは、特定のグレー色調が点描パターンで実装されている。

@item :distant-foreground
代替えのフォアグラウンドカラー(文字列)。これは@code{:foreground}と似ているが、使用されるであろうフォアグラウンドカラーが、バックグラウンドカラーに近いときのみフォアグラウンドカラーとして使用される点が異なる。これはたとえばテキストをマーク時(リージョンフェイス)に有用である。そのテキストが、リージョンフェイスとして可視なフォアグラウンドをもつ場合は、そのフォアグラウンドが使用される。フォアグラウンドがリージョンフェイスのバックグラウンドに近ければ、テキストを可読にするために@code{:distant-foreground}が使用される。

@item :background
バックグラウンドカラー(文字列)。値にはシステム定義済みカラー、または16進カラー仕様を指定できる。@ref{Color Names}を参照のこと。

@cindex underlined text
@item :underline
文字にアンダーラインを引くべきか否かと、その方法。@code{:underline}属性として可能な値は以下のとおり:

@table @asis
@item @code{nil}
アンダーラインを引かない。

@item @code{t}
そのフェイスのフォアグラウンドカラーでアンダーラインを引く。

@item @var{color}
文字列@var{color}で指定されたカラーでアンダーラインを引く。

@item @code{(:color @var{color} :style @var{style})}
@var{color}は文字列、またはそのフェイスのフォアグラウンドカラーを意味するシンボル@code{foreground-color}。属性@code{:color}の省略は、そのフェイスのフォアグラウンドカラーの使用を意味する。@var{style}には直線を意味する@code{line}、または波線を意味する@code{wave}いずれかのシンボルであること。属性@code{:style}の省略は直線を意味する。
@end table

@cindex overlined text
@item :overline
文字にオーバーラインを引くべきか否かと、そのカラー。値が@code{t}なら、そのフェイスのフォアグラウンドカラーを使用してオーバーラインを引く。値が文字列なら、そのカラーを使用してオーバーラインを引く。値@code{nil}はオーバーラインを引かないことを意味する。

@cindex strike-through text
@item :strike-through
文字に取り消し線を引くべきか否かと、そのカラー。値は@code{:overline}で使用される値と同じ。

@cindex 2D box
@cindex 3D box
@item :box
文字周囲に枠(box)を描画するか否か、そのカラー、枠線の幅、3D外観。以下は@code{:box}の可能な値と意味である:

@table @asis
@item @code{nil}
枠を描画しない。

@item @code{t}
幅1の枠線、フォアグラウンドカラーで枠を描画する。

@item @var{color}
幅1の枠線、カラー@var{color}で枠を描画する。

@item @code{(:line-width @var{width} :color @var{color} :style @var{style})}
この方法では、枠のすべての形相を明示的に指定できる。値@var{width}は描画する線の幅を指定し、デフォルトは1。負の幅@var{-n}は、基礎テキストのスペースを占有する線幅@var{n}を意味し、文字の高さまたは幅を避けることができる。

値@var{color}は描画するカラーを指定する。シンプルな枠線ではフェイスのフォアグラウンドカラー、3D枠線ではフェイスのバックグラウンドカラーがデフォルト。

値@var{style}は3D枠線を描画するか否かを指定する。@code{released-button}なら、枠は押下された3Dボタンのような外観、@code{pressed-button}なら押下されていない3Dボタンのような外観、@code{nil}または省略された場合は2D枠線が使用される。
@end table

@item :inverse-video
文字が反転表示されて表示されるべきか否か。値は@code{t}(反転表示する)、または@code{nil}(反転表示しない)であること。

@item :stipple
バックグラウンドの点描(ビットマップ)。

値には文字列を指定でき、それは外部形式Xビットマップデータを含むファイルの名前であること。ファイルは変数@code{x-bitmap-file-path}にリストされるディレクトリー内で検索される。

かわりに@code{(@var{width} @var{height}
@var{data})}という形式のリストにより、ビットマップで直接値を指定できる。ここで@var{width}と@var{height}はピクセル単位によるサイズ、@var{data}は行単位でビットマップのrawビットを含む文字列。各行は文字列内で連続する@math{(@var{width}
+ 7) / 8}バイトを占める(最善の結果を得るためにはユニバイト文字列であるべき)。これは各行が常に少なくとも、1バイト全体を占めることを意味する。

値が@code{nil}なら、点描パターンを使用しないことを意味する。

これは特定のグレー色調を処理するために自動的に使用されるので、通常はstipple属性のセットは必要ない。

@item :font
そのフェイスの表示に使用されるフォント。値はフォントオブジェクトであること。フォントオブジェクト、フォントスペース、フォントエンティティーに関する情報は、@ref{Low-Level
Font}を参照のこと。

@code{set-face-attribute}(@pxref{Attribute
Functions})を使用してこの属性を指定する際にはフォントspec、フォントエンティティー、または文字列を与えることもできる。Emacsはそのような値を適切なフォントオブジェクトに変換して、実際の属性値としてそのフォントオブジェクトを格納する。文字列を指定する場合、その文字列のコンテンツはフォント名であること(@ref{Fonts,,,
emacs, The GNU Emacs
Manual}を参照)。フォント名がワイルドカードを含むXLFDなら、Emacsはそれらのワイルドカードに最初にマッチするフォントを選択する。この属性の指定により、@code{:family}、@code{:foundry}、@code{:width}、@code{:height}、@code{:weight}、@code{:slant}の属性値も変更される。

@cindex inheritance, for faces
@item :inherit
属性を継承するフェイス名、またはフェイス名のリスト。継承フェイス由来の属性は、基礎フェイスより高い優先度で、基礎フェイスの場合と同じような方法でマージされる(@ref{Displaying
Faces}を参照)。フェイスのリストが使用された場合、リスト内先頭側フェイスの属性が末尾側フェイスの属性をオーバーライドする。
@end table

@defun font-family-list &optional frame
この関数は、利用可能なフォントファミリー名のリストをリターンする。オプション引数@var{frame}はそのテキストが表示されるフレームを指定する。これが@code{nil}なら選択されたフレームが使用される。
@end defun

@defopt underline-minimum-offset
この変数は、アンダーラインが引かれたテキスト表示時に、ベースラインとアンダーライン間の最小距離を、ピクセル単位で指定する。
@end defopt

@defopt x-bitmap-file-path
この変数は@code{:stipple}属性のビットマップファイルを検索する、ディレクトリーのリストを指定する。
@end defopt

@defun bitmap-spec-p object
これは@var{object}が、@code{:stipple}(上記参照)での使用に適す有効なビットマップ仕様なら@code{t}、それ以外なら@code{nil}をリターンする。
@end defun

@node Defining Faces
@subsection Defining Faces
@cindex defining faces

@cindex face spec
  フェイスを定義する通常の方法は、@code{defface}マクロを通じて定義する方法です。このマクロはフェイス名(シンボル)を、デフォルトの@dfn{フェイスspec(face
spec)}と関連付けます。フェイスspecは、任意の与えられた端末上でフェイスがどの属性をもつべきかを指定する構成です。たとえばあるフェイスspecは、高カラー端末ではあるフォアグラウンドカラーを指定し、低カラー端末では異なるフォアグラウンドカラーを指定するかもしれません。

  値がフェイス名であるような変数を作りたがる人がいます。ほとんどの場合、これは必要ありません。通常手順は、@code{defface}でフェイスを定義して、その名前を直接使用することです。

@defmac defface face spec doc [keyword value]@dots{}
このマクロは、@var{spec}によりデフォルトフェイスspecが与えられるような、名前つきフェイスとして@var{face}を宣言する。シンボル@var{face}はクォートせず、@samp{-face}で終わらないこと(冗長であろう)。引数@var{doc}は、そのフェイスにたいするドキュメント文字列。追加の@var{keyword}引数は、@code{defgroup}および@code{defcustom}の場合と同じ意味をもつ(@ref{Common
Keywords}を参照)。

If @var{face} already has a default face spec, this macro does nothing.

デフォルトフェイスspecは、何もカスタマイゼーション(@ref{Customization}を参照)の効果がないときに、@var{face}の外観を決定する。@var{face}が、(Customテーマやinitファイルから読み込んだカスタマイズにより)すでにカスタマイズ済みなら、その外観はデフォルトフェイスspecの@var{spec}をオーバーライドする、カスタムフェイスspecにより決定される。しかしその後カスタマイゼーションが削除されたなら、@var{face}の外観は再びそのデフォルトフェイスspecにより決定されるだろう。

例外として、Emacs
Lispモードで@kbd{C-M-x}(@code{eval-defun})から@code{defface}を評価した場合は、@code{eval-defun}の特別な機能により、@code{defface}が何を指示するかをフェイスが正確に反映するように、そのフェイス上の任意のカスタムフェイスをオーバーライドする。

@var{spec}引数は、異なる種別の端末上でそのフェイスがどのような外観で表示されるべきかを示す、@dfn{フェイスspec}である。これは各要素が以下の形式であるようなalistであること

@example
(@var{display} . @var{plist})
@end example

@noindent
@var{display}は端末のクラス(以下参照)を指定する。@var{plist}は、そのような端末上でフェイスがどのような外観かを指定する、フェイス属性とその値からなるプロパティリストであること。後方互換性のために、@code{(@var{display}
@var{plist})}のように要素を記述することもできる。

@var{spec}の要素の@var{display}の部分は、その要素がマッチする端末を決定する。与えられた端末にたいして複数の要素がマッチした場合は、最初にマッチした要素がその端末にたいして使用される。@var{display}には以下の3つが可能:

@table @asis
@item @code{default}
@var{spec}のこの要素は、どの端末にもマッチしない。かわりにすべての端末に適用されるデフォルトを指定する。この要素が仕様された場合は、@var{spec}の最初の要素でなければならない。この後の要素はこれらのデフォルトの一部、またはすべてをオーバーライドできる。

@item @code{t}
@var{spec}のこの要素は、すべての端末にマッチする。したがって@var{spec}の後続要素が使用されることはない。通常@code{t}は、@var{spec}の最後(または唯一)の要素として使用される。

@item リスト
@var{display}がリストなら、各要素は@code{(@var{characteristic}
@var{value}@dots{})}という形式をもつこと。ここで@var{characteristic}は端末をクラス分けする方法、@var{value}は@var{display}に適用されるべき可能なクラス分類である。@var{characteristic}で利用可能な値は:

@table @code
@item type
その端末が使用するウィンドウシステムの種類で@code{graphic}(任意のグラフィック対応ディスプレイ)、@code{x}、@code{pc}(MS-DOSコンソール)、@code{w32}
(MS Windows 9X/NT/2K/XP)、または@code{tty}(グラフィック非対応ディスプレイ)のいずれか。@ref{Window
Systems, window-system}を参照のこと。

@item class
その端末がサポートするカラーの種類で、@code{color}、@code{grayscale}、または@code{mono}のいずれか。

@item background
バックグラウンドの種類で@code{light}か@code{dark}のいずれか。

@item min-colors
その端末がサポートするべき最小カラー数を表す整数。端末の@code{display-color-cells}の値が少なくとも指定された整数なら、その端末にマッチする。

@item supports
その端末が@var{value}@dots{}で与えられたフェイス属性を表示可能か否か(@ref{Face
Attributes}を参照)。このテストがどのように行われるかについてのより正確な情報は、@ref{Display Face Attribute
Testing}を参照のこと。
@end table

与えられた@var{characteristic}にたいして、@var{display}の要素が複数の@var{value}を指定する場合は、いずれの値も許容され得る。@var{display}が複数の要素をもつ場合、各要素は異なる@var{characteristic}を指定すること。その端末の@emph{それぞれ}のcharacteristicは、@var{display}内で指定された値のいずれか1つとマッチしなければならない。
@end table
@end defmac

  たとえば以下は、標準フェイス@code{highlight}の定義です:

@example
(defface highlight
  '((((class color) (min-colors 88) (background light))
     :background "darkseagreen2")
    (((class color) (min-colors 88) (background dark))
     :background "darkolivegreen")
    (((class color) (min-colors 16) (background light))
     :background "darkseagreen2")
    (((class color) (min-colors 16) (background dark))
     :background "darkolivegreen")
    (((class color) (min-colors 8))
     :background "green" :foreground "black")
    (t :inverse-video t))
  "Basic face for highlighting."
  :group 'basic-faces)
@end example

  内部的には、Emacsはフェイスのシンボルプロパティ@code{face-defface-spec}内にそれぞれのフェイスのデフォルトspecを格納します(@ref{Symbol
Properties}を参照)。@code{saved-face}プロパティは、カスタマイゼーションバッファーを使用してユーザーが保存した、任意のフェイスspecを格納します。@code{customized-face}プロパティは、カレントセッションにたいしてカスタマイズされた保存されていないフェイスspecを格納します。そして@code{theme-face}プロパティは、そのフェイスにたいするアクティブなカスタマイゼーションセッティングと、フェイスspecをもつCustomテーマを関連付けるalistです。そのフェイスのドキュメント文字列は、@code{face-documentation}プロパティ内に格納されます。

  通常フェイスは@code{defface}を使用して1回だけ宣言され、その外観にたいするそれ以上の変更はCustomizeフレームワーク(Customizeユーザーインターフェース、または@code{custom-set-faces}関数を通じて。@ref{Applying
Customizations}を参照されたい)、またはフェイスリマッピング(@ref{Face
Remapping}を参照)により行われます。Lispから触接フェイスspec変更を要する稀な機会では、@code{face-spec-set}関数を使用できます。

@defun face-spec-set face spec &optional spec-type
この関数は、@code{face}にたいするフェイスspecとして、@var{spec}を適用する。@var{spec}は、上述した@code{defface}にたいするフェイスspecであること。

この関数は、もしそれが既存のものでなければ、有効なフェイス名として@var{face}を定義して、既存フレームのその属性を(再)計算することも行う。

@cindex override spec @r{(for a face)}
引数@var{spec-type}は、どのspecをセットするべきかを決定する。これが@code{nil}または@code{face-override-spec}なら、この関数は@dfn{オーバーライドspec(override
spec)}をセットする。これは@var{face}上の他のすべてのフェイスspecをオーバーライドする。@code{customized-face}または@code{saved-face}なら、この関数はカスタマイズされたspec、または保存されたカスタムspecをセットする。@code{face-defface-spec}なら、この関数はデフォルトフェイスspec(@code{defface}によりセットされるものと同一)をセットする。@code{reset}なら、この関数は@var{face}からすべてのカスタマイゼーションspecとオーバーライドspecをクリアーする(この場合、@var{spec}の値は無視される)。@var{spec-type}にたいする他のすべての値は、内部的な使用のために予約済みである。
@end defun

@node Attribute Functions
@subsection Face Attribute Functions
@cindex face attributes, access and modification

  このセクションでは、名前つきフェイスの属性に直接アクセスしたり、変更する関数を説明します。

@defun face-attribute face attribute &optional frame inherit
この関数は、@var{frame}上の@var{face}にたいする、属性@var{attribute}の値をリターンする。

@var{frame}が@code{nil}なら、それは選択されたフレームを意味する(@ref{Input
Focus}を参照)。@var{frame}が@code{t}なら、この関数は新たに作成されるフレームにたいする、指定された属性の値をリターンする(これは下記の@code{set-face-attribute}を使用して何らかの値を指定していなければ、通常は@code{unspecified}である)。

@var{inherit}が@code{nil}なら、@var{face}により定義される属性だけが考慮されるので、リターンされる値は@code{unspecified}、または相対的な値かもしれない。@var{inherit}が非@code{nil}なら、@var{face}の@var{attribute}の定義が、@code{:inherit}属性で指定されたフェイスとマージされる。しかしリターンされる値は依然として@code{unspecified}、または相対的な値かもしれない。@var{inherit}がフェイス、またはフェイスのリストなら、指定された絶対的な値になるまで、結果はそのフェイス(1つ以上)と更にマージされる。

リターン値が指定されていて、かつ絶対的であることを保証するためには、@var{inherit}にたいして@code{default}の値を使用すること。(常に完全に指定される)@code{default}フェイスとマージすることにより、すべての未指定または相対的な値は解決されるだろう。

たとえば

@example
(face-attribute 'bold :weight)
     @result{} bold
@end example
@end defun

@c FIXME: Add an index for "relative face attribute", maybe here?  --xfq
@defun face-attribute-relative-p attribute value
この関数は@var{value}がフェイス属性@var{attribute}の値として使用された際に相対的なら、非@code{nil}をリターンする。This
function returns non- if , when used as the value of the face attribute , is
relative.これはフェイスリスト内の後続のフェイス、または継承した他のフェイスが由来となる、任意の値で完全にオーバーライドするのではなく、変更されるであろうことを意味する。

すべての属性にたいして、@code{unspecified}は相対的な値である。@code{:height}にたいしては、浮動小数点数と関数値も相対的である。

たとえば:

@example
(face-attribute-relative-p :height 2.0)
     @result{} t
@end example
@end defun

@defun face-all-attributes face &optional frame
この関数は、@var{face}の属性のalistをリターンする。結果の要素は、@w{@code{(@var{attr-name}
.
@var{attr-value})}}という形式の、名前/値ペアーである。オプション引数@var{frame}は、リターンするべき@var{face}の定義をもつフレームを指定する。省略または@code{nil}なら、リターン値には新たに作成されるフレームにたいする、@var{face}のデフォルト属性が記述される。
@end defun

@defun merge-face-attribute attribute value1 value2
@var{value1}がフェイス属性@var{attribute}にたいして相対的な値なら、基礎的な値@var{value2}とマージしてリターンする。それ以外の場合、@var{value1}がフェイス属性@var{attribute}にたいして絶対的な値なら、@var{value1}を変更せずにリターンする。
@end defun

  通常、Emacsは各フレームのフェイス属性を自動的に計算するために、各フェイスのフェイスspecを使用します(@ref{Defining
Faces}を参照)。関数@code{set-face-attribute}は、特定またはすべてのフレームのフェイスに直接属性を割り当てることにより、この計算をオーバーライドできます。この関数は主として、内部的な使用を意図したものです。

@defun set-face-attribute face frame &rest arguments
この関数は、@var{frame}にたいする@var{face}の1つ以上の属性をセットする。この方法で指定された属性は、@var{face}に属するフェイスspec(1つ以上)をオーバーライドする。

余分の引数@var{arguments}は、セットするべき属性と、それらの値を指定する。これらは、(@code{:family}や@code{:underline}のような)属性名と、値が交互になるよう構成されていること。すなわち、

@example
(set-face-attribute 'foo nil :weight 'bold :slant 'italic)
@end example

@noindent
sets the attribute @code{:weight} to @code{bold} and the attribute
@code{:slant} to @code{italic}.


@var{frame}が@code{t}なら、この関数は新たに作成されるフレームにたいする、デフォルト属性をセットする。@var{frame}が@code{nil}なら、この関数はすべての既存フレーム、同様に新たに作成されるフレームにたいして、その属性をセットする。
@end defun

  以下のコマンドと関数は主として、古いバージョンのEmacsにたいする互換性のために提供されます。これらは@code{set-face-attribute}を呼び出すことにより機能します。これらの@var{frame}引数にたいする値@code{t}と@code{nil}は、@code{set-face-attribute}および@code{face-attribute}の場合と同様に処理されます。コマンドがインタラクティブに呼び出された場合は、ミニバッファーを使用して引数を読み取ります。

@deffn Command set-face-foreground face color &optional frame
@deffnx Command set-face-background face color &optional frame
これらはそれぞれ@var{face}の@code{:foreground}属性、または@code{:background}属性に@var{color}をセットする。
@end deffn

@deffn Command set-face-stipple face pattern &optional frame
これは@var{face}の@code{:stipple}属性に、@var{pattern}をセットする。
@end deffn

@deffn Command set-face-font face font &optional frame
これは@var{face}の@code{:font}属性に、@var{font}をセットする。
@end deffn

@defun set-face-bold face bold-p &optional frame
これは@var{face}の@code{:weight}属性にたいして、@var{bold-p}が@code{nil}なら@var{normal}、それ以外なら@var{bold}をセットする。
@end defun

@defun set-face-italic face italic-p &optional frame
これは@var{face}の@code{:slant}属性にたいして、@var{italic-p}が@code{nil}なら@var{normal}、それ以外なら@var{italic}をセットする。
@end defun

@defun set-face-underline face underline &optional frame
これは@var{face}の@code{:underline}属性に、@var{underline}をセットする。
@end defun

@defun set-face-inverse-video face inverse-video-p &optional frame
これは@var{face}の@code{:inverse-video}属性に、@var{inverse-video-p}をセットする。
@end defun

@deffn Command invert-face face &optional frame
これはフェイス@var{face}のフォアグラウンドカラーとバックグラウンドカラーを交換する。
@end deffn

  以下は、フェイスの属性を調べる関数です。これらは主として、古いバージョンのEmacsとの互換性のために提供されます。これらにたいして@var{frame}を指定しなければ選択されたフレームを、@code{t}なら新たなフレームにたいするデフォルトデータを参照します。フェイスがその属性にたいして何の値も定義していなければ、@code{unspecified}がリターンされます。@var{inherit}が@code{nil}なら、そのフェイスにより直接定義された属性だけがリターンされます。@var{inherit}が非@code{nil}なら、そのフェイスの@code{:inherit}属性により指定される任意のフェイスを、@var{inherit}がフェイスまたはフェイスのリストなら、指定された属性が見つかるまで、それらも考慮されます。リターンされる値が常に指定された値であることを保証するためには、@var{inherit}にたいして値@code{default}を使用してください。

@defun face-font face &optional frame
この関数は、フェイス@var{face}のフォント名をリターンする。
@end defun

@defun face-foreground face &optional frame inherit
@defunx face-background face &optional frame inherit
これらの関数はそれぞれ、フェイス@var{face}のフォアグラウンドカラーまたはバックグラウンドカラーを、文字列としてリターンする。
@end defun

@defun face-stipple face &optional frame inherit
この関数は、フェイス@var{face}のバックグラウンド点描パターンの名前、もしなければ@code{nil}をリターンする。
@end defun

@defun face-bold-p face &optional frame inherit
この関数は@var{face}の@code{:weight}属性がnormalよりbold寄り(@code{semi-bold}、@code{bold}、
@code{extra-bold}、@code{ultra-bold}のいずれか)なら、非@code{nil}、それ以外なら@code{nil}をリターンする。
@end defun

@defun face-italic-p face &optional frame inherit
この関数は、@var{face}の@code{:slant}属性が@code{italic}か@code{oblique}なら非@code{nil}、それ以外なら@code{nil}をリターンする。
@end defun

@defun face-underline-p face &optional frame inherit
この関数は、フェイス@var{face}が非@code{nil}の@code{:underline}属性を指定する場合は、非@code{nil}をリターンする。
@end defun

@defun face-inverse-video-p face &optional frame inherit
この関数は、フェイス@var{face}が非@code{nil}の@code{:inverse-video}属性を指定する場合は、非@code{nil}をリターンする。
@end defun

@node Displaying Faces
@subsection Displaying Faces
@cindex displaying faces
@cindex face merging

  Emacsが与えられたテキスト断片を表示する際、そのテキストの視覚的外観は異なるソースから描画されるフェイスにより決定されるかもしれません。これら種々のソースが、特定の文字にいたいして複数のフェイスを指定する場合、Emacsはそれらのさまざまなフェイスの属性をマージします。以下に、Emacsがフェイスをマージする順序を優先度順に記します:

@itemize @bullet
@item
そのテキストが特別なグリフで構成される場合、そのグリフは特定のフェイスを指定できる。@ref{Glyphs}を参照のこと。

@item
アクティブなリージョンにテキストがある場合、Emacsは@code{region}フェイスを使用してそれをハイライトする。@ref{Standard
Faces,,, emacs, The GNU Emacs Manual}を参照のこと。

@item
非@code{nil}の@code{face}属性をもつオーバーレイにテキストがある場合、Emacsはそのプロパティにより指定されるフェイス(1つ以上)を適用する。そのオーバーレイが@code{mouse-face}プロパティをもち、マウスがそのオーバーレイに``十分に近い''場合、Emacsはかわりに@code{mouse-face}で指定されるフェイスまたはフェイス属性を適用する。@ref{Overlay
Properties}を参照のこと。

1つの文字を複数のオーバーレイがカバーする場合は、高優先度のオーバーレイが低優先度のオーバーレイをオーバーライドする。@ref{Overlays}を参照のこと。

@item
そのテキストが@code{face}または@code{mouse-face}プロパティを含む場合、Emacsは指定されたフェイスおよびフェイス属性を適用する。@ref{Special
Properties}を参照のこと(これはFont Lockモードのフェイス適用方法である。@ref{Font Lock Mode}を参照されたい)。

@item
そのテキストが選択されたウィンドウのモードラインにある場合、Emacsは@code{mode-line}フェイスを適用する。選択されていないウィンドウのモードラインでは、Emacsは@code{mode-line-inactive}フェイスを使用する。ヘッダーラインにたいしては、Emacsは@code{header-line}フェイスを適用する。

@item
先行ステップの間に、与えられた属性が指定されなければ、Emacsは@code{default}フェイスの属性を適用する。
@end itemize

  各ステージにおいて、フェイスが有効な@code{:inherit}属性をもつ場合、Emacsは値@code{unspecified}をもつすべての属性が、親フェイス(1つ以上)由来で描画される、対応する値をもつものとして扱います。@ref{Face
Attributes}を参照してください。親フェイスでも、属性がunspecifiedのままかもしれないことに注意してください。その場合には、フェイスマージの次レベルでも、その属性はunspecifiedのままです。

@node Face Remapping
@subsection Face Remapping
@cindex face remapping

  変数@code{face-remapping-alist}は、あるフェイスの外観のバッファーローカル、またはグローバルな変更にたいして使用されます。たとえばこれは、@code{text-scale-adjust}コマンド(@ref{Text
Scale,,, emacs, The GNU Emacs Manual}を参照)の実装に使用されています。

@defvar face-remapping-alist
この変数の値は、要素が@code{(@var{face}
.
@var{remapping})}という形式をもつalistである。これによりEmacsは、フェイス@var{face}をもつ任意のテキストを、通常の@var{face}の定義ではなく、@var{remapping}で表示する。

@var{remapping}には、テキストプロパティ@code{face}にたいして適切な任意のフェイスspec、すなわちフェイス(フェイス名または属性/値ペアーのプロパティリスト)、またはフェイスのリストのいずれかを指定できる。詳細は、@ref{Special
Properties}の@code{face}テキストプロパティの記述を参照のこと。@var{remapping}はリマップされるフェイスにたいる、完全な仕様としての役目をもつ。これは通常の@var{face}を変更せずに置き換える。

@code{face-remapping-alist}がバッファーローカルなら、そのローカル値はそのバッファーでのみ効果をもつ。

注意:
フェイスのリマッピングは再帰的ではない。@var{remapping}が同じフェイス名@var{face}を参照する場合、直接または@var{remapping}内の他の何らかのフェイスの@code{:inherit}属性を通じて、その参照は@var{face}の通常の定義を使用する。たとえば@code{mode-line}フェイスが、@code{face-remapping-alist}内の以下のエントリーでリマップされる場合:

@example
(mode-line italic mode-line)
@end example

@noindent
@code{mode-line}フェイスの新たな定義は@code{italic}フェイス、および(リマップされていない)@emph{通常}の@code{mode-line}フェイスの定義から継承される。
@end defvar

@cindex relative remapping, faces
@cindex base remapping, faces
  以下の関数は、@code{face-remapping-alist}にたいする高レベルなインターフェースを実装します。ほとんどのLispコードは、リマッピングが他の場所に適用されてしまうのを避けるために、@code{face-remapping-alist}を直接セットするのではなく、これらの関数を使用するべきです。これらの関数はバッファーローカルなリマッピングを意図しており、すべてが副作用として@code{face-remapping-alist}をバッファーローカルにします。これらは、以下の形式の@code{face-remapping-alist}エントリーを管理します

@example
  (@var{face} @var{relative-spec-1} @var{relative-spec-2} @var{...} @var{base-spec})
@end example

@noindent
上述したように、@var{relative-spec-N}と@var{base-spec}はそれぞれ、フェイス名または属性/値ペアーのプロパティリストです。@dfn{相対的リマッピング(relative
remapping)}エントリー@var{relative-spec-N}はそれぞれ、@code{face-remap-add-relative}および@code{face-remap-remove-relative}関数により管理されます。これらはテキストサイズ変更のような、単純な変更を意図しています。@dfn{ベースリマッピング(base
remapping)}エントリー@var{base-spec}は最低の優先度をもち、@code{face-remap-set-base}および@code{face-remap-reset-base}関数により管理されます。これは、メジャーモードが制御下のバッファーでフェイスをリマップするために用いることを意図しています。

@defun face-remap-add-relative face &rest specs
この関数は、カレントバッファー内のフェイス@var{face}にたいして、相対的リマッピングとして、@var{specs}内にフェイスspecを追加する。残りの引数@var{specs}はフェイス名のリスト、または属性/値ペアーのプロパティリストという、いずれかの形式であること。

リターン値は、``cookie''としての役目をもつLispオブジェクトである。後でそのリマッピングの削除を要する場合は、引数として@code{face-remap-remove-relative}にこのオブジェクトを渡すことができる。

@example
;; `escape-glyph'フェイスを`highlight'と`italic'
;; の組み合わせにリマップ:
(face-remap-add-relative 'escape-glyph 'highlight 'italic)

;; `default'フェイスのサイズを50%増加:
(face-remap-add-relative 'default :height 1.5)
@end example
@end defun

@defun face-remap-remove-relative cookie
この関数は、以前@code{face-remap-add-relative}で追加された相対的リマッピングを削除する。@var{cookie}は、そのリマッピングが追加されたときに、@code{face-remap-add-relative}がリターンしたLispオブジェクトであること。
@end defun

@defun face-remap-set-base face &rest specs
この関数は、カレントバッファー内の@var{face}のベースリマッピングを、@var{specs}にセットする。@var{specs}が空なら、@code{face-remap-reset-base}(以下参照)を呼び出したように、デフォルトベースリマッピングがリストアされる。これは単一の値@code{nil}を含む@var{specs}とは異なることに注意。これは逆の結果をもたらす(@var{face}のグローバル定義は無視される)。

これは、グローバルなフェイス定義を継承した、デフォルトの@var{base-spec}を上書きするので、必要ならそのような継承を追加するのは呼び出し側の責任である。
@end defun

@defun face-remap-reset-base face
この関数は、@var{face}のベースリマッピングに、@var{face}のグローバル定義から継承した、デフォルト値にセットする。
@end defun

@node Face Functions
@subsection Functions for Working with Faces

  以下はフェイスを作成および処理するための、追加の関数です。

@defun face-list
この関数は、すべての定義済みフェイス名のリストをリターンする。
@end defun

@defun face-id face
この関数は、フェイス@var{face}の@dfn{フェイス番号(face
number)}をリターンする。これはEmacs内の低レベルで、フェイスを一意に識別する番号である。フェイス番号によるフェイス参照を要するのは稀である。
@end defun

@defun face-documentation face
この関数は、フェイス@var{face}のドキュメント文字列、それが指定されていなければ@code{nil}をリターンする。
@end defun

@defun face-equal face1 face2 &optional frame
これは、フェイス@var{face1}とフェイス@var{face2}が、表示にたいして同じ属性をもつなら@code{t}をリターンする。
@end defun

@defun face-differs-from-default-p face &optional frame
これはフェイス@var{face}の表示がデフォルトフェイスと異なるなら、非@code{nil}をリターンする。
@end defun

@cindex face alias
@cindex alias, for faces
@dfn{フェイスエイリアス(face
alias)}は、あるフェイスにたいして等価な名前を提供します。エイリアスシンボルの@code{face-alias}プロパティに対象となるフェイス名を与えることにより、フェイスエイリアスを定義できます。以下の例では、@code{mode-line}フェイスにたいするエイリアスとして、@code{modeline}を作成します。

@example
(put 'modeline 'face-alias 'mode-line)
@end example

@defmac define-obsolete-face-alias obsolete-face current-face when
このマクロは、@var{current-face}のエイリアスとして@code{obsolete-face}を定義するとともに、将来に削除されるかもしれないことを示すためにobsolete(時代遅れ)とマークする。@var{when}は、@code{obsolete-face}がobsoleteになる時期を示す文字列(通常はバージョン番号文字列)であること。
@end defmac

@node Auto Faces
@subsection Automatic Face Assignment
@cindex automatic face assignment
@cindex faces, automatic choice

  以下のフックは、バッファー内のテキストに自動的にフェイスを割り当てるために使用されます。これはJit-Lockモードの実装の一部であり、Font-Lockにより使用されます。

@defvar fontification-functions
この変数は、再表示を行う直前に、Emacsの再表示により呼び出される関数のリストを保持する。これらはFont
Lockが有効でないときでも呼び出される。Font
Lockモードが有効なら、この変数は通常は単一の関数@code{jit-lock-function}だけを保持する。

関数は、バッファー位置@var{pos}を単一の引数として、リストされた順に呼び出される。これらは、カレントバッファー内の@var{pos}で開始されるテキストにたいして、集合的にフェイスの割り当てを試みるべきである。

関数は@code{face}プロパティをセットするおとにより、割り当てるフェイスを記録すること。またフェイスを割り当てたすべてのテキストに、非@code{nil}の@code{fontified}プロパティも追加するべきである。このプロパティは再表示に、そのテキストにたいしてそのフェイスがすでに割り当て済みであることを告げる。

@var{pos}の後の文字がすでに非@code{nil}の@code{fontified}プロパティをもつが、フォント表示化を要さない場合に、何も行わない関数を追加するのは、おそらくよいアイデアである。ある関数が、前の関数による割り当てをオーバーライドする場合には、実際に問題となるのは最後の関数終了後のプロパティである。

効率化のために、通常は各呼び出しにおいて400から600前後の文字にフェイスを割り当てるように、これらの関数を記述することを推奨する。
@end defvar

@node Basic Faces
@subsection Basic Faces
@cindex basic faces

テキストにたいしてEmacs
Lispプログラムが何らかのフェイス割り当てを要する場合は、完全に新たなフェイスを定義するより、特定の既存フェイス、またはそれらを継承したフェイスを使用するほうが、よいアイデアである場合がしばしばあります。Emacsに特定の外観を与えるために別のユーザーが基本フェイス(basic
face)をカスタマイズしていても、この方法なら追加のカスタマイズなしでプログラムは``適合''することでしょう。

  以下にEmacsが定義する基本フェイスのいくつかをリストしました。これらに加えて、ハイライトがFont
Lockモードによりまだ処理されていなかったり、いくつかのFont Lockフェイスが使用されていなければ、構文的ハイライトのために、Font
Lockフェイスを使うようにしたいと思うかもしれません。@ref{Faces for Font Lock}を参照してください。

@table @code
@item default
属性がすべて指定されたデフォルトフェイス。他のすべてのフェイスは、暗にこのフェイスを継承する。未指定(unspecified)な任意の属性は、このフェイスの属性をデフォルトとする(@ref{Face
Attributes}を参照)。

@item bold
@itemx italic
@itemx bold-italic
@itemx underline
@itemx fixed-pitch
@itemx variable-pitch
これらは、名前に示されるような属性をもち(@code{bold}はboldの@code{:weight}属性をもつ)、それ以外のすべての属性は未指定である(そのため@code{default}により与えられる)。

@item shadow
テキストの``淡色表示(dimmed
out)''用。たとえばこれは、ミニバッファー内で無視されるファイル名部分に使用される(@ref{Minibuffer File,,
Minibuffers for File Names, emacs, The GNU Emacs Manual}を参照)。

@item link
@itemx link-visited
ユーザーを別のバッファーや``位置''へと送る、クリック可能テキストボタン用。

@item highlight
一時的に強調するべきテキスト範囲用。たとえば一般的に、カーソルのハイライトには@code{mouse-face}プロパティが割り当てられる(@ref{Special
Properties}を参照)。

@item match
検索コマンドによりマッチしたテキスト用。

@item error
@itemx warning
@itemx success
エラー、警告、成功に関するテキスト用。たとえば@file{*Compilation*}内のメッセージにたいして使用される。
@end table

@node Font Selection
@subsection Font Selection
@cindex font selection
@cindex selecting a font

  Emacsがグラフィカルなディスプレイ上で文字を描画可能になる前に、まずその文字にたいする@dfn{フォント(font)}を選択しなければなりません@footnote{このコンテキストでは、用語@dfn{font}はFont
Lock(@ref{Font Lock Mode}を参照)にたいして何も行いません。}。@ref{Fonts,,, emacs, The GNU
Emacs
Manual}を参照してください。通常、Emacsはその文字に割り当てられたフェイス、特にフェイス属性@code{:family}、@code{:weight}、@code{:slant}、@code{:width}(@ref{Face
Attributes}を参照)にもとづいて、自動的にフォントを選択します。フォントの選択は、表示される文字にも依存します。表示できるのは文字セットが限定されているフォントもいくつかあります。利用可能なフォントがこの要件を完全に満たさない場合、Emacsは@dfn{もっとも近いフォント(closest
matching font)}を探します。このセクション内の変数は、Emacsがこの選択を行う方法を制御します。

@defopt face-font-family-alternatives
あるfamilyが指定されたが存在しない場合、この変数は試みるべき代替えのフォントファミリーを指定する。各要素は以下の形式をもつ:

@example
(@var{family} @var{alternate-families}@dots{})
@end example

@var{family}が指定されたが利用できなければ、Emacsは@var{alternate-families}で与えられるファミリーで存在するものが見つかるまで、1つずつファミリーを試みる。
@end defopt

@defopt face-font-selection-order
希望するすべてのフェイス属性(@code{:width}、@code{:height}、@code{:weight}、@code{:slant})に完全にマッチするフォントが存在しない場合、この変数はもっとも近いフォントの選択時に考慮すべき、これらの属性の順序を指定する。値はこれらの属性シンボルを重要度降順で含むリストであること。デフォルトは@code{(:width
:height :weight :slant)}。

フォント選択はまず、このリスト内の最初の属性にたいして利用可能な最適マッチを探す。その後、この方法で最適なフォントの中から、2つ目の属性にたいして最適なマッチを検索、...のように選択を行う。

属性@code{:weight}および@code{:width}は、@code{normal}を中心とする範囲のような、シンボリック値をもつ。より極端(@code{normal}から離れた)なマッチは、より極端ではない(@code{normal}に近い)マッチより、幾分優先される。これは、可能なかぎり非normalなフェイスが、normalなフェイスとは対照的になることを保証するようにデザインされている。

この変数が違いを生むケースの例は、デフォルトフォントに等価なイタリックがない場合である。デフォルトの順では、@code{italic}フェイスは、デフォルトのフォントに類似した非イタリックのフォントを使用するだろう。しかし@code{:height}の前に@code{:slant}を置くと、@code{italic}フェイスはたとえheightが同じでなくとも、イタリックフォントを使用するだろう。
@end defopt

@defopt face-font-registry-alternatives
この変数は、registryが指定されたがそれが存在しない場合に試みるべき、代替えのフォントレジストリーを指定する。各要素は以下の形式をもつ:

@example
(@var{registry} @var{alternate-registries}@dots{})
@end example

@var{registry}が指定されたが利用できなければ、Emacsは@var{alternate-registries}内で存在するレジストリーが見つかるまで、他のレジストリーを1つずつ試みる。
@end defopt

@cindex scalable fonts
  Emacsがスケーラブルフォントを使用するようにできますが、デフォルトではそれらを使用しないようになっています。

@defopt scalable-fonts-allowed
この変数は、どのスケーラブルフォントを使用するかを制御する。値@code{nil}(デフォルト)は、スケーラブルフォントを使用しないことを意味する。@code{t}はそのテキストにたいして適切と思われる、任意のスケーラブルフォントを使用することを意味する。

それ以外なら、値は正規表現のリストであること。その場合、名前がこのリスト内の正規表現にマッチする、任意のスケーラブルフォントの使用が有効になる。たとえば、

@example
(setq scalable-fonts-allowed '("iso10646-1$"))
@end example

@noindent
これは、レジストリーが@code{iso10646-1}のようなスケーラブルフォントの使用を可能にする。
@end defopt

@defvar face-font-rescale-alist
この変数は、特定のフォントにたいするスケーリングを指定する。値は、以下の形式の要素をもつリストであること

@example
(@var{fontname-regexp} . @var{scale-factor})
@end example

使用しようとするフォントの名前が@var{fontname-regexp}にマッチする場合、これはファクター@var{scale-factor}に対応した、同様な大きさのフォントの選択を指示する。特定のフォントが提示する通常のheightやwidthが大きい、または小さい場合に、フォントサイズを正規化するためにこの機能を使用できるだろう。
@end defvar

@node Font Lookup
@subsection Looking Up Fonts
@cindex font lookup
@cindex looking up fonts

@defun x-list-fonts name &optional reference-face frame maximum width
この関数は、@var{name}にマッチする利用可能なフォント名のリストをリターンする。@var{name}はFontconfig、GTK、またはXLFDのいずれかのフォーマットによるフォント名を含む文字列であること(@ref{Fonts,,,
emacs, The GNU Emacs
Manual}を参照)。XLFD文字列では、ワイルドカード文字が使用できる。@samp{*}文字は任意の部分文字列、@samp{?}は任意の単一文字にマッチする。フォント名のマッチングでは、大文字小文字の違いは無視される。

オプション引数@var{reference-face}および@var{frame}が指定された場合は、リターンされるリストにはその時点でフレーム@var{frame}上での@var{reference-face}(フェイス名)と同じサイズのフォントだけが含まれる。

オプション引数@var{maximum}は、リターンされるフォント数の制限をセットする。これが非@code{nil}なら、リターン値は最初にマッチした@var{maximum}個のフォントの後が切り捨てられる。@var{maximum}に小さい値を指定すれば、そのパターンに多くのフォントがマッチするような場合に、この関数をより高速にできる。

オプション引数@var{width}は、希望するフォントの幅を指定する。これが非@code{nil}なら、この関数は文字の幅(平均)が、@var{reference-face}の@var{width}倍の幅であるようなフォントだけをリターンする。
@end defun

@defun x-family-fonts &optional family frame
この関数は、@var{frame}上のファミリー@var{family}にたいして利用可能なフォントを記述するリストをリターンする。@var{family}が省略または@code{nil}なら、このリストはすべてのファミリーに適用され、すなわち利用可能なすべてのフォントを含む。それ以外なら、@var{family}は文字列であること。これにはワイルドカード@samp{?}と@samp{*}を含めることができる。

このリストは、@var{frame}のあるディスプレイを記述する。@var{frame}が省略または@code{nil}なら、これは選択されたフレームのディスプレイに適用される(@ref{Input
Focus}を参照)。

このリスト内の各要素は、以下の形式のベクターであること:

@example
[@var{family} @var{width} @var{point-size} @var{weight} @var{slant}
 @var{fixed-p} @var{full} @var{registry-and-encoding}]
@end example

最初の5つの要素はフェイス属性に対応する。あるフェイスにたいしてこれらの属性を指定した場合は、このフォントが使用されるだろう。

最後の3つの要素は、そのフォントに関する追加の情報を与える。そのフォントが固定ピッチ(fixed-pitch)でなければ、@var{fixed-p}は非@code{nil}である。@var{full}はそのフォントのフルネーム、@var{registry-and-encoding}はそのフォントのレジストリーとエンコーディングを与える。
@end defun

@node Fontsets
@subsection Fontsets
@cindex fontset

  @dfn{フォントセット(fontset)}とは、それぞれが文字コードの範囲に割り当てられる、フォントのリストのことです。個々のフォントでは、Emacsがサポートする文字の全範囲を表示できませんが、フォントセットであれば表示することができます。フォントのようにフォントセットは名前をもつことができ、フレームやフェイスにたいして``フォント''を指定する際、フォント名としてフォントセット名を使用できます。以下は、Lispプログラム制御下でのフォントセット定義に関する情報です。

@defun create-fontset-from-fontset-spec fontset-spec &optional style-variant-p noerror
この関数は、仕様文字列@var{fontset-spec}に応じて、新たなフォントセットを定義する。この文字列は以下のような形式であること:

@smallexample
@var{fontpattern}, @r{[}@var{charset}:@var{font}@r{]@dots{}}
@end smallexample

@noindent
カンマの前後の空白文字は無視される。

この文字列の最初の部分@var{fontpattern}は、最後の2つのフィールドが@samp{fontset-@var{alias}}であることを除外して、標準Xフォント名形式をもつこと。

新たなフォントセットはlong名とshort名という、2つの名前をもつ。long名は、それ全体が@var{fontpattern}であり、short名は@samp{fontset-@var{alias}}である。いずれの名前でもこのフォントセットを参照できる。同じ名前がすでに存在するフォントセットでは、@var{noerror}が@code{nil}ならエラーがシグナルされ、@var{noerror}が非@code{nil}ならこの関数は何も行わない。

オプション引数@var{style-variant-p}が非@code{nil}なら、そのフォントセットのbold、italic、およびbold-italicも同様に作成するよう指示する。これらの変種フォントセットはshort名をもたず、bold、および/またはitalicを示すように@var{fontpattern}を変更して作成したlong名だけをもつ。

仕様文字列は、そのフォントセット内でどのフォントを使用するかも宣言する。詳細は以下を参照。
@end defun

  構成@samp{@var{charset}:@var{font}}は、ある特定の文字セットにたいして、(このフォントセット内の)どのフォントを使用するかを指定します。ここで@var{charset}は文字セットの名前、@var{font}はその文字セットにたいして使用するフォントです。仕様文字列内で、この構成を任意の回数使用できます。

  明示的に指定しなかった残りの文字セットにたいして、Emacsは@var{fontpattern}にもとづきフォントを選択します。これは@samp{fontset-@var{alias}}を、その文字セットを命名する値に置き換えます。文字セット@acronym{ASCII}にたいしては、@samp{fontset-@var{alias}}は@samp{ISO8859-1}に置き換えられます。

  加えて、後続の複数フィールドがワイルドカードなら、Emacsはそれらを1つのワイルドカードにまとめます。これは自動スケールフォント(auto-scaled
fonts)の使用を防ぐためです。フォントを大きくスケーリングすることにより作成されたフォントは編集に使用できず、小さくスケーリングされたフォントは、それ自身のサイズがより小さいフォントを使用する(Emacsが行う方法)ほうがよいので、有用ではありません。

  つまり、以下のような@var{fontpattern}なら

@example
-*-fixed-medium-r-normal-*-24-*-*-*-*-*-fontset-24
@end example

@noindent
@acronym{ASCII}にたいするフォントspecは、以下のようになるでしょう:

@example
-*-fixed-medium-r-normal-*-24-*-ISO8859-1
@end example

@noindent
また、Chinese GB2312文字にたいするフォントspecは、以下のようになるでしょう:

@example
-*-fixed-medium-r-normal-*-24-*-gb2312*-*
@end example

  上記のフォントspecにマッチするChineseフォントをもっていないかもしれません。ほとんどのXディストリビューションには、@var{family}フィールドに@samp{song
ti}か@samp{fangsong
ti}をもつChineseフォントだけが含まれます。そのような場合には、以下のように@samp{Fontset-@var{n}}を指定できます:

@smallexample
Emacs.Fontset-0: -*-fixed-medium-r-normal-*-24-*-*-*-*-*-fontset-24,\
        chinese-gb2312:-*-*-medium-r-normal-*-24-*-gb2312*-*
@end smallexample

@noindent
この場合、Chinese
GB2312以外のすべての文にたいするフォントspecは@var{family}フィールドに@samp{fixed}をもち、Chinese
GB2312にたいするフォントspecは@var{family}フィールドにワイルドカード@samp{*}をもちます。

@defun set-fontset-font name character font-spec &optional frame add
この関数は、文字@var{character}にたいして、@var{font-spec}のフォントマッチングを使用するよう、既存のフォントセット@var{name}を変更する。

@var{name}が@code{nil}なら、この関数は@var{frame}のフォントセット、@var{frame}が@code{nil}なら選択されたフレームのフォントセットを変更する。

@var{name}が@code{t}なら、この関数はshort名が@samp{fontset-default}であるような、デフォルトフォントセットを変更する。

@var{character}には@code{(@var{from}
.
@var{to})}のようなコンスを指定できる。ここで@var{from}と@var{to}は文字コードポイントである。この場合、範囲@var{from}から@var{to}(両端を含む)までのすべての文字にたいして、@var{font-spec}を使用する。

@var{character}には文字セットも指定できる。この場合は、その文字セット内のすべての文字にたいして、@var{font-spec}を使用する。

@var{character}にはスクリプト名も指定できる。この場合は、その文字セット内のすべての文字にたいして、@var{font-spec}を使用する。

@var{font-spec}にはコンス@code{(@var{family}
.
@var{registry})}を指定できる。ここで@var{family}はフォントのファミリー名(先頭にfoundry名が含まれるかもしれない)、@var{registry}はフォントのレジストリー名(末尾にエンコーディング名が含まれるかもしれない)である。

@var{font-spec}には、フォント名文字列も指定できる。

オプション引数@var{add}が非@code{nil}なら、以前セットされたフォントspecに@var{font-spec}を追加する方法を指定する。@code{prepend}なら@var{font-spec}は先頭に、@code{append}なら@var{font-spec}は末尾に追加される。デフォルトでは、@var{font-spec}は以前のセッティングをオーバーライドする。

たとえば、以下は文字セット@code{japanese-jisx0208}に属するすえての文字にたいして、ファミリー名が@samp{Kochi
Gothic}であるようなフォントを使用するように、デフォルトフォントセットを変更する。

@smallexample
(set-fontset-font t 'japanese-jisx0208
                  (font-spec :family "Kochi Gothic"))
@end smallexample
@end defun

@defun char-displayable-p char
この関数は、Emacsが@var{char}を表示できるべきなら、@code{t}をリターンする。より正確には、選択されたフレームのフォントセットが、@var{char}が属する文字セットを表示するためのフォントをもつ場合は、@code{t}をリターンする。

フォントセットは、文字単位でフォントを指定できる。フォントセットがこれを行う場合、この関数の値は正確ではないかもしれない。
@end defun

@node Low-Level Font
@subsection Low-Level Font Representation
@cindex font property

  Normally, it is not necessary to manipulate fonts directly.  In case you
need to do so, this section explains how.

  In Emacs Lisp, fonts are represented using three different Lisp object
types: @dfn{font objects}, @dfn{font specs}, and @dfn{font entities}.

@defun fontp object &optional type
Return @code{t} if @var{object} is a font object, font spec, or font
entity.  Otherwise, return @code{nil}.

The optional argument @var{type}, if non-@code{nil}, determines the exact
type of Lisp object to check for.  In that case, @var{type} should be one of
@code{font-object}, @code{font-spec}, or @code{font-entity}.
@end defun

@cindex font object
  A font object is a Lisp object that represents a font that Emacs has
@dfn{opened}.  Font objects cannot be modified in Lisp, but they can be
inspected.

@defun font-at position &optional window string
Return the font object that is being used to display the character at
position @var{position} in the window @var{window}.  If @var{window} is
@code{nil}, it defaults to the selected window.  If @var{string} is
@code{nil}, @var{position} specifies a position in the current buffer;
otherwise, @var{string} should be a string, and @var{position} specifies a
position in that string.
@end defun

@cindex font spec
  A font spec is a Lisp object that contains a set of specifications that can
be used to find a font.  More than one font may match the specifications in
a font spec.

@defun font-spec &rest arguments
Return a new font spec using the specifications in @var{arguments}, which
should come in @code{property}-@code{value} pairs.  The possible
specifications are as follows:

@table @code
@item :name
The font name (a string), in either XLFD, Fontconfig, or GTK format.
@xref{Fonts,,, emacs, The GNU Emacs Manual}.

@item :family
@itemx :foundry
@itemx :weight
@itemx :slant
@itemx :width
These have the same meanings as the face attributes of the same name.
@xref{Face Attributes}.

@item :size
The font size---either a non-negative integer that specifies the pixel size,
or a floating-point number that specifies the point size.

@item :adstyle
Additional typographic style information for the font, such as @samp{sans}.
The value should be a string or a symbol.

@cindex font registry
@item :registry
The charset registry and encoding of the font, such as @samp{iso8859-1}.
The value should be a string or a symbol.

@item :script
The script that the font must support (a symbol).

@item :otf
@cindex OpenType font
The font must be an OpenType font that supports these OpenType features,
provided Emacs is compiled with support for @samp{libotf} (a library for
performing complex text layout in certain scripts).  The value must be a
list of the form

@smallexample
@code{(@var{script-tag} @var{langsys-tag} @var{gsub} @var{gpos})}
@end smallexample

where @var{script-tag} is the OpenType script tag symbol; @var{langsys-tag}
is the OpenType language system tag symbol, or @code{nil} to use the default
language system; @code{gsub} is a list of OpenType GSUB feature tag symbols,
or @code{nil} if none is required; and @code{gpos} is a list of OpenType
GPOS feature tag symbols, or @code{nil} if none is required.  If @code{gsub}
or @code{gpos} is a list, a @code{nil} element in that list means that the
font must not match any of the remaining tag symbols.  The @code{gpos}
element may be omitted.
@end table
@end defun

@defun font-put font-spec property value
Set the font property @var{property} in the font-spec @var{font-spec} to
@var{value}.
@end defun

@cindex font entity
  A font entity is a reference to a font that need not be open.  Its
properties are intermediate between a font object and a font spec: like a
font object, and unlike a font spec, it refers to a single, specific font.
Unlike a font object, creating a font entity does not load the contents of
that font into computer memory.  Emacs may open multiple font objects of
different sizes from a single font entity referring to a scalable font.

@defun find-font font-spec &optional frame
This function returns a font entity that best matches the font spec
@var{font-spec} on frame @var{frame}.  If @var{frame} is @code{nil}, it
defaults to the selected frame.
@end defun

@defun list-fonts font-spec &optional frame num prefer
This function returns a list of all font entities that match the font spec
@var{font-spec}.

The optional argument @var{frame}, if non-@code{nil}, specifies the frame on
which the fonts are to be displayed.  The optional argument @var{num}, if
non-@code{nil}, should be an integer that specifies the maximum length of
the returned list.  The optional argument @var{prefer}, if non-@code{nil},
should be another font spec, which is used to control the order of the
returned list; the returned font entities are sorted in order of decreasing
``closeness'' to that font spec.
@end defun

  If you call @code{set-face-attribute} and pass a font spec, font entity, or
font name string as the value of the @code{:font} attribute, Emacs opens the
best ``matching'' font that is available for display.  It then stores the
corresponding font object as the actual value of the @code{:font} attribute
for that face.

  The following functions can be used to obtain information about a font.  For
these functions, the @var{font} argument can be a font object, a font
entity, or a font spec.

@defun font-get font property
This function returns the value of the font property @var{property} for
@var{font}.

If @var{font} is a font spec and the font spec does not specify
@var{property}, the return value is @code{nil}.  If @var{font} is a font
object or font entity, the value for the @var{:script} property may be a
list of scripts supported by the font.
@end defun

@defun font-face-attributes font &optional frame
This function returns a list of face attributes corresponding to
@var{font}.  The optional argument @var{frame} specifies the frame on which
the font is to be displayed.  If it is @code{nil}, the selected frame is
used.  The return value has the form

@smallexample
(:family @var{family} :height @var{height} :weight @var{weight}
   :slant @var{slant} :width @var{width})
@end smallexample

where the values of @var{family}, @var{height}, @var{weight}, @var{slant},
and @var{width} are face attribute values.  Some of these key-attribute
pairs may be omitted from the list if they are not specified by @var{font}.
@end defun

@defun font-xlfd-name font &optional fold-wildcards
This function returns the XLFD (X Logical Font Descriptor), a string,
matching @var{font}.  @xref{Fonts,,, emacs, The GNU Emacs Manual}, for
information about XLFDs.  If the name is too long for an XLFD (which can
contain at most 255 characters), the function returns @code{nil}.

If the optional argument @var{fold-wildcards} is non-@code{nil}, consecutive
wildcards in the XLFD are folded into one.
@end defun

@node Fringes
@section Fringes
@cindex fringes

  On graphical displays, Emacs draws @dfn{fringes} next to each window: thin
vertical strips down the sides which can display bitmaps indicating
truncation, continuation, horizontal scrolling, and so on.

@menu
* Fringe Size/Pos::          Specifying where to put the window fringes.
* Fringe Indicators::        Displaying indicator icons in the window 
                               fringes.
* Fringe Cursors::           Displaying cursors in the right fringe.
* Fringe Bitmaps::           Specifying bitmaps for fringe indicators.
* Customizing Bitmaps::      Specifying your own bitmaps to use in the 
                               fringes.
* Overlay Arrow::            Display of an arrow to indicate position.
@end menu

@node Fringe Size/Pos
@subsection Fringe Size and Position

  The following buffer-local variables control the position and width of
fringes in windows showing that buffer.

@defvar fringes-outside-margins
The fringes normally appear between the display margins and the window
text.  If the value is non-@code{nil}, they appear outside the display
margins.  @xref{Display Margins}.
@end defvar

@defvar left-fringe-width
This variable, if non-@code{nil}, specifies the width of the left fringe in
pixels.  A value of @code{nil} means to use the left fringe width from the
window's frame.
@end defvar

@defvar right-fringe-width
This variable, if non-@code{nil}, specifies the width of the right fringe in
pixels.  A value of @code{nil} means to use the right fringe width from the
window's frame.
@end defvar

  Any buffer which does not specify values for these variables uses the values
specified by the @code{left-fringe} and @code{right-fringe} frame parameters
(@pxref{Layout Parameters}).

  The above variables actually take effect via the function
@code{set-window-buffer} (@pxref{Buffers and Windows}), which calls
@code{set-window-fringes} as a subroutine.  If you change one of these
variables, the fringe display is not updated in existing windows showing the
buffer, unless you call @code{set-window-buffer} again in each affected
window.  You can also use @code{set-window-fringes} to control the fringe
display in individual windows.

@defun set-window-fringes window left &optional right outside-margins
This function sets the fringe widths of window @var{window}.  If
@var{window} is @code{nil}, the selected window is used.

The argument @var{left} specifies the width in pixels of the left fringe,
and likewise @var{right} for the right fringe.  A value of @code{nil} for
either one stands for the default width.  If @var{outside-margins} is
non-@code{nil}, that specifies that fringes should appear outside of the
display margins.
@end defun

@defun window-fringes &optional window
This function returns information about the fringes of a window
@var{window}.  If @var{window} is omitted or @code{nil}, the selected window
is used.  The value has the form @code{(@var{left-width} @var{right-width}
@var{outside-margins})}.
@end defun


@node Fringe Indicators
@subsection Fringe Indicators
@cindex fringe indicators
@cindex indicators, fringe

  @dfn{Fringe indicators} are tiny icons displayed in the window fringe to
indicate truncated or continued lines, buffer boundaries, etc.

@defopt indicate-empty-lines
@cindex fringes, and empty line indication
@cindex empty lines, indicating
When this is non-@code{nil}, Emacs displays a special glyph in the fringe of
each empty line at the end of the buffer, on graphical displays.
@xref{Fringes}.  This variable is automatically buffer-local in every
buffer.
@end defopt

@defopt indicate-buffer-boundaries
@cindex buffer boundaries, indicating
This buffer-local variable controls how the buffer boundaries and window
scrolling are indicated in the window fringes.

Emacs can indicate the buffer boundaries---that is, the first and last line
in the buffer---with angle icons when they appear on the screen.  In
addition, Emacs can display an up-arrow in the fringe to show that there is
text above the screen, and a down-arrow to show there is text below the
screen.

There are three kinds of basic values:

@table @asis
@item @code{nil}
Don't display any of these fringe icons.
@item @code{left}
Display the angle icons and arrows in the left fringe.
@item @code{right}
Display the angle icons and arrows in the right fringe.
@item any non-alist
Display the angle icons in the left fringe and don't display the arrows.
@end table

Otherwise the value should be an alist that specifies which fringe
indicators to display and where.  Each element of the alist should have the
form @code{(@var{indicator} . @var{position})}.  Here, @var{indicator} is
one of @code{top}, @code{bottom}, @code{up}, @code{down}, and @code{t}
(which covers all the icons not yet specified), while @var{position} is one
of @code{left}, @code{right} and @code{nil}.

For example, @code{((top . left) (t . right))} places the top angle bitmap
in left fringe, and the bottom angle bitmap as well as both arrow bitmaps in
right fringe.  To show the angle bitmaps in the left fringe, and no arrow
bitmaps, use @code{((top .  left) (bottom . left))}.
@end defopt

@defvar fringe-indicator-alist
This buffer-local variable specifies the mapping from logical fringe
indicators to the actual bitmaps displayed in the window fringes.  The value
is an alist of elements @code{(@var{indicator} . @var{bitmaps})}, where
@var{indicator} specifies a logical indicator type and @var{bitmaps}
specifies the fringe bitmaps to use for that indicator.

  Each @var{indicator} should be one of the following symbols:

@table @asis
@item @code{truncation}, @code{continuation}.
Used for truncation and continuation lines.

@item @code{up}, @code{down}, @code{top}, @code{bottom}, @code{top-bottom}
Used when @code{indicate-buffer-boundaries} is non-@code{nil}: @code{up} and
@code{down} indicate a buffer boundary lying above or below the window edge;
@code{top} and @code{bottom} indicate the topmost and bottommost buffer text
line; and @code{top-bottom} indicates where there is just one line of text
in the buffer.

@item @code{empty-line}
Used to indicate empty lines when @code{indicate-empty-lines} is
non-@code{nil}.

@item @code{overlay-arrow}
@c Is this used anywhere?
@c @item Unknown bitmap indicator:
@c @code{unknown}.
Used for overlay arrows (@pxref{Overlay Arrow}).
@end table

  Each @var{bitmaps} value may be a list of symbols @code{(@var{left}
@var{right} [@var{left1} @var{right1}])}.  The @var{left} and @var{right}
symbols specify the bitmaps shown in the left and/or right fringe, for the
specific indicator.  @var{left1} and @var{right1} are specific to the
@code{bottom} and @code{top-bottom} indicators, and are used to indicate
that the last text line has no final newline.  Alternatively, @var{bitmaps}
may be a single symbol which is used in both left and right fringes.

  @xref{Fringe Bitmaps}, for a list of standard bitmap symbols and how to
define your own.  In addition, @code{nil} represents the empty bitmap (i.e.,
an indicator that is not shown).

  When @code{fringe-indicator-alist} has a buffer-local value, and there is no
bitmap defined for a logical indicator, or the bitmap is @code{t}, the
corresponding value from the default value of @code{fringe-indicator-alist}
is used.
@end defvar

@node Fringe Cursors
@subsection Fringe Cursors
@cindex fringe cursors
@cindex cursor, fringe

  When a line is exactly as wide as the window, Emacs displays the cursor in
the right fringe instead of using two lines.  Different bitmaps are used to
represent the cursor in the fringe depending on the current buffer's cursor
type.

@defopt overflow-newline-into-fringe
If this is non-@code{nil}, lines exactly as wide as the window (not counting
the final newline character) are not continued.  Instead, when point is at
the end of the line, the cursor appears in the right fringe.
@end defopt

@defvar fringe-cursor-alist
This variable specifies the mapping from logical cursor type to the actual
fringe bitmaps displayed in the right fringe.  The value is an alist where
each element has the form @code{(@var{cursor-type} . @var{bitmap})}, which
means to use the fringe bitmap @var{bitmap} to display cursors of type
@var{cursor-type}.

Each @var{cursor-type} should be one of @code{box}, @code{hollow},
@code{bar}, @code{hbar}, or @code{hollow-small}.  The first four have the
same meanings as in the @code{cursor-type} frame parameter (@pxref{Cursor
Parameters}).  The @code{hollow-small} type is used instead of @code{hollow}
when the normal @code{hollow-rectangle} bitmap is too tall to fit on a
specific display line.

Each @var{bitmap} should be a symbol specifying the fringe bitmap to be
displayed for that logical cursor type.
@iftex
See the next subsection for details.
@end iftex
@ifnottex
@xref{Fringe Bitmaps}.
@end ifnottex

@c FIXME: I can't find the fringes-indicator-alist variable.  Maybe
@c it should be fringe-indicator-alist or fringe-cursor-alist?  --xfq
When @code{fringe-cursor-alist} has a buffer-local value, and there is no
bitmap defined for a cursor type, the corresponding value from the default
value of @code{fringes-indicator-alist} is used.
@end defvar

@node Fringe Bitmaps
@subsection Fringe Bitmaps
@cindex fringe bitmaps
@cindex bitmaps, fringe

  The @dfn{fringe bitmaps} are the actual bitmaps which represent the logical
fringe indicators for truncated or continued lines, buffer boundaries,
overlay arrows, etc.  Each bitmap is represented by a symbol.
@iftex
These symbols are referred to by the variables @code{fringe-indicator-alist}
and @code{fringe-cursor-alist}, described in the previous subsections.
@end iftex
@ifnottex
These symbols are referred to by the variable @code{fringe-indicator-alist},
which maps fringe indicators to bitmaps (@pxref{Fringe Indicators}), and the
variable @code{fringe-cursor-alist}, which maps fringe cursors to bitmaps
(@pxref{Fringe Cursors}).
@end ifnottex

  Lisp programs can also directly display a bitmap in the left or right
fringe, by using a @code{display} property for one of the characters
appearing in the line (@pxref{Other Display Specs}).  Such a display
specification has the form

@example
(@var{fringe} @var{bitmap} [@var{face}])
@end example

@noindent
@var{fringe} is either the symbol @code{left-fringe} or
@code{right-fringe}.  @var{bitmap} is a symbol identifying the bitmap to
display.  The optional @var{face} names a face whose foreground color is
used to display the bitmap; this face is automatically merged with the
@code{fringe} face.

  Here is a list of the standard fringe bitmaps defined in Emacs, and how they
are currently used in Emacs (via @code{fringe-indicator-alist} and
@code{fringe-cursor-alist}):

@table @asis
@item @code{left-arrow}, @code{right-arrow}
Used to indicate truncated lines.

@item @code{left-curly-arrow}, @code{right-curly-arrow}
Used to indicate continued lines.

@item @code{right-triangle}, @code{left-triangle}
The former is used by overlay arrows.  The latter is unused.

@item @code{up-arrow}, @code{down-arrow}, @code{top-left-angle} @code{top-right-angle}
@itemx @code{bottom-left-angle}, @code{bottom-right-angle}
@itemx @code{top-right-angle}, @code{top-left-angle}
@itemx @code{left-bracket}, @code{right-bracket}, @code{top-right-angle}, @code{top-left-angle}
Used to indicate buffer boundaries.

@item @code{filled-rectangle}, @code{hollow-rectangle}
@itemx @code{filled-square}, @code{hollow-square}
@itemx @code{vertical-bar}, @code{horizontal-bar}
Used for different types of fringe cursors.

@item @code{empty-line}, @code{exclamation-mark}, @code{question-mark}, @code{exclamation-mark}
Not used by core Emacs features.
@end table

@noindent
The next subsection describes how to define your own fringe bitmaps.

@defun fringe-bitmaps-at-pos &optional pos window
This function returns the fringe bitmaps of the display line containing
position @var{pos} in window @var{window}.  The return value has the form
@code{(@var{left} @var{right} @var{ov})}, where @var{left} is the symbol for
the fringe bitmap in the left fringe (or @code{nil} if no bitmap),
@var{right} is similar for the right fringe, and @var{ov} is non-@code{nil}
if there is an overlay arrow in the left fringe.

The value is @code{nil} if @var{pos} is not visible in @var{window}.  If
@var{window} is @code{nil}, that stands for the selected window.  If
@var{pos} is @code{nil}, that stands for the value of point in @var{window}.
@end defun

@node Customizing Bitmaps
@subsection Customizing Fringe Bitmaps
@cindex fringe bitmaps, customizing

@defun define-fringe-bitmap bitmap bits &optional height width align
This function defines the symbol @var{bitmap} as a new fringe bitmap, or
replaces an existing bitmap with that name.

The argument @var{bits} specifies the image to use.  It should be either a
string or a vector of integers, where each element (an integer) corresponds
to one row of the bitmap.  Each bit of an integer corresponds to one pixel
of the bitmap, where the low bit corresponds to the rightmost pixel of the
bitmap.

The height is normally the length of @var{bits}.  However, you can specify a
different height with non-@code{nil} @var{height}.  The width is normally 8,
but you can specify a different width with non-@code{nil} @var{width}.  The
width must be an integer between 1 and 16.

The argument @var{align} specifies the positioning of the bitmap relative to
the range of rows where it is used; the default is to center the bitmap.
The allowed values are @code{top}, @code{center}, or @code{bottom}.

The @var{align} argument may also be a list @code{(@var{align}
@var{periodic})} where @var{align} is interpreted as described above.  If
@var{periodic} is non-@code{nil}, it specifies that the rows in @code{bits}
should be repeated enough times to reach the specified height.
@end defun

@defun destroy-fringe-bitmap bitmap
This function destroy the fringe bitmap identified by @var{bitmap}.  If
@var{bitmap} identifies a standard fringe bitmap, it actually restores the
standard definition of that bitmap, instead of eliminating it entirely.
@end defun

@defun set-fringe-bitmap-face bitmap &optional face
This sets the face for the fringe bitmap @var{bitmap} to @var{face}.  If
@var{face} is @code{nil}, it selects the @code{fringe} face.  The bitmap's
face controls the color to draw it in.

@var{face} is merged with the @code{fringe} face, so normally @var{face}
should specify only the foreground color.
@end defun

@node Overlay Arrow
@subsection The Overlay Arrow
@c @cindex overlay arrow  Duplicates variable names

  The @dfn{overlay arrow} is useful for directing the user's attention to a
particular line in a buffer.  For example, in the modes used for interface
to debuggers, the overlay arrow indicates the line of code about to be
executed.  This feature has nothing to do with @dfn{overlays}
(@pxref{Overlays}).

@defvar overlay-arrow-string
This variable holds the string to display to call attention to a particular
line, or @code{nil} if the arrow feature is not in use.  On a graphical
display the contents of the string are ignored; instead a glyph is displayed
in the fringe area to the left of the display area.
@end defvar

@defvar overlay-arrow-position
This variable holds a marker that indicates where to display the overlay
arrow.  It should point at the beginning of a line.  On a non-graphical
display the arrow text appears at the beginning of that line, overlaying any
text that would otherwise appear.  Since the arrow is usually short, and the
line usually begins with indentation, normally nothing significant is
overwritten.

@c !!! overlay-arrow-position: but the overlay string may remain in the display
@c of some other buffer until an update is required.  This should be fixed
@c now.  Is it?
The overlay-arrow string is displayed in any given buffer if the value of
@code{overlay-arrow-position} in that buffer points into that buffer.  Thus,
it is possible to display multiple overlay arrow strings by creating
buffer-local bindings of @code{overlay-arrow-position}.  However, it is
usually cleaner to use @code{overlay-arrow-variable-list} to achieve this
result.
@end defvar

  You can do a similar job by creating an overlay with a @code{before-string}
property.  @xref{Overlay Properties}.

  You can define multiple overlay arrows via the variable
@code{overlay-arrow-variable-list}.

@defvar overlay-arrow-variable-list
This variable's value is a list of variables, each of which specifies the
position of an overlay arrow.  The variable @code{overlay-arrow-position}
has its normal meaning because it is on this list.
@end defvar

Each variable on this list can have properties @code{overlay-arrow-string}
and @code{overlay-arrow-bitmap} that specify an overlay arrow string (for
text terminals) or fringe bitmap (for graphical terminals) to display at the
corresponding overlay arrow position.  If either property is not set, the
default @code{overlay-arrow-string} or @code{overlay-arrow} fringe indicator
is used.

@node Scroll Bars
@section Scroll Bars
@cindex scroll bars

Normally the frame parameter @code{vertical-scroll-bars} controls whether
the windows in the frame have vertical scroll bars, and whether they are on
the left or right.  The frame parameter @code{scroll-bar-width} specifies
how wide they are (@code{nil} meaning the default).  @xref{Layout
Parameters}.

@defun frame-current-scroll-bars &optional frame
This function reports the scroll bar type settings for frame @var{frame}.
The value is a cons cell @code{(@var{vertical-type} .@:
@var{horizontal-type})}, where @var{vertical-type} is either @code{left},
@code{right}, or @code{nil} (which means no scroll bar.)
@var{horizontal-type} is meant to specify the horizontal scroll bar type,
but since they are not implemented, it is always @code{nil}.
@end defun

@vindex vertical-scroll-bar
  You can enable or disable scroll bars for a particular buffer, by setting
the variable @code{vertical-scroll-bar}.  This variable automatically
becomes buffer-local when set.  The possible values are @code{left},
@code{right}, @code{t}, which means to use the frame's default, and
@code{nil} for no scroll bar.

  You can also control this for individual windows.  Call the function
@code{set-window-scroll-bars} to specify what to do for a specific window:

@defun set-window-scroll-bars window width &optional vertical-type horizontal-type
This function sets the width and type of scroll bars for window
@var{window}.

@var{width} specifies the scroll bar width in pixels (@code{nil} means use
the width specified for the frame).  @var{vertical-type} specifies whether
to have a vertical scroll bar and, if so, where.  The possible values are
@code{left}, @code{right} and @code{nil}, just like the values of the
@code{vertical-scroll-bars} frame parameter.

The argument @var{horizontal-type} is meant to specify whether and where to
have horizontal scroll bars, but since they are not implemented, it has no
effect.  If @var{window} is @code{nil}, the selected window is used.
@end defun

@defun window-scroll-bars &optional window
Report the width and type of scroll bars specified for @var{window}.  If
@var{window} is omitted or @code{nil}, the selected window is used.  The
value is a list of the form @code{(@var{width} @var{cols}
@var{vertical-type} @var{horizontal-type})}.  The value @var{width} is the
value that was specified for the width (which may be @code{nil}); @var{cols}
is the number of columns that the scroll bar actually occupies.

@var{horizontal-type} is not actually meaningful.
@end defun

@defun window-scroll-bar-width &optional window
This function returns the width in pixels of @var{window}'s vertical
scrollbar.  @var{window} must be a live window, and defaults to the selected
window.
@end defun

If you don't specify these values for a window with
@code{set-window-scroll-bars}, the buffer-local variables
@code{scroll-bar-mode} and @code{scroll-bar-width} in the buffer being
displayed control the window's vertical scroll bars.  The function
@code{set-window-buffer} examines these variables.  If you change them in a
buffer that is already visible in a window, you can make the window take
note of the new values by calling @code{set-window-buffer} specifying the
same buffer that is already displayed.

@defopt scroll-bar-mode
This variable, always local in all buffers, controls whether and where to
put scroll bars in windows displaying the buffer.  The possible values are
@code{nil} for no scroll bar, @code{left} to put a scroll bar on the left,
and @code{right} to put a scroll bar on the right.
@end defopt

@defun window-current-scroll-bars &optional window
This function reports the scroll bar type for window @var{window}.  If
@var{window} is omitted or @code{nil}, the selected window is used.  The
value is a cons cell @code{(@var{vertical-type} .@:
@var{horizontal-type})}.  Unlike @code{window-scroll-bars}, this reports the
scroll bar type actually used, once frame defaults and
@code{scroll-bar-mode} are taken into account.
@end defun

@defvar scroll-bar-width
This variable, always local in all buffers, specifies the width of the
buffer's scroll bars, measured in pixels.  A value of @code{nil} means to
use the value specified by the frame.
@end defvar

@node Window Dividers
@section Window Dividers
@cindex window dividers
@cindex right dividers
@cindex bottom dividers

Window dividers are bars drawn between a frame's windows.  A ``right''
divider is drawn between a window and any adjacent windows on the right.
Its width (thickness) is specified by the frame parameter
@code{right-divider-width}.  A ``bottom'' divider is drawn between a window
and adjacent windows on the bottom or the echo area.  Its width is specified
by the frame parameter @code{bottom-divider-width}.  In either case,
specifying a width of zero means to not draw such dividers.  @xref{Layout
Parameters}.

   Technically, a right divider ``belongs'' to the window on its left, which
means that its width contributes to the total width of that window.  A
bottom divider ``belongs'' to the window above it, which means that its
width contributes to the total height of that window.  @xref{Window Sizes}.
When a window has both, a right and a bottom divider, the bottom divider
``prevails''.  This means that a bottom divider is drawn over the full total
width of its window while the right divider ends above the bottom divider.

   Dividers can be dragged with the mouse and are therefore useful for
adjusting the sizes of adjacent windows with the mouse.  They also serve to
visually set apart adjacent windows when no scroll bars or mode lines are
present.  The following three faces allow to customize the appearance of
dividers:

@table @code
@item window-divider
When a divider is less than three pixels wide, it is drawn solidly with the
foreground of this face.  For larger dividers this face is used for the
inner part only, excluding the first and last pixel.

@item window-divider-first-pixel
This is the face used for drawing the first pixel of a divider that is at
least three pixels wide.  To obtain a solid appearance, set this to the same
value used for the @code{window-divider} face.

@item window-divider-last-pixel
This is the face used for drawing the last pixel of a divider that is at
least three pixels wide.  To obtain a solid appearance, set this to the same
value used for the @code{window-divider} face.
@end table

You can get the sizes of the dividers of a specific window with the
following two functions.

@defun window-right-divider-width &optional window
Return the width (thickness) in pixels of @var{window}'s right divider.
@var{window} must be a live window and defaults to the selected one.  The
return value is always zero for a rightmost window.
@end defun

@defun window-bottom-divider-width &optional window
Return the width (thickness) in pixels of @var{window}'s bottom divider.
@var{window} must be a live window and defaults to the selected one.  The
return value is zero for the minibuffer window or a bottommost window on a
minibuffer-less frame.
@end defun


@node Display Property
@section The @code{display} Property
@cindex display specification
@kindex display @r{(text property)}

  The @code{display} text property (or overlay property) is used to insert
images into text, and to control other aspects of how text displays.  The
value of the @code{display} property should be a display specification, or a
list or vector containing several display specifications.  Display
specifications in the same @code{display} property value generally apply in
parallel to the text they cover.

  If several sources (overlays and/or a text property) specify values for the
@code{display} property, only one of the values takes effect, following the
rules of @code{get-char-property}.  @xref{Examining Properties}.

  The rest of this section describes several kinds of display specifications
and what they mean.

@menu
* Replacing Specs::          Display specs that replace the text.
* Specified Space::          Displaying one space with a specified width.
* Pixel Specification::      Specifying space width or height in pixels.
* Other Display Specs::      Displaying an image; adjusting the height, 
                               spacing, and other properties of text.
* Display Margins::          Displaying text or images to the side of the 
                               main text.
@end menu

@node Replacing Specs
@subsection Display Specs That Replace The Text
@cindex replacing display specs

  Some kinds of display specifications specify something to display instead of
the text that has the property.  These are called @dfn{replacing} display
specifications.  Emacs does not allow the user to interactively move point
into the middle of buffer text that is replaced in this way.

  If a list of display specifications includes more than one replacing display
specification, the first overrides the rest.  Replacing display
specifications make most other display specifications irrelevant, since
those don't apply to the replacement.

  For replacing display specifications, ``the text that has the property''
means all the consecutive characters that have the same Lisp object as their
@code{display} property; these characters are replaced as a single unit.  If
two characters have different Lisp objects as their @code{display}
properties (i.e., objects which are not @code{eq}), they are handled
separately.

  Here is an example which illustrates this point.  A string serves as a
replacing display specification, which replaces the text that has the
property with the specified string (@pxref{Other Display Specs}).  Consider
the following function:

@smallexample
(defun foo ()
  (dotimes (i 5)
    (let ((string (concat "A"))
          (start (+ i i (point-min))))
      (put-text-property start (1+ start) 'display string)
      (put-text-property start (+ 2 start) 'display string))))
@end smallexample

@noindent
This function gives each of the first ten characters in the buffer a
@code{display} property which is a string @code{"A"}, but they don't all get
the same string object.  The first two characters get the same string
object, so they are replaced with one @samp{A}; the fact that the display
property was assigned in two separate calls to @code{put-text-property} is
irrelevant.  Similarly, the next two characters get a second string
(@code{concat} creates a new string object), so they are replaced with one
@samp{A}; and so on.  Thus, the ten characters appear as five A's.

@node Specified Space
@subsection Specified Spaces
@cindex spaces, specified height or width
@cindex variable-width spaces

  To display a space of specified width and/or height, use a display
specification of the form @code{(space . @var{props})}, where @var{props} is
a property list (a list of alternating properties and values).  You can put
this property on one or more consecutive characters; a space of the
specified height and width is displayed in place of @emph{all} of those
characters.  These are the properties you can use in @var{props} to specify
the weight of the space:

@table @code
@item :width @var{width}
If @var{width} is a number, it specifies that the space width should be
@var{width} times the normal character width.  @var{width} can also be a
@dfn{pixel width} specification (@pxref{Pixel Specification}).

@item :relative-width @var{factor}
Specifies that the width of the stretch should be computed from the first
character in the group of consecutive characters that have the same
@code{display} property.  The space width is the width of that character,
multiplied by @var{factor}.

@item :align-to @var{hpos}
Specifies that the space should be wide enough to reach @var{hpos}.  If
@var{hpos} is a number, it is measured in units of the normal character
width.  @var{hpos} can also be a @dfn{pixel width} specification
(@pxref{Pixel Specification}).
@end table

  You should use one and only one of the above properties.  You can also
specify the height of the space, with these properties:

@table @code
@item :height @var{height}
Specifies the height of the space.  If @var{height} is a number, it
specifies that the space height should be @var{height} times the normal
character height.  The @var{height} may also be a @dfn{pixel height}
specification (@pxref{Pixel Specification}).

@item :relative-height @var{factor}
Specifies the height of the space, multiplying the ordinary height of the
text having this display specification by @var{factor}.

@item :ascent @var{ascent}
If the value of @var{ascent} is a non-negative number no greater than 100,
it specifies that @var{ascent} percent of the height of the space should be
considered as the ascent of the space---that is, the part above the
baseline.  The ascent may also be specified in pixel units with a @dfn{pixel
ascent} specification (@pxref{Pixel Specification}).

@end table

  Don't use both @code{:height} and @code{:relative-height} together.

  The @code{:width} and @code{:align-to} properties are supported on
non-graphic terminals, but the other space properties in this section are
not.

  Note that space properties are treated as paragraph separators for the
purposes of reordering bidirectional text for display.  @xref{Bidirectional
Display}, for the details.

@node Pixel Specification
@subsection Pixel Specification for Spaces
@cindex spaces, pixel specification

  The value of the @code{:width}, @code{:align-to}, @code{:height}, and
@code{:ascent} properties can be a special kind of expression that is
evaluated during redisplay.  The result of the evaluation is used as an
absolute number of pixels.

  The following expressions are supported:

@smallexample
@group
  @var{expr} ::= @var{num} | (@var{num}) | @var{unit} | @var{elem} | @var{pos} | @var{image} | @var{form}
  @var{num}  ::= @var{integer} | @var{float} | @var{symbol}
  @var{unit} ::= in | mm | cm | width | height
@end group
@group
  @var{elem} ::= left-fringe | right-fringe | left-margin | right-margin
        |  scroll-bar | text
  @var{pos}  ::= left | center | right
  @var{form} ::= (@var{num} . @var{expr}) | (@var{op} @var{expr} ...)
  @var{op}   ::= + | -
@end group
@end smallexample

  The form @var{num} specifies a fraction of the default frame font height or
width.  The form @code{(@var{num})} specifies an absolute number of pixels.
If @var{num} is a symbol, @var{symbol}, its buffer-local variable binding is
used.

  The @code{in}, @code{mm}, and @code{cm} units specify the number of pixels
per inch, millimeter, and centimeter, respectively.  The @code{width} and
@code{height} units correspond to the default width and height of the
current face.  An image specification @code{image} corresponds to the width
or height of the image.

  The elements @code{left-fringe}, @code{right-fringe}, @code{left-margin},
@code{right-margin}, @code{scroll-bar}, and @code{text} specify to the width
of the corresponding area of the window.

  The @code{left}, @code{center}, and @code{right} positions can be used with
@code{:align-to} to specify a position relative to the left edge, center, or
right edge of the text area.

  Any of the above window elements (except @code{text}) can also be used with
@code{:align-to} to specify that the position is relative to the left edge
of the given area.  Once the base offset for a relative position has been
set (by the first occurrence of one of these symbols), further occurrences
of these symbols are interpreted as the width of the specified area.  For
example, to align to the center of the left-margin, use

@example
:align-to (+ left-margin (0.5 . left-margin))
@end example

  If no specific base offset is set for alignment, it is always relative to
the left edge of the text area.  For example, @samp{:align-to 0} in a
header-line aligns with the first text column in the text area.

  A value of the form @code{(@var{num} . @var{expr})} stands for the product
of the values of @var{num} and @var{expr}.  For example, @code{(2 . in)}
specifies a width of 2 inches, while @code{(0.5 .  @var{image})} specifies
half the width (or height) of the specified image.

  The form @code{(+ @var{expr} ...)} adds up the value of the expressions.
The form @code{(- @var{expr} ...)} negates or subtracts the value of the
expressions.

@node Other Display Specs
@subsection Other Display Specifications

  Here are the other sorts of display specifications that you can use in the
@code{display} text property.

@table @code
@item @var{string}
Display @var{string} instead of the text that has this property.

Recursive display specifications are not supported---@var{string}'s
@code{display} properties, if any, are not used.

@item (image . @var{image-props})
This kind of display specification is an image descriptor (@pxref{Images}).
When used as a display specification, it means to display the image instead
of the text that has the display specification.

@item (slice @var{x} @var{y} @var{width} @var{height})
This specification together with @code{image} specifies a @dfn{slice} (a
partial area) of the image to display.  The elements @var{y} and @var{x}
specify the top left corner of the slice, within the image; @var{width} and
@var{height} specify the width and height of the slice.  Integers are
numbers of pixels.  A floating-point number in the range 0.0--1.0 stands for
that fraction of the width or height of the entire image.

@item ((margin nil) @var{string})
A display specification of this form means to display @var{string} instead
of the text that has the display specification, at the same position as that
text.  It is equivalent to using just @var{string}, but it is done as a
special case of marginal display (@pxref{Display Margins}).

@item (left-fringe @var{bitmap} @r{[}@var{face}@r{]})
@itemx (right-fringe @var{bitmap} @r{[}@var{face}@r{]})
This display specification on any character of a line of text causes the
specified @var{bitmap} be displayed in the left or right fringes for that
line, instead of the characters that have the display specification.  The
optional @var{face} specifies the colors to be used for the bitmap.
@xref{Fringe Bitmaps}, for the details.

@item (space-width @var{factor})
This display specification affects all the space characters within the text
that has the specification.  It displays all of these spaces @var{factor}
times as wide as normal.  The element @var{factor} should be an integer or
float.  Characters other than spaces are not affected at all; in particular,
this has no effect on tab characters.

@item (height @var{height})
This display specification makes the text taller or shorter.  Here are the
possibilities for @var{height}:

@table @asis
@item @code{(+ @var{n})}
@c FIXME: Add an index for "step"?  --xfq
This means to use a font that is @var{n} steps larger.  A ``step'' is
defined by the set of available fonts---specifically, those that match what
was otherwise specified for this text, in all attributes except height.
Each size for which a suitable font is available counts as another step.
@var{n} should be an integer.

@item @code{(- @var{n})}
This means to use a font that is @var{n} steps smaller.

@item a number, @var{factor}
A number, @var{factor}, means to use a font that is @var{factor} times as
tall as the default font.

@item a symbol, @var{function}
A symbol is a function to compute the height.  It is called with the current
height as argument, and should return the new height to use.

@item anything else, @var{form}
If the @var{height} value doesn't fit the previous possibilities, it is a
form.  Emacs evaluates it to get the new height, with the symbol
@code{height} bound to the current specified font height.
@end table

@item (raise @var{factor})
This kind of display specification raises or lowers the text it applies to,
relative to the baseline of the line.

@var{factor} must be a number, which is interpreted as a multiple of the
height of the affected text.  If it is positive, that means to display the
characters raised.  If it is negative, that means to display them lower
down.

If the text also has a @code{height} display specification, that does not
affect the amount of raising or lowering, which is based on the faces used
for the text.
@end table

@c We put all the `@code{(when ...)}' on one line to encourage
@c makeinfo's end-of-sentence heuristics to DTRT.  Previously, the dot
@c was at eol; the info file ended up w/ two spaces rendered after it.
  You can make any display specification conditional.  To do that, package it
in another list of the form @code{(when @var{condition} . @var{spec})}.
Then the specification @var{spec} applies only when @var{condition}
evaluates to a non-@code{nil} value.  During the evaluation, @code{object}
is bound to the string or buffer having the conditional @code{display}
property.  @code{position} and @code{buffer-position} are bound to the
position within @code{object} and the buffer position where the
@code{display} property was found, respectively.  Both positions can be
different when @code{object} is a string.

@node Display Margins
@subsection Displaying in the Margins
@cindex display margins
@cindex margins, display

  A buffer can have blank areas called @dfn{display margins} on the left and
on the right.  Ordinary text never appears in these areas, but you can put
things into the display margins using the @code{display} property.  There is
currently no way to make text or images in the margin mouse-sensitive.

  The way to display something in the margins is to specify it in a margin
display specification in the @code{display} property of some text.  This is
a replacing display specification, meaning that the text you put it on does
not get displayed; the margin display appears, but that text does not.

  A margin display specification looks like @code{((margin right-margin)
@var{spec})} or @code{((margin left-margin) @var{spec})}.  Here, @var{spec}
is another display specification that says what to display in the margin.
Typically it is a string of text to display, or an image descriptor.

  To display something in the margin @emph{in association with} certain buffer
text, without altering or preventing the display of that text, put a
@code{before-string} property on the text and put the margin display
specification on the contents of the before-string.

  Before the display margins can display anything, you must give them a
nonzero width.  The usual way to do that is to set these variables:

@defvar left-margin-width
This variable specifies the width of the left margin, in character cell
(a.k.a.@: ``column'') units.  It is buffer-local in all buffers.  A value of
@code{nil} means no left marginal area.
@end defvar

@defvar right-margin-width
This variable specifies the width of the right margin, in character cell
units.  It is buffer-local in all buffers.  A value of @code{nil} means no
right marginal area.
@end defvar

  Setting these variables does not immediately affect the window.  These
variables are checked when a new buffer is displayed in the window.  Thus,
you can make changes take effect by calling @code{set-window-buffer}.

  You can also set the margin widths immediately.

@defun set-window-margins window left &optional right
This function specifies the margin widths for window @var{window}, in
character cell units.  The argument @var{left} controls the left margin, and
@var{right} controls the right margin (default @code{0}).
@end defun

@defun window-margins &optional window
This function returns the width of the left and right margins of
@var{window} as a cons cell of the form @w{@code{(@var{left}
. @var{right})}}.  If one of the two marginal areas does not exist, its
width is returned as @code{nil}; if neither of the two margins exist, the
function returns @code{(nil)}.  If @var{window} is @code{nil}, the selected
window is used.
@end defun

@node Images
@section Images
@cindex images in buffers

  To display an image in an Emacs buffer, you must first create an image
descriptor, then use it as a display specifier in the @code{display}
property of text that is displayed (@pxref{Display Property}).

  Emacs is usually able to display images when it is run on a graphical
terminal.  Images cannot be displayed in a text terminal, on certain
graphical terminals that lack the support for this, or if Emacs is compiled
without image support.  You can use the function @code{display-images-p} to
determine if images can in principle be displayed (@pxref{Display Feature
Testing}).

@menu
* Image Formats::            Supported image formats.
* Image Descriptors::        How to specify an image for use in 
                               @code{:display}.
* XBM Images::               Special features for XBM format.
* XPM Images::               Special features for XPM format.
* PostScript Images::        Special features for PostScript format.
* ImageMagick Images::       Special features available through ImageMagick.
* Other Image Types::        Various other formats are supported.
* Defining Images::          Convenient ways to define an image for later 
                               use.
* Showing Images::           Convenient ways to display an image once it is 
                               defined.
* Multi-Frame Images::       Some images contain more than one frame.
* Image Cache::              Internal mechanisms of image display.
@end menu

@node Image Formats
@subsection Image Formats
@cindex image formats
@cindex image types

  Emacs can display a number of different image formats.  Some of these image
formats are supported only if particular support libraries are installed.
On some platforms, Emacs can load support libraries on demand; if so, the
variable @code{dynamic-library-alist} can be used to modify the set of known
names for these dynamic libraries.  @xref{Dynamic Libraries}.

  Supported image formats (and the required support libraries) include PBM and
XBM (which do not depend on support libraries and are always available), XPM
(@code{libXpm}), GIF (@code{libgif} or @code{libungif}), PostScript
(@code{gs}), JPEG (@code{libjpeg}), TIFF (@code{libtiff}), PNG
(@code{libpng}), and SVG (@code{librsvg}).

  Each of these image formats is associated with an @dfn{image type symbol}.
The symbols for the above formats are, respectively, @code{pbm}, @code{xbm},
@code{xpm}, @code{gif}, @code{postscript}, @code{jpeg}, @code{tiff},
@code{png}, and @code{svg}.

  Furthermore, if you build Emacs with ImageMagick (@code{libMagickWand})
support, Emacs can display any image format that ImageMagick can.
@xref{ImageMagick Images}.  All images displayed via ImageMagick have type
symbol @code{imagemagick}.

@defvar image-types
This variable contains a list of type symbols for image formats which are
potentially supported in the current configuration.

``Potentially'' means that Emacs knows about the image types, not
necessarily that they can be used (for example, they could depend on
unavailable dynamic libraries).  To know which image types are really
available, use @code{image-type-available-p}.
@end defvar

@defun image-type-available-p type
This function returns non-@code{nil} if images of type @var{type} can be
loaded and displayed.  @var{type} must be an image type symbol.

For image types whose support libraries are statically linked, this function
always returns @code{t}.  For image types whose support libraries are
dynamically loaded, it returns @code{t} if the library could be loaded and
@code{nil} otherwise.
@end defun

@node Image Descriptors
@subsection Image Descriptors
@cindex image descriptor

  An @dfn{image descriptor} is a list which specifies the underlying data for
an image, and how to display it.  It is typically used as the value of a
@code{display} overlay or text property (@pxref{Other Display Specs}); but
@xref{Showing Images}, for convenient helper functions to insert images into
buffers.

  Each image descriptor has the form @code{(image . @var{props})}, where
@var{props} is a property list of alternating keyword symbols and values,
including at least the pair @code{:type @var{type}} that specifies the image
type.

  The following is a list of properties that are meaningful for all image
types (there are also properties which are meaningful only for certain image
types, as documented in the following subsections):

@table @code
@item :type @var{type}
The image type.
@ifnottex
@xref{Image Formats}.
@end ifnottex
Every image descriptor must include this property.

@item :file @var{file}
This says to load the image from file @var{file}.  If @var{file} is not an
absolute file name, it is expanded in @code{data-directory}.

@item :data @var{data}
This specifies the raw image data.  Each image descriptor must have either
@code{:data} or @code{:file}, but not both.

For most image types, the value of a @code{:data} property should be a
string containing the image data.  Some image types do not support
@code{:data}; for some others, @code{:data} alone is not enough, so you need
to use other image properties along with @code{:data}.  See the following
subsections for details.

@item :margin @var{margin}
This specifies how many pixels to add as an extra margin around the image.
The value, @var{margin}, must be a non-negative number, or a pair
@code{(@var{x} . @var{y})} of such numbers.  If it is a pair, @var{x}
specifies how many pixels to add horizontally, and @var{y} specifies how
many pixels to add vertically.  If @code{:margin} is not specified, the
default is zero.

@item :ascent @var{ascent}
This specifies the amount of the image's height to use for its ascent---that
is, the part above the baseline.  The value, @var{ascent}, must be a number
in the range 0 to 100, or the symbol @code{center}.

If @var{ascent} is a number, that percentage of the image's height is used
for its ascent.

If @var{ascent} is @code{center}, the image is vertically centered around a
centerline which would be the vertical centerline of text drawn at the
position of the image, in the manner specified by the text properties and
overlays that apply to the image.

If this property is omitted, it defaults to 50.

@item :relief @var{relief}
This adds a shadow rectangle around the image.  The value, @var{relief},
specifies the width of the shadow lines, in pixels.  If @var{relief} is
negative, shadows are drawn so that the image appears as a pressed button;
otherwise, it appears as an unpressed button.

@item :conversion @var{algorithm}
This specifies a conversion algorithm that should be applied to the image
before it is displayed; the value, @var{algorithm}, specifies which
algorithm.

@table @code
@item laplace
@itemx emboss
Specifies the Laplace edge detection algorithm, which blurs out small
differences in color while highlighting larger differences.  People
sometimes consider this useful for displaying the image for a ``disabled''
button.

@item (edge-detection :matrix @var{matrix} :color-adjust @var{adjust})
@cindex edge detection, images
Specifies a general edge-detection algorithm.  @var{matrix} must be either a
nine-element list or a nine-element vector of numbers.  A pixel at position
@math{x/y} in the transformed image is computed from original pixels around
that position.  @var{matrix} specifies, for each pixel in the neighborhood
of @math{x/y}, a factor with which that pixel will influence the transformed
pixel; element @math{0} specifies the factor for the pixel at
@math{x-1/y-1}, element @math{1} the factor for the pixel at @math{x/y-1}
etc., as shown below:
@iftex
@tex
$$\pmatrix{x-1/y-1 & x/y-1  & x+1/y-1 \cr
   x-1/y  &   x/y &    x+1/y \cr
   x-1/y+1&   x/y+1 &  x+1/y+1 \cr}$$
@end tex
@end iftex
@ifnottex
@display
  (x-1/y-1  x/y-1  x+1/y-1
   x-1/y    x/y    x+1/y
   x-1/y+1  x/y+1  x+1/y+1)
@end display
@end ifnottex

The resulting pixel is computed from the color intensity of the color
resulting from summing up the RGB values of surrounding pixels, multiplied
by the specified factors, and dividing that sum by the sum of the factors'
absolute values.

Laplace edge-detection currently uses a matrix of
@iftex
@tex
$$\pmatrix{1 & 0 & 0 \cr
   0&  0 &  0 \cr
   0 & 0 & -1 \cr}$$
@end tex
@end iftex
@ifnottex
@display
  (1  0  0
   0  0  0
   0  0 -1)
@end display
@end ifnottex

Emboss edge-detection uses a matrix of
@iftex
@tex
$$\pmatrix{ 2 & -1 &  0 \cr
   -1 &  0 &  1 \cr
    0  & 1 & -2 \cr}$$
@end tex
@end iftex
@ifnottex
@display
  ( 2 -1  0
   -1  0  1
    0  1 -2)
@end display
@end ifnottex

@item disabled
Specifies transforming the image so that it looks ``disabled''.
@end table

@item :mask @var{mask}
If @var{mask} is @code{heuristic} or @code{(heuristic @var{bg})}, build a
clipping mask for the image, so that the background of a frame is visible
behind the image.  If @var{bg} is not specified, or if @var{bg} is @code{t},
determine the background color of the image by looking at the four corners
of the image, assuming the most frequently occurring color from the corners
is the background color of the image.  Otherwise, @var{bg} must be a list
@code{(@var{red} @var{green} @var{blue})} specifying the color to assume for
the background of the image.

If @var{mask} is @code{nil}, remove a mask from the image, if it has one.
Images in some formats include a mask which can be removed by specifying
@code{:mask nil}.

@item :pointer @var{shape}
This specifies the pointer shape when the mouse pointer is over this image.
@xref{Pointer Shape}, for available pointer shapes.

@item :map @var{map}
@cindex image maps
This associates an image map of @dfn{hot spots} with this image.

An image map is an alist where each element has the format @code{(@var{area}
@var{id} @var{plist})}.  An @var{area} is specified as either a rectangle, a
circle, or a polygon.

A rectangle is a cons @code{(rect . ((@var{x0} . @var{y0}) . (@var{x1}
. @var{y1})))} which specifies the pixel coordinates of the upper left and
bottom right corners of the rectangle area.

A circle is a cons @code{(circle . ((@var{x0} . @var{y0}) . @var{r}))} which
specifies the center and the radius of the circle; @var{r} may be a float or
integer.

A polygon is a cons @code{(poly . [@var{x0} @var{y0} @var{x1} @var{y1}
...])} where each pair in the vector describes one corner in the polygon.

When the mouse pointer lies on a hot-spot area of an image, the @var{plist}
of that hot-spot is consulted; if it contains a @code{help-echo} property,
that defines a tool-tip for the hot-spot, and if it contains a
@code{pointer} property, that defines the shape of the mouse cursor when it
is on the hot-spot.  @xref{Pointer Shape}, for available pointer shapes.

When you click the mouse when the mouse pointer is over a hot-spot, an event
is composed by combining the @var{id} of the hot-spot with the mouse event;
for instance, @code{[area4 mouse-1]} if the hot-spot's @var{id} is
@code{area4}.
@end table

@defun image-mask-p spec &optional frame
This function returns @code{t} if image @var{spec} has a mask bitmap.
@var{frame} is the frame on which the image will be displayed.  @var{frame}
@code{nil} or omitted means to use the selected frame (@pxref{Input Focus}).
@end defun

@node XBM Images
@subsection XBM Images
@cindex XBM

  To use XBM format, specify @code{xbm} as the image type.  This image format
doesn't require an external library, so images of this type are always
supported.

  Additional image properties supported for the @code{xbm} image type are:

@table @code
@item :foreground @var{foreground}
The value, @var{foreground}, should be a string specifying the image
foreground color, or @code{nil} for the default color.  This color is used
for each pixel in the XBM that is 1.  The default is the frame's foreground
color.

@item :background @var{background}
The value, @var{background}, should be a string specifying the image
background color, or @code{nil} for the default color.  This color is used
for each pixel in the XBM that is 0.  The default is the frame's background
color.
@end table

  If you specify an XBM image using data within Emacs instead of an external
file, use the following three properties:

@table @code
@item :data @var{data}
The value, @var{data}, specifies the contents of the image.  There are three
formats you can use for @var{data}:

@itemize @bullet
@item
A vector of strings or bool-vectors, each specifying one line of the image.
Do specify @code{:height} and @code{:width}.

@item
A string containing the same byte sequence as an XBM file would contain.
You must not specify @code{:height} and @code{:width} in this case, because
omitting them is what indicates the data has the format of an XBM file.  The
file contents specify the height and width of the image.

@item
A string or a bool-vector containing the bits of the image (plus perhaps
some extra bits at the end that will not be used).  It should contain at
least @var{width} * @code{height} bits.  In this case, you must specify
@code{:height} and @code{:width}, both to indicate that the string contains
just the bits rather than a whole XBM file, and to specify the size of the
image.
@end itemize

@item :width @var{width}
The value, @var{width}, specifies the width of the image, in pixels.

@item :height @var{height}
The value, @var{height}, specifies the height of the image, in pixels.
@end table

@node XPM Images
@subsection XPM Images
@cindex XPM

  To use XPM format, specify @code{xpm} as the image type.  The additional
image property @code{:color-symbols} is also meaningful with the @code{xpm}
image type:

@table @code
@item :color-symbols @var{symbols}
The value, @var{symbols}, should be an alist whose elements have the form
@code{(@var{name} . @var{color})}.  In each element, @var{name} is the name
of a color as it appears in the image file, and @var{color} specifies the
actual color to use for displaying that name.
@end table

@node PostScript Images
@subsection PostScript Images
@cindex postscript images

  To use PostScript for an image, specify image type @code{postscript}.  This
works only if you have Ghostscript installed.  You must always use these
three properties:

@table @code
@item :pt-width @var{width}
The value, @var{width}, specifies the width of the image measured in points
(1/72 inch).  @var{width} must be an integer.

@item :pt-height @var{height}
The value, @var{height}, specifies the height of the image in points (1/72
inch).  @var{height} must be an integer.

@item :bounding-box @var{box}
The value, @var{box}, must be a list or vector of four integers, which
specifying the bounding box of the PostScript image, analogous to the
@samp{BoundingBox} comment found in PostScript files.

@example
%%BoundingBox: 22 171 567 738
@end example
@end table

@node ImageMagick Images
@subsection ImageMagick Images
@cindex ImageMagick images
@cindex images, support for more formats

  If you build Emacs with ImageMagick support, you can use the ImageMagick
library to load many image formats (@pxref{File Conveniences,,, emacs, The
GNU Emacs Manual}).  The image type symbol for images loaded via ImageMagick
is @code{imagemagick}, regardless of the actual underlying image format.

@defun imagemagick-types
This function returns a list of image file extensions supported by the
current ImageMagick installation.  Each list element is a symbol
representing an internal ImageMagick name for an image type, such as
@code{BMP} for @file{.bmp} images.
@end defun

@defopt imagemagick-enabled-types
The value of this variable is a list of ImageMagick image types which Emacs
may attempt to render using ImageMagick.  Each list element should be one of
the symbols in the list returned by @code{imagemagick-types}, or an
equivalent string.  Alternatively, a value of @code{t} enables ImageMagick
for all possible image types.  Regardless of the value of this variable,
@code{imagemagick-types-inhibit} (see below) takes precedence.
@end defopt

@defopt imagemagick-types-inhibit
The value of this variable lists the ImageMagick image types which should
never be rendered using ImageMagick, regardless of the value of
@code{imagemagick-enabled-types}.  A value of @code{t} disables ImageMagick
entirely.
@end defopt

@defvar image-format-suffixes
This variable is an alist mapping image types to file name extensions.
Emacs uses this in conjunction with the @code{:format} image property (see
below) to give a hint to the ImageMagick library as to the type of an
image.  Each element has the form @code{(@var{type} @var{extension})}, where
@var{type} is a symbol specifying an image content-type, and @var{extension}
is a string that specifies the associated file name extension.
@end defvar

  Images loaded with ImageMagick support the following additional image
descriptor properties:

@table @code
@item :background @var{background}
@var{background}, if non-@code{nil}, should be a string specifying a color,
which is used as the image's background color if the image supports
transparency.  If the value is @code{nil}, it defaults to the frame's
background color.

@item :width @var{width}, :height @var{height}
The @code{:width} and @code{:height} keywords are used for scaling the
image.  If only one of them is specified, the other one will be calculated
so as to preserve the aspect ratio.  If both are specified, aspect ratio may
not be preserved.

@item :max-width @var{max-width}, :max-height @var{max-height}
The @code{:max-width} and @code{:max-height} keywords are used for scaling
if the size of the image of the image exceeds these values.  If
@code{:width} is set it will have precedence over @code{max-width}, and if
@code{:height} is set it will have precedence over @code{max-height}, but
you can otherwise mix these keywords as you wish.  @code{:max-width} and
@code{:max-height} will always preserve the aspect ratio.

@item :format @var{type}
The value, @var{type}, should be a symbol specifying the type of the image
data, as found in @code{image-format-suffixes}.  This is used when the image
does not have an associated file name, to provide a hint to ImageMagick to
help it detect the image type.

@item :rotation @var{angle}
Specifies a rotation angle in degrees.

@item :index @var{frame}
@c Doesn't work: http://debbugs.gnu.org/7978
@xref{Multi-Frame Images}.
@end table

@node Other Image Types
@subsection Other Image Types
@cindex PBM

  For PBM images, specify image type @code{pbm}.  Color, gray-scale and
monochromatic images are supported.  For mono PBM images, two additional
image properties are supported.

@table @code
@item :foreground @var{foreground}
The value, @var{foreground}, should be a string specifying the image
foreground color, or @code{nil} for the default color.  This color is used
for each pixel in the PBM that is 1.  The default is the frame's foreground
color.

@item :background @var{background}
The value, @var{background}, should be a string specifying the image
background color, or @code{nil} for the default color.  This color is used
for each pixel in the PBM that is 0.  The default is the frame's background
color.
@end table

@noindent
The remaining image types that Emacs can support are:

@table @asis
@item GIF
Image type @code{gif}.  Supports the @code{:index} property.
@xref{Multi-Frame Images}.

@item JPEG
Image type @code{jpeg}.

@item PNG
Image type @code{png}.

@item SVG
Image type @code{svg}.

@item TIFF
Image type @code{tiff}.  Supports the @code{:index} property.
@xref{Multi-Frame Images}.
@end table

@node Defining Images
@subsection Defining Images
@cindex define image

  The functions @code{create-image}, @code{defimage} and @code{find-image}
provide convenient ways to create image descriptors.

@defun create-image file-or-data &optional type data-p &rest props
This function creates and returns an image descriptor which uses the data in
@var{file-or-data}.  @var{file-or-data} can be a file name or a string
containing the image data; @var{data-p} should be @code{nil} for the former
case, non-@code{nil} for the latter case.

The optional argument @var{type} is a symbol specifying the image type.  If
@var{type} is omitted or @code{nil}, @code{create-image} tries to determine
the image type from the file's first few bytes, or else from the file's
name.

The remaining arguments, @var{props}, specify additional image
properties---for example,

@c ':heuristic-mask' is not documented?
@example
(create-image "foo.xpm" 'xpm nil :heuristic-mask t)
@end example

The function returns @code{nil} if images of this type are not supported.
Otherwise it returns an image descriptor.
@end defun

@defmac defimage symbol specs &optional doc
This macro defines @var{symbol} as an image name.  The arguments @var{specs}
is a list which specifies how to display the image.  The third argument,
@var{doc}, is an optional documentation string.

Each argument in @var{specs} has the form of a property list, and each one
should specify at least the @code{:type} property and either the
@code{:file} or the @code{:data} property.  The value of @code{:type} should
be a symbol specifying the image type, the value of @code{:file} is the file
to load the image from, and the value of @code{:data} is a string containing
the actual image data.  Here is an example:

@example
(defimage test-image
  ((:type xpm :file "~/test1.xpm")
   (:type xbm :file "~/test1.xbm")))
@end example

@code{defimage} tests each argument, one by one, to see if it is
usable---that is, if the type is supported and the file exists.  The first
usable argument is used to make an image descriptor which is stored in
@var{symbol}.

If none of the alternatives will work, then @var{symbol} is defined as
@code{nil}.
@end defmac

@defun find-image specs
This function provides a convenient way to find an image satisfying one of a
list of image specifications @var{specs}.

Each specification in @var{specs} is a property list with contents depending
on image type.  All specifications must at least contain the properties
@code{:type @var{type}} and either @w{@code{:file @var{file}}} or
@w{@code{:data @var{data}}}, where @var{type} is a symbol specifying the
image type, e.g., @code{xbm}, @var{file} is the file to load the image from,
and @var{data} is a string containing the actual image data.  The first
specification in the list whose @var{type} is supported, and @var{file}
exists, is used to construct the image specification to be returned.  If no
specification is satisfied, @code{nil} is returned.

The image is looked for in @code{image-load-path}.
@end defun

@defvar image-load-path
This variable's value is a list of locations in which to search for image
files.  If an element is a string or a variable symbol whose value is a
string, the string is taken to be the name of a directory to search.  If an
element is a variable symbol whose value is a list, that is taken to be a
list of directory names to search.

The default is to search in the @file{images} subdirectory of the directory
specified by @code{data-directory}, then the directory specified by
@code{data-directory}, and finally in the directories in @code{load-path}.
Subdirectories are not automatically included in the search, so if you put
an image file in a subdirectory, you have to supply the subdirectory name
explicitly.  For example, to find the image @file{images/foo/bar.xpm} within
@code{data-directory}, you should specify the image as follows:

@example
(defimage foo-image '((:type xpm :file "foo/bar.xpm")))
@end example
@end defvar

@defun image-load-path-for-library library image &optional path no-error
This function returns a suitable search path for images used by the Lisp
package @var{library}.

The function searches for @var{image} first using @code{image-load-path},
excluding @file{@code{data-directory}/images}, and then in @code{load-path},
followed by a path suitable for @var{library}, which includes
@file{../../etc/images} and @file{../etc/images} relative to the library
file itself, and finally in @file{@code{data-directory}/images}.

Then this function returns a list of directories which contains first the
directory in which @var{image} was found, followed by the value of
@code{load-path}.  If @var{path} is given, it is used instead of
@code{load-path}.

If @var{no-error} is non-@code{nil} and a suitable path can't be found,
don't signal an error.  Instead, return a list of directories as before,
except that @code{nil} appears in place of the image directory.

Here is an example of using @code{image-load-path-for-library}:

@example
(defvar image-load-path) ; shush compiler
(let* ((load-path (image-load-path-for-library
                    "mh-e" "mh-logo.xpm"))
       (image-load-path (cons (car load-path)
                              image-load-path)))
  (mh-tool-bar-folder-buttons-init))
@end example
@end defun

@node Showing Images
@subsection Showing Images
@cindex show image

  You can use an image descriptor by setting up the @code{display} property
yourself, but it is easier to use the functions in this section.

@defun insert-image image &optional string area slice
This function inserts @var{image} in the current buffer at point.  The value
@var{image} should be an image descriptor; it could be a value returned by
@code{create-image}, or the value of a symbol defined with @code{defimage}.
The argument @var{string} specifies the text to put in the buffer to hold
the image.  If it is omitted or @code{nil}, @code{insert-image} uses @code{"
"} by default.

The argument @var{area} specifies whether to put the image in a margin.  If
it is @code{left-margin}, the image appears in the left margin;
@code{right-margin} specifies the right margin.  If @var{area} is @code{nil}
or omitted, the image is displayed at point within the buffer's text.

The argument @var{slice} specifies a slice of the image to insert.  If
@var{slice} is @code{nil} or omitted the whole image is inserted.
Otherwise, @var{slice} is a list @code{(@var{x} @var{y} @var{width}
@var{height})} which specifies the @var{x} and @var{y} positions and
@var{width} and @var{height} of the image area to insert.  Integer values
are in units of pixels.  A floating-point number in the range 0.0--1.0
stands for that fraction of the width or height of the entire image.

Internally, this function inserts @var{string} in the buffer, and gives it a
@code{display} property which specifies @var{image}.  @xref{Display
Property}.
@end defun

@cindex slice, image
@cindex image slice
@defun insert-sliced-image image &optional string area rows cols
This function inserts @var{image} in the current buffer at point, like
@code{insert-image}, but splits the image into @var{rows}x@var{cols} equally
sized slices.

If an image is inserted ``sliced'', Emacs displays each slice as a separate
image, and allow more intuitive scrolling up/down, instead of jumping
up/down the entire image when paging through a buffer that displays (large)
images.
@end defun

@defun put-image image pos &optional string area
This function puts image @var{image} in front of @var{pos} in the current
buffer.  The argument @var{pos} should be an integer or a marker.  It
specifies the buffer position where the image should appear.  The argument
@var{string} specifies the text that should hold the image as an alternative
to the default.

The argument @var{image} must be an image descriptor, perhaps returned by
@code{create-image} or stored by @code{defimage}.

The argument @var{area} specifies whether to put the image in a margin.  If
it is @code{left-margin}, the image appears in the left margin;
@code{right-margin} specifies the right margin.  If @var{area} is @code{nil}
or omitted, the image is displayed at point within the buffer's text.

Internally, this function creates an overlay, and gives it a
@code{before-string} property containing text that has a @code{display}
property whose value is the image.  (Whew!)
@end defun

@defun remove-images start end &optional buffer
This function removes images in @var{buffer} between positions @var{start}
and @var{end}.  If @var{buffer} is omitted or @code{nil}, images are removed
from the current buffer.

This removes only images that were put into @var{buffer} the way
@code{put-image} does it, not images that were inserted with
@code{insert-image} or in other ways.
@end defun

@defun image-size spec &optional pixels frame
@cindex size of image
This function returns the size of an image as a pair @w{@code{(@var{width}
. @var{height})}}.  @var{spec} is an image specification.  @var{pixels}
non-@code{nil} means return sizes measured in pixels, otherwise return sizes
measured in canonical character units (fractions of the width/height of the
frame's default font).  @var{frame} is the frame on which the image will be
displayed.  @var{frame} null or omitted means use the selected frame
(@pxref{Input Focus}).
@end defun

@defvar max-image-size
This variable is used to define the maximum size of image that Emacs will
load.  Emacs will refuse to load (and display) any image that is larger than
this limit.

If the value is an integer, it directly specifies the maximum image height
and width, measured in pixels.  If it is floating point, it specifies the
maximum image height and width as a ratio to the frame height and width.  If
the value is non-numeric, there is no explicit limit on the size of images.

The purpose of this variable is to prevent unreasonably large images from
accidentally being loaded into Emacs.  It only takes effect the first time
an image is loaded.  Once an image is placed in the image cache, it can
always be displayed, even if the value of @code{max-image-size} is
subsequently changed (@pxref{Image Cache}).
@end defvar

@node Multi-Frame Images
@subsection Multi-Frame Images
@cindex multi-frame images

@cindex animation
@cindex image animation
@cindex image frames
Some image files can contain more than one image.  We say that there are
multiple ``frames'' in the image.  At present, Emacs supports multiple
frames for GIF, TIFF, and certain ImageMagick formats such as DJVM@.

The frames can be used either to represent multiple ``pages'' (this is
usually the case with multi-frame TIFF files, for example), or to create
animation (usually the case with multi-frame GIF files).

A multi-frame image has a property @code{:index}, whose value is an integer
(counting from 0) that specifies which frame is being displayed.

@defun image-multi-frame-p image
This function returns non-@code{nil} if @var{image} contains more than one
frame.  The actual return value is a cons @code{(@var{nimages}
. @var{delay})}, where @var{nimages} is the number of frames and @var{delay}
is the delay in seconds between them, or @code{nil} if the image does not
specify a delay.  Images that are intended to be animated usually specify a
frame delay, whereas ones that are intended to be treated as multiple pages
do not.
@end defun

@defun image-current-frame image
This function returns the index of the current frame number for @var{image},
counting from 0.
@end defun

@defun image-show-frame image n &optional nocheck
This function switches @var{image} to frame number @var{n}.  It replaces a
frame number outside the valid range with that of the end of the range,
unless @var{nocheck} is non-@code{nil}.  If @var{image} does not contain a
frame with the specified number, the image displays as a hollow box.
@end defun

@defun image-animate image &optional index limit
This function animates @var{image}.  The optional integer @var{index}
specifies the frame from which to start (default 0).  The optional argument
@var{limit} controls the length of the animation.  If omitted or @code{nil},
the image animates once only; if @code{t} it loops forever; if a number
animation stops after that many seconds.
@end defun

@vindex image-minimum-frame-delay
@vindex image-default-frame-delay
@noindent Animation operates by means of a timer.  Note that Emacs imposes a
minimum frame delay of 0.01 (@code{image-minimum-frame-delay}) seconds.  If
the image itself does not specify a delay, Emacs uses
@code{image-default-frame-delay}.

@defun image-animate-timer image
This function returns the timer responsible for animating @var{image}, if
there is one.
@end defun


@node Image Cache
@subsection Image Cache
@cindex image cache

  Emacs caches images so that it can display them again more efficiently.
When Emacs displays an image, it searches the image cache for an existing
image specification @code{equal} to the desired specification.  If a match
is found, the image is displayed from the cache.  Otherwise, Emacs loads the
image normally.

@defun image-flush spec &optional frame
This function removes the image with specification @var{spec} from the image
cache of frame @var{frame}.  Image specifications are compared using
@code{equal}.  If @var{frame} is @code{nil}, it defaults to the selected
frame.  If @var{frame} is @code{t}, the image is flushed on all existing
frames.

In Emacs's current implementation, each graphical terminal possesses an
image cache, which is shared by all the frames on that terminal
(@pxref{Multiple Terminals}).  Thus, refreshing an image in one frame also
refreshes it in all other frames on the same terminal.
@end defun

  One use for @code{image-flush} is to tell Emacs about a change in an image
file.  If an image specification contains a @code{:file} property, the image
is cached based on the file's contents when the image is first displayed.
Even if the file subsequently changes, Emacs continues displaying the old
version of the image.  Calling @code{image-flush} flushes the image from the
cache, forcing Emacs to re-read the file the next time it needs to display
that image.

  Another use for @code{image-flush} is for memory conservation.  If your Lisp
program creates a large number of temporary images over a period much
shorter than @code{image-cache-eviction-delay} (see below), you can opt to
flush unused images yourself, instead of waiting for Emacs to do it
automatically.

@defun clear-image-cache &optional filter
This function clears an image cache, removing all the images stored in it.
If @var{filter} is omitted or @code{nil}, it clears the cache for the
selected frame.  If @var{filter} is a frame, it clears the cache for that
frame.  If @var{filter} is @code{t}, all image caches are cleared.
Otherwise, @var{filter} is taken to be a file name, and all images
associated with that file name are removed from all image caches.
@end defun

If an image in the image cache has not been displayed for a specified period
of time, Emacs removes it from the cache and frees the associated memory.

@defvar image-cache-eviction-delay
This variable specifies the number of seconds an image can remain in the
cache without being displayed.  When an image is not displayed for this
length of time, Emacs removes it from the image cache.

Under some circumstances, if the number of images in the cache grows too
large, the actual eviction delay may be shorter than this.

If the value is @code{nil}, Emacs does not remove images from the cache
except when you explicitly clear it.  This mode can be useful for debugging.
@end defvar

@node Buttons
@section Buttons
@cindex buttons in buffers
@cindex clickable buttons in buffers

  The Button package defines functions for inserting and manipulating
@dfn{buttons} that can be activated with the mouse or via keyboard
commands.  These buttons are typically used for various kinds of hyperlinks.

  A button is essentially a set of text or overlay properties, attached to a
stretch of text in a buffer.  These properties are called @dfn{button
properties}.  One of these properties, the @dfn{action property}, specifies
a function which is called when the user invokes the button using the
keyboard or the mouse.  The action function may examine the button and use
its other properties as desired.

  In some ways, the Button package duplicates the functionality in the Widget
package.  @xref{Top, , Introduction, widget, The Emacs Widget Library}.  The
advantage of the Button package is that it is faster, smaller, and simpler
to program.  From the point of view of the user, the interfaces produced by
the two packages are very similar.

@menu
* Button Properties::        Button properties with special meanings.
* Button Types::             Defining common properties for classes of 
                               buttons.
* Making Buttons::           Adding buttons to Emacs buffers.
* Manipulating Buttons::     Getting and setting properties of buttons.
* Button Buffer Commands::   Buffer-wide commands and bindings for buttons.
@end menu

@node Button Properties
@subsection Button Properties
@cindex button properties

  Each button has an associated list of properties defining its appearance and
behavior, and other arbitrary properties may be used for application
specific purposes.  The following properties have special meaning to the
Button package:

@table @code
@item action
@kindex action @r{(button property)}
The function to call when the user invokes the button, which is passed the
single argument @var{button}.  By default this is @code{ignore}, which does
nothing.

@item mouse-action
@kindex mouse-action @r{(button property)}
This is similar to @code{action}, and when present, will be used instead of
@code{action} for button invocations resulting from mouse-clicks (instead of
the user hitting @key{RET}).  If not present, mouse-clicks use @code{action}
instead.

@item face
@kindex face @r{(button property)}
This is an Emacs face controlling how buttons of this type are displayed; by
default this is the @code{button} face.

@item mouse-face
@kindex mouse-face @r{(button property)}
This is an additional face which controls appearance during mouse-overs
(merged with the usual button face); by default this is the usual Emacs
@code{highlight} face.

@item keymap
@kindex keymap @r{(button property)}
The button's keymap, defining bindings active within the button region.  By
default this is the usual button region keymap, stored in the variable
@code{button-map}, which defines @key{RET} and @key{mouse-2} to invoke the
button.

@item type
@kindex type @r{(button property)}
The button type.  @xref{Button Types}.

@item help-echo
@kindex help-index @r{(button property)}
A string displayed by the Emacs tool-tip help system; by default,
@code{"mouse-2, RET: Push this button"}.

@item follow-link
@kindex follow-link @r{(button property)}
The follow-link property, defining how a @key{Mouse-1} click behaves on this
button, @xref{Clickable Text}.

@item button
@kindex button @r{(button property)}
All buttons have a non-@code{nil} @code{button} property, which may be
useful in finding regions of text that comprise buttons (which is what the
standard button functions do).
@end table

  There are other properties defined for the regions of text in a button, but
these are not generally interesting for typical uses.

@node Button Types
@subsection Button Types
@cindex button types

  Every button has a @dfn{button type}, which defines default values for the
button's properties.  Button types are arranged in a hierarchy, with
specialized types inheriting from more general types, so that it's easy to
define special-purpose types of buttons for specific tasks.

@defun define-button-type name &rest properties
Define a `button type' called @var{name} (a symbol).  The remaining
arguments form a sequence of @var{property value} pairs, specifying default
property values for buttons with this type (a button's type may be set by
giving it a @code{type} property when creating the button, using the
@code{:type} keyword argument).

In addition, the keyword argument @code{:supertype} may be used to specify a
button-type from which @var{name} inherits its default property values.
Note that this inheritance happens only when @var{name} is defined;
subsequent changes to a supertype are not reflected in its subtypes.
@end defun

  Using @code{define-button-type} to define default properties for buttons is
not necessary---buttons without any specified type use the built-in
button-type @code{button}---but it is encouraged, since doing so usually
makes the resulting code clearer and more efficient.

@node Making Buttons
@subsection Making Buttons
@cindex making buttons

  Buttons are associated with a region of text, using an overlay or text
properties to hold button-specific information, all of which are initialized
from the button's type (which defaults to the built-in button type
@code{button}).  Like all Emacs text, the appearance of the button is
governed by the @code{face} property; by default (via the @code{face}
property inherited from the @code{button} button-type)  this is a simple
underline, like a typical web-page link.

  For convenience, there are two sorts of button-creation functions, those
that add button properties to an existing region of a buffer, called
@code{make-...button}, and those that also insert the button text, called
@code{insert-...button}.

  The button-creation functions all take the @code{&rest} argument
@var{properties}, which should be a sequence of @var{property value} pairs,
specifying properties to add to the button; see @ref{Button Properties}.  In
addition, the keyword argument @code{:type} may be used to specify a
button-type from which to inherit other properties; see @ref{Button Types}.
Any properties not explicitly specified during creation will be inherited
from the button's type (if the type defines such a property).

  The following functions add a button using an overlay (@pxref{Overlays}) to
hold the button properties:

@defun make-button beg end &rest properties
This makes a button from @var{beg} to @var{end} in the current buffer, and
returns it.
@end defun

@defun insert-button label &rest properties
This insert a button with the label @var{label} at point, and returns it.
@end defun

  The following functions are similar, but using text properties (@pxref{Text
Properties}) to hold the button properties.  Such buttons do not add markers
to the buffer, so editing in the buffer does not slow down if there is an
extremely large numbers of buttons.  However, if there is an existing face
text property on the text (e.g., a face assigned by Font Lock mode), the
button face may not be visible.  Both of these functions return the starting
position of the new button.

@defun make-text-button beg end &rest properties
This makes a button from @var{beg} to @var{end} in the current buffer, using
text properties.
@end defun

@defun insert-text-button label &rest properties
This inserts a button with the label @var{label} at point, using text
properties.
@end defun

@node Manipulating Buttons
@subsection Manipulating Buttons
@cindex manipulating buttons

These are functions for getting and setting properties of buttons.  Often
these are used by a button's invocation function to determine what to do.

Where a @var{button} parameter is specified, it means an object referring to
a specific button, either an overlay (for overlay buttons), or a
buffer-position or marker (for text property buttons).  Such an object is
passed as the first argument to a button's invocation function when it is
invoked.

@defun button-start button
Return the position at which @var{button} starts.
@end defun

@defun button-end button
Return the position at which @var{button} ends.
@end defun

@defun button-get button prop
Get the property of button @var{button} named @var{prop}.
@end defun

@defun button-put button prop val
Set @var{button}'s @var{prop} property to @var{val}.
@end defun

@defun button-activate button &optional use-mouse-action
Call @var{button}'s @code{action} property (i.e., invoke the function that
is the value of that property, passing it the single argument
@var{button}).  If @var{use-mouse-action} is non-@code{nil}, try to invoke
the button's @code{mouse-action} property instead of @code{action}; if the
button has no @code{mouse-action} property, use @code{action} as normal.
@end defun

@defun button-label button
Return @var{button}'s text label.
@end defun

@defun button-type button
Return @var{button}'s button-type.
@end defun

@defun button-has-type-p button type
Return @code{t} if @var{button} has button-type @var{type}, or one of
@var{type}'s subtypes.
@end defun

@defun button-at pos
Return the button at position @var{pos} in the current buffer, or
@code{nil}.  If the button at @var{pos} is a text property button, the
return value is a marker pointing to @var{pos}.
@end defun

@defun button-type-put type prop val
Set the button-type @var{type}'s @var{prop} property to @var{val}.
@end defun

@defun button-type-get type prop
Get the property of button-type @var{type} named @var{prop}.
@end defun

@defun button-type-subtype-p type supertype
Return @code{t} if button-type @var{type} is a subtype of @var{supertype}.
@end defun

@node Button Buffer Commands
@subsection Button Buffer Commands
@cindex button buffer commands

These are commands and functions for locating and operating on buttons in an
Emacs buffer.

@code{push-button} is the command that a user uses to actually `push' a
button, and is bound by default in the button itself to @key{RET} and to
@key{mouse-2} using a local keymap in the button's overlay or text
properties.  Commands that are useful outside the buttons itself, such as
@code{forward-button} and @code{backward-button} are additionally available
in the keymap stored in @code{button-buffer-map}; a mode which uses buttons
may want to use @code{button-buffer-map} as a parent keymap for its keymap.

If the button has a non-@code{nil} @code{follow-link} property, and
@code{mouse-1-click-follows-link} is set, a quick @key{Mouse-1} click will
also activate the @code{push-button} command.  @xref{Clickable Text}.

@deffn Command push-button &optional pos use-mouse-action
Perform the action specified by a button at location @var{pos}.  @var{pos}
may be either a buffer position or a mouse-event.  If @var{use-mouse-action}
is non-@code{nil}, or @var{pos} is a mouse-event (@pxref{Mouse Events}), try
to invoke the button's @code{mouse-action} property instead of
@code{action}; if the button has no @code{mouse-action} property, use
@code{action} as normal.  @var{pos} defaults to point, except when
@code{push-button} is invoked interactively as the result of a mouse-event,
in which case, the mouse event's position is used.  If there's no button at
@var{pos}, do nothing and return @code{nil}, otherwise return @code{t}.
@end deffn

@deffn Command forward-button n &optional wrap display-message
Move to the @var{n}th next button, or @var{n}th previous button if @var{n}
is negative.  If @var{n} is zero, move to the start of any button at point.
If @var{wrap} is non-@code{nil}, moving past either end of the buffer
continues from the other end.  If @var{display-message} is non-@code{nil},
the button's help-echo string is displayed.  Any button with a
non-@code{nil} @code{skip} property is skipped over.  Returns the button
found.
@end deffn

@deffn Command backward-button n &optional wrap display-message
Move to the @var{n}th previous button, or @var{n}th next button if @var{n}
is negative.  If @var{n} is zero, move to the start of any button at point.
If @var{wrap} is non-@code{nil}, moving past either end of the buffer
continues from the other end.  If @var{display-message} is non-@code{nil},
the button's help-echo string is displayed.  Any button with a
non-@code{nil} @code{skip} property is skipped over.  Returns the button
found.
@end deffn

@defun next-button pos &optional count-current
@defunx previous-button pos &optional count-current
Return the next button after (for @code{next-button}) or before (for
@code{previous-button}) position @var{pos} in the current buffer.  If
@var{count-current} is non-@code{nil}, count any button at @var{pos} in the
search, instead of starting at the next button.
@end defun

@node Abstract Display
@section Abstract Display
@cindex ewoc
@cindex display, abstract
@cindex display, arbitrary objects
@cindex model/view/controller
@cindex view part, model/view/controller

  The Ewoc package constructs buffer text that represents a structure of Lisp
objects, and updates the text to follow changes in that structure.  This is
like the ``view'' component in the ``model/view/controller'' design
paradigm.  Ewoc means ``Emacs's Widget for Object Collections''.

  An @dfn{ewoc} is a structure that organizes information required to
construct buffer text that represents certain Lisp data.  The buffer text of
the ewoc has three parts, in order: first, fixed @dfn{header} text; next,
textual descriptions of a series of data elements (Lisp objects that you
specify); and last, fixed @dfn{footer} text.  Specifically, an ewoc contains
information on:

@itemize @bullet
@item
The buffer which its text is generated in.

@item
The text's start position in the buffer.

@item
The header and footer strings.

@item
@cindex node, ewoc
@c or "@cindex node, abstract display"?
A doubly-linked chain of @dfn{nodes}, each of which contains:

@itemize
@item
A @dfn{data element}, a single Lisp object.

@item
Links to the preceding and following nodes in the chain.
@end itemize

@item
A @dfn{pretty-printer} function which is responsible for inserting the
textual representation of a data element value into the current buffer.
@end itemize

  Typically, you define an ewoc with @code{ewoc-create}, and then pass the
resulting ewoc structure to other functions in the Ewoc package to build
nodes within it, and display it in the buffer.  Once it is displayed in the
buffer, other functions determine the correspondence between buffer
positions and nodes, move point from one node's textual representation to
another, and so forth.  @xref{Abstract Display Functions}.

@cindex encapsulation, ewoc
@c or "@cindex encapsulation, abstract display"?
  A node @dfn{encapsulates} a data element much the way a variable holds a
value.  Normally, encapsulation occurs as a part of adding a node to the
ewoc.  You can retrieve the data element value and place a new value in its
place, like so:

@lisp
(ewoc-data @var{node})
@result{} value

(ewoc-set-data @var{node} @var{new-value})
@result{} @var{new-value}
@end lisp

@noindent
You can also use, as the data element value, a Lisp object (list or vector)
that is a container for the ``real'' value, or an index into some other
structure.  The example (@pxref{Abstract Display Example})  uses the latter
approach.

  When the data changes, you will want to update the text in the buffer.  You
can update all nodes by calling @code{ewoc-refresh}, or just specific nodes
using @code{ewoc-invalidate}, or all nodes satisfying a predicate using
@code{ewoc-map}.  Alternatively, you can delete invalid nodes using
@code{ewoc-delete} or @code{ewoc-filter}, and add new nodes in their place.
Deleting a node from an ewoc deletes its associated textual description from
buffer, as well.

@menu
* Abstract Display Functions::  Functions in the Ewoc package.
* Abstract Display Example::  Example of using Ewoc.
@end menu

@node Abstract Display Functions
@subsection Abstract Display Functions

  In this subsection, @var{ewoc} and @var{node} stand for the structures
described above (@pxref{Abstract Display}), while @var{data} stands for an
arbitrary Lisp object used as a data element.

@defun ewoc-create pretty-printer &optional header footer nosep
This constructs and returns a new ewoc, with no nodes (and thus no data
elements).  @var{pretty-printer} should be a function that takes one
argument, a data element of the sort you plan to use in this ewoc, and
inserts its textual description at point using @code{insert} (and never
@code{insert-before-markers}, because that would interfere with the Ewoc
package's internal mechanisms).

Normally, a newline is automatically inserted after the header, the footer
and every node's textual description.  If @var{nosep} is non-@code{nil}, no
newline is inserted.  This may be useful for displaying an entire ewoc on a
single line, for example, or for making nodes ``invisible'' by arranging for
@var{pretty-printer} to do nothing for those nodes.

An ewoc maintains its text in the buffer that is current when you create it,
so switch to the intended buffer before calling @code{ewoc-create}.
@end defun

@defun ewoc-buffer ewoc
This returns the buffer where @var{ewoc} maintains its text.
@end defun

@defun ewoc-get-hf ewoc
This returns a cons cell @code{(@var{header} . @var{footer})} made from
@var{ewoc}'s header and footer.
@end defun

@defun ewoc-set-hf ewoc header footer
This sets the header and footer of @var{ewoc} to the strings @var{header}
and @var{footer}, respectively.
@end defun

@defun ewoc-enter-first ewoc data
@defunx ewoc-enter-last ewoc data
These add a new node encapsulating @var{data}, putting it, respectively, at
the beginning or end of @var{ewoc}'s chain of nodes.
@end defun

@defun ewoc-enter-before ewoc node data
@defunx ewoc-enter-after ewoc node data
These add a new node encapsulating @var{data}, adding it to @var{ewoc}
before or after @var{node}, respectively.
@end defun

@defun ewoc-prev ewoc node
@defunx ewoc-next ewoc node
These return, respectively, the previous node and the next node of
@var{node} in @var{ewoc}.
@end defun

@defun ewoc-nth ewoc n
This returns the node in @var{ewoc} found at zero-based index @var{n}.  A
negative @var{n} means count from the end.  @code{ewoc-nth} returns
@code{nil} if @var{n} is out of range.
@end defun

@defun ewoc-data node
This extracts the data encapsulated by @var{node} and returns it.
@end defun

@defun ewoc-set-data node data
This sets the data encapsulated by @var{node} to @var{data}.
@end defun

@defun ewoc-locate ewoc &optional pos guess
This determines the node in @var{ewoc} which contains point (or @var{pos} if
specified), and returns that node.  If @var{ewoc} has no nodes, it returns
@code{nil}.  If @var{pos} is before the first node, it returns the first
node; if @var{pos} is after the last node, it returns the last node.  The
optional third arg @var{guess} should be a node that is likely to be near
@var{pos}; this doesn't alter the result, but makes the function run faster.
@end defun

@defun ewoc-location node
This returns the start position of @var{node}.
@end defun

@defun ewoc-goto-prev ewoc arg
@defunx ewoc-goto-next ewoc arg
These move point to the previous or next, respectively, @var{arg}th node in
@var{ewoc}.  @code{ewoc-goto-prev} does not move if it is already at the
first node or if @var{ewoc} is empty, whereas @code{ewoc-goto-next} moves
past the last node, returning @code{nil}.  Excepting this special case,
these functions return the node moved to.
@end defun

@defun ewoc-goto-node ewoc node
This moves point to the start of @var{node} in @var{ewoc}.
@end defun

@defun ewoc-refresh ewoc
This function regenerates the text of @var{ewoc}.  It works by deleting the
text between the header and the footer, i.e., all the data elements'
representations, and then calling the pretty-printer function for each node,
one by one, in order.
@end defun

@defun ewoc-invalidate ewoc &rest nodes
This is similar to @code{ewoc-refresh}, except that only @var{nodes} in
@var{ewoc} are updated instead of the entire set.
@end defun

@defun ewoc-delete ewoc &rest nodes
This deletes each node in @var{nodes} from @var{ewoc}.
@end defun

@defun ewoc-filter ewoc predicate &rest args
This calls @var{predicate} for each data element in @var{ewoc} and deletes
those nodes for which @var{predicate} returns @code{nil}.  Any @var{args}
are passed to @var{predicate}.
@end defun

@defun ewoc-collect ewoc predicate &rest args
This calls @var{predicate} for each data element in @var{ewoc} and returns a
list of those elements for which @var{predicate} returns non-@code{nil}.
The elements in the list are ordered as in the buffer.  Any @var{args} are
passed to @var{predicate}.
@end defun

@defun ewoc-map map-function ewoc &rest args
This calls @var{map-function} for each data element in @var{ewoc} and
updates those nodes for which @var{map-function} returns non-@code{nil}.
Any @var{args} are passed to @var{map-function}.
@end defun

@node Abstract Display Example
@subsection Abstract Display Example

  Here is a simple example using functions of the ewoc package to implement a
``color components display'', an area in a buffer that represents a vector
of three integers (itself representing a 24-bit RGB value) in various ways.

@example
(setq colorcomp-ewoc nil
      colorcomp-data nil
      colorcomp-mode-map nil
      colorcomp-labels ["Red" "Green" "Blue"])

(defun colorcomp-pp (data)
  (if data
      (let ((comp (aref colorcomp-data data)))
        (insert (aref colorcomp-labels data) "\t: #x"
                (format "%02X" comp) " "
                (make-string (ash comp -2) ?#) "\n"))
    (let ((cstr (format "#%02X%02X%02X"
                        (aref colorcomp-data 0)
                        (aref colorcomp-data 1)
                        (aref colorcomp-data 2)))
          (samp " (sample text) "))
      (insert "Color\t: "
              (propertize samp 'face
                          `(foreground-color . ,cstr))
              (propertize samp 'face
                          `(background-color . ,cstr))
              "\n"))))

(defun colorcomp (color)
  "Allow fiddling with COLOR in a new buffer.
The buffer is in Color Components mode."
  (interactive "sColor (name or #RGB or #RRGGBB): ")
  (when (string= "" color)
    (setq color "green"))
  (unless (color-values color)
    (error "No such color: %S" color))
  (switch-to-buffer
   (generate-new-buffer (format "originally: %s" color)))
  (kill-all-local-variables)
  (setq major-mode 'colorcomp-mode
        mode-name "Color Components")
  (use-local-map colorcomp-mode-map)
  (erase-buffer)
  (buffer-disable-undo)
  (let ((data (apply 'vector (mapcar (lambda (n) (ash n -8))
                                     (color-values color))))
        (ewoc (ewoc-create 'colorcomp-pp
                           "\nColor Components\n\n"
                           (substitute-command-keys
                            "\n\\@{colorcomp-mode-map@}"))))
    (set (make-local-variable 'colorcomp-data) data)
    (set (make-local-variable 'colorcomp-ewoc) ewoc)
    (ewoc-enter-last ewoc 0)
    (ewoc-enter-last ewoc 1)
    (ewoc-enter-last ewoc 2)
    (ewoc-enter-last ewoc nil)))
@end example

@cindex controller part, model/view/controller
  This example can be extended to be a ``color selection widget'' (in other
words, the controller part of the ``model/view/controller'' design paradigm)
by defining commands to modify @code{colorcomp-data} and to ``finish'' the
selection process, and a keymap to tie it all together conveniently.

@smallexample
(defun colorcomp-mod (index limit delta)
  (let ((cur (aref colorcomp-data index)))
    (unless (= limit cur)
      (aset colorcomp-data index (+ cur delta)))
    (ewoc-invalidate
     colorcomp-ewoc
     (ewoc-nth colorcomp-ewoc index)
     (ewoc-nth colorcomp-ewoc -1))))

(defun colorcomp-R-more () (interactive) (colorcomp-mod 0 255 1))
(defun colorcomp-G-more () (interactive) (colorcomp-mod 1 255 1))
(defun colorcomp-B-more () (interactive) (colorcomp-mod 2 255 1))
(defun colorcomp-R-less () (interactive) (colorcomp-mod 0 0 -1))
(defun colorcomp-G-less () (interactive) (colorcomp-mod 1 0 -1))
(defun colorcomp-B-less () (interactive) (colorcomp-mod 2 0 -1))

(defun colorcomp-copy-as-kill-and-exit ()
  "Copy the color components into the kill ring and kill the buffer.
The string is formatted #RRGGBB (hash followed by six hex digits)."
  (interactive)
  (kill-new (format "#%02X%02X%02X"
                    (aref colorcomp-data 0)
                    (aref colorcomp-data 1)
                    (aref colorcomp-data 2)))
  (kill-buffer nil))

(setq colorcomp-mode-map
      (let ((m (make-sparse-keymap)))
        (suppress-keymap m)
        (define-key m "i" 'colorcomp-R-less)
        (define-key m "o" 'colorcomp-R-more)
        (define-key m "k" 'colorcomp-G-less)
        (define-key m "l" 'colorcomp-G-more)
        (define-key m "," 'colorcomp-B-less)
        (define-key m "." 'colorcomp-B-more)
        (define-key m " " 'colorcomp-copy-as-kill-and-exit)
        m))
@end smallexample

Note that we never modify the data in each node, which is fixed when the
ewoc is created to be either @code{nil} or an index into the vector
@code{colorcomp-data}, the actual color components.

@node Blinking
@section Blinking Parentheses
@cindex parenthesis matching
@cindex blinking parentheses
@cindex balancing parentheses

  This section describes the mechanism by which Emacs shows a matching open
parenthesis when the user inserts a close parenthesis.

@defvar blink-paren-function
The value of this variable should be a function (of no arguments) to be
called whenever a character with close parenthesis syntax is inserted.  The
value of @code{blink-paren-function} may be @code{nil}, in which case
nothing is done.
@end defvar

@defopt blink-matching-paren
If this variable is @code{nil}, then @code{blink-matching-open} does
nothing.
@end defopt

@defopt blink-matching-paren-distance
This variable specifies the maximum distance to scan for a matching
parenthesis before giving up.
@end defopt

@defopt blink-matching-delay
This variable specifies the number of seconds to keep indicating the
matching parenthesis.  A fraction of a second often gives good results, but
the default is 1, which works on all systems.
@end defopt

@deffn Command blink-matching-open
This function is the default value of @code{blink-paren-function}.  It
assumes that point follows a character with close parenthesis syntax and
applies the appropriate effect momentarily to the matching opening
character.  If that character is not already on the screen, it displays the
character's context in the echo area.  To avoid long delays, this function
does not search farther than @code{blink-matching-paren-distance}
characters.

Here is an example of calling this function explicitly.

@smallexample
@group
(defun interactive-blink-matching-open ()
  "Indicate momentarily the start of parenthesized sexp before point."
  (interactive)
@end group
@group
  (let ((blink-matching-paren-distance
         (buffer-size))
        (blink-matching-paren t))
    (blink-matching-open)))
@end group
@end smallexample
@end deffn

@node Character Display
@section Character Display

  This section describes how characters are actually displayed by Emacs.
Typically, a character is displayed as a @dfn{glyph} (a graphical symbol
which occupies one character position on the screen), whose appearance
corresponds to the character itself.  For example, the character @samp{a}
(character code 97) is displayed as @samp{a}.  Some characters, however, are
displayed specially.  For example, the formfeed character (character code
12) is usually displayed as a sequence of two glyphs, @samp{^L}, while the
newline character (character code 10) starts a new screen line.

  You can modify how each character is displayed by defining a @dfn{display
table}, which maps each character code into a sequence of glyphs.
@xref{Display Tables}.

@menu
* Usual Display::            The usual conventions for displaying 
                               characters.
* Display Tables::           What a display table consists of.
* Active Display Table::     How Emacs selects a display table to use.
* Glyphs::                   How to define a glyph, and what glyphs mean.
* Glyphless Chars::          How glyphless characters are drawn.
@end menu

@node Usual Display
@subsection Usual Display Conventions

  Here are the conventions for displaying each character code (in the absence
of a display table, which can override these
@iftex
conventions).
@end iftex
@ifnottex
conventions; @pxref{Display Tables}).
@end ifnottex

@cindex printable ASCII characters
@itemize @bullet
@item
The @dfn{printable @acronym{ASCII} characters}, character codes 32 through
126 (consisting of numerals, English letters, and symbols like @samp{#}) are
displayed literally.

@item
The tab character (character code 9) displays as whitespace stretching up to
the next tab stop column.  @xref{Text Display,,, emacs, The GNU Emacs
Manual}.  The variable @code{tab-width} controls the number of spaces per
tab stop (see below).

@item
The newline character (character code 10) has a special effect: it ends the
preceding line and starts a new line.

@cindex ASCII control characters
@item
The non-printable @dfn{@acronym{ASCII} control characters}---character codes
0 through 31, as well as the @key{DEL} character (character code
127)---display in one of two ways according to the variable
@code{ctl-arrow}.  If this variable is non-@code{nil} (the default), these
characters are displayed as sequences of two glyphs, where the first glyph
is @samp{^} (a display table can specify a glyph to use instead of
@samp{^}); e.g., the @key{DEL} character is displayed as @samp{^?}.

If @code{ctl-arrow} is @code{nil}, these characters are displayed as octal
escapes (see below).

This rule also applies to carriage return (character code 13), if that
character appears in the buffer.  But carriage returns usually do not appear
in buffer text; they are eliminated as part of end-of-line conversion
(@pxref{Coding System Basics}).

@cindex octal escapes
@item
@dfn{Raw bytes} are non-@acronym{ASCII} characters with codes 128 through
255 (@pxref{Text Representations}).  These characters display as @dfn{octal
escapes}: sequences of four glyphs, where the first glyph is the
@acronym{ASCII} code for @samp{\}, and the others are digit characters
representing the character code in octal.  (A display table can specify a
glyph to use instead of @samp{\}.)

@item
Each non-@acronym{ASCII} character with code above 255 is displayed
literally, if the terminal supports it.  If the terminal does not support
it, the character is said to be @dfn{glyphless}, and it is usually displayed
using a placeholder glyph.  For example, if a graphical terminal has no font
for a character, Emacs usually displays a box containing the character code
in hexadecimal.  @xref{Glyphless Chars}.
@end itemize

  The above display conventions apply even when there is a display table, for
any character whose entry in the active display table is @code{nil}.  Thus,
when you set up a display table, you need only specify the characters for
which you want special behavior.

  The following variables affect how certain characters are displayed on the
screen.  Since they change the number of columns the characters occupy, they
also affect the indentation functions.  They also affect how the mode line
is displayed; if you want to force redisplay of the mode line using the new
values, call the function @code{force-mode-line-update} (@pxref{Mode Line
Format}).

@defopt ctl-arrow
@cindex control characters in display
This buffer-local variable controls how control characters are displayed.
If it is non-@code{nil}, they are displayed as a caret followed by the
character: @samp{^A}.  If it is @code{nil}, they are displayed as octal
escapes: a backslash followed by three octal digits, as in @samp{\001}.
@end defopt

@defopt tab-width
The value of this buffer-local variable is the spacing between tab stops
used for displaying tab characters in Emacs buffers.  The value is in units
of columns, and the default is 8.  Note that this feature is completely
independent of the user-settable tab stops used by the command
@code{tab-to-tab-stop}.  @xref{Indent Tabs}.
@end defopt

@node Display Tables
@subsection Display Tables

@cindex display table
  A display table is a special-purpose char-table (@pxref{Char-Tables}), with
@code{display-table} as its subtype, which is used to override the usual
character display conventions.  This section describes how to make, inspect,
and assign elements to a display table object.

@defun make-display-table
This creates and returns a display table.  The table initially has
@code{nil} in all elements.
@end defun

  The ordinary elements of the display table are indexed by character codes;
the element at index @var{c} says how to display the character code
@var{c}.  The value should be @code{nil} (which means to display the
character @var{c} according to the usual display conventions; @pxref{Usual
Display}), or a vector of glyph codes (which means to display the character
@var{c} as those glyphs; @pxref{Glyphs}).

  @strong{Warning:} if you use the display table to change the display of
newline characters, the whole buffer will be displayed as one long ``line''.

  The display table also has six ``extra slots'' which serve special
purposes.  Here is a table of their meanings; @code{nil} in any slot means
to use the default for that slot, as stated below.

@table @asis
@item 0
The glyph for the end of a truncated screen line (the default for this is
@samp{$}).  @xref{Glyphs}.  On graphical terminals, Emacs uses arrows in the
fringes to indicate truncation, so the display table has no effect.

@item 1
The glyph for the end of a continued line (the default is @samp{\}).  On
graphical terminals, Emacs uses curved arrows in the fringes to indicate
continuation, so the display table has no effect.

@item 2
The glyph for indicating a character displayed as an octal character code
(the default is @samp{\}).

@item 3
The glyph for indicating a control character (the default is @samp{^}).

@item 4
A vector of glyphs for indicating the presence of invisible lines (the
default is @samp{...}).  @xref{Selective Display}.

@item 5
The glyph used to draw the border between side-by-side windows (the default
is @samp{|}).  @xref{Splitting Windows}.  This takes effect only when there
are no scroll bars; if scroll bars are supported and in use, a scroll bar
separates the two windows.
@end table

  For example, here is how to construct a display table that mimics the effect
of setting @code{ctl-arrow} to a non-@code{nil} value (@pxref{Glyphs}, for
the function @code{make-glyph-code}):

@example
(setq disptab (make-display-table))
(dotimes (i 32)
  (or (= i ?\t)
      (= i ?\n)
      (aset disptab i
            (vector (make-glyph-code ?^ 'escape-glyph)
                    (make-glyph-code (+ i 64) 'escape-glyph)))))
(aset disptab 127
      (vector (make-glyph-code ?^ 'escape-glyph)
              (make-glyph-code ?? 'escape-glyph)))))
@end example

@defun display-table-slot display-table slot
This function returns the value of the extra slot @var{slot} of
@var{display-table}.  The argument @var{slot} may be a number from 0 to 5
inclusive, or a slot name (symbol).  Valid symbols are @code{truncation},
@code{wrap}, @code{escape}, @code{control}, @code{selective-display}, and
@code{vertical-border}.
@end defun

@defun set-display-table-slot display-table slot value
This function stores @var{value} in the extra slot @var{slot} of
@var{display-table}.  The argument @var{slot} may be a number from 0 to 5
inclusive, or a slot name (symbol).  Valid symbols are @code{truncation},
@code{wrap}, @code{escape}, @code{control}, @code{selective-display}, and
@code{vertical-border}.
@end defun

@defun describe-display-table display-table
This function displays a description of the display table
@var{display-table} in a help buffer.
@end defun

@deffn Command describe-current-display-table
This command displays a description of the current display table in a help
buffer.
@end deffn

@node Active Display Table
@subsection Active Display Table
@cindex active display table

  Each window can specify a display table, and so can each buffer.  The
window's display table, if there is one, takes precedence over the buffer's
display table.  If neither exists, Emacs tries to use the standard display
table; if that is @code{nil}, Emacs uses the usual character display
conventions (@pxref{Usual Display}).

  Note that display tables affect how the mode line is displayed, so if you
want to force redisplay of the mode line using a new display table, call
@code{force-mode-line-update} (@pxref{Mode Line Format}).

@defun window-display-table &optional window
This function returns @var{window}'s display table, or @code{nil} if there
is none.  The default for @var{window} is the selected window.
@end defun

@defun set-window-display-table window table
This function sets the display table of @var{window} to @var{table}.  The
argument @var{table} should be either a display table or @code{nil}.
@end defun

@defvar buffer-display-table
This variable is automatically buffer-local in all buffers; its value
specifies the buffer's display table.  If it is @code{nil}, there is no
buffer display table.
@end defvar

@defvar standard-display-table
The value of this variable is the standard display table, which is used when
Emacs is displaying a buffer in a window with neither a window display table
nor a buffer display table defined.  Its default is @code{nil}.
@end defvar

The @file{disp-table} library defines several functions for changing the
standard display table.

@node Glyphs
@subsection Glyphs
@cindex glyph

@cindex glyph code
  A @dfn{glyph} is a graphical symbol which occupies a single character
position on the screen.  Each glyph is represented in Lisp as a @dfn{glyph
code}, which specifies a character and optionally a face to display it in
(@pxref{Faces}).  The main use of glyph codes is as the entries of display
tables (@pxref{Display Tables}).  The following functions are used to
manipulate glyph codes:

@defun make-glyph-code char &optional face
This function returns a glyph code representing char @var{char} with face
@var{face}.  If @var{face} is omitted or @code{nil}, the glyph uses the
default face; in that case, the glyph code is an integer.  If @var{face} is
non-@code{nil}, the glyph code is not necessarily an integer object.
@end defun

@defun glyph-char glyph
This function returns the character of glyph code @var{glyph}.
@end defun

@defun glyph-face glyph
This function returns face of glyph code @var{glyph}, or @code{nil} if
@var{glyph} uses the default face.
@end defun

@ifnottex
  You can set up a @dfn{glyph table} to change how glyph codes are actually
displayed on text terminals.  This feature is semi-obsolete; use
@code{glyphless-char-display} instead (@pxref{Glyphless Chars}).

@defvar glyph-table
The value of this variable, if non-@code{nil}, is the current glyph table.
It takes effect only on character terminals; on graphical displays, all
glyphs are displayed literally.  The glyph table should be a vector whose
@var{g}th element specifies how to display glyph code @var{g}, where @var{g}
is the glyph code for a glyph whose face is unspecified.  Each element
should be one of the following:

@table @asis
@item @code{nil}
Display this glyph literally.

@item a string
Display this glyph by sending the specified string to the terminal.

@item a glyph code
Display the specified glyph code instead.
@end table

Any integer glyph code greater than or equal to the length of the glyph
table is displayed literally.
@end defvar
@end ifnottex

@node Glyphless Chars
@subsection Glyphless Character Display
@cindex glyphless characters

  @dfn{Glyphless characters} are characters which are displayed in a special
way, e.g., as a box containing a hexadecimal code, instead of being
displayed literally.  These include characters which are explicitly defined
to be glyphless, as well as characters for which there is no available font
(on a graphical display), and characters which cannot be encoded by the
terminal's coding system (on a text terminal).

@defvar glyphless-char-display
The value of this variable is a char-table which defines glyphless
characters and how they are displayed.  Each entry must be one of the
following display methods:

@table @asis
@item @code{nil}
Display the character in the usual way.

@item @code{zero-width}
Don't display the character.

@item @code{thin-space}
Display a thin space, 1-pixel wide on graphical displays, or 1-character
wide on text terminals.

@item @code{empty-box}
Display an empty box.

@item @code{hex-code}
Display a box containing the Unicode codepoint of the character, in
hexadecimal notation.

@item an @acronym{ASCII} string
Display a box containing that string.

@item a cons cell @code{(@var{graphical} . @var{text})}
Display with @var{graphical} on graphical displays, and with @var{text} on
text terminals.  Both @var{graphical} and @var{text} must be one of the
display methods described above.
@end table

@noindent
The @code{thin-space}, @code{empty-box}, @code{hex-code}, and
@acronym{ASCII} string display methods are drawn with the
@code{glyphless-char} face.

The char-table has one extra slot, which determines how to display any
character that cannot be displayed with any available font, or cannot be
encoded by the terminal's coding system.  Its value should be one of the
above display methods, except @code{zero-width} or a cons cell.

If a character has a non-@code{nil} entry in an active display table, the
display table takes effect; in this case, Emacs does not consult
@code{glyphless-char-display} at all.
@end defvar

@defopt glyphless-char-display-control
This user option provides a convenient way to set
@code{glyphless-char-display} for groups of similar characters.  Do not set
its value directly from Lisp code; the value takes effect only via a custom
@code{:set} function (@pxref{Variable Definitions}), which updates
@code{glyphless-char-display}.

Its value should be an alist of elements @code{(@var{group}
. @var{method})}, where @var{group} is a symbol specifying a group of
characters, and @var{method} is a symbol specifying how to display them.

@var{group} should be one of the following:

@table @code
@item c0-control
@acronym{ASCII} control characters @code{U+0000} to @code{U+001F}, excluding
the newline and tab characters (normally displayed as escape sequences like
@samp{^A}; @pxref{Text Display,, How Text Is Displayed, emacs, The GNU Emacs
Manual}).

@item c1-control
Non-@acronym{ASCII}, non-printing characters @code{U+0080} to @code{U+009F}
(normally displayed as octal escape sequences like @samp{\230}).

@item format-control
Characters of Unicode General Category `Cf', such as @samp{U+200E}
(Left-to-Right Mark), but excluding characters that have graphic images,
such as @samp{U+00AD} (Soft Hyphen).

@item no-font
Characters for there is no suitable font, or which cannot be encoded by the
terminal's coding system.
@end table

@c FIXME: this can also be `acronym', but that's not currently
@c completely implemented; it applies only to the format-control
@c group, and only works if the acronym is in `char-acronym-table'.
The @var{method} symbol should be one of @code{zero-width},
@code{thin-space}, @code{empty-box}, or @code{hex-code}.  These have the
same meanings as in @code{glyphless-char-display}, above.
@end defopt

@node Beeping
@section Beeping
@cindex bell

  This section describes how to make Emacs ring the bell (or blink the screen)
to attract the user's attention.  Be conservative about how often you do
this; frequent bells can become irritating.  Also be careful not to use just
beeping when signaling an error is more appropriate (@pxref{Errors}).

@defun ding &optional do-not-terminate
@cindex keyboard macro termination
This function beeps, or flashes the screen (see @code{visible-bell} below).
It also terminates any keyboard macro currently executing unless
@var{do-not-terminate} is non-@code{nil}.
@end defun

@defun beep &optional do-not-terminate
This is a synonym for @code{ding}.
@end defun

@defopt visible-bell
This variable determines whether Emacs should flash the screen to represent
a bell.  Non-@code{nil} means yes, @code{nil} means no.  This is effective
on graphical displays, and on text terminals provided the terminal's Termcap
entry defines the visible bell capability (@samp{vb}).
@end defopt

@defvar ring-bell-function
If this is non-@code{nil}, it specifies how Emacs should ``ring the bell''.
Its value should be a function of no arguments.  If this is non-@code{nil},
it takes precedence over the @code{visible-bell} variable.
@end defvar

@node Window Systems
@section Window Systems

  Emacs works with several window systems, most notably the X Window System.
Both Emacs and X use the term ``window'', but use it differently.  An Emacs
frame is a single window as far as X is concerned; the individual Emacs
windows are not known to X at all.

@defvar window-system
This terminal-local variable tells Lisp programs what window system Emacs is
using for displaying the frame.  The possible values are

@table @code
@item x
@cindex X Window System
Emacs is displaying the frame using X.
@item w32
Emacs is displaying the frame using native MS-Windows GUI.
@item ns
Emacs is displaying the frame using the Nextstep interface (used on GNUstep
and Mac OS X).
@item pc
Emacs is displaying the frame using MS-DOS direct screen writes.
@item nil
Emacs is displaying the frame on a character-based terminal.
@end table
@end defvar

@defvar initial-window-system
This variable holds the value of @code{window-system} used for the first
frame created by Emacs during startup.  (When Emacs is invoked with the
@option{--daemon} option, it does not create any initial frames, so
@code{initial-window-system} is @code{nil}.  @xref{Initial Options, daemon,,
emacs, The GNU Emacs Manual}.)
@end defvar

@defun window-system &optional frame
This function returns a symbol whose name tells what window system is used
for displaying @var{frame} (which defaults to the currently selected
frame).  The list of possible symbols it returns is the same one documented
for the variable @code{window-system} above.
@end defun

  Do @emph{not} use @code{window-system} and @code{initial-window-system} as
predicates or boolean flag variables, if you want to write code that works
differently on text terminals and graphic displays.  That is because
@code{window-system} is not a good indicator of Emacs capabilities on a
given display type.  Instead, use @code{display-graphic-p} or any of the
other @code{display-*-p} predicates described in @ref{Display Feature
Testing}.

@node Bidirectional Display
@section Bidirectional Display
@cindex bidirectional display
@cindex right-to-left text

  Emacs can display text written in scripts, such as Arabic, Farsi, and
Hebrew, whose natural ordering for horizontal text display runs from right
to left.  Furthermore, segments of Latin script and digits embedded in
right-to-left text are displayed left-to-right, while segments of
right-to-left script embedded in left-to-right text (e.g., Arabic or Hebrew
text in comments or strings in a program source file) are appropriately
displayed right-to-left.  We call such mixtures of left-to-right and
right-to-left text @dfn{bidirectional text}.  This section describes the
facilities and options for editing and displaying bidirectional text.

@cindex logical order
@cindex reading order
@cindex visual order
@cindex unicode bidirectional algorithm
@cindex UBA
@cindex bidirectional reordering
@cindex reordering, of bidirectional text
  Text is stored in Emacs buffers and strings in @dfn{logical} (or
@dfn{reading}) order, i.e., the order in which a human would read each
character.  In right-to-left and bidirectional text, the order in which
characters are displayed on the screen (called @dfn{visual order}) is not
the same as logical order; the characters' screen positions do not increase
monotonically with string or buffer position.  In performing this
@dfn{bidirectional reordering}, Emacs follows the Unicode Bidirectional
Algorithm (a.k.a.@: @acronym{UBA}), which is described in Annex #9 of the
Unicode standard (@url{http://www.unicode.org/reports/tr9/}).  Emacs
currently provides a ``Non-isolate Bidirectionality'' class implementation
of the @acronym{UBA}: it does not yet support the isolate directional
formatting characters introduced with Unicode Standard v6.3.0.

@defvar bidi-display-reordering
If the value of this buffer-local variable is non-@code{nil} (the default),
Emacs performs bidirectional reordering for display.  The reordering affects
buffer text, as well as display strings and overlay strings from text and
overlay properties in the buffer (@pxref{Overlay Properties}, and
@pxref{Display Property}).  If the value is @code{nil}, Emacs does not
perform bidirectional reordering in the buffer.

The default value of @code{bidi-display-reordering} controls the reordering
of strings which are not directly supplied by a buffer, including the text
displayed in mode lines (@pxref{Mode Line Format})  and header lines
(@pxref{Header Lines}).
@end defvar

@cindex unibyte buffers, and bidi reordering
  Emacs never reorders the text of a unibyte buffer, even if
@code{bidi-display-reordering} is non-@code{nil} in the buffer.  This is
because unibyte buffers contain raw bytes, not characters, and thus lack the
directionality properties required for reordering.  Therefore, to test
whether text in a buffer will be reordered for display, it is not enough to
test the value of @code{bidi-display-reordering} alone.  The correct test is
this:

@example
 (if (and enable-multibyte-characters
          bidi-display-reordering)
     ;; Buffer is being reordered for display
   )
@end example

  However, unibyte display and overlay strings @emph{are} reordered if their
parent buffer is reordered.  This is because plain-@sc{ascii} strings are
stored by Emacs as unibyte strings.  If a unibyte display or overlay string
includes non-@sc{ascii} characters, these characters are assumed to have
left-to-right direction.

@cindex display properties, and bidi reordering of text
  Text covered by @code{display} text properties, by overlays with
@code{display} properties whose value is a string, and by any other
properties that replace buffer text, is treated as a single unit when it is
reordered for display.  That is, the entire chunk of text covered by these
properties is reordered together.  Moreover, the bidirectional properties of
the characters in such a chunk of text are ignored, and Emacs reorders them
as if they were replaced with a single character @code{U+FFFC}, known as the
@dfn{Object Replacement Character}.  This means that placing a display
property over a portion of text may change the way that the surrounding text
is reordered for display.  To prevent this unexpected effect, always place
such properties on text whose directionality is identical with text that
surrounds it.

@cindex base direction of a paragraph
  Each paragraph of bidirectional text has a @dfn{base direction}, either
right-to-left or left-to-right.  Left-to-right paragraphs are displayed
beginning at the left margin of the window, and are truncated or continued
when the text reaches the right margin.  Right-to-left paragraphs are
displayed beginning at the right margin, and are continued or truncated at
the left margin.

  By default, Emacs determines the base direction of each paragraph by looking
at the text at its beginning.  The precise method of determining the base
direction is specified by the @acronym{UBA}; in a nutshell, the first
character in a paragraph that has an explicit directionality determines the
base direction of the paragraph.  However, sometimes a buffer may need to
force a certain base direction for its paragraphs.  For example, buffers
containing program source code should force all paragraphs to be displayed
left-to-right.  You can use following variable to do this:

@defvar bidi-paragraph-direction
If the value of this buffer-local variable is the symbol
@code{right-to-left} or @code{left-to-right}, all paragraphs in the buffer
are assumed to have that specified direction.  Any other value is equivalent
to @code{nil} (the default), which means to determine the base direction of
each paragraph from its contents.

@cindex @code{prog-mode}, and @code{bidi-paragraph-direction}
Modes for program source code should set this to @code{left-to-right}.  Prog
mode does this by default, so modes derived from Prog mode do not need to
set this explicitly (@pxref{Basic Major Modes}).
@end defvar

@defun current-bidi-paragraph-direction &optional buffer
This function returns the paragraph direction at point in the named
@var{buffer}.  The returned value is a symbol, either @code{left-to-right}
or @code{right-to-left}.  If @var{buffer} is omitted or @code{nil}, it
defaults to the current buffer.  If the buffer-local value of the variable
@code{bidi-paragraph-direction} is non-@code{nil}, the returned value will
be identical to that value; otherwise, the returned value reflects the
paragraph direction determined dynamically by Emacs.  For buffers whose
value of @code{bidi-display-reordering} is @code{nil} as well as unibyte
buffers, this function always returns @code{left-to-right}.
@end defun

@cindex visual-order cursor motion
  Sometimes there's a need to move point in strict visual order, either to the
left or to the right of its current screen position.  Emacs provides a
primitive to do that.

@defun move-point-visually direction
This function moves point of the currently selected window to the buffer
position that appears immediately to the right or to the left of point on
the screen.  If @var{direction} is positive, point will move one screen
position to the right, otherwise it will move one screen position to the
left.  Note that, depending on the surrounding bidirectional context, this
could potentially move point many buffer positions away.  If invoked at the
end of a screen line, the function moves point to the rightmost or leftmost
screen position of the next or previous screen line, as appropriate for the
value of @var{direction}.

The function returns the new buffer position as its value.
@end defun

@cindex layout on display, and bidirectional text
@cindex jumbled display of bidirectional text
@cindex concatenating bidirectional strings
  Bidirectional reordering can have surprising and unpleasant effects when two
strings with bidirectional content are juxtaposed in a buffer, or otherwise
programmatically concatenated into a string of text.  A typical problematic
case is when a buffer consists of sequences of text ``fields'' separated by
whitespace or punctuation characters, like Buffer Menu mode or Rmail Summary
Mode.  Because the punctuation characters used as separators have @dfn{weak
directionality}, they take on the directionality of surrounding text.  As
result, a numeric field that follows a field with bidirectional content can
be displayed @emph{to the left} of the preceding field, messing up the
expected layout.  There are several ways to avoid this problem:

@itemize @minus
@item
Append the special character @code{U+200E}, LEFT-TO-RIGHT MARK, or
@acronym{LRM}, to the end of each field that may have bidirectional content,
or prepend it to the beginning of the following field.  The function
@code{bidi-string-mark-left-to-right}, described below, comes in handy for
this purpose.  (In a right-to-left paragraph, use @code{U+200F},
RIGHT-TO-LEFT MARK, or @acronym{RLM}, instead.)  This is one of the
solutions recommended by the UBA.

@item
Include the tab character in the field separator.  The tab character plays
the role of @dfn{segment separator} in bidirectional reordering, causing the
text on either side to be reordered separately.

@cindex @code{space} display spec, and bidirectional text
@item
Separate fields with a @code{display} property or overlay with a property
value of the form @code{(space . PROPS)} (@pxref{Specified Space}).  Emacs
treats this display specification as a @dfn{paragraph separator}, and
reorders the text on either side separately.
@end itemize

@defun bidi-string-mark-left-to-right string
This function returns its argument @var{string}, possibly modified, such
that the result can be safely concatenated with another string, or
juxtaposed with another string in a buffer, without disrupting the relative
layout of this string and the next one on display.  If the string returned
by this function is displayed as part of a left-to-right paragraph, it will
always appear on display to the left of the text that follows it.  The
function works by examining the characters of its argument, and if any of
those characters could cause reordering on display, the function appends the
@acronym{LRM} character to the string.  The appended @acronym{LRM} character
is made invisible by giving it an @code{invisible} text property of @code{t}
(@pxref{Invisible Text}).
@end defun

  The reordering algorithm uses the bidirectional properties of the characters
stored as their @code{bidi-class} property (@pxref{Character Properties}).
Lisp programs can change these properties by calling the
@code{put-char-code-property} function.  However, doing this requires a
thorough understanding of the @acronym{UBA}, and is therefore not
recommended.  Any changes to the bidirectional properties of a character
have global effect: they affect all Emacs frames and windows.

  Similarly, the @code{mirroring} property is used to display the appropriate
mirrored character in the reordered text.  Lisp programs can affect the
mirrored display by changing this property.  Again, any such changes affect
all of Emacs display.
